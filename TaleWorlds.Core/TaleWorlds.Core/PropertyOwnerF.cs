using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.Core;

public class PropertyOwnerF<T> : IReadOnlyPropertyOwnerF<T> where T : MBObjectBase
{
	[SaveableField(10)]
	protected Dictionary<T, float> _attributes;

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		collectedObjects.Add(_attributes);
	}

	public PropertyOwnerF()
	{
		_attributes = new Dictionary<T, float>();
	}

	public PropertyOwnerF(PropertyOwnerF<T> propertyOwner)
	{
		_attributes = new Dictionary<T, float>(propertyOwner._attributes);
	}

	public void SetPropertyValue(T attribute, float value)
	{
		if (!value.ApproximatelyEqualsTo(0f))
		{
			_attributes[attribute] = value;
		}
		else if (HasProperty(attribute))
		{
			_attributes.Remove(attribute);
		}
	}

	public float GetPropertyValue(T attribute)
	{
		if (attribute != null)
		{
			if (!_attributes.TryGetValue(attribute, out var value))
			{
				return 0f;
			}
			return value;
		}
		Debug.FailedAssert("attribute in GetPropertyValue can not be null!", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.Core\\PropertyOwner.cs", "GetPropertyValue", 144);
		return 0f;
	}

	public bool HasProperty(T attribute)
	{
		return _attributes.ContainsKey(attribute);
	}

	public void ClearAllProperty()
	{
		_attributes.Clear();
	}

	public MBList<T> GetProperties()
	{
		return _attributes.Keys.ToMBList();
	}

	public void Serialize(XmlWriter writer)
	{
		writer.WriteStartElement("attributes");
		foreach (KeyValuePair<T, float> attribute in _attributes)
		{
			writer.WriteStartElement("attribute");
			writer.WriteAttributeString("id", attribute.Key.StringId);
			writer.WriteAttributeString("value", attribute.Value.ToString());
			writer.WriteEndElement();
		}
		writer.WriteEndElement();
	}

	public void Deserialize(MBObjectManager objectManager, XmlNode node)
	{
		foreach (XmlNode childNode in node.ChildNodes)
		{
			if (childNode.NodeType != XmlNodeType.Comment)
			{
				XmlAttributeCollection? attributes = childNode.Attributes;
				string value = attributes["id"].Value;
				string value2 = attributes["value"].Value;
				T val = Game.Current.ObjectManager.GetObject<T>(value);
				if (val != null)
				{
					float value3 = Convert.ToSingle(value2);
					SetPropertyValue(val, value3);
				}
			}
		}
	}
}
