using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;

namespace TaleWorlds.Core;

public sealed class ItemModifier : MBObjectBase
{
	[CachedData]
	public TextObject Name { get; private set; }

	public int Damage { get; private set; }

	public int Speed { get; private set; }

	public int MissileSpeed { get; private set; }

	public int Armor { get; private set; }

	public short HitPoints { get; private set; }

	public short StackCount { get; private set; }

	public float MountSpeed { get; private set; }

	public float Maneuver { get; private set; }

	public float ChargeDamage { get; private set; }

	public float MountHitPoints { get; private set; }

	public float LootDropScore { get; private set; }

	public float ProductionDropScore { get; private set; }

	public float PriceMultiplier { get; private set; }

	public ItemQuality ItemQuality { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsItemModifier(object o, List<object> collectedObjects)
	{
		((ItemModifier)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	public ItemModifier()
	{
		Name = TextObject.GetEmpty();
	}

	public override void Deserialize(MBObjectManager objectManager, XmlNode node)
	{
		base.Deserialize(objectManager, node);
		Name = new TextObject(XmlHelper.ReadString(node, "name"));
		Damage = XmlHelper.ReadInt(node, "damage");
		Speed = XmlHelper.ReadInt(node, "speed");
		MissileSpeed = XmlHelper.ReadInt(node, "missile_speed");
		Armor = XmlHelper.ReadInt(node, "armor");
		MountSpeed = XmlHelper.ReadFloat(node, "horse_speed");
		Maneuver = XmlHelper.ReadFloat(node, "maneuver");
		ChargeDamage = XmlHelper.ReadFloat(node, "charge_damage");
		MountHitPoints = XmlHelper.ReadFloat(node, "horse_hit_points");
		HitPoints = (short)XmlHelper.ReadInt(node, "hit_points");
		StackCount = (short)XmlHelper.ReadInt(node, "stack_count");
		ItemQuality = ReadItemQuality(node);
		LootDropScore = XmlHelper.ReadInt(node, "loot_drop_score");
		ProductionDropScore = XmlHelper.ReadInt(node, "production_drop_score");
		PriceMultiplier = XmlHelper.ReadFloat(node, "price_factor", 1f);
		MBObjectManager.Instance.ReadObjectReferenceFromXml<ItemModifierGroup>("modifier_group", node)?.AddItemModifier(this);
	}

	private ItemQuality ReadItemQuality(XmlNode node)
	{
		switch (XmlHelper.ReadString(node, "quality"))
		{
		case "poor":
			return ItemQuality.Poor;
		case "inferior":
			return ItemQuality.Inferior;
		case "fine":
			return ItemQuality.Fine;
		case "masterwork":
			return ItemQuality.Masterwork;
		case "legendary":
			return ItemQuality.Legendary;
		case "common":
		case "":
			return ItemQuality.Common;
		default:
			return ItemQuality.Common;
		}
	}

	public bool Equals(ItemModifier other)
	{
		if (other == null)
		{
			return false;
		}
		return base.StringId == other.StringId;
	}

	public override int GetHashCode()
	{
		return base.StringId.GetDeterministicHashCode();
	}

	private static int ModifyFactor(int baseValue, float factor)
	{
		if (baseValue == 0)
		{
			return 0;
		}
		if (!MBMath.ApproximatelyEquals(factor, 0f))
		{
			baseValue = ((factor < 1f) ? TaleWorlds.Library.MathF.Ceiling(factor * (float)baseValue) : TaleWorlds.Library.MathF.Floor(factor * (float)baseValue));
		}
		return baseValue;
	}

	public int ModifyDamage(int baseDamage)
	{
		return Math.Max(baseDamage + Damage, 1);
	}

	public int ModifySpeed(int baseSpeed)
	{
		return Math.Max(baseSpeed + Speed, 1);
	}

	public int ModifyMountSpeed(int baseSpeed)
	{
		return Math.Max(ModifyFactor(baseSpeed, MountSpeed), 1);
	}

	public int ModifyMountManeuver(int baseManeuver)
	{
		return Math.Max(ModifyFactor(baseManeuver, Maneuver), 1);
	}

	public int ModifyMountCharge(int baseCharge)
	{
		return Math.Max(ModifyFactor(baseCharge, ChargeDamage), 1);
	}

	public int ModifyMountHitPoints(int baseCharge)
	{
		return Math.Max(ModifyFactor(baseCharge, MountHitPoints), 1);
	}

	public int ModifyMissileSpeed(int baseSpeed)
	{
		return Math.Max(baseSpeed + MissileSpeed, 1);
	}

	public int ModifyArmor(int armorValue)
	{
		return Math.Max(armorValue + Armor, 1);
	}

	public short ModifyHitPoints(short baseHitPoints)
	{
		return Math.Max((short)(baseHitPoints + HitPoints), (short)1);
	}

	public short ModifyStackCount(short baseStackCount)
	{
		return Math.Max((short)(baseStackCount + StackCount), (short)1);
	}
}
