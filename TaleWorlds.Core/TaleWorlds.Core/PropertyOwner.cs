using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.Core;

public class PropertyOwner<T> : IReadOnlyPropertyOwner<T> where T : MBObjectBase
{
	[SaveableField(10)]
	protected readonly Dictionary<T, int> _attributes;

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		collectedObjects.Add(_attributes);
	}

	public PropertyOwner()
	{
		_attributes = new Dictionary<T, int>();
	}

	public PropertyOwner(PropertyOwner<T> propertyOwner)
	{
		_attributes = new Dictionary<T, int>(propertyOwner._attributes);
	}

	public void SetPropertyValue(T attribute, int value)
	{
		if (value != 0)
		{
			_attributes[attribute] = value;
		}
		else if (HasProperty(attribute))
		{
			_attributes.Remove(attribute);
		}
	}

	public int GetPropertyValue(T attribute)
	{
		if (attribute != null)
		{
			if (!_attributes.TryGetValue(attribute, out var value))
			{
				return 0;
			}
			return value;
		}
		Debug.FailedAssert("attribute in GetPropertyValue can not be null!", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.Core\\PropertyOwner.cs", "GetPropertyValue", 64);
		return 0;
	}

	public bool HasProperty(T attribute)
	{
		return _attributes.ContainsKey(attribute);
	}

	public void ClearAllProperty()
	{
		_attributes.Clear();
	}

	public MBList<T> GetProperties()
	{
		return _attributes.Keys.ToMBList();
	}

	public void Deserialize(MBObjectManager objectManager, XmlNode node)
	{
		foreach (XmlNode childNode in node.ChildNodes)
		{
			if (childNode.NodeType != XmlNodeType.Comment)
			{
				XmlAttributeCollection? attributes = childNode.Attributes;
				string value = attributes["id"].Value;
				string value2 = attributes["value"].Value;
				T val = Game.Current.ObjectManager.GetObject<T>(value);
				if (val != null)
				{
					int value3 = Convert.ToInt32(value2);
					SetPropertyValue(val, value3);
				}
			}
		}
	}
}
