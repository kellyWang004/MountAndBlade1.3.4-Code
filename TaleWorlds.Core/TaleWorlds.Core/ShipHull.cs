using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;

namespace TaleWorlds.Core;

public class ShipHull : MBObjectBase
{
	public enum ShipType
	{
		Light,
		Medium,
		Heavy
	}

	public MBReadOnlyDictionary<string, ShipSlot> AvailableSlots;

	public TextObject Name { get; private set; }

	public TextObject Description { get; private set; }

	public float BaseSpeed { get; private set; }

	public int Value { get; private set; }

	public bool HasHold { get; private set; }

	public bool CanNavigateShallowWater { get; private set; }

	public bool CanEquipFigurehead { get; private set; }

	public float ProductionBuildWeight { get; private set; }

	public int SeaWorthiness { get; private set; }

	public ShipType Type { get; private set; }

	public bool IsTradeShip { get; private set; }

	public string MissionShipObjectId { get; private set; }

	public int DefaultFormationGroup { get; private set; }

	public int InventoryCapacity { get; private set; }

	public int MaxHitPoints { get; private set; }

	public int MaxFireHitPoints { get; private set; }

	public int MaxSailHitPoints { get; private set; }

	public int TotalCrewCapacity { get; private set; }

	public int MainDeckCrewCapacity { get; private set; }

	public int SkeletalCrewCapacity { get; private set; }

	public float MapVisualScale { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsShipHull(object o, List<object> collectedObjects)
	{
		((ShipHull)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	public override string ToString()
	{
		return Name.ToString();
	}

	public override TextObject GetName()
	{
		return Name;
	}

	public override void Deserialize(MBObjectManager objectManager, XmlNode node)
	{
		base.Deserialize(objectManager, node);
		Name = new TextObject(node.Attributes["name"].Value);
		Description = new TextObject(node.Attributes["description"].Value);
		float.TryParse(node.Attributes["base_speed"].Value, out var result);
		BaseSpeed = result;
		XmlAttribute xmlAttribute = node.Attributes["has_hold"];
		HasHold = bool.Parse(xmlAttribute.Value);
		XmlAttribute xmlAttribute2 = node.Attributes["value"];
		Value = Convert.ToInt32(xmlAttribute2.Value);
		XmlAttribute xmlAttribute3 = node.Attributes["is_trade_ship"];
		IsTradeShip = bool.Parse(xmlAttribute3.Value);
		XmlAttribute xmlAttribute4 = node.Attributes["can_navigate_shallow_water"];
		CanNavigateShallowWater = bool.Parse(xmlAttribute4.Value);
		XmlAttribute xmlAttribute5 = node.Attributes["can_equip_figurehead"];
		CanEquipFigurehead = bool.Parse(xmlAttribute5.Value);
		SeaWorthiness = Convert.ToInt32(node.Attributes["sea_worthiness"].Value);
		Type = (ShipType)Enum.Parse(typeof(ShipType), node.Attributes["ship_type"].InnerText, ignoreCase: true);
		ProductionBuildWeight = Convert.ToSingle(node.Attributes["production_build_weight"].Value);
		Dictionary<string, ShipSlot> dictionary = new Dictionary<string, ShipSlot>();
		InventoryCapacity = Convert.ToInt32(node.Attributes["inventory_capacity"].Value);
		MapVisualScale = Convert.ToSingle(node.Attributes["map_visual_scale"].Value);
		bool isAttributeValid = false;
		MaxHitPoints = DeserializeScalarAttribute<int>(node, "max_hitpoints", isRequiredAttribute: true, out isAttributeValid);
		MaxFireHitPoints = DeserializeScalarAttribute<int>(node, "max_fire_hitpoints", isRequiredAttribute: true, out isAttributeValid);
		MaxSailHitPoints = DeserializeScalarAttribute<int>(node, "max_sail_hitpoints", isRequiredAttribute: true, out isAttributeValid);
		TotalCrewCapacity = DeserializeScalarAttribute<int>(node, "total_crew_capacity", isRequiredAttribute: true, out isAttributeValid);
		MainDeckCrewCapacity = DeserializeScalarAttribute<int>(node, "main_deck_crew_capacity", isRequiredAttribute: true, out isAttributeValid);
		SkeletalCrewCapacity = DeserializeScalarAttribute<int>(node, "skeletal_crew_capacity", isRequiredAttribute: true, out isAttributeValid);
		foreach (XmlNode childNode in node.ChildNodes)
		{
			if (!(childNode.Name == "AvailableSlots"))
			{
				continue;
			}
			foreach (XmlNode childNode2 in childNode.ChildNodes)
			{
				string value = childNode2.Attributes["id"].Value;
				string value2 = childNode2.Attributes["tag_id"].Value;
				ShipSlot shipSlot = MBObjectManager.Instance.GetObject<ShipSlot>(value);
				if (shipSlot != null)
				{
					dictionary.Add(value2, shipSlot);
				}
				else
				{
					Debug.FailedAssert("ShipSlot does not exist! Ship slot id: " + value + "\nShip slot cannot be added!", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.Core\\NavalCore\\ShipHull.cs", "Deserialize", 136);
				}
			}
		}
		AvailableSlots = dictionary.GetReadOnlyDictionary();
		XmlAttribute xmlAttribute6 = node.Attributes["mission_ship"];
		MissionShipObjectId = xmlAttribute6.Value;
		XmlNode xmlNode2 = node.Attributes["default_group"];
		DefaultFormationGroup = ((xmlNode2 != null) ? FetchDefaultFormationGroup(xmlNode2.InnerText) : 0);
	}

	private int FetchDefaultFormationGroup(string innerText)
	{
		if (Enum.TryParse<FormationClass>(innerText, ignoreCase: true, out var result))
		{
			return (int)result;
		}
		return -1;
	}

	private T DeserializeScalarAttribute<T>(XmlNode node, string attributeName, bool isRequiredAttribute, out bool isAttributeValid)
	{
		XmlAttribute xmlAttribute = node.Attributes[attributeName];
		isAttributeValid = xmlAttribute != null && !string.IsNullOrEmpty(xmlAttribute.InnerText);
		if (isAttributeValid)
		{
			return (T)Convert.ChangeType(xmlAttribute.Value, typeof(T));
		}
		return default(T);
	}
}
