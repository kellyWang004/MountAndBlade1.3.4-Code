using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using StoryMode.StoryModeObjects;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Party.PartyComponents;
using TaleWorlds.CampaignSystem.SceneInformationPopupTypes;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ModuleManager;
using TaleWorlds.MountAndBlade;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Resolvers;

namespace StoryMode.Quests.ThirdPhase;

public class DefeatTheConspiracyQuestBehavior : CampaignBehaviorBase
{
	internal class OppositionData
	{
		[SaveableField(10)]
		public float InitialWarScore;

		[SaveableField(20)]
		public float ReinforcedWarScore;

		[SaveableField(30)]
		public JournalLog QuestLog;

		[SaveableField(40)]
		public CampaignTime LastPeaceOfferDate = CampaignTime.Zero;

		internal static void AutoGeneratedStaticCollectObjectsOppositionData(object o, List<object> collectedObjects)
		{
			((OppositionData)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			//IL_000d: Unknown result type (might be due to invalid IL or missing references)
			collectedObjects.Add(QuestLog);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime((object)LastPeaceOfferDate, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueInitialWarScore(object o)
		{
			return ((OppositionData)o).InitialWarScore;
		}

		internal static object AutoGeneratedGetMemberValueReinforcedWarScore(object o)
		{
			return ((OppositionData)o).ReinforcedWarScore;
		}

		internal static object AutoGeneratedGetMemberValueQuestLog(object o)
		{
			return ((OppositionData)o).QuestLog;
		}

		internal static object AutoGeneratedGetMemberValueLastPeaceOfferDate(object o)
		{
			//IL_0006: Unknown result type (might be due to invalid IL or missing references)
			return ((OppositionData)o).LastPeaceOfferDate;
		}
	}

	public class DefeatTheConspiracyQuestBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public DefeatTheConspiracyQuestBehaviorTypeDefiner()
			: base(16000)
		{
		}

		protected override void DefineClassTypes()
		{
			((SaveableTypeDefiner)this).AddClassDefinition(typeof(OppositionData), 1, (IObjectResolver)null);
			((SaveableTypeDefiner)this).AddClassDefinition(typeof(DefeatTheConspiracyQuest), 2, (IObjectResolver)null);
		}
	}

	public class DefeatTheConspiracyQuest : StoryModeQuestBase
	{
		private const int ProgressTrackerRange = 100;

		[SaveableField(100)]
		private Kingdom _oppositionKingdom;

		[SaveableField(110)]
		private OppositionData _oppositionData;

		public override TextObject Title
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_0023: Expected O, but got Unknown
				TextObject val = new TextObject("{=Dfmg8stq}Eliminate {FACTION}", (Dictionary<string, object>)null);
				val.SetTextVariable("FACTION", _oppositionKingdom.Name);
				return val;
			}
		}

		private TextObject _questCanceledLogText => new TextObject("{=tVlZTOst}You have chosen a different path.", (Dictionary<string, object>)null);

		private TextObject _defeatOpposingKingdomsQuestLogText => new TextObject("{=ib2TKPUa}The ruler of the {FACTION} is leading the alliance against you. Defeat their armies or force them to make peace by capturing their settlements and destroying their parties to achieve victory.", (Dictionary<string, object>)null);

		private TextObject _defeatOpposingKingdomsProgressLogText => new TextObject("{=3Io5vmOk}War Progress with the {FACTION}", (Dictionary<string, object>)null);

		private TextObject _imperialKingdomDefeatedPopUpTitleText => new TextObject("{=XWL3XcIq}{FACTION} Defeated", (Dictionary<string, object>)null);

		private TextObject _imperialKingdomDefeatedPopUpDescriptionText => new TextObject("{=4SnDe0rA}The clans of the {FACTION} have defected to surrounding kingdoms as their leader has given up all hopes of restoring the Empire.", (Dictionary<string, object>)null);

		private TextObject _imperialKingdomDefeatedQuestLogText => new TextObject("{=OwcgxRXB}Weakened by the war, the {FACTION} has collapsed and its clans have defected to surrounding kingdoms.", (Dictionary<string, object>)null);

		private TextObject _antiImperialKingdomDefeatedPopUpTitleText => new TextObject("{=L3Qb6lbp}Peace Offer from the {FACTION}", (Dictionary<string, object>)null);

		private TextObject _antiImperialKingdomDefeatedPopUpKingDescriptionText => new TextObject("{=E87miqTI}Exhausted from the war, the clans of the {FACTION} offer to make peace with the {PLAYER_SUPPORTED_FACTION}.", (Dictionary<string, object>)null);

		private TextObject _antiImperialKingdomDefeatedPopUpSubjectDescriptionText => new TextObject("{=hGPdLssq}The ruler of the {PLAYER_SUPPORTED_FACTION} has accepted the peace offered by the war-ravaged {FACTION}.", (Dictionary<string, object>)null);

		private TextObject _antiImperialKingdomDefeatedQuestLogText => new TextObject("{=weS3DJKA}Weakened by war, the ruler of the {FACTION} offers to make peace with {PLAYER_FACTION}.", (Dictionary<string, object>)null);

		private TextObject _playerSupportedKingdomDestroyedLogText
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_002c: Expected O, but got Unknown
				TextObject val = new TextObject("{=eH8z6Fws}Despite its Dragon Banner, the {PLAYER_SUPPORTED_KINGDOM} has been destroyed!", (Dictionary<string, object>)null);
				val.SetTextVariable("PLAYER_SUPPORTED_KINGDOM", StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom.EncyclopediaLinkWithName);
				return val;
			}
		}

		public DefeatTheConspiracyQuest(string questId, Kingdom oppositionKingdom)
			: base(questId, StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine ? StoryModeHeroes.ImperialMentor : StoryModeHeroes.AntiImperialMentor, CampaignTime.Never)
		{
			//IL_001f: Unknown result type (might be due to invalid IL or missing references)
			_oppositionKingdom = oppositionKingdom;
			((QuestBase)this).SetDialogs();
			((QuestBase)this).InitializeQuestOnCreation();
		}

		protected override void SetDialogs()
		{
		}

		protected override void InitializeQuestOnGameLoad()
		{
			((QuestBase)this).SetDialogs();
		}

		protected override void HourlyTick()
		{
			UpdateWarProgressWithKingdom();
		}

		private void UpdateWarProgressWithKingdom()
		{
			//IL_00b0: Unknown result type (might be due to invalid IL or missing references)
			//IL_00b5: Unknown result type (might be due to invalid IL or missing references)
			float num = CalculateWarScoreForKingdom(_oppositionKingdom);
			float reinforcedWarScore = _oppositionData.ReinforcedWarScore;
			float num2 = _oppositionData.InitialWarScore / 2f;
			int num3 = (int)MathF.Clamp((reinforcedWarScore - num) / (reinforcedWarScore - num2) * 100f, -100f, 100f);
			_oppositionData.QuestLog.UpdateCurrentProgress(num3);
			if (MobileParty.MainParty.MapEvent == null && MobileParty.MainParty.SiegeEvent == null && !Hero.MainHero.IsPrisoner && num <= _oppositionData.InitialWarScore / 2f && ((CampaignTime)(ref _oppositionData.LastPeaceOfferDate)).ElapsedDaysUntilNow >= (float)CampaignTime.DaysInWeek)
			{
				_oppositionData.LastPeaceOfferDate = CampaignTime.Now;
				InitializeKingdomDefeatedPopUp(_oppositionKingdom);
			}
		}

		private void InitializeKingdomDefeatedPopUp(Kingdom kingdom)
		{
			//IL_008c: Unknown result type (might be due to invalid IL or missing references)
			//IL_0093: Expected O, but got Unknown
			//IL_00c7: Unknown result type (might be due to invalid IL or missing references)
			//IL_00d3: Expected O, but got Unknown
			//IL_01d0: Unknown result type (might be due to invalid IL or missing references)
			//IL_01d7: Expected O, but got Unknown
			//IL_020b: Unknown result type (might be due to invalid IL or missing references)
			//IL_0217: Expected O, but got Unknown
			//IL_0138: Unknown result type (might be due to invalid IL or missing references)
			//IL_013f: Expected O, but got Unknown
			//IL_0145: Unknown result type (might be due to invalid IL or missing references)
			//IL_014c: Expected O, but got Unknown
			//IL_018d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0199: Expected O, but got Unknown
			Kingdom playerSupportedKingdom = StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom;
			TextObject val = null;
			TextObject val2 = null;
			if (StoryModeData.IsKingdomImperial(kingdom))
			{
				val = _imperialKingdomDefeatedPopUpTitleText;
				val.SetTextVariable("FACTION", kingdom.Name);
				val2 = _imperialKingdomDefeatedPopUpDescriptionText;
				val2.SetTextVariable("FACTION", kingdom.Name);
				val2.SetTextVariable("PLAYER_SUPPORTED_FACTION", playerSupportedKingdom.Name);
				TextObject val3 = new TextObject("{=DM6luo3c}Continue", (Dictionary<string, object>)null);
				InformationManager.ShowInquiry(new InquiryData(((object)val).ToString(), ((object)val2).ToString(), true, false, ((object)val3).ToString(), "", (Action)delegate
				{
					OnKingdomDefeated(kingdom);
				}, (Action)null, "", 0f, (Action)null, (Func<ValueTuple<bool, string>>)null, (Func<ValueTuple<bool, string>>)null), true, false);
				return;
			}
			val = _antiImperialKingdomDefeatedPopUpTitleText;
			val.SetTextVariable("FACTION", kingdom.Name);
			if (playerSupportedKingdom.Leader == Hero.MainHero)
			{
				val2 = _antiImperialKingdomDefeatedPopUpKingDescriptionText;
				val2.SetTextVariable("FACTION", kingdom.Name);
				val2.SetTextVariable("PLAYER_SUPPORTED_FACTION", playerSupportedKingdom.Name);
				TextObject val4 = new TextObject("{=Y94H6XnK}Accept", (Dictionary<string, object>)null);
				TextObject val5 = new TextObject("{=cOgmdp9e}Decline", (Dictionary<string, object>)null);
				InformationManager.ShowInquiry(new InquiryData(((object)val).ToString(), ((object)val2).ToString(), true, true, ((object)val4).ToString(), ((object)val5).ToString(), (Action)delegate
				{
					OnKingdomDefeated(kingdom);
				}, (Action)delegate
				{
					OnKingdomDefeated(kingdom, makePeace: false);
				}, "", 0f, (Action)null, (Func<ValueTuple<bool, string>>)null, (Func<ValueTuple<bool, string>>)null), true, false);
			}
			else
			{
				val2 = _antiImperialKingdomDefeatedPopUpSubjectDescriptionText;
				val2.SetTextVariable("FACTION", kingdom.Name);
				val2.SetTextVariable("PLAYER_SUPPORTED_FACTION", playerSupportedKingdom.Name);
				TextObject val6 = new TextObject("{=DM6luo3c}Continue", (Dictionary<string, object>)null);
				InformationManager.ShowInquiry(new InquiryData(((object)val).ToString(), ((object)val2).ToString(), true, false, ((object)val6).ToString(), "", (Action)delegate
				{
					OnKingdomDefeated(kingdom);
				}, (Action)null, "", 0f, (Action)null, (Func<ValueTuple<bool, string>>)null, (Func<ValueTuple<bool, string>>)null), true, false);
			}
		}

		private void OnKingdomDefeated(Kingdom kingdom, bool makePeace = true)
		{
			if (_oppositionKingdom != kingdom)
			{
				return;
			}
			Kingdom playerSupportedKingdom = StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom;
			if (StoryModeData.IsKingdomImperial(kingdom))
			{
				StoryModeManager.Current.MainStoryLine.ThirdPhase.RemoveOppositionKingdom(kingdom);
				((QuestBase)this).RemoveLog(_oppositionData.QuestLog);
				TextObject imperialKingdomDefeatedQuestLogText = _imperialKingdomDefeatedQuestLogText;
				imperialKingdomDefeatedQuestLogText.SetTextVariable("FACTION", kingdom.EncyclopediaLinkWithName);
				((QuestBase)this).AddLog(imperialKingdomDefeatedQuestLogText, false);
				Kingdom val = null;
				if (!Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)StoryModeManager.Current.MainStoryLine.ThirdPhase.OppositionKingdoms))
				{
					val = ((IEnumerable<Kingdom>)StoryModeManager.Current.MainStoryLine.ThirdPhase.OppositionKingdoms).OrderBy((Kingdom t) => Campaign.Current.Models.MapDistanceModel.GetDistance(kingdom.FactionMidSettlement, t.FactionMidSettlement, false, false, (NavigationType)1)).FirstOrDefault();
				}
				else
				{
					List<Kingdom> list = ((IEnumerable<Kingdom>)Kingdom.All).Where((Kingdom t) => !StoryModeData.IsKingdomImperial(t) && !t.IsEliminated && t != playerSupportedKingdom).ToList();
					if (Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)list))
					{
						val = playerSupportedKingdom;
					}
					else
					{
						val = list.OrderBy((Kingdom t) => Campaign.Current.Models.MapDistanceModel.GetDistance(kingdom.FactionMidSettlement, t.FactionMidSettlement, false, false, (NavigationType)1)).FirstOrDefault();
						bool flag = false;
						foreach (Settlement item in new List<Settlement>((IEnumerable<Settlement>)kingdom.Settlements))
						{
							if (item.SiegeEvent != null)
							{
								if (item.SiegeEvent.IsPlayerSiegeEvent && !flag)
								{
									flag = true;
								}
								item.SiegeEvent.FinalizeSiegeEvent();
							}
							ChangeOwnerOfSettlementAction.ApplyByLeaveFaction(playerSupportedKingdom.Leader, item);
						}
						if (flag)
						{
							GameMenu.ActivateGameMenu("siege_ended_by_last_conspiracy_kingdom_defeat");
						}
					}
				}
				if (val != null)
				{
					DefectClansOfKingdomToKingdom(kingdom, val);
				}
				else
				{
					Debug.FailedAssert("Kingdom to defect can't be found", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\StoryMode\\Quests\\ThirdPhase\\DefeatTheConspiracyQuestBehavior.cs", "OnKingdomDefeated", 396);
				}
			}
			else
			{
				StoryModeManager.Current.MainStoryLine.ThirdPhase.RemoveOppositionKingdom(kingdom);
				((QuestBase)this).RemoveLog(_oppositionData.QuestLog);
				TextObject antiImperialKingdomDefeatedQuestLogText = _antiImperialKingdomDefeatedQuestLogText;
				antiImperialKingdomDefeatedQuestLogText.SetTextVariable("FACTION", kingdom.EncyclopediaLinkWithName);
				antiImperialKingdomDefeatedQuestLogText.SetTextVariable("PLAYER_FACTION", playerSupportedKingdom.EncyclopediaLinkWithName);
				((QuestBase)this).AddLog(antiImperialKingdomDefeatedQuestLogText, false);
				if (makePeace)
				{
					MakePeaceAction.Apply((IFaction)(object)playerSupportedKingdom, (IFaction)(object)kingdom);
				}
				if (Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)StoryModeManager.Current.MainStoryLine.ThirdPhase.OppositionKingdoms))
				{
					Kingdom val2 = playerSupportedKingdom;
					foreach (Kingdom item2 in ((IEnumerable<Kingdom>)Kingdom.All).Where((Kingdom t) => !t.IsEliminated && StoryModeData.IsKingdomImperial(t)))
					{
						if (item2 != val2)
						{
							DefectClansOfKingdomToKingdom(item2, val2);
						}
					}
				}
			}
			((QuestBase)this).CompleteQuestWithSuccess();
		}

		private void DefectClansOfKingdomToKingdom(Kingdom defectorKingdom, Kingdom targetKingdom)
		{
			//IL_0051: Unknown result type (might be due to invalid IL or missing references)
			//IL_0057: Unknown result type (might be due to invalid IL or missing references)
			//IL_003a: Unknown result type (might be due to invalid IL or missing references)
			foreach (Clan item in new List<Clan>((IEnumerable<Clan>)defectorKingdom.Clans))
			{
				if (item == Clan.PlayerClan)
				{
					ChangeKingdomAction.ApplyByLeaveKingdom(Clan.PlayerClan, true);
				}
				else if (item.IsUnderMercenaryService)
				{
					ChangeKingdomAction.ApplyByJoinFactionAsMercenary(item, targetKingdom, CampaignTime.Zero, item.MercenaryAwardMultiplier, false);
				}
				else
				{
					ChangeKingdomAction.ApplyByJoinToKingdom(item, targetKingdom, default(CampaignTime), false);
				}
			}
			DestroyKingdomAction.Apply(defectorKingdom);
		}

		private void OnKingdomDestroyed(Kingdom kingdom)
		{
			//IL_002d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0033: Expected O, but got Unknown
			//IL_004a: Unknown result type (might be due to invalid IL or missing references)
			//IL_0050: Expected O, but got Unknown
			if (StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom == kingdom)
			{
				((QuestBase)this).AddLog(_playerSupportedKingdomDestroyedLogText, false);
				((QuestBase)this).CompleteQuestWithFail((TextObject)null);
				TextObject val = new TextObject("{=atnUtXdO}The {KINGDOM_NAME} has been defeated. Your quest to restore the Empire has failed.", (Dictionary<string, object>)null);
				if (!StoryModeManager.Current.MainStoryLine.IsOnAntiImperialQuestLine)
				{
					val = new TextObject("{=r48aEAbq}The {KINGDOM_NAME} has been defeated. Your quest to destroy the Empire has failed.", (Dictionary<string, object>)null);
				}
				val.SetTextVariable("KINGDOM_NAME", StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom.Name);
				MBInformationManager.AddQuickInformation(val, 0, (BasicCharacterObject)null, (Equipment)null, "");
			}
		}

		private float CalculateWarScoreForKingdom(Kingdom kingdom)
		{
			float num = 0f;
			foreach (Settlement item in (List<Settlement>)(object)kingdom.Settlements)
			{
				num += GetWarScoreOfSettlement(item);
			}
			return num + kingdom.CurrentTotalStrength;
		}

		private float GetWarScoreOfSettlement(Settlement settlement)
		{
			float result = 0f;
			if (settlement.IsTown)
			{
				result = 3000f;
			}
			else if (settlement.IsCastle)
			{
				result = 1000f;
			}
			return result;
		}

		protected override void RegisterEvents()
		{
			CampaignEvents.KingdomDestroyedEvent.AddNonSerializedListener((object)this, (Action<Kingdom>)OnKingdomDestroyed);
			CampaignEvents.OnQuestCompletedEvent.AddNonSerializedListener((object)this, (Action<QuestBase, QuestCompleteDetails>)OnCampaignQuestCompleted);
			CampaignEvents.OnSettlementOwnerChangedEvent.AddNonSerializedListener((object)this, (Action<Settlement, bool, Hero, Hero, Hero, ChangeOwnerOfSettlementDetail>)SettlementOwnerChanged);
			CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener((object)this, (Action<Clan, Kingdom, Kingdom, ChangeKingdomActionDetail, bool>)OnClanChangedKingdom);
		}

		private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomActionDetail detail, bool showNotification = true)
		{
			if (clan == Clan.PlayerClan && oldKingdom == StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom)
			{
				((QuestBase)this).CompleteQuestWithCancel(_questCanceledLogText);
				StoryModeManager.Current.MainStoryLine.CancelSecondAndThirdPhase();
			}
		}

		private void OnCampaignQuestCompleted(QuestBase completedQuest, QuestCompleteDetails detail)
		{
			//IL_0021: Unknown result type (might be due to invalid IL or missing references)
			if ((object)completedQuest != this && completedQuest is DefeatTheConspiracyQuest)
			{
				UpdateWarProgressWithKingdom();
				StoryModeManager.Current.MainStoryLine.ThirdPhase.CompleteThirdPhase(detail);
			}
		}

		private void SettlementOwnerChanged(Settlement settlement, bool openToClaim, Hero newOwner, Hero oldOwner, Hero capturerHero, ChangeOwnerOfSettlementDetail detail)
		{
			if (((newOwner != null && (object)newOwner.MapFaction == _oppositionKingdom) || (oldOwner != null && (object)oldOwner.MapFaction == _oppositionKingdom)) && GetWarScoreOfSettlement(settlement) > 0f)
			{
				UpdateWarProgressWithKingdom();
			}
		}

		protected override void OnStartQuest()
		{
			OppositionData oppositionData = new OppositionData();
			oppositionData.InitialWarScore = CalculateWarScoreForKingdom(_oppositionKingdom);
			oppositionData.ReinforcedWarScore = 0f;
			TextObject defeatOpposingKingdomsQuestLogText = _defeatOpposingKingdomsQuestLogText;
			TextObject defeatOpposingKingdomsProgressLogText = _defeatOpposingKingdomsProgressLogText;
			defeatOpposingKingdomsQuestLogText.SetTextVariable("FACTION", _oppositionKingdom.EncyclopediaLinkWithName);
			defeatOpposingKingdomsProgressLogText.SetTextVariable("FACTION", _oppositionKingdom.EncyclopediaLinkWithName);
			oppositionData.QuestLog = ((QuestBase)this).AddTwoWayContinuousLog(defeatOpposingKingdomsQuestLogText, defeatOpposingKingdomsProgressLogText, 0, 100, false);
			_oppositionData = oppositionData;
		}

		public void CalculateReinforcedWarScore()
		{
			_oppositionData.ReinforcedWarScore = CalculateWarScoreForKingdom(_oppositionKingdom);
		}

		internal static void AutoGeneratedStaticCollectObjectsDefeatTheConspiracyQuest(object o, List<object> collectedObjects)
		{
			((MBObjectBase)(DefeatTheConspiracyQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			((QuestBase)this).AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_oppositionKingdom);
			collectedObjects.Add(_oppositionData);
		}

		internal static object AutoGeneratedGetMemberValue_oppositionKingdom(object o)
		{
			return ((DefeatTheConspiracyQuest)o)._oppositionKingdom;
		}

		internal static object AutoGeneratedGetMemberValue_oppositionData(object o)
		{
			return ((DefeatTheConspiracyQuest)o)._oppositionData;
		}
	}

	private const int TroopCountPerNewLord = 200;

	private bool _hasBeenFinalized;

	private List<MobileParty> _partiesCreatedForQuest = new List<MobileParty>();

	public const int TroopLimitPerNewClanParty = 600;

	private TextObject _empireUnitedText => new TextObject("{=zTYd6Qai}The Empire has been united under the {FACTION}!", (Dictionary<string, object>)null);

	private TextObject _empireDefeatedText => new TextObject("{=rCX81DDR}The Empire has been destroyed!", (Dictionary<string, object>)null);

	public bool IsMobilePartyCreatedForQuest(MobileParty mobileParty)
	{
		return _partiesCreatedForQuest.Contains(mobileParty);
	}

	public override void RegisterEvents()
	{
		StoryModeEvents.OnConspiracyActivatedEvent.AddNonSerializedListener((object)this, (Action)OnConspiracyActivated);
		CampaignEvents.HourlyTickEvent.AddNonSerializedListener((object)this, (Action)HourlyTick);
		CampaignEvents.MobilePartyDestroyed.AddNonSerializedListener((object)this, (Action<MobileParty, PartyBase>)OnMobilePartyDestroyed);
	}

	private void OnMobilePartyDestroyed(MobileParty mobileParty, PartyBase destroyerParty)
	{
		if (_partiesCreatedForQuest.Contains(mobileParty))
		{
			_partiesCreatedForQuest.Remove(mobileParty);
		}
	}

	private void OnConspiracyActivated()
	{
		InitializeFinalPhase();
	}

	private void HourlyTick()
	{
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0095: Unknown result type (might be due to invalid IL or missing references)
		//IL_009b: Expected O, but got Unknown
		//IL_00a0: Expected O, but got Unknown
		//IL_00cd: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d9: Expected O, but got Unknown
		if (StoryModeManager.Current.MainStoryLine.ThirdPhase == null || !Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)StoryModeManager.Current.MainStoryLine.ThirdPhase.OppositionKingdoms) || _hasBeenFinalized)
		{
			return;
		}
		_hasBeenFinalized = true;
		TextObject val = new TextObject("{=R4Gqskgq}Victory", (Dictionary<string, object>)null);
		TextObject val2 = (StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine ? _empireUnitedText : _empireDefeatedText);
		val2.SetTextVariable("FACTION", StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom.Name);
		TextObject val3 = new TextObject("{=DM6luo3c}Continue", (Dictionary<string, object>)null);
		InformationManager.ShowInquiry(new InquiryData(((object)val).ToString(), ((object)val2).ToString(), true, false, ((object)val3).ToString(), "", (Action)delegate
		{
			string videoFile;
			string audioFile;
			string subtitleFile;
			if (StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine)
			{
				videoFile = "imperial_outro";
				audioFile = "imperial_outro";
				subtitleFile = "imperial_outro";
			}
			else
			{
				videoFile = "anti_imperial_outro";
				audioFile = "anti_imperial_outro";
				subtitleFile = "anti_imperial_outro";
			}
			Campaign.Current.TimeControlMode = (CampaignTimeControlMode)0;
			PlayOutroCinematic(videoFile, audioFile, subtitleFile, ShowGameStatistics);
		}, (Action)null, "", 0f, (Action)null, (Func<ValueTuple<bool, string>>)null, (Func<ValueTuple<bool, string>>)null), true, false);
	}

	protected void InitializeFinalPhase()
	{
		//IL_0a8c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0a93: Expected O, but got Unknown
		//IL_0a81: Unknown result type (might be due to invalid IL or missing references)
		//IL_0a88: Expected O, but got Unknown
		//IL_0682: Unknown result type (might be due to invalid IL or missing references)
		//IL_0688: Unknown result type (might be due to invalid IL or missing references)
		//IL_071a: Unknown result type (might be due to invalid IL or missing references)
		//IL_071f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0721: Unknown result type (might be due to invalid IL or missing references)
		//IL_074b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0742: Unknown result type (might be due to invalid IL or missing references)
		//IL_0747: Unknown result type (might be due to invalid IL or missing references)
		bool isOnImperialQuestLine = StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine;
		List<Kingdom> list = ((IEnumerable<Kingdom>)Kingdom.All).Where((Kingdom t) => StoryModeData.IsKingdomImperial(t) && t != StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom && !t.IsEliminated).ToList();
		List<Kingdom> list2 = ((IEnumerable<Kingdom>)Kingdom.All).Where((Kingdom t) => !StoryModeData.IsKingdomImperial(t) && t != StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom && !t.IsEliminated).ToList();
		List<DefeatTheConspiracyQuest> list3 = new List<DefeatTheConspiracyQuest>();
		List<Kingdom> list4;
		List<Kingdom> list5;
		if (isOnImperialQuestLine)
		{
			if (Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)list2))
			{
				Kingdom randomElementWithPredicate = Extensions.GetRandomElementWithPredicate<Kingdom>(Kingdom.All, (Func<Kingdom, bool>)((Kingdom t) => !StoryModeData.IsKingdomImperial(t)));
				randomElementWithPredicate.ReactivateKingdom();
				list2.Add(randomElementWithPredicate);
			}
			list4 = list2.OrderByDescending((Kingdom t) => t.CurrentTotalStrength).Take(3).ToList();
			list5 = new List<Kingdom> { StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom };
			for (int num = 0; num < list2.Count; num++)
			{
				for (int num2 = num + 1; num2 < list2.Count; num2++)
				{
					if (!DiplomacyHelper.IsSameFactionAndNotEliminated((IFaction)(object)list2[num], (IFaction)(object)list2[num2]))
					{
						MakePeaceAction.Apply((IFaction)(object)list2[num], (IFaction)(object)list2[num2]);
					}
				}
			}
		}
		else
		{
			if (Extensions.IsEmpty<Kingdom>((IEnumerable<Kingdom>)list))
			{
				Kingdom randomElementWithPredicate2 = Extensions.GetRandomElementWithPredicate<Kingdom>(Kingdom.All, (Func<Kingdom, bool>)StoryModeData.IsKingdomImperial);
				randomElementWithPredicate2.ReactivateKingdom();
				list.Add(randomElementWithPredicate2);
			}
			list4 = list.ToList();
			list5 = new List<Kingdom> { StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom };
			for (int num3 = 0; num3 < list.Count; num3++)
			{
				for (int num4 = num3 + 1; num4 < list.Count; num4++)
				{
					if (!DiplomacyHelper.IsSameFactionAndNotEliminated((IFaction)(object)list[num3], (IFaction)(object)list[num4]))
					{
						MakePeaceAction.Apply((IFaction)(object)list[num3], (IFaction)(object)list[num4]);
					}
				}
			}
		}
		foreach (Kingdom item in list5)
		{
			StoryModeManager.Current.MainStoryLine.ThirdPhase.AddAllyKingdom(item);
		}
		int num5 = 0;
		foreach (Kingdom item2 in list4)
		{
			StoryModeManager.Current.MainStoryLine.ThirdPhase.AddOppositionKingdom(item2);
			DefeatTheConspiracyQuest defeatTheConspiracyQuest = new DefeatTheConspiracyQuest("defeat_the_conspiracy_quest_" + num5, item2);
			num5++;
			((QuestBase)defeatTheConspiracyQuest).StartQuest();
			list3.Add(defeatTheConspiracyQuest);
		}
		Dictionary<Kingdom, int> dictionary = new Dictionary<Kingdom, int>();
		float conspiracyStrength = StoryModeManager.Current.MainStoryLine.SecondPhase.ConspiracyStrength;
		List<float> list6 = new List<float> { 0.5f, 0.3f, 0.2f };
		int num6 = 0;
		for (int num7 = 0; num7 < list6.Count; num7++)
		{
			if (num6 > list4.Count - 1)
			{
				num6 = 0;
			}
			Kingdom key = list4[num6];
			if (!dictionary.ContainsKey(key))
			{
				dictionary.Add(key, 0);
			}
			dictionary[key] += (int)(conspiracyStrength * list6[num7]);
			num6++;
		}
		foreach (KeyValuePair<Kingdom, int> item3 in dictionary)
		{
			Kingdom kingdom = item3.Key;
			MBList<MobileParty> val = new MBList<MobileParty>();
			foreach (WarPartyComponent item4 in (List<WarPartyComponent>)(object)kingdom.WarPartyComponents)
			{
				if (((PartyComponent)item4).Leader != null)
				{
					((List<MobileParty>)(object)val).Add(((PartyComponent)item4).MobileParty);
				}
			}
			MBList<CharacterObject> val2 = Extensions.ToMBList<CharacterObject>(CharacterHelper.GetTroopTree(kingdom.Culture.BasicTroop, 3f, 6f));
			int num8 = item3.Value / 2;
			int num9 = num8 / 200;
			List<Hero> list7 = new List<Hero>();
			Clan val3 = null;
			for (int num10 = 0; num10 < num9; num10++)
			{
				bool flag = false;
				if (val3 == null || ((List<Hero>)(object)val3.AliveLords).Count >= val3.CommanderLimit)
				{
					TextObject clanName = NameGenerator.Current.GenerateClanName(kingdom.Culture, Extensions.GetRandomElementWithPredicate<Settlement>(Settlement.All, (Func<Settlement, bool>)((Settlement t) => t.Culture == kingdom.Culture && t.IsVillage)));
					val3 = Clan.CreateClan("main_storyline_clan_" + ((object)clanName).ToString() + "_" + ((IEnumerable<Clan>)Clan.All).Count((Clan t) => t.Name == clanName));
					val3.ChangeClanName(clanName, clanName);
					val3.Culture = kingdom.Culture;
					val3.Banner = Banner.CreateRandomClanBanner(-1);
					val3.SetInitialHomeSettlement(kingdom.InitialHomeSettlement);
					val3.IsNoble = true;
					flag = true;
					val3.CalculateMidSettlement();
				}
				MBList<Settlement> val4 = Extensions.ToMBList<Settlement>(((IEnumerable<Settlement>)kingdom.Settlements).Where((Settlement t) => !t.IsUnderSiege && !t.IsUnderRaid));
				Settlement val5 = null;
				if (!Extensions.IsEmpty<Settlement>((IEnumerable<Settlement>)val4))
				{
					val5 = Extensions.GetRandomElementWithPredicate<Settlement>(val4, (Func<Settlement, bool>)((Settlement t) => t.IsTown));
				}
				if (val5 == null)
				{
					val5 = kingdom.InitialHomeSettlement;
				}
				Hero val6 = HeroCreator.CreateSpecialHero(((((List<MobileParty>)(object)val).Count > 0) ? Extensions.GetRandomElement<MobileParty>(val).LeaderHero : Extensions.GetRandomElementWithPredicate<Hero>(Hero.AllAliveHeroes, (Func<Hero, bool>)((Hero t) => (int)t.Occupation == 3 && t.Culture == kingdom.Culture))).CharacterObject, val5, val3, (Clan)null, -1);
				GiveGoldAction.ApplyBetweenCharacters((Hero)null, val6, 200000, true);
				val6.ChangeState((CharacterStates)1);
				if (val3.Leader == null)
				{
					val3.SetLeader(val6);
				}
				if (val3.Kingdom != kingdom)
				{
					ChangeKingdomAction.ApplyByJoinToKingdom(val3, kingdom, default(CampaignTime), false);
				}
				if (val3.Kingdom.RulingClan == null || val3.Kingdom.RulingClan.IsEliminated)
				{
					ChangeRulingClanAction.Apply(val3.Kingdom, val3);
				}
				MobileParty val7;
				if (val5 != null)
				{
					val6.BornSettlement = val5;
					EnterSettlementAction.ApplyForCharacterOnly(val6, val5);
					val7 = MobilePartyHelper.CreateNewClanMobileParty(val6, val3);
					_partiesCreatedForQuest.Add(val7);
				}
				else
				{
					Clan rulingClan = kingdom.RulingClan;
					CampaignVec2 val8 = (((rulingClan != null) ? rulingClan.FactionMidSettlement : null) ?? kingdom.FactionMidSettlement).GatePosition;
					if (!NavigationHelper.IsPositionValidForNavigationType(val8, (NavigationType)1))
					{
						val8 = Campaign.Current.MapSceneWrapper.GetAccessiblePointNearPosition(ref val8, Campaign.Current.GetAverageDistanceBetweenClosestTwoTownsWithNavigationType((NavigationType)1));
					}
					val7 = MobilePartyHelper.SpawnLordParty(val6, val8, 5f);
					_partiesCreatedForQuest.Add(val7);
					val6.BornSettlement = Extensions.GetRandomElementWithPredicate<Settlement>(Settlement.All, (Func<Settlement, bool>)((Settlement t) => t.IsTown || t.IsVillage));
				}
				val7.MemberRoster.AddToCounts(Extensions.GetRandomElement<CharacterObject>(val2), 200, false, 0, 0, true, -1);
				val7.ItemRoster.AddToCounts(DefaultItems.Grain, 100);
				val7.ItemRoster.AddToCounts(DefaultItems.Meat, 50);
				((PartyComponent)val7.LordPartyComponent).SetWagePaymentLimit(Campaign.Current.Models.PartyWageModel.MaxWagePaymentLimit);
				list7.Add(val6);
				if (flag)
				{
					((CampaignEventReceiver)CampaignEventDispatcher.Instance).OnClanCreated(val3, false);
				}
			}
			if (Extensions.IsEmpty<MobileParty>((IEnumerable<MobileParty>)val))
			{
				((List<MobileParty>)(object)val).AddRange(list7.Select((Hero t) => t.PartyBelongedTo));
			}
			if (Extensions.IsEmpty<MobileParty>((IEnumerable<MobileParty>)val))
			{
				continue;
			}
			int num11 = item3.Value - num8;
			int num12 = num8 - list7.Count * 200;
			int num13 = num11 + num12;
			int num14 = num13 / ((List<MobileParty>)(object)val).Count;
			int num15 = num13 % ((List<MobileParty>)(object)val).Count;
			if (num14 > 0)
			{
				foreach (MobileParty item5 in (List<MobileParty>)(object)val)
				{
					for (int num16 = 0; num16 < num14; num16++)
					{
						item5.MemberRoster.AddToCounts(Extensions.GetRandomElement<CharacterObject>(val2), 1, false, 0, 0, true, -1);
					}
				}
			}
			if (num15 > 0)
			{
				MobileParty randomElement = Extensions.GetRandomElement<MobileParty>(val);
				for (int num17 = 0; num17 < num15; num17++)
				{
					randomElement.MemberRoster.AddToCounts(Extensions.GetRandomElement<CharacterObject>(val2), 1, false, 0, 0, true, -1);
				}
			}
		}
		for (int num18 = 0; num18 < list4.Count; num18++)
		{
			foreach (Clan item6 in (List<Clan>)(object)list4[num18].Clans)
			{
				item6.UpdateCurrentStrength();
			}
			if (!list4[num18].IsAtWarWith((IFaction)(object)StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom))
			{
				ChangeRelationAction.ApplyPlayerRelation(list4[num18].Leader, -10, true, true);
				DeclareWarAction.ApplyByPlayerHostility((IFaction)(object)list4[num18], (IFaction)(object)StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom);
			}
		}
		foreach (DefeatTheConspiracyQuest item7 in list3)
		{
			item7.CalculateReinforcedWarScore();
		}
		Hero leader = list4[Extensions.IndexOfMax<Kingdom>((IReadOnlyList<Kingdom>)list4, (Func<Kingdom, int>)((Kingdom k) => (int)k.CurrentTotalStrength))].Leader;
		SceneNotificationData val9 = (SceneNotificationData)((!StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine) ? ((object)new ProEmpireConspiracyBeginsSceneNotificationItem(leader)) : ((object)new AntiEmpireConspiracyBeginsSceneNotificationItem(leader, ((IEnumerable<Kingdom>)StoryModeManager.Current.MainStoryLine.ThirdPhase.OppositionKingdoms).ToList())));
		MBInformationManager.ShowSceneNotification(val9);
	}

	public override void SyncData(IDataStore dataStore)
	{
		dataStore.SyncData<bool>("_hasBeenFinalized", ref _hasBeenFinalized);
		dataStore.SyncData<List<MobileParty>>("_partiesCreatedForQuest", ref _partiesCreatedForQuest);
	}

	private static void PlayOutroCinematic(string videoFile, string audioFile, string subtitleFile, Action onVideoFinished)
	{
		VideoPlaybackState val = Game.Current.GameStateManager.CreateState<VideoPlaybackState>();
		string text = ModuleHelper.GetModuleFullPath("SandBox") + "Videos/CampaignOutro/";
		string text2 = text + videoFile + ".ivf";
		string text3 = text + audioFile + ".ogg";
		string text4 = text + subtitleFile;
		val.SetStartingParameters(text2, text3, text4, 30f, true);
		val.SetOnVideoFinisedDelegate(onVideoFinished);
		Game.Current.GameStateManager.PushState((GameState)(object)val, 0);
	}

	private void ShowGameStatistics()
	{
		GameOverState val = Game.Current.GameStateManager.CreateState<GameOverState>(new object[1] { (object)(GameOverReason)2 });
		Game.Current.GameStateManager.PopState(0);
		Game.Current.GameStateManager.PushState((GameState)(object)val, 0);
	}
}
