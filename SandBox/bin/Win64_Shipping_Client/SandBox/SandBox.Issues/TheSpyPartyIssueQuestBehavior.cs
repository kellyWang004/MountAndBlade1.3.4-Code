using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using SandBox.Conversation.MissionLogics;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.AgentOrigins;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Issues;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Settlements.Locations;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.MountAndBlade;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Resolvers;

namespace SandBox.Issues;

public class TheSpyPartyIssueQuestBehavior : CampaignBehaviorBase
{
	public class TheSpyPartyIssueQuestTypeDefiner : SaveableTypeDefiner
	{
		public TheSpyPartyIssueQuestTypeDefiner()
			: base(121250)
		{
		}

		protected override void DefineClassTypes()
		{
			((SaveableTypeDefiner)this).AddClassDefinition(typeof(TheSpyPartyIssue), 1, (IObjectResolver)null);
			((SaveableTypeDefiner)this).AddClassDefinition(typeof(TheSpyPartyIssueQuest), 2, (IObjectResolver)null);
		}

		protected override void DefineStructTypes()
		{
			((SaveableTypeDefiner)this).AddStructDefinition(typeof(SuspectNpc), 3, (IObjectResolver)null);
		}
	}

	public struct SuspectNpc
	{
		[SaveableField(10)]
		public readonly CharacterObject CharacterObject;

		[SaveableField(20)]
		public readonly bool HasHair;

		[SaveableField(30)]
		public readonly bool HasBigSword;

		[SaveableField(40)]
		public readonly bool WithoutMarkings;

		[SaveableField(50)]
		public readonly bool HasBeard;

		public SuspectNpc(CharacterObject characterObject, bool hasHair, bool hasBigSword, bool withoutMarkings, bool hasBeard)
		{
			CharacterObject = characterObject;
			HasHair = hasHair;
			HasBigSword = hasBigSword;
			WithoutMarkings = withoutMarkings;
			HasBeard = hasBeard;
		}

		public static void AutoGeneratedStaticCollectObjectsSuspectNpc(object o, List<object> collectedObjects)
		{
			((SuspectNpc)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(CharacterObject);
		}

		internal static object AutoGeneratedGetMemberValueCharacterObject(object o)
		{
			return ((SuspectNpc)o).CharacterObject;
		}

		internal static object AutoGeneratedGetMemberValueHasHair(object o)
		{
			return ((SuspectNpc)o).HasHair;
		}

		internal static object AutoGeneratedGetMemberValueHasBigSword(object o)
		{
			return ((SuspectNpc)o).HasBigSword;
		}

		internal static object AutoGeneratedGetMemberValueWithoutMarkings(object o)
		{
			return ((SuspectNpc)o).WithoutMarkings;
		}

		internal static object AutoGeneratedGetMemberValueHasBeard(object o)
		{
			return ((SuspectNpc)o).HasBeard;
		}
	}

	public class TheSpyPartyIssue : IssueBase
	{
		private const int QuestDurationInDays = 16;

		private const int RequiredSkillValue = 150;

		private const int AlternativeSolutionTroopTierRequirement = 2;

		[SaveableField(10)]
		private readonly Settlement _selectedSettlement;

		public override AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags => (AlternativeSolutionScaleFlag)8;

		protected override int CompanionSkillRewardXP => (int)(600f + 800f * ((IssueBase)this).IssueDifficultyMultiplier);

		public override bool IsThereAlternativeSolution => true;

		public override bool IsThereLordSolution => false;

		public override int AlternativeSolutionBaseNeededMenCount => 1 + MathF.Ceiling(4f * ((IssueBase)this).IssueDifficultyMultiplier);

		protected override int AlternativeSolutionBaseDurationInDaysInternal => 3 + MathF.Ceiling(3f * ((IssueBase)this).IssueDifficultyMultiplier);

		protected override int RewardGold => (int)(500f + 3000f * ((IssueBase)this).IssueDifficultyMultiplier);

		public override TextObject IssueBriefByIssueGiver
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_0023: Expected O, but got Unknown
				TextObject val = new TextObject("{=tFPJySG7}I am hosting a tournament at {SELECTED_SETTLEMENT}. [ib:convo_undecided_open][if:convo_pondering]I am expecting contenders to partake from all over the realm. I have my reasons to believe one of the attending warriors is actually a spy, sent to gather information about its defenses.", (Dictionary<string, object>)null);
				val.SetTextVariable("SELECTED_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return val;
			}
		}

		public override TextObject IssueAcceptByPlayer => new TextObject("{=EYT7b2J5}Any traveler can be asked by an enemy to spy on the places he travels. How can I track this one down?", (Dictionary<string, object>)null);

		public override TextObject IssueQuestSolutionExplanationByIssueGiver
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_0023: Expected O, but got Unknown
				TextObject val = new TextObject("{=2lgkL9db}Of course. I have employed spies myself. But if a tournament [if:convo_pondering][ib:confident3]participant is asking questions about the state of the garrison and the walls, things which would concern no honest traveler - well, between that and the private information I've received, I think we'd have our man. The spy must be hiding inside {SELECTED_SETTLEMENT}. Once you are there start questioning the townsfolk.", (Dictionary<string, object>)null);
				val.SetTextVariable("SELECTED_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return val;
			}
		}

		public override TextObject IssuePlayerResponseAfterAlternativeExplanation => new TextObject("{=2nFBTmao}Is there any other way to solve this other than asking around?", (Dictionary<string, object>)null);

		public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_001e: Expected O, but got Unknown
				TextObject val = new TextObject("{=avVno3H8}Well, you can assign a companion of yours with a knack for this kind of game[if:convo_thinking] and enough muscles to back him up. Judging from what I have heard, a group of {NEEDED_MEN_COUNT} should be enough.", (Dictionary<string, object>)null);
				val.SetTextVariable("NEEDED_MEN_COUNT", ((IssueBase)this).GetTotalAlternativeSolutionNeededMenCount());
				return val;
			}
		}

		public override TextObject IssueQuestSolutionAcceptByPlayer => new TextObject("{=99OsuHGa}I will find the one you are looking for.", (Dictionary<string, object>)null);

		public override TextObject Title => new TextObject("{=SJHtVaNa}The Spy Among Us", (Dictionary<string, object>)null);

		public override TextObject Description
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=C6rbcpbi}{QUEST_GIVER.LINK} wants you to find a spy before he causes any harm...", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((IssueBase)this).IssueOwner.CharacterObject, val, false);
				return val;
			}
		}

		public override TextObject IssueAlternativeSolutionAcceptByPlayer
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_001d: Unknown result type (might be due to invalid IL or missing references)
				//IL_0030: Expected O, but got Unknown
				TextObject val = new TextObject("{=FEcAwSfk}I will assign a companion with {NEEDED_MEN_COUNT} good men for {ALTERNATIVE_SOLUTION_DURATION} days.", (Dictionary<string, object>)null);
				val.SetTextVariable("NEEDED_MEN_COUNT", ((IssueBase)this).GetTotalAlternativeSolutionNeededMenCount());
				val.SetTextVariable("ALTERNATIVE_SOLUTION_DURATION", ((IssueBase)this).GetTotalAlternativeSolutionDurationInDays());
				return val;
			}
		}

		public override TextObject IssueDiscussAlternativeSolution => new TextObject("{=O0Cjam62}I hope your people are careful about how they proceed.[if:convo_focused_happy] It would be a pity if that spy got away.", (Dictionary<string, object>)null);

		public override TextObject IssueAlternativeSolutionResponseByIssueGiver
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=ciXBiMMa}Thank you {PLAYER.NAME}, I hope your people will be successful.[if:convo_focused_happy]", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, val, false);
				return val;
			}
		}

		public override TextObject IssueAlternativeSolutionSuccessLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=YIxpNP4k}You received a message from {ISSUE_GIVER.LINK}. \"Thank you for killing the spy. Please accept these {REWARD_GOLD}{GOLD_ICON} denars with our gratitude.\"", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("ISSUE_GIVER", ((IssueBase)this).IssueOwner.CharacterObject, val, false);
				val.SetTextVariable("REWARD_GOLD", ((IssueBase)this).RewardGold);
				val.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				return val;
			}
		}

		protected override TextObject AlternativeSolutionStartLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=s5qs0bPs}{ISSUE_GIVER.LINK}, the {?ISSUE_GIVER.GENDER}lady{?}lord{\\?} of {QUEST_SETTLEMENT}, has told you about a spy that hides as a tournament attendee. You are asked to expose the spy and take care of him. You asked {COMPANION.LINK} to take {NEEDED_MEN_COUNT} of your best men to go and take care of it. They should report back to you in {ALTERNATIVE_SOLUTION_DURATION} days.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("ISSUE_GIVER", ((IssueBase)this).IssueOwner.CharacterObject, val, false);
				StringHelpers.SetCharacterProperties("COMPANION", ((IssueBase)this).AlternativeSolutionHero.CharacterObject, val, false);
				val.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				val.SetTextVariable("ALTERNATIVE_SOLUTION_DURATION", ((IssueBase)this).GetTotalAlternativeSolutionDurationInDays());
				val.SetTextVariable("NEEDED_MEN_COUNT", base.AlternativeSolutionSentTroops.TotalManCount - 1);
				return val;
			}
		}

		public TheSpyPartyIssue(Hero issueOwner, Settlement selectedSettlement)
			: base(issueOwner, CampaignTime.DaysFromNow(5f))
		{
			//IL_0007: Unknown result type (might be due to invalid IL or missing references)
			_selectedSettlement = selectedSettlement;
		}

		protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
		{
			if (issueEffect == DefaultIssueEffects.SettlementSecurity)
			{
				return -2f;
			}
			if (issueEffect == DefaultIssueEffects.SettlementLoyalty)
			{
				return -0.5f;
			}
			if (issueEffect == DefaultIssueEffects.ClanInfluence)
			{
				return -0.2f;
			}
			return 0f;
		}

		public override (SkillObject, int) GetAlternativeSolutionSkill(Hero hero)
		{
			return ((hero.GetSkillValue(DefaultSkills.Charm) >= hero.GetSkillValue(DefaultSkills.Roguery)) ? DefaultSkills.Charm : DefaultSkills.Roguery, 150);
		}

		public override bool AlternativeSolutionCondition(out TextObject explanation)
		{
			return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, ((IssueBase)this).GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false);
		}

		public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
		{
			return character.Tier >= 2;
		}

		public override bool DoTroopsSatisfyAlternativeSolution(TroopRoster troopRoster, out TextObject explanation)
		{
			return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, ((IssueBase)this).GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false);
		}

		protected override void AlternativeSolutionEndWithSuccessConsequence()
		{
			GainRenownAction.Apply(Hero.MainHero, 1f, false);
			((IssueBase)this).RelationshipChangeWithIssueOwner = 5;
			Town town = _selectedSettlement.Town;
			town.Prosperity += 5f;
		}

		protected override void AlternativeSolutionEndWithFailureConsequence()
		{
			((IssueBase)this).RelationshipChangeWithIssueOwner = -5;
			((IssueBase)this).IssueOwner.AddPower(-5f);
			Town town = _selectedSettlement.Town;
			town.Security -= 10f;
			Town town2 = _selectedSettlement.Town;
			town2.Loyalty -= 10f;
		}

		protected override void OnGameLoad()
		{
		}

		protected override void HourlyTick()
		{
		}

		protected override QuestBase GenerateIssueQuest(string questId)
		{
			//IL_000c: Unknown result type (might be due to invalid IL or missing references)
			return (QuestBase)(object)new TheSpyPartyIssueQuest(questId, ((IssueBase)this).IssueOwner, CampaignTime.DaysFromNow(16f), ((IssueBase)this).RewardGold, _selectedSettlement, ((IssueBase)this).IssueDifficultyMultiplier);
		}

		public override IssueFrequency GetFrequency()
		{
			return (IssueFrequency)2;
		}

		protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
		{
			flag = (PreconditionFlags)0;
			relationHero = null;
			skill = null;
			if (issueGiver.GetRelationWithPlayer() < -10f)
			{
				flag = (PreconditionFlags)((uint)flag | 1u);
				relationHero = issueGiver;
			}
			if (issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				flag = (PreconditionFlags)((uint)flag | 0x40u);
			}
			return (int)flag == 0;
		}

		public override bool IssueStayAliveConditions()
		{
			if (((IssueBase)this).IssueOwner.IsAlive && _selectedSettlement.OwnerClan == ((IssueBase)this).IssueOwner.Clan)
			{
				return ((IssueBase)this).IssueOwner.Clan != Clan.PlayerClan;
			}
			return false;
		}

		protected override void CompleteIssueWithTimedOutConsequences()
		{
		}

		internal static void AutoGeneratedStaticCollectObjectsTheSpyPartyIssue(object o, List<object> collectedObjects)
		{
			((MBObjectBase)(TheSpyPartyIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			((IssueBase)this).AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_selectedSettlement);
		}

		internal static object AutoGeneratedGetMemberValue_selectedSettlement(object o)
		{
			return ((TheSpyPartyIssue)o)._selectedSettlement;
		}
	}

	public class TheSpyPartyIssueQuest : QuestBase
	{
		public const float CustomAgentHealth = 225f;

		[SaveableField(10)]
		private Settlement _selectedSettlement;

		[SaveableField(20)]
		private SuspectNpc _selectedSpy;

		private MBList<SuspectNpc> _suspectList;

		private List<Agent> _alreadySpokenAgents;

		[SaveableField(30)]
		private bool _playerLearnedHasHair;

		[SaveableField(40)]
		private bool _playerLearnedHasNoMarkings;

		[SaveableField(50)]
		private bool _playerLearnedHasBigSword;

		[SaveableField(60)]
		private bool _playerLearnedHasBeard;

		private bool _playerWonTheFight;

		private bool _addSpyNpcsToSettlement;

		private bool _startFightWithSpy;

		private bool _checkForBattleResult;

		private bool _playerManagedToFindSpy;

		private float _giveClueChange;

		private CharacterObject _duelCharacter;

		[SaveableField(70)]
		private float _issueDifficultyMultiplier;

		[SaveableField(80)]
		private string _currentDifficultySuffix;

		public override bool IsRemainingTimeHidden => false;

		public override TextObject Title => new TextObject("{=SJHtVaNa}The Spy Among Us", (Dictionary<string, object>)null);

		private TextObject QuestStartedLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=94WRYoQp}{?QUEST_GIVER.GENDER}Lady{?}Lord{\\?} {QUEST_GIVER.LINK} from {QUEST_SETTLEMENT}, has told you about rumors of a spy disguised amongst the tournament attendees. You agreed to take care of the situation by yourself. {QUEST_GIVER.LINK} believes that the spy is posing as a tournament attendee in the city of {QUEST_SETTLEMENT}.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				val.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return val;
			}
		}

		private TextObject QuestSuccessQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=YIxpNP4k}You received a message from {QUEST_GIVER.LINK}. \"Thank you for killing the spy. Please accept these {REWARD_GOLD}{GOLD_ICON} denars with our gratitude.\"", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				val.SetTextVariable("REWARD_GOLD", base.RewardGold);
				val.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				return val;
			}
		}

		private TextObject QuestFailedKilledAnotherQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=tTKpOFRK}You won the duel but your opponent was innocent. {QUEST_GIVER.LINK} is disappointed.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				return val;
			}
		}

		private TextObject PlayerFoundTheSpyButLostTheFightQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=hJ1SFkmq}You managed to find the spy but lost the duel. {QUEST_GIVER.LINK} is disappointed.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				return val;
			}
		}

		private TextObject PlayerCouldNotFoundTheSpyAndLostTheFightQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=dOdp1aKA}You couldn't find the spy and dueled the wrong warrior. {QUEST_GIVER.LINK} is disappointed.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				return val;
			}
		}

		private TextObject TimedOutQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=0dlDkkJV}You have failed to find the spy. {QUEST_GIVER.LINK} is disappointed.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				return val;
			}
		}

		private TextObject QuestGiverLostOwnershipQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=2OmrHVjp}{QUEST_GIVER.LINK} has lost the ownership of {QUEST_SETTLEMENT}. Your contract with {?QUEST_GIVER.GENDER}her{?}him{\\?} has canceled.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				val.SetTextVariable("QUEST_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
				return val;
			}
		}

		private TextObject WarDeclaredQuestLog
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000b: Unknown result type (might be due to invalid IL or missing references)
				//IL_0028: Expected O, but got Unknown
				TextObject val = new TextObject("{=cKz1cyuM}Your clan is now at war with {QUEST_GIVER_SETTLEMENT_FACTION}. Quest is canceled.", (Dictionary<string, object>)null);
				val.SetTextVariable("QUEST_GIVER_SETTLEMENT_FACTION", ((QuestBase)this).QuestGiver.MapFaction.Name);
				return val;
			}
		}

		private TextObject PlayerDeclaredWarQuestLogText
		{
			get
			{
				//IL_0006: Unknown result type (might be due to invalid IL or missing references)
				//IL_000c: Expected O, but got Unknown
				TextObject val = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.", (Dictionary<string, object>)null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
				return val;
			}
		}

		public TheSpyPartyIssueQuest(string questId, Hero questGiver, CampaignTime duration, int rewardGold, Settlement selectedSettlement, float issueDifficultyMultiplier)
			: base(questId, questGiver, duration, rewardGold)
		{
			//IL_0003: Unknown result type (might be due to invalid IL or missing references)
			_selectedSettlement = selectedSettlement;
			_alreadySpokenAgents = new List<Agent>();
			_issueDifficultyMultiplier = issueDifficultyMultiplier;
			_giveClueChange = 0.1f;
			((QuestBase)this).SetDialogs();
			((QuestBase)this).InitializeQuestOnCreation();
			InitializeSuspectNpcs();
			_selectedSpy = Extensions.GetRandomElement<SuspectNpc>(_suspectList);
			if (!((QuestBase)this).IsTracked((ITrackableCampaignObject)(object)_selectedSettlement))
			{
				((QuestBase)this).AddTrackedObject((ITrackableCampaignObject)(object)_selectedSettlement);
			}
		}

		private void InitializeSuspectNpcs()
		{
			_suspectList = new MBList<SuspectNpc>();
			_currentDifficultySuffix = GetDifficultySuffix(_issueDifficultyMultiplier);
			((List<SuspectNpc>)(object)_suspectList).Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + _currentDifficultySuffix), hasHair: false, hasBigSword: true, withoutMarkings: true, hasBeard: true));
			((List<SuspectNpc>)(object)_suspectList).Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: false, withoutMarkings: true, hasBeard: true));
			((List<SuspectNpc>)(object)_suspectList).Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: true, withoutMarkings: false, hasBeard: true));
			((List<SuspectNpc>)(object)_suspectList).Add(new SuspectNpc(MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + _currentDifficultySuffix), hasHair: true, hasBigSword: true, withoutMarkings: true, hasBeard: false));
		}

		protected override void InitializeQuestOnGameLoad()
		{
			_alreadySpokenAgents = new List<Agent>();
			_giveClueChange = 0.1f;
			InitializeSuspectNpcs();
			((QuestBase)this).SetDialogs();
			if (Settlement.CurrentSettlement != null && Settlement.CurrentSettlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		protected override void HourlyTick()
		{
		}

		protected override void SetDialogs()
		{
			//IL_0006: Unknown result type (might be due to invalid IL or missing references)
			//IL_000c: Expected O, but got Unknown
			//IL_0029: Unknown result type (might be due to invalid IL or missing references)
			//IL_002f: Expected O, but got Unknown
			//IL_005f: Unknown result type (might be due to invalid IL or missing references)
			//IL_0069: Expected O, but got Unknown
			//IL_0070: Unknown result type (might be due to invalid IL or missing references)
			//IL_007a: Expected O, but got Unknown
			//IL_0097: Unknown result type (might be due to invalid IL or missing references)
			//IL_00a5: Expected O, but got Unknown
			//IL_00ac: Unknown result type (might be due to invalid IL or missing references)
			//IL_00b6: Expected O, but got Unknown
			//IL_00c3: Unknown result type (might be due to invalid IL or missing references)
			//IL_00d0: Expected O, but got Unknown
			//IL_00e1: Unknown result type (might be due to invalid IL or missing references)
			//IL_00eb: Expected O, but got Unknown
			//IL_00f6: Unknown result type (might be due to invalid IL or missing references)
			//IL_0103: Expected O, but got Unknown
			//IL_0109: Unknown result type (might be due to invalid IL or missing references)
			//IL_0117: Expected O, but got Unknown
			//IL_011d: Unknown result type (might be due to invalid IL or missing references)
			//IL_012b: Expected O, but got Unknown
			//IL_0132: Unknown result type (might be due to invalid IL or missing references)
			//IL_013c: Expected O, but got Unknown
			TextObject val = new TextObject("{=wql79Eta}Good! We understand the spy is going to {TARGET_SETTLEMENT}. If they're trying to gather information,[ib:aggressive2][if:convo_undecided_open] they'll be wandering around the market asking questions in the guise of making small talk. Just go around talking to the townsfolk, and you should be able to figure out who it is.", (Dictionary<string, object>)null);
			val.SetTextVariable("TARGET_SETTLEMENT", _selectedSettlement.EncyclopediaLinkWithName);
			TextObject val2 = new TextObject("{=aC0Fq6IE}Do not waste time, {PLAYER.NAME}. The spy probably won't linger any longer than he has to.[if:convo_thinking] Or she has to.", (Dictionary<string, object>)null);
			StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, val2, false);
			base.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(val, (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null).Condition((OnConditionDelegate)(() => Hero.OneToOneConversationHero == ((QuestBase)this).QuestGiver))
				.Consequence(new OnConsequenceDelegate(QuestAcceptedConsequences))
				.CloseDialog();
			base.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(new TextObject("{=yLRfb5zb}Any news? Have you managed to find him yet?[if:convo_astonished]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null).Condition((OnConditionDelegate)(() => Hero.OneToOneConversationHero == ((QuestBase)this).QuestGiver))
				.BeginPlayerOptions((string)null, false)
				.PlayerOption(new TextObject("{=wErSpkjy}I'm still working on it.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(val2, (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(LeaveEncounter))
				.CloseDialog()
				.PlayerOption(new TextObject("{=I8raOMRH}Sorry. No progress yet.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(new TextObject("{=ajSm2FEU}I know spies are hard to catch but I tasked this to you for a reason. [if:convo_stern]Do not let me down {PLAYER.NAME}.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(new TextObject("{=pW69nUp8}Finish this task before it is too late.[if:convo_stern]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(LeaveEncounter))
				.CloseDialog()
				.EndPlayerOptions()
				.CloseDialog();
			Campaign.Current.ConversationManager.AddDialogFlow(GetTownsPeopleDialogFlow(), (object)this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetNotablesDialogFlow(), (object)this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetTradersDialogFlow(), (object)this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetSuspectsDialogFlow(), (object)this);
		}

		private void LeaveEncounter()
		{
			if (PlayerEncounter.Current != null)
			{
				PlayerEncounter.LeaveEncounter = true;
			}
		}

		private void QuestAcceptedConsequences()
		{
			((QuestBase)this).StartQuest();
			((QuestBase)this).AddLog(QuestStartedLog, false);
			if (Settlement.CurrentSettlement != null && Settlement.CurrentSettlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		private DialogFlow GetSuspectsDialogFlow()
		{
			//IL_0012: Unknown result type (might be due to invalid IL or missing references)
			//IL_0020: Expected O, but got Unknown
			//IL_0027: Unknown result type (might be due to invalid IL or missing references)
			//IL_0031: Expected O, but got Unknown
			//IL_003e: Unknown result type (might be due to invalid IL or missing references)
			//IL_004b: Expected O, but got Unknown
			//IL_0051: Unknown result type (might be due to invalid IL or missing references)
			//IL_005f: Expected O, but got Unknown
			//IL_006c: Unknown result type (might be due to invalid IL or missing references)
			//IL_0079: Expected O, but got Unknown
			//IL_007f: Unknown result type (might be due to invalid IL or missing references)
			//IL_008d: Expected O, but got Unknown
			//IL_0093: Unknown result type (might be due to invalid IL or missing references)
			//IL_00a0: Expected O, but got Unknown
			//IL_00a6: Unknown result type (might be due to invalid IL or missing references)
			//IL_00b4: Expected O, but got Unknown
			//IL_00bb: Unknown result type (might be due to invalid IL or missing references)
			//IL_00c5: Expected O, but got Unknown
			//IL_00d0: Unknown result type (might be due to invalid IL or missing references)
			//IL_00dd: Expected O, but got Unknown
			//IL_00ed: Unknown result type (might be due to invalid IL or missing references)
			//IL_00fa: Expected O, but got Unknown
			return DialogFlow.CreateDialogFlow("start", 125).NpcLine(new TextObject("{=IqhGJ8Dy}Hello there friend. Are you here for the tournament.[ib:confident3][if:convo_relaxed_happy]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null).Condition((OnConditionDelegate)(() => ((IEnumerable<SuspectNpc>)_suspectList).Any((SuspectNpc x) => x.CharacterObject == CharacterObject.OneToOneConversationCharacter)))
				.BeginPlayerOptions((string)null, false)
				.PlayerOption(new TextObject("{=SRa9NyP1}No, my friend. I am on a hunt.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(new TextObject("{=gYCSwLB2}Eh, what do you mean by that?[ib:closed][if:convo_confused_normal]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.BeginPlayerOptions((string)null, false)
				.PlayerOption(new TextObject("{=oddzOnad}I'm hunting a spy. And now I have found him.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(new TextObject("{=MU8nbzwJ}You have nothing on me. If you try to take me anywhere I'll kill you, and it will be in self-defense.[if:convo_grave]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=WDdlPUHw}Not if it's a duel. I challenge you. No true tournament fighter would refuse.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.NpcLine(new TextObject("{=Ll8q45h5}Hmf... Very well. I shall wipe out this insult with your blood.[ib:warrior][if:convo_furious]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence((OnConsequenceDelegate)delegate
				{
					Campaign.Current.ConversationManager.ConversationEndOneShot += StartFightWithSpy;
				})
				.CloseDialog()
				.PlayerOption(new TextObject("{=O5PDH9Bc}Nothing, nothing. Go on your way.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.EndPlayerOptions()
				.PlayerOption(new TextObject("{=O7j0uzcH}I should be on my way.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.EndPlayerOptions();
		}

		private void StartFightWithSpy()
		{
			_playerManagedToFindSpy = _selectedSpy.CharacterObject == CharacterObject.OneToOneConversationCharacter;
			_duelCharacter = CharacterObject.OneToOneConversationCharacter;
			_startFightWithSpy = true;
			Campaign.Current.GameMenuManager.NextLocation = LocationComplex.Current.GetLocationWithId("arena");
			Mission.Current.EndMission();
		}

		private DialogFlow GetNotablesDialogFlow()
		{
			//IL_0006: Unknown result type (might be due to invalid IL or missing references)
			//IL_000c: Expected O, but got Unknown
			//IL_003d: Unknown result type (might be due to invalid IL or missing references)
			//IL_004a: Expected O, but got Unknown
			//IL_0051: Unknown result type (might be due to invalid IL or missing references)
			//IL_005b: Expected O, but got Unknown
			TextObject val = new TextObject("{=0RTwaPBJ}I speak to many people. Of course, as I am loyal to {QUEST_GIVER.NAME}, [if:convo_pondering]I am always on the lookout for spies. But I've seen no one like this.", (Dictionary<string, object>)null);
			StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, val, false);
			return DialogFlow.CreateDialogFlow("hero_main_options", 125).BeginPlayerOptions((string)null, false).PlayerOption(new TextObject("{=xPTxkzVM}I am looking for a spy. Have you seen any warriors in the tournament wandering about, asking too many suspicious questions?", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Condition((OnConditionDelegate)(() => Settlement.CurrentSettlement == _selectedSettlement && Hero.OneToOneConversationHero.IsNotable))
				.NpcLine(val, (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.EndPlayerOptions();
		}

		private DialogFlow GetTradersDialogFlow()
		{
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_0026: Expected O, but got Unknown
			//IL_002d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0037: Expected O, but got Unknown
			//IL_003d: Unknown result type (might be due to invalid IL or missing references)
			//IL_004b: Expected O, but got Unknown
			return DialogFlow.CreateDialogFlow("weaponsmith_talk_player", 125).BeginPlayerOptions((string)null, false).PlayerOption(new TextObject("{=SHwlcdp3}I ask you because you are a trader here. Have you seen one of the warriors in the tournament walking around here, asking people a lot of suspicious questions?", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Condition((OnConditionDelegate)(() => Settlement.CurrentSettlement == _selectedSettlement && ((int)CharacterObject.OneToOneConversationCharacter.Occupation == 12 || (int)CharacterObject.OneToOneConversationCharacter.Occupation == 4 || (int)CharacterObject.OneToOneConversationCharacter.Occupation == 28 || (int)CharacterObject.OneToOneConversationCharacter.Occupation == 10)))
				.NpcLine(new TextObject("{=ocoHNhNk}Hmm... I keep pretty busy with my own trade. I haven't heard anything like that.[if:convo_pondering]", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.EndPlayerOptions();
		}

		private DialogFlow GetTownsPeopleDialogFlow()
		{
			//IL_0014: Unknown result type (might be due to invalid IL or missing references)
			//IL_001e: Expected O, but got Unknown
			//IL_0042: Unknown result type (might be due to invalid IL or missing references)
			//IL_004c: Expected O, but got Unknown
			//IL_0053: Unknown result type (might be due to invalid IL or missing references)
			//IL_005d: Expected O, but got Unknown
			//IL_0088: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Expected O, but got Unknown
			//IL_009c: Unknown result type (might be due to invalid IL or missing references)
			//IL_00a6: Expected O, but got Unknown
			//IL_00ad: Unknown result type (might be due to invalid IL or missing references)
			//IL_00b7: Expected O, but got Unknown
			//IL_00c4: Unknown result type (might be due to invalid IL or missing references)
			//IL_00d0: Unknown result type (might be due to invalid IL or missing references)
			//IL_00de: Expected O, but got Unknown
			//IL_00de: Expected O, but got Unknown
			//IL_00e4: Unknown result type (might be due to invalid IL or missing references)
			//IL_00f1: Expected O, but got Unknown
			//IL_00f8: Unknown result type (might be due to invalid IL or missing references)
			//IL_0102: Expected O, but got Unknown
			//IL_010d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0119: Unknown result type (might be due to invalid IL or missing references)
			//IL_0127: Expected O, but got Unknown
			//IL_0127: Expected O, but got Unknown
			//IL_012d: Unknown result type (might be due to invalid IL or missing references)
			//IL_013a: Expected O, but got Unknown
			//IL_0141: Unknown result type (might be due to invalid IL or missing references)
			//IL_014b: Expected O, but got Unknown
			//IL_0156: Unknown result type (might be due to invalid IL or missing references)
			//IL_0162: Unknown result type (might be due to invalid IL or missing references)
			//IL_0170: Expected O, but got Unknown
			//IL_0170: Expected O, but got Unknown
			//IL_0176: Unknown result type (might be due to invalid IL or missing references)
			//IL_0183: Expected O, but got Unknown
			//IL_018a: Unknown result type (might be due to invalid IL or missing references)
			//IL_0194: Expected O, but got Unknown
			//IL_019f: Unknown result type (might be due to invalid IL or missing references)
			//IL_01ab: Unknown result type (might be due to invalid IL or missing references)
			//IL_01b9: Expected O, but got Unknown
			//IL_01b9: Expected O, but got Unknown
			//IL_01bf: Unknown result type (might be due to invalid IL or missing references)
			//IL_01cc: Expected O, but got Unknown
			//IL_01d3: Unknown result type (might be due to invalid IL or missing references)
			//IL_01dd: Expected O, but got Unknown
			//IL_01e8: Unknown result type (might be due to invalid IL or missing references)
			//IL_01f4: Unknown result type (might be due to invalid IL or missing references)
			//IL_0202: Expected O, but got Unknown
			//IL_0202: Expected O, but got Unknown
			//IL_0208: Unknown result type (might be due to invalid IL or missing references)
			//IL_0215: Expected O, but got Unknown
			//IL_0220: Unknown result type (might be due to invalid IL or missing references)
			//IL_022c: Unknown result type (might be due to invalid IL or missing references)
			//IL_023a: Expected O, but got Unknown
			//IL_023a: Expected O, but got Unknown
			//IL_0240: Unknown result type (might be due to invalid IL or missing references)
			//IL_024d: Expected O, but got Unknown
			//IL_0258: Unknown result type (might be due to invalid IL or missing references)
			//IL_0264: Unknown result type (might be due to invalid IL or missing references)
			//IL_0272: Expected O, but got Unknown
			//IL_0272: Expected O, but got Unknown
			//IL_0278: Unknown result type (might be due to invalid IL or missing references)
			//IL_0285: Expected O, but got Unknown
			//IL_0290: Unknown result type (might be due to invalid IL or missing references)
			//IL_029c: Unknown result type (might be due to invalid IL or missing references)
			//IL_02aa: Expected O, but got Unknown
			//IL_02aa: Expected O, but got Unknown
			//IL_02b0: Unknown result type (might be due to invalid IL or missing references)
			//IL_02bd: Expected O, but got Unknown
			//IL_02c8: Unknown result type (might be due to invalid IL or missing references)
			//IL_02d4: Unknown result type (might be due to invalid IL or missing references)
			//IL_02e2: Expected O, but got Unknown
			//IL_02e2: Expected O, but got Unknown
			//IL_02e8: Unknown result type (might be due to invalid IL or missing references)
			//IL_02f5: Expected O, but got Unknown
			TextObject playerOption1 = new TextObject("{=A2oos2Uo}Listen to me. I'm on assignment from {QUEST_GIVER.NAME}. Have any strangers been around here, asking odd questions about the garrison?", (Dictionary<string, object>)null);
			StringHelpers.SetCharacterProperties("QUEST_GIVER", ((QuestBase)this).QuestGiver.CharacterObject, playerOption1, false);
			TextObject playerOption2 = new TextObject("{=RXhBl8e1}Act normal. Have any of the participants in the tournament come round, asking very odd questions?", (Dictionary<string, object>)null);
			TextObject playerOption3 = new TextObject("{=HF2GIpbI}Listen to me. Have any of the tournament participants spent long hours in the market and tavern? More than usual?", (Dictionary<string, object>)null);
			float dontGiveClueResponse = 0f;
			bool giveClue = false;
			return DialogFlow.CreateDialogFlow("town_or_village_player", 125).BeginPlayerOptions((string)null, false).PlayerOption(new TextObject("{=GtgGnMe1}{PLAYER_OPTION}", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Condition((OnConditionDelegate)delegate
				{
					if (Settlement.CurrentSettlement == _selectedSettlement)
					{
						float randomFloat = MBRandom.RandomFloat;
						dontGiveClueResponse = MBRandom.RandomFloat;
						if (randomFloat < 0.33f)
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption1, false);
						}
						else if (randomFloat >= 0.33f && randomFloat <= 0.66f)
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption2, false);
						}
						else
						{
							MBTextManager.SetTextVariable("PLAYER_OPTION", playerOption3, false);
						}
						return true;
					}
					return false;
				})
				.Consequence((OnConsequenceDelegate)delegate
				{
					giveClue = _giveClueChange >= MBRandom.RandomFloat;
					Campaign.Current.ConversationManager.ConversationEndOneShot += AddAgentToAlreadySpokenList;
				})
				.BeginNpcOptions((string)null, false)
				.NpcOption(new TextObject("{=8gmne3b9}Not to me {?PLAYER.GENDER}madam{?}sir{\\?}, no. I did overhear someone talking to another merchant about such things. I remember him because he had this nasty looking sword by his side.[if:convo_disbelief]", (Dictionary<string, object>)null), (OnConditionDelegate)(() => giveClue && _selectedSpy.HasBigSword && !_playerLearnedHasBigSword && CommonCondition()), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=VP6s1YFW}Many contenders have swords on their backs. Still this information might prove useful.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(PlayerLearnedSpyHasSword))
				.CloseDialog()
				.NpcOption(new TextObject("{=gHnMYU9n}Why yes... At the tavern last night... Cornered a drunk and kept pressing him for information about the gatehouse. Had a beard, that one did.[if:convo_pondering]", (Dictionary<string, object>)null), (OnConditionDelegate)(() => giveClue && _selectedSpy.HasBeard && !_playerLearnedHasBeard && CommonCondition()), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=QaAzicqA}Many men have beards. Still, that is something.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(PlayerLearnedSpyHasBeard))
				.CloseDialog()
				.NpcOption(new TextObject("{=DUVqJifX}Yeah. I've seen one like that around the arena, asking all matter of outlandish questions. Middle-aged, normal head of hair, that's really all I can remember though.[if:convo_thinking]", (Dictionary<string, object>)null), (OnConditionDelegate)(() => giveClue && _selectedSpy.HasHair && !_playerLearnedHasHair && CommonCondition()), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=JjtmptiD}More men have hair than not, but this is another tile in the mosaic.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(PlayerLearnedSpyHasHair))
				.CloseDialog()
				.NpcOption(new TextObject("{=tXpmCzoZ}Well, there was one warrior. A handsome young lad. Didn't have any of those scars that some fighters pick up in battle, nor any of those marks or tattoos or whatever that [if:convo_pondering]some of the hard cases like to show off.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => giveClue && _selectedSpy.WithoutMarkings && !_playerLearnedHasNoMarkings && CommonCondition()), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=ZCbQvqqv}A face without scars and markings is usual for farmers and merchants but less so for warriors. This might be useful.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.Consequence(new OnConsequenceDelegate(PlayerLearnedSpyHasNoMarkings))
				.CloseDialog()
				.NpcOption(new TextObject("{=sfxfiWxl}{?PLAYER.GENDER}Madam{?}Sir{\\?}, people gossip. Everyone around here knows you've been asking those questions. Your quarry is going to slip away if you don't move quickly.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => dontGiveClueResponse <= 0.2f), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=04gFKwY1}Well, if you see anyone like that, let me know.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.NpcOption(new TextObject("{=VWaNqkqJ}Can't say I've seen anyone around here like that, {?PLAYER.GENDER}madam{?}sir{\\?}.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => dontGiveClueResponse > 0.2f && dontGiveClueResponse <= 0.4f), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=QbzsgawM}Okay, just keep your eyes open.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.NpcOption(new TextObject("{=ff5XEKPB}Afraid I can't recall anyone like that, {?PLAYER.GENDER}madam{?}sir{\\?}.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => dontGiveClueResponse > 0.4f && dontGiveClueResponse <= 0.6f), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=ArseaKsm}Very well. Thanks for your time.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.NpcOption(new TextObject("{=C6EOT3yY}No, sorry. Haven't seen anything like that.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => dontGiveClueResponse > 0.6f && dontGiveClueResponse <= 0.8f), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=3UX334MB}Hmm.. Very well. Sorry for interrupting.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.NpcOption(new TextObject("{=9DDWjL9Y}Hmm... Maybe, but I can't remember who. I didn't think it suspicious.", (Dictionary<string, object>)null), (OnConditionDelegate)(() => dontGiveClueResponse > 0.8f), (OnMultipleConversationConsequenceDelegate)null, (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.PlayerLine(new TextObject("{=QbzsgawM}Okay, just keep your eyes open.", (Dictionary<string, object>)null), (OnMultipleConversationConsequenceDelegate)null, (string)null, (string)null)
				.CloseDialog()
				.EndNpcOptions()
				.EndPlayerOptions();
		}

		private void AddAgentToAlreadySpokenList()
		{
			//IL_002d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0037: Expected O, but got Unknown
			_giveClueChange += 0.15f;
			_alreadySpokenAgents.Add((Agent)MissionConversationLogic.Current.ConversationManager.ConversationAgents[0]);
		}

		private bool CommonCondition()
		{
			//IL_0028: Unknown result type (might be due to invalid IL or missing references)
			//IL_0032: Expected O, but got Unknown
			//IL_0039: Unknown result type (might be due to invalid IL or missing references)
			//IL_003f: Invalid comparison between Unknown and I4
			if (Settlement.CurrentSettlement == _selectedSettlement && !_alreadySpokenAgents.Contains((Agent)MissionConversationLogic.Current.ConversationManager.ConversationAgents[0]))
			{
				return (int)CharacterObject.OneToOneConversationCharacter.Occupation == 8;
			}
			return false;
		}

		private void CheckIfPlayerLearnedEverything()
		{
			//IL_0050: Unknown result type (might be due to invalid IL or missing references)
			//IL_0056: Expected O, but got Unknown
			int num = 0;
			num = ((!_playerLearnedHasBeard) ? num : (++num));
			num = ((!_playerLearnedHasBigSword) ? num : (++num));
			num = ((!_playerLearnedHasHair) ? num : (++num));
			num = ((!_playerLearnedHasNoMarkings) ? num : (++num));
			if (num >= 3)
			{
				TextObject val = new TextObject("{=2LW2jWuG}You should now have enough evidence to identify the spy. You might be able to find the tournament participants hanging out in the alleys with local thugs. Find and speak with them.", (Dictionary<string, object>)null);
				((QuestBase)this).AddLog(val, false);
			}
		}

		private void PlayerLearnedSpyHasSword()
		{
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_0024: Expected O, but got Unknown
			_giveClueChange = 0f;
			_playerLearnedHasBigSword = true;
			((QuestBase)this).AddLog(new TextObject("{=awYMellZ}The spy is known to carry a sword.", (Dictionary<string, object>)null), false);
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasBeard()
		{
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_0024: Expected O, but got Unknown
			_giveClueChange = 0f;
			_playerLearnedHasBeard = true;
			((QuestBase)this).AddLog(new TextObject("{=5om6Wv1n}After questioning some folk in town, you learned that the spy has a beard.", (Dictionary<string, object>)null), false);
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasHair()
		{
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_0024: Expected O, but got Unknown
			_giveClueChange = 0f;
			_playerLearnedHasHair = true;
			((QuestBase)this).AddLog(new TextObject("{=PLgOm8tV}The townsfolk told you that the spy is not bald.", (Dictionary<string, object>)null), false);
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		private void PlayerLearnedSpyHasNoMarkings()
		{
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_0024: Expected O, but got Unknown
			_giveClueChange = 0f;
			_playerLearnedHasNoMarkings = true;
			((QuestBase)this).AddLog(new TextObject("{=1ieLd5qq}The townsfolk told you that the spy has no distinctive scars or other facial markings.", (Dictionary<string, object>)null), false);
			_alreadySpokenAgents.Add(MissionConversationLogic.Current.ConversationAgent);
			CheckIfPlayerLearnedEverything();
		}

		protected override void RegisterEvents()
		{
			CampaignEvents.SettlementEntered.AddNonSerializedListener((object)this, (Action<MobileParty, Settlement, Hero>)OnSettlementEntered);
			CampaignEvents.OnSettlementLeftEvent.AddNonSerializedListener((object)this, (Action<MobileParty, Settlement>)OnSettlementLeft);
			CampaignEvents.AfterMissionStarted.AddNonSerializedListener((object)this, (Action<IMission>)OnMissionStarted);
			CampaignEvents.OnSettlementOwnerChangedEvent.AddNonSerializedListener((object)this, (Action<Settlement, bool, Hero, Hero, Hero, ChangeOwnerOfSettlementDetail>)OnSettlementOwnerChanged);
			CampaignEvents.WarDeclared.AddNonSerializedListener((object)this, (Action<IFaction, IFaction, DeclareWarDetail>)OnWarDeclared);
			CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener((object)this, (Action<Clan, Kingdom, Kingdom, ChangeKingdomActionDetail, bool>)OnClanChangedKingdom);
			CampaignEvents.BeforeGameMenuOpenedEvent.AddNonSerializedListener((object)this, (Action<MenuCallbackArgs>)BeforeGameMenuOpenedEvent);
			CampaignEvents.MapEventStarted.AddNonSerializedListener((object)this, (Action<MapEvent, PartyBase, PartyBase>)OnMapEventStarted);
		}

		private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
		{
			if (QuestHelper.CheckMinorMajorCoercion((QuestBase)(object)this, mapEvent, attackerParty))
			{
				QuestHelper.ApplyGenericMinorMajorCoercionConsequences((QuestBase)(object)this, mapEvent);
			}
		}

		private void BeforeGameMenuOpenedEvent(MenuCallbackArgs args)
		{
			if (Settlement.CurrentSettlement != _selectedSettlement || !(args.MenuContext.GameMenu.StringId == "town"))
			{
				return;
			}
			if (_startFightWithSpy && Campaign.Current.GameMenuManager.NextLocation == LocationComplex.Current.GetLocationWithId("arena") && GameStateManager.Current.ActiveState is MapState)
			{
				_startFightWithSpy = false;
				CampaignMission.OpenArenaDuelMission(LocationComplex.Current.GetLocationWithId("arena").GetSceneName(_selectedSettlement.Town.GetWallLevel()), LocationComplex.Current.GetLocationWithId("arena"), _duelCharacter, false, false, (Action<CharacterObject>)OnFightEnd, 225f);
				Campaign.Current.GameMenuManager.NextLocation = null;
			}
			if (!_checkForBattleResult)
			{
				return;
			}
			if (_playerWonTheFight)
			{
				if (_playerManagedToFindSpy)
				{
					PlayerFoundTheSpyAndKilledHim();
				}
				else
				{
					PlayerCouldNotFoundTheSpyAndKilledAnotherSuspect();
				}
			}
			else if (_playerManagedToFindSpy)
			{
				PlayerFoundTheSpyButLostTheFight();
			}
			else
			{
				PlayerCouldNotFoundTheSpyAndLostTheFight();
			}
		}

		private void PlayerFoundTheSpyAndKilledHim()
		{
			((QuestBase)this).AddLog(QuestSuccessQuestLog, false);
			GainRenownAction.Apply(Hero.MainHero, 1f, false);
			GiveGoldAction.ApplyBetweenCharacters((Hero)null, Hero.MainHero, base.RewardGold, false);
			((QuestBase)this).RelationshipChangeWithQuestGiver = 5;
			Town town = _selectedSettlement.Town;
			town.Prosperity += 5f;
			((QuestBase)this).CompleteQuestWithSuccess();
		}

		private void PlayerCouldNotFoundTheSpyAndKilledAnotherSuspect()
		{
			((QuestBase)this).AddLog(QuestFailedKilledAnotherQuestLog, false);
			((QuestBase)this).RelationshipChangeWithQuestGiver = -5;
			Town town = _selectedSettlement.Town;
			town.Security -= 10f;
			Town town2 = _selectedSettlement.Town;
			town2.Loyalty -= 10f;
			((QuestBase)this).CompleteQuestWithFail((TextObject)null);
			ChangeCrimeRatingAction.Apply(((QuestBase)this).QuestGiver.MapFaction, 10f, true);
		}

		private void PlayerFoundTheSpyButLostTheFight()
		{
			((QuestBase)this).AddLog(PlayerFoundTheSpyButLostTheFightQuestLog, false);
			((QuestBase)this).RelationshipChangeWithQuestGiver = -5;
			Town town = _selectedSettlement.Town;
			town.Security -= 10f;
			Town town2 = _selectedSettlement.Town;
			town2.Loyalty -= 10f;
			((QuestBase)this).CompleteQuestWithFail((TextObject)null);
		}

		private void PlayerCouldNotFoundTheSpyAndLostTheFight()
		{
			((QuestBase)this).AddLog(PlayerCouldNotFoundTheSpyAndLostTheFightQuestLog, false);
			((QuestBase)this).RelationshipChangeWithQuestGiver = -5;
			Town town = _selectedSettlement.Town;
			town.Security -= 10f;
			Town town2 = _selectedSettlement.Town;
			town2.Loyalty -= 10f;
			((QuestBase)this).CompleteQuestWithFail((TextObject)null);
		}

		private void OnFightEnd(CharacterObject winnerCharacterObject)
		{
			_checkForBattleResult = true;
			_playerWonTheFight = winnerCharacterObject == CharacterObject.PlayerCharacter;
		}

		private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomActionDetail detail, bool showNotification = true)
		{
			if (((QuestBase)this).QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				((QuestBase)this).CompleteQuestWithCancel(WarDeclaredQuestLog);
			}
		}

		private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarDetail detail)
		{
			//IL_0003: Unknown result type (might be due to invalid IL or missing references)
			QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest((QuestBase)(object)this, faction1, faction2, detail, PlayerDeclaredWarQuestLogText, WarDeclaredQuestLog, false);
		}

		private void OnSettlementOwnerChanged(Settlement settlement, bool openToClaim, Hero newOwner, Hero oldOwner, Hero capturerHero, ChangeOwnerOfSettlementDetail detail)
		{
			if (settlement == _selectedSettlement && oldOwner.Clan == ((QuestBase)this).QuestGiver.Clan)
			{
				((QuestBase)this).AddLog(QuestGiverLostOwnershipQuestLog, false);
				((QuestBase)this).CompleteQuestWithCancel((TextObject)null);
			}
		}

		private void OnSettlementEntered(MobileParty party, Settlement settlement, Hero hero)
		{
			if (party != null && party.IsMainParty && settlement == _selectedSettlement && hero == Hero.MainHero)
			{
				_addSpyNpcsToSettlement = true;
			}
		}

		public override IssueQuestFlags IsLocationTrackedByQuest(Location location)
		{
			if (PlayerEncounter.LocationEncounter.Settlement == _selectedSettlement && location.StringId == "center")
			{
				return (IssueQuestFlags)2;
			}
			return (IssueQuestFlags)0;
		}

		private void OnSettlementLeft(MobileParty party, Settlement settlement)
		{
			if (party.IsMainParty && settlement == _selectedSettlement)
			{
				_addSpyNpcsToSettlement = false;
			}
		}

		private void OnMissionStarted(IMission mission)
		{
			//IL_002b: Unknown result type (might be due to invalid IL or missing references)
			//IL_0041: Expected O, but got Unknown
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_005f: Expected O, but got Unknown
			//IL_0067: Unknown result type (might be due to invalid IL or missing references)
			//IL_007d: Expected O, but got Unknown
			//IL_0085: Unknown result type (might be due to invalid IL or missing references)
			//IL_009b: Expected O, but got Unknown
			if (_addSpyNpcsToSettlement)
			{
				Location locationWithId = Settlement.CurrentSettlement.LocationComplex.GetLocationWithId("center");
				if (locationWithId != null)
				{
					locationWithId.AddLocationCharacters(new CreateLocationCharacterDelegate(CreateBoldSpyLocationCharacter), Settlement.CurrentSettlement.Culture, (CharacterRelations)0, 1);
					locationWithId.AddLocationCharacters(new CreateLocationCharacterDelegate(CreateConfidentSpyLocationCharacter), Settlement.CurrentSettlement.Culture, (CharacterRelations)0, 1);
					locationWithId.AddLocationCharacters(new CreateLocationCharacterDelegate(CreateDignifiedSpyLocationCharacter), Settlement.CurrentSettlement.Culture, (CharacterRelations)0, 1);
					locationWithId.AddLocationCharacters(new CreateLocationCharacterDelegate(CreateHardySpyLocationCharacters), Settlement.CurrentSettlement.Culture, (CharacterRelations)0, 1);
				}
			}
		}

		private LocationCharacter CreateBoldSpyLocationCharacter(CultureObject culture, CharacterRelations relation)
		{
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_004f: Unknown result type (might be due to invalid IL or missing references)
			//IL_0050: Unknown result type (might be due to invalid IL or missing references)
			//IL_005a: Expected O, but got Unknown
			//IL_0055: Unknown result type (might be due to invalid IL or missing references)
			//IL_0076: Unknown result type (might be due to invalid IL or missing references)
			//IL_0081: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Expected O, but got Unknown
			//IL_0090: Unknown result type (might be due to invalid IL or missing references)
			//IL_0096: Expected O, but got Unknown
			CharacterObject val = MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = FaceGen.GetMonsterWithSuffix(((BasicCharacterObject)val).Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, ((BasicCharacterObject)val).IsFemale, "_villain"), monsterWithSuffix);
			AgentData obj = new AgentData((IAgentOriginBase)new SimpleAgentOrigin((BasicCharacterObject)(object)val, -1, (Banner)null, default(UniqueTroopDescriptor))).Monster(tuple.Item2);
			IAgentBehaviorManager agentBehaviorManager = SandBoxManager.Instance.AgentBehaviorManager;
			return new LocationCharacter(obj, new AddBehaviorsDelegate(agentBehaviorManager.AddFixedCharacterBehaviors), "alley_1", true, relation, tuple.Item1, true, false, (ItemObject)null, false, true, false, (AfterAgentCreatedDelegate)null, false);
		}

		private LocationCharacter CreateConfidentSpyLocationCharacter(CultureObject culture, CharacterRelations relation)
		{
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_004f: Unknown result type (might be due to invalid IL or missing references)
			//IL_0050: Unknown result type (might be due to invalid IL or missing references)
			//IL_005a: Expected O, but got Unknown
			//IL_0055: Unknown result type (might be due to invalid IL or missing references)
			//IL_0076: Unknown result type (might be due to invalid IL or missing references)
			//IL_0081: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Expected O, but got Unknown
			//IL_0090: Unknown result type (might be due to invalid IL or missing references)
			//IL_0096: Expected O, but got Unknown
			CharacterObject val = MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = FaceGen.GetMonsterWithSuffix(((BasicCharacterObject)val).Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, ((BasicCharacterObject)val).IsFemale, "_villain"), monsterWithSuffix);
			AgentData obj = new AgentData((IAgentOriginBase)new SimpleAgentOrigin((BasicCharacterObject)(object)val, -1, (Banner)null, default(UniqueTroopDescriptor))).Monster(tuple.Item2);
			IAgentBehaviorManager agentBehaviorManager = SandBoxManager.Instance.AgentBehaviorManager;
			return new LocationCharacter(obj, new AddBehaviorsDelegate(agentBehaviorManager.AddFixedCharacterBehaviors), "alley_3", true, relation, tuple.Item1, true, false, (ItemObject)null, false, true, false, (AfterAgentCreatedDelegate)null, false);
		}

		private LocationCharacter CreateDignifiedSpyLocationCharacter(CultureObject culture, CharacterRelations relation)
		{
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_004f: Unknown result type (might be due to invalid IL or missing references)
			//IL_0050: Unknown result type (might be due to invalid IL or missing references)
			//IL_005a: Expected O, but got Unknown
			//IL_0055: Unknown result type (might be due to invalid IL or missing references)
			//IL_0076: Unknown result type (might be due to invalid IL or missing references)
			//IL_0081: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Expected O, but got Unknown
			//IL_0090: Unknown result type (might be due to invalid IL or missing references)
			//IL_0096: Expected O, but got Unknown
			CharacterObject val = MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = FaceGen.GetMonsterWithSuffix(((BasicCharacterObject)val).Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, ((BasicCharacterObject)val).IsFemale, "_villain"), monsterWithSuffix);
			AgentData obj = new AgentData((IAgentOriginBase)new SimpleAgentOrigin((BasicCharacterObject)(object)val, -1, (Banner)null, default(UniqueTroopDescriptor))).Monster(tuple.Item2);
			IAgentBehaviorManager agentBehaviorManager = SandBoxManager.Instance.AgentBehaviorManager;
			return new LocationCharacter(obj, new AddBehaviorsDelegate(agentBehaviorManager.AddFixedCharacterBehaviors), "alley_3", true, relation, tuple.Item1, true, false, (ItemObject)null, false, true, false, (AfterAgentCreatedDelegate)null, false);
		}

		private LocationCharacter CreateHardySpyLocationCharacters(CultureObject culture, CharacterRelations relation)
		{
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_004f: Unknown result type (might be due to invalid IL or missing references)
			//IL_0050: Unknown result type (might be due to invalid IL or missing references)
			//IL_005a: Expected O, but got Unknown
			//IL_0055: Unknown result type (might be due to invalid IL or missing references)
			//IL_0076: Unknown result type (might be due to invalid IL or missing references)
			//IL_0081: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Expected O, but got Unknown
			//IL_0090: Unknown result type (might be due to invalid IL or missing references)
			//IL_0096: Expected O, but got Unknown
			CharacterObject val = MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + _currentDifficultySuffix);
			Monster monsterWithSuffix = FaceGen.GetMonsterWithSuffix(((BasicCharacterObject)val).Race, "_settlement");
			Tuple<string, Monster> tuple = new Tuple<string, Monster>(ActionSetCode.GenerateActionSetNameWithSuffix(monsterWithSuffix, ((BasicCharacterObject)val).IsFemale, "_villain"), monsterWithSuffix);
			AgentData obj = new AgentData((IAgentOriginBase)new SimpleAgentOrigin((BasicCharacterObject)(object)val, -1, (Banner)null, default(UniqueTroopDescriptor))).Monster(tuple.Item2);
			IAgentBehaviorManager agentBehaviorManager = SandBoxManager.Instance.AgentBehaviorManager;
			return new LocationCharacter(obj, new AddBehaviorsDelegate(agentBehaviorManager.AddFixedCharacterBehaviors), "alley_2", true, relation, tuple.Item1, true, false, (ItemObject)null, false, true, false, (AfterAgentCreatedDelegate)null, false);
		}

		protected override void OnTimedOut()
		{
			((QuestBase)this).AddLog(TimedOutQuestLog, false);
			((QuestBase)this).QuestGiver.AddPower(-5f);
			((QuestBase)this).RelationshipChangeWithQuestGiver = -5;
			Town town = _selectedSettlement.Town;
			town.Security -= 10f;
			Town town2 = _selectedSettlement.Town;
			town2.Loyalty -= 10f;
		}

		internal static void AutoGeneratedStaticCollectObjectsTheSpyPartyIssueQuest(object o, List<object> collectedObjects)
		{
			((MBObjectBase)(TheSpyPartyIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			((QuestBase)this).AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_selectedSettlement);
			SuspectNpc.AutoGeneratedStaticCollectObjectsSuspectNpc(_selectedSpy, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValue_selectedSettlement(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._selectedSettlement;
		}

		internal static object AutoGeneratedGetMemberValue_selectedSpy(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._selectedSpy;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasHair(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasHair;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasNoMarkings(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasNoMarkings;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasBigSword(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasBigSword;
		}

		internal static object AutoGeneratedGetMemberValue_playerLearnedHasBeard(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._playerLearnedHasBeard;
		}

		internal static object AutoGeneratedGetMemberValue_issueDifficultyMultiplier(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._issueDifficultyMultiplier;
		}

		internal static object AutoGeneratedGetMemberValue_currentDifficultySuffix(object o)
		{
			return ((TheSpyPartyIssueQuest)o)._currentDifficultySuffix;
		}
	}

	private const IssueFrequency TheSpyPartyIssueFrequency = (IssueFrequency)2;

	private const int IssueDuration = 5;

	public override void RegisterEvents()
	{
		CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener((object)this, (Action<Hero>)OnCheckForIssue);
	}

	public void OnCheckForIssue(Hero hero)
	{
		//IL_004f: Unknown result type (might be due to invalid IL or missing references)
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0033: Expected O, but got Unknown
		//IL_002e: Unknown result type (might be due to invalid IL or missing references)
		if (ConditionsHold(hero, out var selectedSettlement))
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new StartIssueDelegate(OnStartIssue), typeof(TheSpyPartyIssue), (IssueFrequency)2, (object)selectedSettlement));
		}
		else
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(TheSpyPartyIssue), (IssueFrequency)2));
		}
	}

	private bool ConditionsHold(Hero issueGiver, out Settlement selectedSettlement)
	{
		selectedSettlement = null;
		int num;
		if (issueGiver.IsLord && issueGiver.Clan != Clan.PlayerClan && ((IEnumerable<Settlement>)issueGiver.Clan.Settlements).Any((Settlement x) => x.IsTown))
		{
			selectedSettlement = Extensions.GetRandomElementWithPredicate<Settlement>(issueGiver.Clan.Settlements, (Func<Settlement, bool>)((Settlement x) => x.IsTown));
			string difficultySuffix = GetDifficultySuffix(Campaign.Current.Models.IssueModel.GetIssueDifficultyMultiplier());
			if (MBObjectManager.Instance.GetObject<CharacterObject>("bold_contender_" + difficultySuffix) != null && MBObjectManager.Instance.GetObject<CharacterObject>("confident_contender_" + difficultySuffix) != null && MBObjectManager.Instance.GetObject<CharacterObject>("dignified_contender_" + difficultySuffix) != null)
			{
				num = ((MBObjectManager.Instance.GetObject<CharacterObject>("hardy_contender_" + difficultySuffix) != null) ? 1 : 0);
				if (num != 0)
				{
					goto IL_010b;
				}
			}
			else
			{
				num = 0;
			}
			((CampaignEventReceiver)CampaignEventDispatcher.Instance).RemoveListeners((object)this);
			goto IL_010b;
		}
		return false;
		IL_010b:
		return (byte)num != 0;
	}

	private static string GetDifficultySuffix(float difficulty)
	{
		if (difficulty <= 0.25f)
		{
			return "easy";
		}
		if (difficulty <= 0.5f)
		{
			return "normal";
		}
		if (difficulty <= 0.75f)
		{
			return "hard";
		}
		return "very_hard";
	}

	private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
	{
		//IL_0002: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		PotentialIssueData val = pid;
		object relatedObject = ((PotentialIssueData)(ref val)).RelatedObject;
		return (IssueBase)(object)new TheSpyPartyIssue(issueOwner, (Settlement)((relatedObject is Settlement) ? relatedObject : null));
	}

	public override void SyncData(IDataStore dataStore)
	{
	}
}
