using System;
using System.Collections.Generic;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Load;

namespace TaleWorlds.CampaignSystem;

public class StanceLink
{
	[SaveableField(0)]
	private StanceType _stanceType;

	[SaveableField(3)]
	public int BehaviorPriority;

	[SaveableField(40)]
	private CampaignTime _warStartDate;

	[SaveableField(50)]
	private CampaignTime _peaceDeclarationDate;

	[SaveableField(60)]
	private int _troopCasualties1;

	[SaveableField(70)]
	private int _troopCasualties2;

	[SaveableField(110)]
	private int _successfulSieges1;

	[SaveableField(120)]
	private int _successfulSieges2;

	[SaveableField(130)]
	private int _successfulRaids1;

	[SaveableField(140)]
	private int _successfulRaids2;

	[SaveableField(211)]
	private int _totalTributePaidFrom1To2;

	[SaveableField(220)]
	private int _dailyTributeFrom1To2;

	[SaveableField(221)]
	private int _dailyTributeInstallments;

	[SaveableField(230)]
	private int _successfulTownSieges1;

	[SaveableField(240)]
	private int _successfulTownSieges2;

	public bool IsNeutral => _stanceType == StanceType.Neutral;

	public bool IsAtWar => _stanceType == StanceType.War;

	internal StanceType StanceType
	{
		get
		{
			return _stanceType;
		}
		set
		{
			if (_stanceType != value)
			{
				if (_stanceType == StanceType.War)
				{
					ResetStats();
					PeaceDeclarationDate = CampaignTime.Now;
				}
				_stanceType = value;
				if (_stanceType == StanceType.War)
				{
					ResetStats();
					WarStartDate = CampaignTime.Now;
				}
				CampaignEventDispatcher.Instance.OnMapEventContinuityNeedsUpdate(Faction1);
			}
		}
	}

	[SaveableProperty(20)]
	public IFaction Faction1 { get; private set; }

	[SaveableProperty(30)]
	public IFaction Faction2 { get; private set; }

	public CampaignTime WarStartDate
	{
		get
		{
			return _warStartDate;
		}
		private set
		{
			_warStartDate = value;
		}
	}

	public CampaignTime PeaceDeclarationDate
	{
		get
		{
			return _peaceDeclarationDate;
		}
		private set
		{
			_peaceDeclarationDate = value;
		}
	}

	public int TroopCasualties1
	{
		get
		{
			return _troopCasualties1;
		}
		set
		{
			_troopCasualties1 = value;
		}
	}

	public int TroopCasualties2
	{
		get
		{
			return _troopCasualties2;
		}
		set
		{
			_troopCasualties2 = value;
		}
	}

	[SaveableProperty(80)]
	public int ShipCasualties1 { get; set; }

	[SaveableProperty(90)]
	public int ShipCasualties2 { get; set; }

	public int SuccessfulSieges1
	{
		get
		{
			return _successfulSieges1;
		}
		set
		{
			_successfulSieges1 = value;
		}
	}

	public int SuccessfulSieges2
	{
		get
		{
			return _successfulSieges2;
		}
		set
		{
			_successfulSieges2 = value;
		}
	}

	public int SuccessfulRaids1
	{
		get
		{
			return _successfulRaids1;
		}
		set
		{
			_successfulRaids1 = value;
		}
	}

	public int SuccessfulRaids2
	{
		get
		{
			return _successfulRaids2;
		}
		set
		{
			_successfulRaids2 = value;
		}
	}

	public int TotalTributePaidFrom1To2
	{
		get
		{
			return _totalTributePaidFrom1To2;
		}
		set
		{
			_totalTributePaidFrom1To2 = value;
		}
	}

	public int TotalTributePaidFrom2To1
	{
		get
		{
			return -_totalTributePaidFrom1To2;
		}
		set
		{
			_totalTributePaidFrom1To2 = -value;
		}
	}

	private int DailyTributeFrom1To2
	{
		get
		{
			return _dailyTributeFrom1To2;
		}
		set
		{
			_dailyTributeFrom1To2 = value;
		}
	}

	private int DailyTributeFrom2To1
	{
		get
		{
			return -_dailyTributeFrom1To2;
		}
		set
		{
			_dailyTributeFrom1To2 = -value;
		}
	}

	public int DailyTributeInstallments
	{
		get
		{
			return _dailyTributeInstallments;
		}
		set
		{
			_dailyTributeInstallments = value;
		}
	}

	public int SuccessfulTownSieges1
	{
		get
		{
			return _successfulTownSieges1;
		}
		set
		{
			_successfulTownSieges1 = value;
		}
	}

	public int SuccessfulTownSieges2
	{
		get
		{
			return _successfulTownSieges2;
		}
		set
		{
			_successfulTownSieges2 = value;
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsStanceLink(object o, List<object> collectedObjects)
	{
		((StanceLink)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(_warStartDate, collectedObjects);
		CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(_peaceDeclarationDate, collectedObjects);
		collectedObjects.Add(Faction1);
		collectedObjects.Add(Faction2);
	}

	internal static object AutoGeneratedGetMemberValueFaction1(object o)
	{
		return ((StanceLink)o).Faction1;
	}

	internal static object AutoGeneratedGetMemberValueFaction2(object o)
	{
		return ((StanceLink)o).Faction2;
	}

	internal static object AutoGeneratedGetMemberValueShipCasualties1(object o)
	{
		return ((StanceLink)o).ShipCasualties1;
	}

	internal static object AutoGeneratedGetMemberValueShipCasualties2(object o)
	{
		return ((StanceLink)o).ShipCasualties2;
	}

	internal static object AutoGeneratedGetMemberValueBehaviorPriority(object o)
	{
		return ((StanceLink)o).BehaviorPriority;
	}

	internal static object AutoGeneratedGetMemberValue_stanceType(object o)
	{
		return ((StanceLink)o)._stanceType;
	}

	internal static object AutoGeneratedGetMemberValue_warStartDate(object o)
	{
		return ((StanceLink)o)._warStartDate;
	}

	internal static object AutoGeneratedGetMemberValue_peaceDeclarationDate(object o)
	{
		return ((StanceLink)o)._peaceDeclarationDate;
	}

	internal static object AutoGeneratedGetMemberValue_troopCasualties1(object o)
	{
		return ((StanceLink)o)._troopCasualties1;
	}

	internal static object AutoGeneratedGetMemberValue_troopCasualties2(object o)
	{
		return ((StanceLink)o)._troopCasualties2;
	}

	internal static object AutoGeneratedGetMemberValue_successfulSieges1(object o)
	{
		return ((StanceLink)o)._successfulSieges1;
	}

	internal static object AutoGeneratedGetMemberValue_successfulSieges2(object o)
	{
		return ((StanceLink)o)._successfulSieges2;
	}

	internal static object AutoGeneratedGetMemberValue_successfulRaids1(object o)
	{
		return ((StanceLink)o)._successfulRaids1;
	}

	internal static object AutoGeneratedGetMemberValue_successfulRaids2(object o)
	{
		return ((StanceLink)o)._successfulRaids2;
	}

	internal static object AutoGeneratedGetMemberValue_totalTributePaidFrom1To2(object o)
	{
		return ((StanceLink)o)._totalTributePaidFrom1To2;
	}

	internal static object AutoGeneratedGetMemberValue_dailyTributeFrom1To2(object o)
	{
		return ((StanceLink)o)._dailyTributeFrom1To2;
	}

	internal static object AutoGeneratedGetMemberValue_dailyTributeInstallments(object o)
	{
		return ((StanceLink)o)._dailyTributeInstallments;
	}

	internal static object AutoGeneratedGetMemberValue_successfulTownSieges1(object o)
	{
		return ((StanceLink)o)._successfulTownSieges1;
	}

	internal static object AutoGeneratedGetMemberValue_successfulTownSieges2(object o)
	{
		return ((StanceLink)o)._successfulTownSieges2;
	}

	public int GetCasualties(IFaction faction)
	{
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return _troopCasualties2;
		}
		return _troopCasualties1;
	}

	public int GetSuccessfulSieges(IFaction faction)
	{
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return _successfulSieges2;
		}
		return _successfulSieges1;
	}

	public int GetSuccessfulRaids(IFaction faction)
	{
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return _successfulRaids2;
		}
		return _successfulRaids1;
	}

	public int GetTotalTributePaid(IFaction faction)
	{
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return TotalTributePaidFrom2To1;
		}
		return TotalTributePaidFrom1To2;
	}

	public int GetSuccessfulTownSieges(IFaction faction)
	{
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return _successfulTownSieges2;
		}
		return _successfulTownSieges1;
	}

	internal StanceLink(StanceType stanceType, IFaction faction1, IFaction faction2)
	{
		_stanceType = stanceType;
		Faction1 = faction1;
		Faction2 = faction2;
	}

	[LoadInitializationCallback]
	private void OnLoad(MetaData metaData, ObjectLoadData objectLoadData)
	{
		if (!MBSaveLoad.LastLoadedGameVersion.IsOlderThan(ApplicationVersion.FromString("v1.3.0.89349")) || !objectLoadData.HasMember(200) || !objectLoadData.HasMember(210))
		{
			return;
		}
		int num = (int)objectLoadData.GetFieldValueBySaveId(200);
		int num2 = (int)objectLoadData.GetFieldValueBySaveId(210);
		_totalTributePaidFrom1To2 = ((num != 0) ? num : (-num2));
		if (_dailyTributeFrom1To2 != 0)
		{
			IFaction payer = ((_dailyTributeFrom1To2 > 0) ? Faction1 : Faction2);
			int num3 = Math.Abs(_dailyTributeFrom1To2);
			int num4 = Math.Abs(_totalTributePaidFrom1To2);
			int num5 = 100 - num4 / num3;
			if (num5 <= 0)
			{
				SetDailyTributePaid(payer, 0, 0);
			}
			else
			{
				SetDailyTributePaid(payer, num3, num5);
			}
		}
	}

	internal void ResetPeaceStats()
	{
		ResetStats();
		PeaceDeclarationDate = CampaignTime.Now;
	}

	private void ResetStats()
	{
		TroopCasualties1 = 0;
		TroopCasualties2 = 0;
		ShipCasualties1 = 0;
		ShipCasualties2 = 0;
		SuccessfulRaids1 = 0;
		SuccessfulRaids2 = 0;
		SuccessfulSieges1 = 0;
		SuccessfulSieges2 = 0;
		_dailyTributeFrom1To2 = 0;
		_totalTributePaidFrom1To2 = 0;
		DailyTributeInstallments = 0;
		SuccessfulTownSieges1 = 0;
		SuccessfulTownSieges2 = 0;
	}

	public int GetDailyTributeToPay(IFaction faction)
	{
		if (GetRemainingTributePaymentCount() == 0)
		{
			return 0;
		}
		if (faction != Faction1)
		{
			if (faction != Faction2)
			{
				return 0;
			}
			return DailyTributeFrom2To1;
		}
		return DailyTributeFrom1To2;
	}

	public void SetDailyTributePaid(IFaction payer, int dailyTribute, int dailyTributeInstallments)
	{
		DailyTributeFrom1To2 = ((payer == Faction1) ? dailyTribute : ((payer == Faction2) ? (-dailyTribute) : 0));
		DailyTributeInstallments = dailyTributeInstallments;
	}

	public int GetRemainingTributePaymentCount()
	{
		if (((((DailyTributeFrom1To2 > 0) ? Faction1 : Faction2) == Faction1) ? DailyTributeFrom1To2 : DailyTributeFrom2To1) == 0)
		{
			return 0;
		}
		int val = (_dailyTributeInstallments * _dailyTributeFrom1To2 - TotalTributePaidFrom1To2) / _dailyTributeFrom1To2;
		return Math.Max(0, val);
	}
}
