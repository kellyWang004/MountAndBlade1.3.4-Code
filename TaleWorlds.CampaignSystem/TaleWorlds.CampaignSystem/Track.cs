using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Load;

namespace TaleWorlds.CampaignSystem;

public sealed class Track : ILocatable<Track>, IInteractablePoint
{
	public enum PartyTypeEnum
	{
		Default,
		Lord,
		Bandit,
		Villager,
		GarrisonParty,
		PartyTypesCount,
		Caravan
	}

	[CachedData]
	private int _locatorNodeIndex;

	[SaveableField(117)]
	private Track _nextLocatable;

	[SaveableField(2)]
	public CampaignVec2 Position;

	[SaveableField(1)]
	public float Direction;

	[SaveableField(10)]
	public TextObject PartyName;

	[SaveableField(20)]
	public CultureObject Culture;

	[SaveableField(30)]
	public float Speed;

	[SaveableField(40)]
	public int NumberOfAllMembers;

	[SaveableField(50)]
	public int NumberOfHealthyMembers;

	[SaveableField(60)]
	public int NumberOfMenWithHorse;

	[SaveableField(70)]
	public int NumberOfMenWithoutHorse;

	[SaveableField(80)]
	public int NumberOfPackAnimals;

	[SaveableField(90)]
	public int NumberOfPrisoners;

	[SaveableField(100)]
	public CampaignTime CreationTime;

	[SaveableField(140)]
	public float Life;

	[SaveableField(150)]
	public PartyTypeEnum PartyType;

	public Vec2 GetPosition2D => Position.ToVec2();

	int ILocatable<Track>.LocatorNodeIndex
	{
		get
		{
			return _locatorNodeIndex;
		}
		set
		{
			_locatorNodeIndex = value;
		}
	}

	Track ILocatable<Track>.NextLocatable
	{
		get
		{
			return _nextLocatable;
		}
		set
		{
			_nextLocatable = value;
		}
	}

	public int Size => NumberOfAllMembers + NumberOfPrisoners;

	[SaveableProperty(110)]
	public bool IsDetected { get; set; }

	[SaveableProperty(120)]
	public bool IsPointer { get; set; }

	[SaveableProperty(130)]
	public bool IsEnemy { get; set; }

	public bool IsExpired => CreationTime.ElapsedHoursUntilNow > Life;

	public bool IsAlive => !IsExpired;

	public float Scale => Campaign.Current.Models.MapTrackModel.GetTrackScale(this);

	internal static void AutoGeneratedStaticCollectObjectsTrack(object o, List<object> collectedObjects)
	{
		((Track)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		CampaignVec2.AutoGeneratedStaticCollectObjectsCampaignVec2(Position, collectedObjects);
		collectedObjects.Add(PartyName);
		collectedObjects.Add(Culture);
		CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(CreationTime, collectedObjects);
		collectedObjects.Add(_nextLocatable);
	}

	internal static object AutoGeneratedGetMemberValueIsDetected(object o)
	{
		return ((Track)o).IsDetected;
	}

	internal static object AutoGeneratedGetMemberValueIsPointer(object o)
	{
		return ((Track)o).IsPointer;
	}

	internal static object AutoGeneratedGetMemberValueIsEnemy(object o)
	{
		return ((Track)o).IsEnemy;
	}

	internal static object AutoGeneratedGetMemberValuePosition(object o)
	{
		return ((Track)o).Position;
	}

	internal static object AutoGeneratedGetMemberValueDirection(object o)
	{
		return ((Track)o).Direction;
	}

	internal static object AutoGeneratedGetMemberValuePartyName(object o)
	{
		return ((Track)o).PartyName;
	}

	internal static object AutoGeneratedGetMemberValueCulture(object o)
	{
		return ((Track)o).Culture;
	}

	internal static object AutoGeneratedGetMemberValueSpeed(object o)
	{
		return ((Track)o).Speed;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfAllMembers(object o)
	{
		return ((Track)o).NumberOfAllMembers;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfHealthyMembers(object o)
	{
		return ((Track)o).NumberOfHealthyMembers;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfMenWithHorse(object o)
	{
		return ((Track)o).NumberOfMenWithHorse;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfMenWithoutHorse(object o)
	{
		return ((Track)o).NumberOfMenWithoutHorse;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfPackAnimals(object o)
	{
		return ((Track)o).NumberOfPackAnimals;
	}

	internal static object AutoGeneratedGetMemberValueNumberOfPrisoners(object o)
	{
		return ((Track)o).NumberOfPrisoners;
	}

	internal static object AutoGeneratedGetMemberValueCreationTime(object o)
	{
		return ((Track)o).CreationTime;
	}

	internal static object AutoGeneratedGetMemberValueLife(object o)
	{
		return ((Track)o).Life;
	}

	internal static object AutoGeneratedGetMemberValuePartyType(object o)
	{
		return ((Track)o).PartyType;
	}

	internal static object AutoGeneratedGetMemberValue_nextLocatable(object o)
	{
		return ((Track)o)._nextLocatable;
	}

	CampaignVec2 IInteractablePoint.GetInteractionPosition(MobileParty interactingParty)
	{
		return Position;
	}

	public bool CanPartyInteract(MobileParty mobileParty, float dt)
	{
		return false;
	}

	void IInteractablePoint.OnPartyInteraction(MobileParty mobileParty)
	{
	}

	public static PartyTypeEnum GetPartyTypeEnum(MobileParty party)
	{
		if (party.IsBandit)
		{
			return PartyTypeEnum.Bandit;
		}
		if (party.IsVillager)
		{
			return PartyTypeEnum.Villager;
		}
		if (party.IsCaravan)
		{
			return PartyTypeEnum.Caravan;
		}
		if (party.IsLordParty)
		{
			return PartyTypeEnum.Lord;
		}
		return PartyTypeEnum.Default;
	}

	public Track()
	{
		Reset();
	}

	public void Reset()
	{
		PartyName = TextObject.GetEmpty();
		Culture = null;
		_locatorNodeIndex = -1;
		_nextLocatable = null;
	}

	[LoadInitializationCallback]
	private void OnLoad(MetaData metaData, ObjectLoadData objectLoadData)
	{
		_locatorNodeIndex = -1;
		if (MBSaveLoad.LastLoadedGameVersion.IsOlderThan(ApplicationVersion.FromString("v1.3.0")))
		{
			Vec2 pos = (Vec2)objectLoadData.GetMemberValueBySaveId(0);
			Position = new CampaignVec2(pos, isOnLand: true);
		}
	}
}
