using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem;

public struct CampaignVec2 : ISavedStruct
{
	[SaveableField(1)]
	private Vec2 _position;

	[SaveableField(2)]
	public bool IsOnLand;

	[CachedData]
	private bool _isPositionCacheValid;

	[CachedData]
	private PathFaceRecord _faceCache;

	public static CampaignVec2 Invalid => new CampaignVec2(Vec2.Invalid, isOnLand: true);

	public static CampaignVec2 Zero => new CampaignVec2(Vec2.Zero, isOnLand: true);

	public float X => _position.X;

	public float Y => _position.Y;

	public PathFaceRecord Face
	{
		get
		{
			if (!_isPositionCacheValid)
			{
				_faceCache = Campaign.Current.MapSceneWrapper.GetFaceIndex(in this);
				_isPositionCacheValid = true;
			}
			return _faceCache;
		}
	}

	public float Length => _position.Length;

	public float LengthSquared => _position.LengthSquared;

	public float RotationInRadians => _position.RotationInRadians;

	public static void AutoGeneratedStaticCollectObjectsCampaignVec2(object o, List<object> collectedObjects)
	{
		((CampaignVec2)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
	}

	internal static object AutoGeneratedGetMemberValueIsOnLand(object o)
	{
		return ((CampaignVec2)o).IsOnLand;
	}

	internal static object AutoGeneratedGetMemberValue_position(object o)
	{
		return ((CampaignVec2)o)._position;
	}

	public CampaignVec2(Vec2 pos, bool isOnLand)
	{
		_faceCache = PathFaceRecord.NullFaceRecord;
		_position = pos;
		IsOnLand = isOnLand;
		_isPositionCacheValid = false;
	}

	public static CampaignVec2 operator +(CampaignVec2 v1, CampaignVec2 v2)
	{
		return new CampaignVec2(v1._position + v2._position, v1.IsOnLand);
	}

	public static CampaignVec2 operator -(CampaignVec2 v1, CampaignVec2 v2)
	{
		return new CampaignVec2(v1._position - v2._position, v1.IsOnLand);
	}

	public static CampaignVec2 operator +(CampaignVec2 v1, Vec2 v2)
	{
		return new CampaignVec2(v1._position + v2, v1.IsOnLand);
	}

	public static CampaignVec2 operator -(CampaignVec2 v1, Vec2 v2)
	{
		return new CampaignVec2(v1._position - v2, v1.IsOnLand);
	}

	public static CampaignVec2 operator *(CampaignVec2 v, float f)
	{
		return new CampaignVec2(new Vec2(v.X * f, v.Y * f), v.IsOnLand);
	}

	public static CampaignVec2 operator *(float f, CampaignVec2 v)
	{
		return new CampaignVec2(new Vec2(v.X * f, v.Y * f), v.IsOnLand);
	}

	public static CampaignVec2 operator /(CampaignVec2 v, float f)
	{
		return new CampaignVec2(new Vec2(v.X / f, v.Y / f), v.IsOnLand);
	}

	public void AddVec2(Vec2 vec2)
	{
		_position += vec2;
		_isPositionCacheValid = false;
	}

	public Vec2 ToVec2()
	{
		return _position;
	}

	public static bool operator ==(CampaignVec2 v1, CampaignVec2 v2)
	{
		if (v1._position == v2._position)
		{
			return v1.IsOnLand == v2.IsOnLand;
		}
		return false;
	}

	public static bool operator !=(CampaignVec2 v1, CampaignVec2 v2)
	{
		return !(v1 == v2);
	}

	public override bool Equals(object obj)
	{
		if (obj is CampaignVec2 other)
		{
			return Equals(other);
		}
		return false;
	}

	public Vec3 AsVec3()
	{
		float height = 0f;
		Campaign.Current.MapSceneWrapper.GetHeightAtPoint(in this, ref height);
		return new Vec3(_position, height);
	}

	public bool Equals(CampaignVec2 other)
	{
		if (_position.Equals(other._position))
		{
			return IsOnLand == other.IsOnLand;
		}
		return false;
	}

	public bool IsValid()
	{
		if (_position.IsValid && Face.IsValid())
		{
			return Campaign.Current.Models.PartyNavigationModel.IsTerrainTypeValidForNavigationType(Campaign.Current.MapSceneWrapper.GetFaceTerrainType(Face), IsOnLand ? MobileParty.NavigationType.Default : MobileParty.NavigationType.Naval);
		}
		return false;
	}

	public float DistanceSquared(CampaignVec2 v)
	{
		return _position.DistanceSquared(v._position);
	}

	public float DistanceSquared(Vec2 v)
	{
		return _position.DistanceSquared(v);
	}

	public float Distance(CampaignVec2 v)
	{
		return _position.Distance(v._position);
	}

	public float Distance(Vec2 v)
	{
		return _position.Distance(v);
	}

	public override string ToString()
	{
		return "(CampaignVec2) X: " + X + " Y: " + Y + " IsOnLand: " + IsOnLand.ToString();
	}

	public bool IsDefault()
	{
		return _position == Vec2.Zero;
	}

	public bool IsNonZero()
	{
		return _position.IsNonZero();
	}

	public bool NearlyEquals(Vec2 v, float epsilon = 1E-05f)
	{
		return _position.NearlyEquals(v, epsilon);
	}

	public bool NearlyEquals(CampaignVec2 v, float epsilon = 1E-05f)
	{
		return _position.NearlyEquals(v._position, epsilon);
	}

	public float Normalize()
	{
		_isPositionCacheValid = false;
		return _position.Normalize();
	}

	public static CampaignVec2 Normalized(CampaignVec2 v)
	{
		v.Normalize();
		return v;
	}

	public CampaignVec2 RightVec()
	{
		return new CampaignVec2(new Vec2(Y, 0f - X), IsOnLand);
	}

	public CampaignVec2 LeftVec()
	{
		return new CampaignVec2(new Vec2(0f - Y, X), IsOnLand);
	}

	public override int GetHashCode()
	{
		int hashCode = _position.GetHashCode();
		hashCode <<= 1;
		if (IsOnLand)
		{
			hashCode++;
		}
		return hashCode;
	}
}
