using System.Collections.Generic;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Load;

namespace TaleWorlds.CampaignSystem;

public class VisualTrackerManager
{
	[SaveableField(1)]
	private Dictionary<ITrackableBase, TrackedObject> _trackedObjects;

	[CachedData]
	public int TrackedObjectsVersion { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsVisualTrackerManager(object o, List<object> collectedObjects)
	{
		((VisualTrackerManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		collectedObjects.Add(_trackedObjects);
	}

	internal static object AutoGeneratedGetMemberValue_trackedObjects(object o)
	{
		return ((VisualTrackerManager)o)._trackedObjects;
	}

	public VisualTrackerManager()
	{
		_trackedObjects = new Dictionary<ITrackableBase, TrackedObject>();
		TrackedObjectsVersion = 0;
	}

	[LateLoadInitializationCallback]
	private void OnLateLoad(MetaData metaData, ObjectLoadData objectLoadData)
	{
		if (MBSaveLoad.IsUpdatingGameVersion && MBSaveLoad.LastLoadedGameVersion.IsOlderThan(ApplicationVersion.FromString("v1.3.0")))
		{
			_trackedObjects = new Dictionary<ITrackableBase, TrackedObject>();
			RetrieveTrackedObjectsFromOldVersion(objectLoadData);
		}
		if (_trackedObjects == null)
		{
			_trackedObjects = new Dictionary<ITrackableBase, TrackedObject>();
		}
	}

	private void RetrieveTrackedObjectsFromOldVersion(ObjectLoadData objectLoadData)
	{
		if (objectLoadData.GetMemberValueBySaveId(0) is IReadOnlyCollection<TrackedObject> readOnlyCollection)
		{
			foreach (TrackedObject item in readOnlyCollection)
			{
				_trackedObjects.Add(item.Object, item);
			}
		}
		else
		{
			Debug.FailedAssert("Failed to recover tracked objects from old save file.", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\VisualTrackerManager.cs", "RetrieveTrackedObjectsFromOldVersion", 60);
		}
		TrackedObjectsVersion++;
	}

	public void RegisterObject(ITrackableCampaignObject trackableObject)
	{
		if (trackableObject == null)
		{
			Debug.FailedAssert("Registered tracked object is null", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\VisualTrackerManager.cs", "RegisterObject", 70);
			return;
		}
		if (_trackedObjects.TryGetValue(trackableObject, out var value))
		{
			value.TrackerCount++;
			return;
		}
		_trackedObjects.Add(trackableObject, new TrackedObject(trackableObject));
		TrackedObjectsVersion++;
	}

	public bool CheckTracked(ITrackableBase trackableObject)
	{
		return _trackedObjects.ContainsKey(trackableObject);
	}

	public void RemoveTrackedObject(ITrackableBase trackableObject, bool forceRemove = false)
	{
		TrackedObject value;
		if (trackableObject == null)
		{
			Debug.FailedAssert("Trying to remove null trackable object", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\VisualTrackerManager.cs", "RemoveTrackedObject", 94);
		}
		else if (_trackedObjects.TryGetValue(trackableObject, out value))
		{
			value.TrackerCount--;
			if (value.TrackerCount == 0 || forceRemove)
			{
				_trackedObjects.Remove(trackableObject);
				TrackedObjectsVersion++;
			}
		}
	}

	private void ResetTracker()
	{
		_trackedObjects.Clear();
		TrackedObjectsVersion++;
	}

	public void SetDirty()
	{
		TrackedObjectsVersion++;
	}
}
