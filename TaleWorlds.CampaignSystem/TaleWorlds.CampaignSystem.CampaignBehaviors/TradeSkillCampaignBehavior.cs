using System.Collections.Generic;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Inventory;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.CampaignBehaviors;

public class TradeSkillCampaignBehavior : CampaignBehaviorBase, IPlayerTradeBehavior
{
	public class TradeSkillCampaignBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public TradeSkillCampaignBehaviorTypeDefiner()
			: base(150794)
		{
		}

		protected override void DefineStructTypes()
		{
			AddStructDefinition(typeof(ItemTradeData), 10);
		}

		protected override void DefineContainerDefinitions()
		{
			ConstructContainerDefinition(typeof(Dictionary<ItemObject, ItemTradeData>));
		}
	}

	internal struct ItemTradeData
	{
		[SaveableField(10)]
		public readonly float AveragePrice;

		[SaveableField(20)]
		public readonly int NumItemsPurchased;

		public ItemTradeData(float averagePrice, int numItemsPurchased)
		{
			AveragePrice = averagePrice;
			NumItemsPurchased = numItemsPurchased;
		}

		public static void AutoGeneratedStaticCollectObjectsItemTradeData(object o, List<object> collectedObjects)
		{
			((ItemTradeData)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
		}

		internal static object AutoGeneratedGetMemberValueAveragePrice(object o)
		{
			return ((ItemTradeData)o).AveragePrice;
		}

		internal static object AutoGeneratedGetMemberValueNumItemsPurchased(object o)
		{
			return ((ItemTradeData)o).NumItemsPurchased;
		}
	}

	private Dictionary<ItemObject, ItemTradeData> ItemsTradeData = new Dictionary<ItemObject, ItemTradeData>();

	public override void RegisterEvents()
	{
		CampaignEvents.PlayerInventoryExchangeEvent.AddNonSerializedListener(this, PlayerInventoryUpdated);
	}

	private void RecordPurchases(ItemRosterElement itemRosterElement, int totalPrice)
	{
		if (!ItemsTradeData.TryGetValue(itemRosterElement.EquipmentElement.Item, out var value))
		{
			value = default(ItemTradeData);
		}
		int num = value.NumItemsPurchased + itemRosterElement.Amount;
		float averagePrice = (value.AveragePrice * (float)value.NumItemsPurchased + (float)totalPrice) / MathF.Max(0.0001f, (float)num);
		ItemsTradeData[itemRosterElement.EquipmentElement.Item] = new ItemTradeData(averagePrice, num);
	}

	private int RecordSales(ItemRosterElement itemRosterElement, int totalPrice, bool isTrading)
	{
		int result = 0;
		if (ItemsTradeData.TryGetValue(itemRosterElement.EquipmentElement.Item, out var value))
		{
			if (isTrading)
			{
				int num = MathF.Min(value.NumItemsPurchased, itemRosterElement.Amount);
				int num2 = value.NumItemsPurchased - num;
				float f = (float)num * value.AveragePrice;
				float num3 = (float)totalPrice / MathF.Max(0.001f, (float)itemRosterElement.Amount);
				int num4 = MathF.Round((float)num * num3);
				result = MathF.Max(0, num4 - MathF.Floor(f));
				if (num2 == 0)
				{
					ItemsTradeData.Remove(itemRosterElement.EquipmentElement.Item);
				}
				else
				{
					ItemsTradeData[itemRosterElement.EquipmentElement.Item] = new ItemTradeData(value.AveragePrice, num2);
				}
			}
			else
			{
				int num5 = MobileParty.MainParty.ItemRoster.FindIndexOfElement(itemRosterElement.EquipmentElement);
				if (num5 == -1)
				{
					ItemsTradeData.Remove(itemRosterElement.EquipmentElement.Item);
				}
				else
				{
					int amount = MobileParty.MainParty.ItemRoster.GetElementCopyAtIndex(num5).Amount;
					if (value.NumItemsPurchased > amount)
					{
						ItemsTradeData[itemRosterElement.EquipmentElement.Item] = new ItemTradeData(value.AveragePrice, amount);
					}
				}
			}
		}
		return result;
	}

	private int GetAveragePriceForItem(ItemRosterElement itemRosterElement)
	{
		if (!ItemsTradeData.TryGetValue(itemRosterElement.EquipmentElement.Item, out var value))
		{
			return 0;
		}
		return MathF.Round(value.AveragePrice);
	}

	private void PlayerInventoryUpdated(List<(ItemRosterElement, int)> purchasedItems, List<(ItemRosterElement, int)> soldItems, bool isTrading)
	{
		int num = 0;
		if (isTrading)
		{
			foreach (var purchasedItem in purchasedItems)
			{
				ProcessPurchases(purchasedItem.Item1, purchasedItem.Item2);
			}
		}
		foreach (var soldItem in soldItems)
		{
			num += ProcessSales(soldItem.Item1, soldItem.Item2, isTrading);
		}
		if (isTrading)
		{
			SkillLevelingManager.OnTradeProfitMade(PartyBase.MainParty, num);
			CampaignEventDispatcher.Instance.OnPlayerTradeProfit(num);
		}
	}

	private int ProcessSales(ItemRosterElement itemRosterElement, int totalPrice, bool isTrading)
	{
		if (itemRosterElement.EquipmentElement.ItemModifier == null)
		{
			return RecordSales(itemRosterElement, totalPrice, isTrading);
		}
		return 0;
	}

	private void ProcessPurchases(ItemRosterElement itemRosterElement, int totalPrice)
	{
		if (itemRosterElement.EquipmentElement.ItemModifier == null)
		{
			RecordPurchases(itemRosterElement, totalPrice);
		}
	}

	public override void SyncData(IDataStore dataStore)
	{
		dataStore.SyncData("ItemsTradeData", ref ItemsTradeData);
	}

	public int GetProjectedProfit(ItemRosterElement itemRosterElement, int itemCost)
	{
		if (itemRosterElement.EquipmentElement.ItemModifier != null)
		{
			return 0;
		}
		int averagePriceForItem = GetAveragePriceForItem(itemRosterElement);
		return itemCost - averagePriceForItem;
	}
}
