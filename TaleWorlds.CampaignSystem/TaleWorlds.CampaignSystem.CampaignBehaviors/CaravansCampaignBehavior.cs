using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Naval;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Party.PartyComponents;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Settlements.Buildings;
using TaleWorlds.CampaignSystem.Siege;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.CampaignBehaviors;

public class CaravansCampaignBehavior : CampaignBehaviorBase
{
	public class CaravansCampaignBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public CaravansCampaignBehaviorTypeDefiner()
			: base(60000)
		{
		}

		protected override void DefineEnumTypes()
		{
			AddEnumDefinition(typeof(PlayerInteraction), 1);
		}

		protected override void DefineContainerDefinitions()
		{
			ConstructContainerDefinition(typeof(Dictionary<MobileParty, PlayerInteraction>));
			ConstructContainerDefinition(typeof(List<TradeActionLog>));
			ConstructContainerDefinition(typeof(Dictionary<MobileParty, List<TradeActionLog>>));
		}

		protected override void DefineClassTypes()
		{
			AddClassDefinition(typeof(TradeActionLog), 2);
		}
	}

	private enum PlayerInteraction
	{
		None,
		Friendly,
		TradedWith,
		Hostile
	}

	private struct PriceIndexData
	{
		internal readonly float AverageBuySellPriceIndex;

		internal readonly float MinBuySellPriceIndex;

		public PriceIndexData(float averageBuySellPriceIndex, float minBuySellPriceIndex)
		{
			AverageBuySellPriceIndex = averageBuySellPriceIndex;
			MinBuySellPriceIndex = minBuySellPriceIndex;
		}
	}

	internal class TradeActionLog
	{
		[SaveableField(0)]
		public Settlement BoughtSettlement;

		[SaveableField(1)]
		public int BuyPrice;

		[SaveableField(2)]
		public int SellPrice;

		[SaveableField(3)]
		public ItemRosterElement ItemRosterElement;

		[SaveableField(4)]
		public Settlement SoldSettlement;

		[SaveableField(5)]
		public CampaignTime BoughtTime;

		public float ProfitRate => (float)SellPrice / (float)BuyPrice;

		public void OnSellAction(Settlement soldSettlement, int sellPrice)
		{
			SellPrice = sellPrice;
			SoldSettlement = soldSettlement;
		}

		public void Reset()
		{
			BoughtSettlement = null;
			SoldSettlement = null;
			SellPrice = 0;
			BuyPrice = 0;
		}

		internal static void AutoGeneratedStaticCollectObjectsTradeActionLog(object o, List<object> collectedObjects)
		{
			((TradeActionLog)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(BoughtSettlement);
			ItemRosterElement.AutoGeneratedStaticCollectObjectsItemRosterElement(ItemRosterElement, collectedObjects);
			collectedObjects.Add(SoldSettlement);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(BoughtTime, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueBoughtSettlement(object o)
		{
			return ((TradeActionLog)o).BoughtSettlement;
		}

		internal static object AutoGeneratedGetMemberValueBuyPrice(object o)
		{
			return ((TradeActionLog)o).BuyPrice;
		}

		internal static object AutoGeneratedGetMemberValueSellPrice(object o)
		{
			return ((TradeActionLog)o).SellPrice;
		}

		internal static object AutoGeneratedGetMemberValueItemRosterElement(object o)
		{
			return ((TradeActionLog)o).ItemRosterElement;
		}

		internal static object AutoGeneratedGetMemberValueSoldSettlement(object o)
		{
			return ((TradeActionLog)o).SoldSettlement;
		}

		internal static object AutoGeneratedGetMemberValueBoughtTime(object o)
		{
			return ((TradeActionLog)o).BoughtTime;
		}
	}

	internal class TradeActionLogPool
	{
		private Stack<TradeActionLog> _stack;

		public int Size => _stack?.Count ?? 0;

		private int MaxSize { get; }

		public TradeActionLogPool(int size)
		{
			MaxSize = size;
			_stack = new Stack<TradeActionLog>(size);
			for (int i = 0; i < size; i++)
			{
				_stack.Push(new TradeActionLog());
			}
		}

		public TradeActionLog CreateNewLog(Settlement boughtSettlement, int buyPrice, ItemRosterElement itemRosterElement)
		{
			TradeActionLog obj = ((_stack.Count > 0) ? _stack.Pop() : new TradeActionLog());
			obj.BoughtSettlement = boughtSettlement;
			obj.BuyPrice = buyPrice;
			obj.ItemRosterElement = itemRosterElement;
			obj.BoughtTime = CampaignTime.Now;
			return obj;
		}

		public void ReleaseLog(TradeActionLog log)
		{
			log.Reset();
			if (_stack.Count < MaxSize)
			{
				_stack.Push(log);
			}
		}

		public override string ToString()
		{
			return $"TrackPool: {Size}";
		}
	}

	private const float InventoryFullnessGoal = 0.9f;

	private const float AverageCaravanWaitAtSettlement = 3f;

	private const float ProfitRateRumorThreshold = 1.2f;

	private const float ReferenceBudgetValue = 5000f;

	private const float HighSecurityThreshold = 75f;

	private const float MustDiscardPriorityValue = float.MinValue;

	private const float CaravanTradeAgreementBonus = 2f;

	private const float ConvoyTradeAgreementBonus = 1.5f;

	private float _navalCaravanVeryFarCache = -1f;

	private float _defaultCaravanVeryFarCache = -1f;

	private ITradeAgreementsCampaignBehavior _tradeAgreementsBehavior;

	private Dictionary<MobileParty, CampaignTime> _tradeRumorTakenCaravans = new Dictionary<MobileParty, CampaignTime>();

	private Dictionary<MobileParty, CampaignTime> _caravanLastHomeTownVisitTime = new Dictionary<MobileParty, CampaignTime>();

	private Dictionary<MobileParty, CampaignTime> _lootedCaravans = new Dictionary<MobileParty, CampaignTime>();

	private Dictionary<MobileParty, PlayerInteraction> _interactedCaravans = new Dictionary<MobileParty, PlayerInteraction>();

	private Dictionary<MobileParty, List<TradeActionLog>> _tradeActionLogs = new Dictionary<MobileParty, List<TradeActionLog>>();

	private TradeActionLogPool _tradeActionLogPool;

	private List<Kingdom> _prohibitedKingdomsForPlayerCaravans = new List<Kingdom>();

	private int _packAnimalCategoryIndex = -1;

	private readonly Dictionary<ItemCategory, float> _averageValuesCached = new Dictionary<ItemCategory, float>();

	private readonly Dictionary<ItemCategory, PriceIndexData> _priceDictionary = new Dictionary<ItemCategory, PriceIndexData>();

	private readonly Dictionary<ItemCategory, PriceIndexData> _coastalPriceDictionary = new Dictionary<ItemCategory, PriceIndexData>();

	private readonly Dictionary<ItemCategory, int> _totalValueOfItemsAtCategory = new Dictionary<ItemCategory, int>();

	private int MaxNumberOfItemsToBuyFromSingleCategory => Campaign.Current.Models.CaravanModel.MaxNumberOfItemsToBuyFromSingleCategory;

	public ITradeAgreementsCampaignBehavior TradeAgreementsCampaignBehavior
	{
		get
		{
			if (_tradeAgreementsBehavior == null)
			{
				_tradeAgreementsBehavior = Campaign.Current.GetCampaignBehavior<ITradeAgreementsCampaignBehavior>();
			}
			return _tradeAgreementsBehavior;
		}
	}

	private float GetDistanceLimitVeryFarAsDaysForNavigationType(bool isNavalCaravan)
	{
		if (!isNavalCaravan)
		{
			return _defaultCaravanVeryFarCache;
		}
		return _navalCaravanVeryFarCache;
	}

	private float GetDistanceLimitFarAsDaysForNavigationType(bool isNavalCaravan)
	{
		return GetDistanceLimitVeryFarAsDaysForNavigationType(isNavalCaravan) * 0.75f;
	}

	private float GetDistanceLimitMediumAsDaysForNavigationType(bool isNavalCaravan)
	{
		return GetDistanceLimitVeryFarAsDaysForNavigationType(isNavalCaravan) * 0.5f;
	}

	private float GetDistanceLimitCloseAsDaysForNavigationType(bool isNavalCaravan)
	{
		return GetDistanceLimitVeryFarAsDaysForNavigationType(isNavalCaravan) * 0.25f;
	}

	public CaravansCampaignBehavior()
	{
		_tradeActionLogPool = new TradeActionLogPool(4096);
	}

	public override void RegisterEvents()
	{
		CampaignEvents.SettlementEntered.AddNonSerializedListener(this, OnSettlementEntered);
		CampaignEvents.OnSettlementLeftEvent.AddNonSerializedListener(this, OnSettlementLeft);
		CampaignEvents.DailyTickEvent.AddNonSerializedListener(this, DailyTick);
		CampaignEvents.DailyTickHeroEvent.AddNonSerializedListener(this, DailyTickHero);
		CampaignEvents.HourlyTickPartyEvent.AddNonSerializedListener(this, HourlyTickParty);
		CampaignEvents.OnSessionLaunchedEvent.AddNonSerializedListener(this, OnSessionLaunched);
		CampaignEvents.OnNewGameCreatedPartialFollowUpEndEvent.AddNonSerializedListener(this, OnNewGameCreatedPartialFollowUpEndEvent);
		CampaignEvents.MobilePartyDestroyed.AddNonSerializedListener(this, OnMobilePartyDestroyed);
		CampaignEvents.MobilePartyCreated.AddNonSerializedListener(this, OnMobilePartyCreated);
		CampaignEvents.MapEventEnded.AddNonSerializedListener(this, OnMapEventEnded);
		CampaignEvents.OnLootDistributedToPartyEvent.AddNonSerializedListener(this, OnLootDistributedToParty);
		CampaignEvents.OnSiegeEventStartedEvent.AddNonSerializedListener(this, OnSiegeEventStarted);
		CampaignEvents.OnGameLoadFinishedEvent.AddNonSerializedListener(this, OnGameLoadFinished);
		CampaignEvents.KingdomDestroyedEvent.AddNonSerializedListener(this, OnKingdomDestroyed);
	}

	private void OnKingdomDestroyed(Kingdom destroyedKingdom)
	{
		if (_prohibitedKingdomsForPlayerCaravans.Contains(destroyedKingdom))
		{
			_prohibitedKingdomsForPlayerCaravans.Remove(destroyedKingdom);
		}
	}

	private void OnGameLoadFinished()
	{
		CreatePriceDataCache();
		foreach (MobileParty allCaravanParty in MobileParty.AllCaravanParties)
		{
			if ((!allCaravanParty.IsActive || !allCaravanParty.IsReady) && _caravanLastHomeTownVisitTime.ContainsKey(allCaravanParty))
			{
				_caravanLastHomeTownVisitTime.Remove(allCaravanParty);
			}
		}
	}

	private void OnSiegeEventStarted(SiegeEvent siegeEvent)
	{
		for (int i = 0; i < siegeEvent.BesiegedSettlement.Parties.Count; i++)
		{
			if (siegeEvent.BesiegedSettlement.Parties[i].IsCaravan)
			{
				siegeEvent.BesiegedSettlement.Parties[i].SetMoveModeHold();
			}
		}
	}

	private void OnLootDistributedToParty(PartyBase winnerParty, PartyBase defeatedParty, ItemRoster lootedItems)
	{
		if (winnerParty.IsMobile && defeatedParty.IsMobile && defeatedParty.MobileParty.IsCaravan)
		{
			SkillLevelingManager.OnLoot(winnerParty.MobileParty, defeatedParty.MobileParty, lootedItems, attacked: true);
		}
	}

	private void OnNewGameCreatedPartialFollowUpEndEvent(CampaignGameStarter obj)
	{
		for (int i = 0; i < 2; i++)
		{
			foreach (Hero allAliveHero in Hero.AllAliveHeroes)
			{
				if (allAliveHero.Clan != Clan.PlayerClan && Campaign.Current.Models.CaravanModel.CanHeroCreateCaravan(allAliveHero))
				{
					SpawnCaravan(allAliveHero, initialSpawn: true);
				}
			}
			UpdateAverageValues();
			DoInitialTradeRuns();
		}
	}

	public override void SyncData(IDataStore dataStore)
	{
		dataStore.SyncData("_tradeRumorTakenCaravans", ref _tradeRumorTakenCaravans);
		dataStore.SyncData("_lootedCaravans", ref _lootedCaravans);
		dataStore.SyncData("_interactedCaravans", ref _interactedCaravans);
		dataStore.SyncData("_tradeActionLogs", ref _tradeActionLogs);
		dataStore.SyncData("_caravanLastHomeTownVisitTime", ref _caravanLastHomeTownVisitTime);
		dataStore.SyncData("_prohibitedKingdomsForPlayerCaravans", ref _prohibitedKingdomsForPlayerCaravans);
	}

	private void DoInitialTradeRuns()
	{
		foreach (MobileParty allCaravanParty in MobileParty.AllCaravanParties)
		{
			Town town = null;
			Town town2 = allCaravanParty.CurrentSettlement?.Town;
			MobileParty.NavigationType navigationType = ((!allCaravanParty.HasNavalNavigationCapability) ? MobileParty.NavigationType.Default : MobileParty.NavigationType.Naval);
			List<(Town, float)> list = new List<(Town, float)>();
			foreach (Town allTown in Town.AllTowns)
			{
				if (allTown.Settlement.HasPort || allCaravanParty.HasLandNavigationCapability)
				{
					float num = float.MaxValue;
					bool flag = navigationType == MobileParty.NavigationType.Naval;
					num = ((allCaravanParty.CurrentSettlement == null) ? Campaign.Current.Models.MapDistanceModel.GetDistance(allCaravanParty, allTown.Settlement, flag, navigationType, out var _) : Campaign.Current.Models.MapDistanceModel.GetDistance(allCaravanParty.CurrentSettlement, allTown.Settlement, flag, flag, navigationType));
					list.Add((allTown, 1f / TaleWorlds.Library.MathF.Pow(num, 1.5f)));
				}
			}
			town = MBRandom.ChooseWeighted(list);
			if (town != null && town2 != null)
			{
				CreatePriceDataCache();
				if (MBRandom.RandomFloat < 0.5f)
				{
					SellGoods(allCaravanParty, town2, 0.7f);
					BuyGoods(allCaravanParty, town2);
					SellGoods(allCaravanParty, town, 0.7f);
				}
				else
				{
					SellGoods(allCaravanParty, town, 0.7f);
					BuyGoods(allCaravanParty, town);
					SellGoods(allCaravanParty, town2, 0.7f);
				}
			}
		}
	}

	public void OnSessionLaunched(CampaignGameStarter campaignGameStarter)
	{
		CacheVeryFarDistances();
		AddDialogs(campaignGameStarter);
		UpdateAverageValues();
	}

	private void CacheVeryFarDistances()
	{
		MobileParty.NavigationType navigationType = MobileParty.NavigationType.Naval;
		float num = 20f;
		float num2 = Campaign.Current.GetAverageDistanceBetweenClosestTwoTownsWithNavigationType(navigationType) * num;
		float num3 = Campaign.Current.EstimatedAverageCaravanPartyNavalSpeed * (float)CampaignTime.HoursInDay;
		_navalCaravanVeryFarCache = num2 / num3;
		navigationType = MobileParty.NavigationType.Default;
		num = 5f;
		num2 = Campaign.Current.GetAverageDistanceBetweenClosestTwoTownsWithNavigationType(navigationType) * num;
		num3 = Campaign.Current.EstimatedAverageCaravanPartySpeed * (float)CampaignTime.HoursInDay;
		_defaultCaravanVeryFarCache = num2 / num3;
	}

	private void OnMapEventEnded(MapEvent mapEvent)
	{
		foreach (PartyBase involvedParty in mapEvent.InvolvedParties)
		{
			if (!involvedParty.IsMobile || !involvedParty.MobileParty.IsCaravan || !mapEvent.IsWinnerSide(involvedParty.Side))
			{
				continue;
			}
			if (involvedParty.MobileParty.HasNavalNavigationCapability)
			{
				DiscardShips(involvedParty.MobileParty);
			}
			MobileParty mobileParty = involvedParty.MobileParty;
			int numberOfPackAnimals = mobileParty.ItemRoster.NumberOfPackAnimals;
			int numberOfLivestockAnimals = mobileParty.ItemRoster.NumberOfLivestockAnimals;
			int numberOfMounts = mobileParty.ItemRoster.NumberOfMounts;
			int totalManCount = mobileParty.MemberRoster.TotalManCount;
			if (involvedParty.MobileParty.HasLandNavigationCapability && (float)(numberOfPackAnimals + numberOfLivestockAnimals + numberOfMounts) > (float)totalManCount * 1.2f)
			{
				int num = numberOfPackAnimals + numberOfLivestockAnimals + numberOfMounts;
				while (num > totalManCount)
				{
					int num2 = 10000;
					ItemRosterElement itemRosterElement = involvedParty.MobileParty.ItemRoster[0];
					foreach (ItemRosterElement item in involvedParty.MobileParty.ItemRoster)
					{
						if (item.EquipmentElement.Item.IsMountable || item.EquipmentElement.Item.ItemCategory == DefaultItemCategories.PackAnimal || item.EquipmentElement.Item.IsAnimal)
						{
							int itemValue = item.EquipmentElement.ItemValue;
							if (itemValue < num2)
							{
								num2 = itemValue;
								itemRosterElement = item;
							}
						}
					}
					int num3 = TaleWorlds.Library.MathF.Min(itemRosterElement.Amount, TaleWorlds.Library.MathF.Max(1, num - totalManCount));
					mobileParty.ItemRoster.AddToCounts(itemRosterElement.EquipmentElement, -num3);
					num -= num3;
				}
			}
			int inventoryCapacity = mobileParty.InventoryCapacity;
			float totalWeightCarried = mobileParty.TotalWeightCarried;
			float num4 = 0f;
			if (!(totalWeightCarried - num4 > (float)inventoryCapacity))
			{
				continue;
			}
			int num6;
			float weight;
			for (; totalWeightCarried - num4 > (float)inventoryCapacity; num4 += weight * (float)num6)
			{
				int num5 = 10000;
				ItemRosterElement itemRosterElement2 = involvedParty.MobileParty.ItemRoster[0];
				foreach (ItemRosterElement item2 in involvedParty.MobileParty.ItemRoster)
				{
					if (!item2.EquipmentElement.Item.IsMountable)
					{
						int itemValue2 = item2.EquipmentElement.ItemValue;
						if (itemValue2 < num5)
						{
							num5 = itemValue2;
							itemRosterElement2 = item2;
						}
					}
				}
				int val = TaleWorlds.Library.MathF.Ceiling((totalWeightCarried - num4 - (float)inventoryCapacity) / itemRosterElement2.EquipmentElement.Weight);
				num6 = Math.Max(1, Math.Min(itemRosterElement2.Amount, val));
				weight = itemRosterElement2.EquipmentElement.Weight;
				mobileParty.ItemRoster.AddToCounts(itemRosterElement2.EquipmentElement, -num6);
			}
		}
	}

	public void SpawnCaravan(Hero hero, bool initialSpawn = false)
	{
		bool flag = Campaign.Current.Models.CaravanModel.GetEliteCaravanSpawnChance(hero) > hero.RandomFloat();
		PartyTemplateObject randomElementWithPredicate = ((MBReadOnlyList<PartyTemplateObject>)(flag ? hero.Culture.EliteCaravanPartyTemplates : hero.Culture.CaravanPartyTemplates)).GetRandomElementWithPredicate((Func<PartyTemplateObject, bool>)((PartyTemplateObject x) => x.ShipHulls.Count == 0 != hero.CurrentSettlement.HasPort));
		bool isNaval = randomElementWithPredicate.ShipHulls.Any();
		Settlement settlement = hero.HomeSettlement ?? hero.BornSettlement;
		MobileParty caravanParty = CaravanPartyComponent.CreateCaravanParty(spawnSettlement: (settlement == null) ? Town.AllTowns.GetRandomElementWithPredicate((Town x) => x.Settlement.HasPort == isNaval).Settlement : (settlement.IsTown ? settlement : ((!settlement.IsVillage) ? Town.AllTowns.GetRandomElementWithPredicate((Town x) => x.Settlement.HasPort == isNaval).Settlement : (settlement.Village.TradeBound ?? Town.AllTowns.GetRandomElementWithPredicate((Town x) => x.Settlement.HasPort == isNaval).Settlement))), caravanOwner: hero, templateObject: randomElementWithPredicate, isInitialSpawn: initialSpawn, caravanLeader: null, caravanItems: null, isElite: flag);
		if (!initialSpawn)
		{
			hero.AddPower(Campaign.Current.Models.CaravanModel.GetPowerChangeAfterCaravanCreation(hero, caravanParty));
		}
	}

	private void UpdateAverageValues()
	{
		Dictionary<ItemCategory, (float, int)> dictionary = new Dictionary<ItemCategory, (float, int)>();
		foreach (ItemObject item in Items.All)
		{
			if (item.IsReady)
			{
				dictionary.TryGetValue(item.ItemCategory, out var value);
				dictionary[item.ItemCategory] = (value.Item1 + (float)TaleWorlds.Library.MathF.Min(500, item.Value), value.Item2 + 1);
			}
		}
		_packAnimalCategoryIndex = -1;
		for (int i = 0; i < ItemCategories.All.Count; i++)
		{
			ItemCategory itemCategory = ItemCategories.All[i];
			(float, int) value2;
			bool flag = dictionary.TryGetValue(itemCategory, out value2);
			_averageValuesCached[itemCategory] = (flag ? (value2.Item1 / (float)value2.Item2) : 1f);
			if (itemCategory == DefaultItemCategories.PackAnimal)
			{
				_packAnimalCategoryIndex = i;
			}
		}
	}

	private void CreatePriceDataCache()
	{
		foreach (ItemCategory item in ItemCategories.All)
		{
			float num = 0f;
			float num2 = 1000f;
			float num3 = 0f;
			float num4 = 1000f;
			foreach (Town allTown in Town.AllTowns)
			{
				float itemCategoryPriceIndex = allTown.GetItemCategoryPriceIndex(item);
				num += itemCategoryPriceIndex;
				if (itemCategoryPriceIndex < num2)
				{
					num2 = itemCategoryPriceIndex;
				}
				if (allTown.Settlement.HasPort)
				{
					num3 += itemCategoryPriceIndex;
					if (itemCategoryPriceIndex < num4)
					{
						num4 = itemCategoryPriceIndex;
					}
				}
			}
			float averageBuySellPriceIndex = num / (float)Town.AllTowns.Count;
			float averageBuySellPriceIndex2 = num3 / (float)Town.AllTowns.Count((Town x) => x.Settlement.HasPort);
			_priceDictionary[item] = new PriceIndexData(averageBuySellPriceIndex, num2);
			_coastalPriceDictionary[item] = new PriceIndexData(averageBuySellPriceIndex2, num4);
		}
	}

	public void DailyTick()
	{
		DeleteExpiredTradeRumorTakenCaravans();
		DeleteExpiredLootedCaravans();
		CreatePriceDataCache();
	}

	private void DailyTickHero(Hero hero)
	{
		if (hero != Hero.MainHero && MBRandom.RandomFloat < 0.75f && Campaign.Current.Models.CaravanModel.CanHeroCreateCaravan(hero))
		{
			SpawnCaravan(hero);
		}
	}

	private void DeleteExpiredTradeRumorTakenCaravans()
	{
		List<MobileParty> list = new List<MobileParty>();
		foreach (KeyValuePair<MobileParty, CampaignTime> tradeRumorTakenCaravan in _tradeRumorTakenCaravans)
		{
			if (CampaignTime.Now - tradeRumorTakenCaravan.Value >= CampaignTime.Days(1f))
			{
				list.Add(tradeRumorTakenCaravan.Key);
			}
		}
		foreach (MobileParty item in list)
		{
			_tradeRumorTakenCaravans.Remove(item);
		}
	}

	private void DeleteExpiredLootedCaravans()
	{
		List<MobileParty> list = new List<MobileParty>();
		foreach (KeyValuePair<MobileParty, CampaignTime> lootedCaravan in _lootedCaravans)
		{
			if (CampaignTime.Now - lootedCaravan.Value >= CampaignTime.Days(10f))
			{
				list.Add(lootedCaravan.Key);
			}
		}
		foreach (MobileParty item in list)
		{
			_lootedCaravans.Remove(item);
		}
	}

	private Town GetDestinationForMobileParty(MobileParty party)
	{
		return party.TargetSettlement?.Town;
	}

	public void HourlyTickParty(MobileParty mobileParty)
	{
		if (!Campaign.Current.GameStarted || !mobileParty.IsCaravan)
		{
			return;
		}
		bool flag = false;
		float randomFloat = MBRandom.RandomFloat;
		if (mobileParty.MapEvent != null || mobileParty.IsInRaftState || !mobileParty.IsPartyTradeActive || mobileParty.Ai.DoNotMakeNewDecisions || mobileParty.DefaultBehavior == AiBehavior.MoveToNearestLandOrPort)
		{
			return;
		}
		if (mobileParty.CurrentSettlement != null && mobileParty.CurrentSettlement.IsFortification)
		{
			if ((!mobileParty.CurrentSettlement.IsUnderSiege || (!mobileParty.CurrentSettlement.SiegeEvent.IsBlockadeActive && mobileParty.HasNavalNavigationCapability)) && mobileParty.ShortTermBehavior != AiBehavior.FleeToPoint && !mobileParty.Ai.IsAlerted && (mobileParty.IsCurrentlyUsedByAQuest || randomFloat < 1f / 3f))
			{
				float num = ((mobileParty.MemberRoster.TotalManCount > 0) ? ((float)mobileParty.MemberRoster.TotalWounded / (float)mobileParty.MemberRoster.TotalManCount) : 1f);
				float num2 = 1f;
				if ((double)num > 0.4)
				{
					num2 = 0f;
				}
				else if ((double)num > 0.2)
				{
					num2 = 0.1f;
				}
				else if ((double)num > 0.1)
				{
					num2 = 0.2f;
				}
				else if ((double)num > 0.05)
				{
					num2 = 0.3f;
				}
				else if ((double)num > 0.025)
				{
					num2 = 0.4f;
				}
				float randomFloat2 = MBRandom.RandomFloat;
				if (num2 > randomFloat2)
				{
					flag = true;
				}
			}
		}
		else
		{
			Town destinationForMobileParty = GetDestinationForMobileParty(mobileParty);
			flag = destinationForMobileParty == null || (destinationForMobileParty.IsUnderSiege && (!mobileParty.HasNavalNavigationCapability || destinationForMobileParty.Settlement.SiegeEvent.IsBlockadeActive)) || !CanTradeWith(mobileParty.MapFaction, destinationForMobileParty.MapFaction);
		}
		if (flag)
		{
			if (mobileParty.CurrentSettlement != null && mobileParty.CurrentSettlement.IsTown)
			{
				Town town = mobileParty.CurrentSettlement.Town;
				BuyGoods(mobileParty, town);
			}
			MobileParty.NavigationType bestNavigationType;
			bool isFromPort;
			bool isTargetingPort;
			Town town2 = ThinkNextDestination(mobileParty, out bestNavigationType, out isFromPort, out isTargetingPort);
			if (town2 != null)
			{
				SetPartyAiAction.GetActionForVisitingSettlement(mobileParty, town2.Settlement, bestNavigationType, isFromPort, isTargetingPort);
			}
		}
	}

	public void OnSettlementEntered(MobileParty mobileParty, Settlement settlement, Hero hero)
	{
		Town town = settlement.Town;
		if (Campaign.Current.GameStarted && mobileParty != null && town != null && mobileParty.IsCaravan && mobileParty.IsPartyTradeActive && mobileParty.IsActive)
		{
			if (mobileParty.DefaultBehavior == AiBehavior.MoveToNearestLandOrPort)
			{
				mobileParty.SetMoveModeHold();
			}
			if (mobileParty.CaravanPartyComponent.CanHaveNavalNavigationCapability)
			{
				AdjustConvoyShips(mobileParty, town);
				RefillConvoyTroops(mobileParty);
			}
			if (Campaign.Current.GameStarted)
			{
				if (_tradeActionLogs.TryGetValue(mobileParty, out var value))
				{
					for (int num = value.Count - 1; num >= 0; num--)
					{
						TradeActionLog tradeActionLog = value[num];
						if (tradeActionLog.BoughtTime.ElapsedDaysUntilNow > 7f)
						{
							value.RemoveAt(num);
							_tradeActionLogPool.ReleaseLog(tradeActionLog);
						}
					}
				}
				SellGoods(mobileParty, town);
			}
			if (mobileParty.HomeSettlement == settlement)
			{
				_caravanLastHomeTownVisitTime[mobileParty] = CampaignTime.Now;
			}
		}
		if (mobileParty != null && mobileParty.IsCaravan && mobileParty.HasLandNavigationCapability && settlement.IsTown && settlement.Town.Governor != null && settlement.Town.Governor.GetPerkValue(DefaultPerks.Trade.Tollgates))
		{
			settlement.Town.TradeTaxAccumulated += TaleWorlds.Library.MathF.Round(DefaultPerks.Trade.Tollgates.SecondaryBonus);
		}
	}

	private void DiscardShips(MobileParty convoy)
	{
		MBList<(Ship, float)> mBList = new MBList<(Ship, float)>();
		foreach (Ship ship in convoy.Ships)
		{
			mBList.Add((ship, GetShipPriority(convoy, ship, isForSelling: false)));
		}
		mBList = mBList.OrderByDescending(((Ship, float) x) => x.Item2).ToMBList();
		int idealShipNumber = Campaign.Current.Models.PartyShipLimitModel.GetIdealShipNumber(convoy);
		for (int num = 0; num < mBList.Count; num++)
		{
			Ship item = mBList[num].Item1;
			float item2 = mBList[num].Item2;
			if (num >= idealShipNumber || (item2 == float.MinValue && convoy.Ships.Count > 1))
			{
				DestroyShipAction.ApplyByDiscard(item);
			}
		}
	}

	private void RefillConvoyTroops(MobileParty convoy)
	{
		PartyTemplateObject randomCaravanTemplate = CaravanHelper.GetRandomCaravanTemplate(convoy.Owner.Culture, convoy.CaravanPartyComponent.IsElite, isLand: false);
		int totalManCount = convoy.MemberRoster.TotalManCount;
		int num = convoy.Party.PartySizeLimit - totalManCount;
		if (num <= 0)
		{
			return;
		}
		int num2 = randomCaravanTemplate.Stacks.Sum((PartyTemplateStack x) => x.MaxValue);
		float num3 = (float)num / (float)num2;
		foreach (PartyTemplateStack stack in randomCaravanTemplate.Stacks)
		{
			CharacterObject character = stack.Character;
			int num4 = TaleWorlds.Library.MathF.Floor((float)stack.MaxValue * num3);
			num -= num4;
			convoy.MemberRoster.AddToCounts(character, num4);
		}
		if (num > 0)
		{
			List<(int, float)> list = new List<(int, float)>();
			for (int num5 = 0; num5 < randomCaravanTemplate.Stacks.Count; num5++)
			{
				PartyTemplateStack partyTemplateStack = randomCaravanTemplate.Stacks[num5];
				float item = (float)(partyTemplateStack.MaxValue + partyTemplateStack.MinValue) / 2f;
				list.Add((num5, item));
			}
			for (int num6 = 0; num6 < num; num6++)
			{
				int index = MBRandom.ChooseWeighted(list);
				CharacterObject character2 = randomCaravanTemplate.Stacks[index].Character;
				convoy.MemberRoster.AddToCounts(character2, 1);
			}
		}
	}

	private void AdjustConvoyShips(MobileParty caravan, Town town)
	{
		if (town.AvailableShips.Count > 0 && caravan.PartyTradeGold > 10000 && caravan.Ships.Count < Campaign.Current.Models.PartyShipLimitModel.GetIdealShipNumber(caravan))
		{
			BuyShips(caravan, town);
		}
	}

	private void BuyShips(MobileParty caravan, Town town)
	{
		MBList<(Ship, float)> mBList = new MBList<(Ship, float)>();
		bool flag = false;
		if (caravan.CaravanPartyComponent.IsElite)
		{
			flag = true;
			for (int i = 0; i < caravan.Ships.Count; i++)
			{
				if (caravan.Ships[i].ShipHull.Type == ShipHull.ShipType.Medium)
				{
					flag = false;
					break;
				}
			}
		}
		for (int num = town.AvailableShips.Count - 1; num >= 0; num--)
		{
			Ship ship = town.AvailableShips[num];
			if (ship.ShipHull.Type == ShipHull.ShipType.Light || (ship.ShipHull.Type == ShipHull.ShipType.Medium && flag))
			{
				mBList.Add((ship, GetShipPriority(caravan, ship, isForSelling: false)));
			}
		}
		mBList = mBList.OrderByDescending(((Ship, float) x) => x.Item2).ToMBList();
		int idealShipNumber = Campaign.Current.Models.PartyShipLimitModel.GetIdealShipNumber(caravan);
		for (int num2 = 0; num2 < mBList.Count; num2++)
		{
			if (caravan.Ships.Count >= idealShipNumber)
			{
				break;
			}
			Ship item = mBList[num2].Item1;
			if ((float)caravan.PartyTradeGold * 0.5f >= Campaign.Current.Models.ShipCostModel.GetShipTradeValue(item, town.Settlement.Party, caravan.Party) && (item.ShipHull.Type != ShipHull.ShipType.Medium || flag))
			{
				ChangeShipOwnerAction.ApplyByTrade(caravan.Party, item);
				if (item.ShipHull.Type == ShipHull.ShipType.Medium)
				{
					flag = false;
				}
			}
		}
	}

	private float GetShipPriority(MobileParty convoy, Ship ship, bool isForSelling)
	{
		return Campaign.Current.Models.PartyShipLimitModel.GetShipPriority(convoy, ship, isForSelling);
	}

	public void OnSettlementLeft(MobileParty mobileParty, Settlement settlement)
	{
		if (mobileParty == null || mobileParty == MobileParty.MainParty || (!mobileParty.IsCaravan && !mobileParty.IsLordParty))
		{
			return;
		}
		int inventoryCapacity = mobileParty.InventoryCapacity;
		float totalWeightCarried = mobileParty.TotalWeightCarried;
		Town town = (settlement.IsTown ? settlement.Town : (settlement.IsVillage ? settlement.Village.Bound.Town : null));
		if (town == null)
		{
			return;
		}
		float num = 1.1f;
		while (totalWeightCarried > (float)inventoryCapacity)
		{
			SellGoods(mobileParty, town, num, toLoseWeight: true);
			num -= 0.02f;
			if (!(num < 0.75f))
			{
				inventoryCapacity = mobileParty.InventoryCapacity;
				totalWeightCarried = mobileParty.TotalWeightCarried;
				continue;
			}
			break;
		}
	}

	private void OnMobilePartyDestroyed(MobileParty mobileParty, PartyBase destroyerParty)
	{
		if (!mobileParty.IsCaravan)
		{
			return;
		}
		if (_interactedCaravans.ContainsKey(mobileParty))
		{
			_interactedCaravans.Remove(mobileParty);
		}
		if (_tradeActionLogs.TryGetValue(mobileParty, out var value))
		{
			_tradeActionLogs.Remove(mobileParty);
			for (int i = 0; i < value.Count; i++)
			{
				TradeActionLog log = value[i];
				_tradeActionLogPool.ReleaseLog(log);
			}
		}
		if (_caravanLastHomeTownVisitTime.ContainsKey(mobileParty))
		{
			_caravanLastHomeTownVisitTime.Remove(mobileParty);
		}
	}

	private void OnMobilePartyCreated(MobileParty mobileParty)
	{
		if (mobileParty.IsCaravan)
		{
			_caravanLastHomeTownVisitTime.Add(mobileParty, CampaignTime.Now);
		}
	}

	private Town ThinkNextDestination(MobileParty caravanParty, out MobileParty.NavigationType bestNavigationType, out bool isFromPort, out bool isTargetingPort)
	{
		RefreshTotalValueOfItemsAtCategoryForParty(caravanParty);
		Town town = FindNextDestinationForCaravan(caravanParty, distanceCut: true, out bestNavigationType, out isFromPort, out isTargetingPort);
		if (town == null)
		{
			town = FindNextDestinationForCaravan(caravanParty, distanceCut: false, out bestNavigationType, out isFromPort, out isTargetingPort);
		}
		return town;
	}

	private Town FindNextDestinationForCaravan(MobileParty caravanParty, bool distanceCut, out MobileParty.NavigationType bestNavigationType, out bool isFromPort, out bool isTargetingPort)
	{
		float num = 0f;
		Town result = null;
		bestNavigationType = MobileParty.NavigationType.None;
		isTargetingPort = false;
		float input = caravanParty.TotalWeightCarried / (float)caravanParty.InventoryCapacity;
		input = MBMath.Map(input, 0f, 1f, 0f, 0.9f);
		_caravanLastHomeTownVisitTime.TryGetValue(caravanParty, out var value);
		bool hasNavalNavigationCapability = caravanParty.HasNavalNavigationCapability;
		foreach (Town allTown in Town.AllTowns)
		{
			if (allTown.Owner.Settlement != caravanParty.CurrentSettlement && (!allTown.IsUnderSiege || (!allTown.Settlement.SiegeEvent.IsBlockadeActive && hasNavalNavigationCapability)) && CanTradeWith(caravanParty.MapFaction, allTown.MapFaction) && (allTown.Settlement.HasPort || !hasNavalNavigationCapability) && (!allTown.Settlement.Parties.Contains(MobileParty.MainParty) || !MobileParty.MainParty.MapFaction.IsAtWarWith(caravanParty.MapFaction)))
			{
				MobileParty.NavigationType bestNavigationType2;
				bool isTargetingPort2;
				float tradeScoreForTown = GetTradeScoreForTown(caravanParty, allTown, value, input, distanceCut, out bestNavigationType2, out isTargetingPort2);
				if (tradeScoreForTown > num)
				{
					num = tradeScoreForTown;
					result = allTown;
					isTargetingPort = isTargetingPort2;
					bestNavigationType = bestNavigationType2;
				}
			}
		}
		isFromPort = isTargetingPort && caravanParty.CurrentSettlement != null;
		return result;
	}

	private void AdjustVeryFarAddition(bool isNavalCaravan, float distanceAsDays, float minimumAddition, ref float veryFarAddition)
	{
		float distanceLimitVeryFarAsDaysForNavigationType = GetDistanceLimitVeryFarAsDaysForNavigationType(isNavalCaravan);
		if (distanceAsDays > distanceLimitVeryFarAsDaysForNavigationType)
		{
			veryFarAddition += (distanceAsDays - distanceLimitVeryFarAsDaysForNavigationType) * minimumAddition * 4f;
		}
		float distanceLimitFarAsDaysForNavigationType = GetDistanceLimitFarAsDaysForNavigationType(isNavalCaravan);
		if (distanceAsDays > distanceLimitFarAsDaysForNavigationType)
		{
			veryFarAddition += (distanceAsDays - distanceLimitFarAsDaysForNavigationType) * minimumAddition * 3f;
		}
		float distanceLimitMediumAsDaysForNavigationType = GetDistanceLimitMediumAsDaysForNavigationType(isNavalCaravan);
		if (distanceAsDays > distanceLimitMediumAsDaysForNavigationType)
		{
			veryFarAddition += (distanceAsDays - distanceLimitMediumAsDaysForNavigationType) * minimumAddition * 2f;
		}
		float distanceLimitCloseAsDaysForNavigationType = GetDistanceLimitCloseAsDaysForNavigationType(isNavalCaravan);
		if (distanceAsDays > distanceLimitCloseAsDaysForNavigationType)
		{
			veryFarAddition += (distanceAsDays - distanceLimitCloseAsDaysForNavigationType) * minimumAddition;
		}
	}

	private float GetTradeScoreForTown(MobileParty caravanParty, Town town, CampaignTime lastHomeVisitTimeOfCaravan, float caravanFullness, bool distanceCut, out MobileParty.NavigationType bestNavigationType, out bool isTargetingPort)
	{
		bool flag = (isTargetingPort = caravanParty.HasNavalNavigationCapability);
		AiHelper.GetBestNavigationTypeAndAdjustedDistanceOfSettlementForMobileParty(caravanParty, town.Settlement, isTargetingPort, out bestNavigationType, out var bestNavigationDistance, out var _);
		if (bestNavigationType != MobileParty.NavigationType.None)
		{
			float num = bestNavigationDistance / ((flag ? Campaign.Current.EstimatedAverageCaravanPartyNavalSpeed : Campaign.Current.EstimatedAverageCaravanPartySpeed) * (float)CampaignTime.HoursInDay);
			float veryFarAddition = 0f;
			AdjustVeryFarAddition(flag, num, 0.15f, ref veryFarAddition);
			float elapsedDaysUntilNow = lastHomeVisitTimeOfCaravan.ElapsedDaysUntilNow;
			bool flag2 = elapsedDaysUntilNow > GetDistanceLimitVeryFarAsDaysForNavigationType(flag);
			if (flag2)
			{
				float distanceAsDays = bestNavigationDistance / ((flag ? Campaign.Current.EstimatedAverageCaravanPartyNavalSpeed : Campaign.Current.EstimatedAverageCaravanPartySpeed) * (float)CampaignTime.HoursInDay);
				AdjustVeryFarAddition(flag, distanceAsDays, ((elapsedDaysUntilNow - 1f) * TaleWorlds.Library.MathF.Sqrt(elapsedDaysUntilNow - 1f) - 1f) * 0.008f, ref veryFarAddition);
			}
			ExplainedNumber result = default(ExplainedNumber);
			town.AddEffectOfBuildings(BuildingEffectEnum.CaravanAccessibility, ref result);
			float num2 = Math.Max(1f, result.ResultNumber);
			float distanceLimitVeryFarAsDaysForNavigationType = GetDistanceLimitVeryFarAsDaysForNavigationType(flag);
			float num3 = num + veryFarAddition;
			if (distanceCut && (town.Owner.Settlement != caravanParty.HomeSettlement || !flag2) && num3 > distanceLimitVeryFarAsDaysForNavigationType)
			{
				bestNavigationType = MobileParty.NavigationType.None;
				isTargetingPort = false;
				return -1f;
			}
			float num4 = (flag ? TaleWorlds.Library.MathF.Max(0.1f, 1f - num3 / (2f * distanceLimitVeryFarAsDaysForNavigationType)) : (1f / num3));
			float num5 = 1f;
			if (caravanParty.HomeSettlement == town.Owner.Settlement)
			{
				num5 = 1f + elapsedDaysUntilNow * 0.1f * (elapsedDaysUntilNow * 0.1f);
				if (num4 < 0.5f)
				{
					num4 = 0.5f;
				}
			}
			TownMarketData marketData = town.MarketData;
			float num6 = 1.1f;
			float num7 = 0f;
			for (int i = 0; i < caravanParty.Party.ItemRoster.Count; i++)
			{
				ItemObject item = caravanParty.ItemRoster.GetElementCopyAtIndex(i).EquipmentElement.Item;
				float limitValue = num6 - TaleWorlds.Library.MathF.Sqrt((float)TaleWorlds.Library.MathF.Min(_totalValueOfItemsAtCategory[item.ItemCategory], 5000) / 5000f) * 0.2f;
				num7 += CalculateTownSellScoreForCategory(caravanParty, marketData, i, limitValue);
			}
			num7 *= (flag ? 0.5f : 0.3f) + caravanFullness;
			float num8 = 0f;
			for (int j = 0; j < ItemCategories.All.Count; j++)
			{
				ItemCategory itemCategory = ItemCategories.All[j];
				if (itemCategory.IsTradeGood || itemCategory.IsAnimal)
				{
					num8 += CalculateTownBuyScoreForCategory(marketData, j, caravanParty);
				}
			}
			num8 *= TaleWorlds.Library.MathF.Max(0.1f, 1f - 2f * (caravanFullness - (flag ? 0.5f : 0.3f) * TaleWorlds.Library.MathF.Min(num7, 1000f) / 1000f));
			num8 = TaleWorlds.Library.MathF.Min(num8, (float)(int)(0.5f * (float)caravanParty.PartyTradeGold));
			float num9 = ((caravanParty.IsCurrentlyUsedByAQuest && town.Settlement == caravanParty.HomeSettlement && caravanParty.Position.Distance(caravanParty.HomeSettlement.Position) < Campaign.Current.Models.EncounterModel.NeededMaximumDistanceForEncounteringTown * 5f) ? 0.1f : 1f);
			float num10 = 1f;
			float num11 = ((town.Security >= 75f) ? (1f + TaleWorlds.Library.MathF.Clamp((town.Security - 75f) * 0.002f, 0f, 0.05f)) : 1f);
			float num12 = ((caravanParty.Owner != null) ? caravanParty.Owner.RandomFloat(1f, 1.03f) : 1f);
			float num13 = 1f;
			if (TradeAgreementsCampaignBehavior != null && caravanParty.MapFaction.IsKingdomFaction && town.MapFaction.IsKingdomFaction && TradeAgreementsCampaignBehavior.HasTradeAgreement((Kingdom)caravanParty.MapFaction, (Kingdom)town.MapFaction))
			{
				num13 = (flag ? 1.5f : 2f);
			}
			return (num7 + num8) * num4 * num13 * num5 * num9 * num10 * num11 * num12 * num2;
		}
		bestNavigationType = MobileParty.NavigationType.None;
		isTargetingPort = false;
		return -1f;
	}

	private float CalculateTownSellScoreForCategory(MobileParty party, TownMarketData marketData, int i, float limitValue)
	{
		ItemRosterElement itemRosterElement = party.Party.ItemRoster[i];
		ItemCategory itemCategory = itemRosterElement.EquipmentElement.Item.ItemCategory;
		GetCategoryPriceData(itemCategory, party, out var priceIndex);
		float num = marketData.GetPriceFactor(itemCategory) - priceIndex.AverageBuySellPriceIndex * limitValue;
		if (num > 0f)
		{
			int num2 = ((itemRosterElement.EquipmentElement.Item.ItemCategory != DefaultItemCategories.PackAnimal || !party.HasLandNavigationCapability) ? itemRosterElement.Amount : TaleWorlds.Library.MathF.Max(0, itemRosterElement.Amount - party.MemberRoster.TotalManCount));
			float num3 = ((itemCategory.Properties == ItemCategory.Property.BonusToFoodStores) ? 1.1f : 1f);
			return num * num3 * (float)TaleWorlds.Library.MathF.Min(4000, itemRosterElement.EquipmentElement.Item.Value * num2);
		}
		return 0f;
	}

	private void SetPlayerInteraction(MobileParty mobileParty, PlayerInteraction interaction)
	{
		if (_interactedCaravans.ContainsKey(mobileParty))
		{
			_interactedCaravans[mobileParty] = interaction;
		}
		else
		{
			_interactedCaravans.Add(mobileParty, interaction);
		}
	}

	private PlayerInteraction GetPlayerInteraction(MobileParty mobileParty)
	{
		if (_interactedCaravans.TryGetValue(mobileParty, out var value))
		{
			return value;
		}
		return PlayerInteraction.None;
	}

	private float CalculateTownBuyScoreForCategory(TownMarketData marketData, int categoryIndex, MobileParty mobileParty)
	{
		ItemCategory itemCategory = ItemCategories.All[categoryIndex];
		GetCategoryPriceData(itemCategory, mobileParty, out var priceIndex);
		float priceFactor = marketData.GetPriceFactor(itemCategory);
		float num = priceIndex.AverageBuySellPriceIndex / priceFactor;
		float num2 = num * num - 1.1f;
		if (num2 > 0f)
		{
			return TaleWorlds.Library.MathF.Min(TaleWorlds.Library.MathF.Sqrt(_averageValuesCached[itemCategory]) * 3f * num2, 0.3f * (float)marketData.GetCategoryData(itemCategory).InStoreValue);
		}
		return 0f;
	}

	private bool GetCategoryPriceData(ItemCategory category, MobileParty mobileParty, out PriceIndexData priceIndex)
	{
		bool result = true;
		if (!(ShouldPartyUseCoastalPrices(mobileParty) ? _coastalPriceDictionary : _priceDictionary).TryGetValue(category, out priceIndex))
		{
			result = false;
			priceIndex = new PriceIndexData(1f, 1f);
		}
		return result;
	}

	private void RefreshTotalValueOfItemsAtCategoryForParty(MobileParty caravanParty)
	{
		_totalValueOfItemsAtCategory.Clear();
		for (int i = 0; i < caravanParty.ItemRoster.Count; i++)
		{
			ItemRosterElement elementCopyAtIndex = caravanParty.ItemRoster.GetElementCopyAtIndex(i);
			ItemObject item = elementCopyAtIndex.EquipmentElement.Item;
			int num = elementCopyAtIndex.Amount * (item.Value + 10);
			if (_totalValueOfItemsAtCategory.TryGetValue(item.ItemCategory, out var value))
			{
				_totalValueOfItemsAtCategory[item.ItemCategory] = value + num;
			}
			else
			{
				_totalValueOfItemsAtCategory.Add(item.ItemCategory, num);
			}
		}
	}

	private bool ShouldPartyUseCoastalPrices(MobileParty mobileParty)
	{
		if (mobileParty.IsCaravan)
		{
			return mobileParty.CaravanPartyComponent.CanHaveNavalNavigationCapability;
		}
		return false;
	}

	private void SellGoodsInternal(MobileParty mobileParty, Town town, bool sellHorses, List<(EquipmentElement, int)> soldItems, float priceIndexSellLimit = 1.1f, bool toLoseWeight = false)
	{
		int itemAverageWeight = Campaign.Current.Models.InventoryCapacityModel.GetItemAverageWeight();
		RefreshTotalValueOfItemsAtCategoryForParty(mobileParty);
		for (int num = mobileParty.ItemRoster.Count - 1; num >= 0; num--)
		{
			int num2 = (int)((float)mobileParty.ItemRoster.NumberOfPackAnimals - (float)mobileParty.Party.NumberOfAllMembers * 0.6f);
			int num3 = (int)((float)mobileParty.ItemRoster.NumberOfLivestockAnimals - (float)mobileParty.Party.NumberOfAllMembers * 0.6f);
			ItemRosterElement elementCopyAtIndex = mobileParty.ItemRoster.GetElementCopyAtIndex(num);
			ItemObject item = elementCopyAtIndex.EquipmentElement.Item;
			if (GetCategoryPriceData(item.GetItemCategory(), mobileParty, out var priceIndex) && sellHorses == (item.HasHorseComponent || item.ItemCategory == DefaultItemCategories.PackAnimal) && (!toLoseWeight || !item.HasHorseComponent || !mobileParty.HasLandNavigationCapability))
			{
				bool flag = item.ItemCategory == DefaultItemCategories.PackAnimal;
				if (!flag || num2 > 0 || !mobileParty.HasLandNavigationCapability)
				{
					float priceFactor = town.MarketData.GetPriceFactor(item.ItemCategory);
					float num4 = priceFactor / priceIndex.AverageBuySellPriceIndex;
					float num5 = priceIndexSellLimit - (Campaign.Current.GameStarted ? (TaleWorlds.Library.MathF.Sqrt((float)TaleWorlds.Library.MathF.Min(_totalValueOfItemsAtCategory[item.ItemCategory], 5000) / 5000f) * 0.4f) : 0f);
					bool flag2 = num2 > 0 && flag;
					bool flag3 = num3 > 0 && item.HorseComponent != null && item.HorseComponent.IsLiveStock;
					if (!(num4 < num5) || (mobileParty.HasLandNavigationCapability && (flag3 || flag2)))
					{
						float num6 = 0.8f * priceIndex.AverageBuySellPriceIndex + 0.2f * priceIndex.MinBuySellPriceIndex;
						if (!(priceFactor < num6 * num5) || (mobileParty.HasLandNavigationCapability && (flag3 || flag2)))
						{
							float num7 = priceFactor - num6 * num5;
							float demand = town.MarketData.GetDemand(item.ItemCategory);
							float num8 = Campaign.Current.Models.SettlementEconomyModel.CalculateDailySettlementBudgetForItemCategory(town, demand, item.ItemCategory) + (float)(2 * item.Value);
							int itemPrice = town.GetItemPrice(item, mobileParty, isSelling: true);
							float num9 = ((item.ItemCategory == DefaultItemCategories.PackAnimal) ? 1.5f : 1f);
							float num10 = (mobileParty.HasNavalNavigationCapability ? 5f : 3f);
							float num11 = num8 * num7 * num4 * num9 * num10;
							if (num11 > 0f || flag3 || flag2)
							{
								int num12 = MBRandom.RoundRandomized(num11 / (float)itemPrice);
								if (mobileParty.HasLandNavigationCapability)
								{
									if (flag2)
									{
										num12 = num2;
									}
									else if (flag3)
									{
										num12 = num3;
									}
								}
								int amount = elementCopyAtIndex.Amount;
								if (num12 > amount)
								{
									num12 = amount;
								}
								if (num12 * itemPrice > town.Gold)
								{
									num12 = town.Gold / itemPrice;
								}
								if (toLoseWeight && mobileParty.TotalWeightCarried - (float)(num12 * itemAverageWeight) < (float)mobileParty.InventoryCapacity)
								{
									num12 = (int)((mobileParty.TotalWeightCarried - (float)mobileParty.InventoryCapacity) / (float)itemAverageWeight + 0.99f);
								}
								if (num12 > elementCopyAtIndex.Amount)
								{
									num12 = elementCopyAtIndex.Amount;
								}
								if (num12 * itemPrice > town.Gold)
								{
									num12 = town.Gold / itemPrice;
								}
								if (num12 > 0)
								{
									soldItems.Add((elementCopyAtIndex.EquipmentElement, num12));
									if (Campaign.Current.GameStarted)
									{
										OnSellItems(mobileParty, elementCopyAtIndex, town);
									}
									SellItemsAction.Apply(mobileParty.Party, town.Owner, elementCopyAtIndex, num12, town.Owner.Settlement);
								}
							}
						}
					}
				}
			}
		}
	}

	private void SellGoods(MobileParty mobileParty, Town town, float priceIndexSellLimit = 1.1f, bool toLoseWeight = false)
	{
		RefreshTotalValueOfItemsAtCategoryForParty(mobileParty);
		List<(EquipmentElement, int)> list = new List<(EquipmentElement, int)>();
		SellGoodsInternal(mobileParty, town, sellHorses: false, list, priceIndexSellLimit, toLoseWeight);
		SellGoodsInternal(mobileParty, town, sellHorses: true, list, priceIndexSellLimit, toLoseWeight);
		if (!list.IsEmpty() && mobileParty.IsCaravan)
		{
			CampaignEventDispatcher.Instance.OnCaravanTransactionCompleted(mobileParty, town, list);
		}
	}

	private void OnSellItems(MobileParty caravanParty, ItemRosterElement rosterElement, Town soldTown)
	{
		int itemPrice = soldTown.GetItemPrice(rosterElement.EquipmentElement.Item, caravanParty, isSelling: true);
		if (!_tradeActionLogs.TryGetValue(caravanParty, out var value))
		{
			return;
		}
		foreach (TradeActionLog item in value)
		{
			if (item.ItemRosterElement.EquipmentElement.Item == rosterElement.EquipmentElement.Item && itemPrice > item.SellPrice)
			{
				item.OnSellAction(soldTown.Settlement, itemPrice);
			}
		}
	}

	private void BuyGoods(MobileParty caravanParty, Town town)
	{
		List<(EquipmentElement, int)> list = new List<(EquipmentElement, int)>();
		float capacityFactor = CalculateCapacityFactor(caravanParty);
		float budgetFactor = CalculateBudgetFactor(caravanParty);
		RefreshTotalValueOfItemsAtCategoryForParty(caravanParty);
		MBList<ItemCategory> mBList = ItemCategories.All.OrderByDescending((ItemCategory x) => CalculateBuyValue(x, town, caravanParty, budgetFactor, capacityFactor)).ToMBList();
		int num = (caravanParty.HasNavalNavigationCapability ? 10 : 5);
		for (int num2 = 0; num2 < num; num2++)
		{
			BuyCategory(caravanParty, town, mBList[num2], budgetFactor, capacityFactor, list);
		}
		if (caravanParty.HasNavalNavigationCapability)
		{
			BuyCategory(caravanParty, town, DefaultItemCategories.Grain, budgetFactor, capacityFactor, list);
			BuyCategory(caravanParty, town, DefaultItemCategories.Fish, budgetFactor, capacityFactor, list);
		}
		else if ((float)(caravanParty.ItemRoster.NumberOfPackAnimals + caravanParty.ItemRoster.NumberOfLivestockAnimals) < (float)caravanParty.Party.NumberOfAllMembers * 2f && caravanParty.ItemRoster.NumberOfPackAnimals < caravanParty.Party.NumberOfAllMembers && _packAnimalCategoryIndex >= 0 && caravanParty.PartyTradeGold > 1000)
		{
			BuyCategory(caravanParty, town, DefaultItemCategories.PackAnimal, budgetFactor, capacityFactor, list);
		}
		if (!list.IsEmpty())
		{
			CampaignEventDispatcher.Instance.OnCaravanTransactionCompleted(caravanParty, town, list);
		}
	}

	private float CalculateBudgetFactor(MobileParty caravanParty)
	{
		return 0.1f + TaleWorlds.Library.MathF.Clamp((float)caravanParty.PartyTradeGold / 5000f, 0f, 1f);
	}

	private float CalculateCapacityFactor(MobileParty caravanParty)
	{
		float num = caravanParty.TotalWeightCarried / ((float)caravanParty.InventoryCapacity + 1f);
		num *= 0.9f;
		return 1.1f - TaleWorlds.Library.MathF.Clamp(num, 0f, 1f);
	}

	private void BuyCategory(MobileParty caravanParty, Town town, ItemCategory category, float budgetFactor, float capacityFactor, List<(EquipmentElement, int)> boughtItems)
	{
		float num = CalculateBuyValue(category, town, caravanParty, budgetFactor, capacityFactor);
		if (num < 7f || (caravanParty.TotalWeightCarried / (float)caravanParty.InventoryCapacity > 0.9f && !category.IsAnimal) || town.MarketData.GetCategoryData(category).InStore == 0)
		{
			return;
		}
		float num2 = TaleWorlds.Library.MathF.Min(TaleWorlds.Library.MathF.Min((float)caravanParty.PartyTradeGold * 0.5f, num * 1.5f), (float)Campaign.Current.Models.CaravanModel.GetMaxGoldToSpendOnOneItemCategory(caravanParty, category));
		if (!Campaign.Current.GameStarted)
		{
			num2 *= 0.5f;
		}
		float num3 = num2;
		int num4 = 0;
		int num5;
		do
		{
			num5 = 0;
			int x = (int)(MBRandom.RandomFloat * (float)town.Owner.ItemRoster.Count);
			int num6 = town.Owner.ItemRoster.FindIndexFirstAfterXthElement((ItemObject itemObject) => itemObject.ItemCategory == category, x);
			if (num6 < 0)
			{
				break;
			}
			ItemRosterElement rosterElement = town.Owner.ItemRoster.GetElementCopyAtIndex(num6);
			ItemObject item = rosterElement.EquipmentElement.Item;
			int itemPrice = town.GetItemPrice(item, caravanParty);
			int num7 = MBRandom.RoundRandomized(num3 / (float)itemPrice);
			if (num7 > rosterElement.Amount)
			{
				num7 = rosterElement.Amount;
			}
			if (num7 > MaxNumberOfItemsToBuyFromSingleCategory)
			{
				num7 = MaxNumberOfItemsToBuyFromSingleCategory;
			}
			if ((!category.IsAnimal || !caravanParty.HasLandNavigationCapability) && caravanParty.TotalWeightCarried + (float)num7 * item.Weight > (float)caravanParty.InventoryCapacity)
			{
				num7 = (int)(((float)caravanParty.InventoryCapacity * 0.9f - caravanParty.TotalWeightCarried) / item.Weight);
			}
			if (caravanParty.HasLandNavigationCapability && rosterElement.EquipmentElement.Item.HorseComponent != null && (rosterElement.EquipmentElement.Item.HorseComponent.IsLiveStock || rosterElement.EquipmentElement.Item.HorseComponent.IsPackAnimal))
			{
				int numberOfPackAnimals = caravanParty.ItemRoster.NumberOfPackAnimals;
				int numberOfLivestockAnimals = caravanParty.ItemRoster.NumberOfLivestockAnimals;
				if (rosterElement.EquipmentElement.Item.HorseComponent.IsLiveStock && (float)(numberOfLivestockAnimals + num7) > (float)caravanParty.Party.NumberOfAllMembers * 0.6f)
				{
					num7 = (int)((float)caravanParty.Party.NumberOfAllMembers * 0.6f) - numberOfLivestockAnimals;
				}
				else if (rosterElement.EquipmentElement.Item.HorseComponent.IsPackAnimal && numberOfPackAnimals + num7 > caravanParty.Party.NumberOfAllMembers)
				{
					num7 = caravanParty.Party.NumberOfAllMembers - numberOfPackAnimals;
				}
			}
			if (num7 <= 0)
			{
				continue;
			}
			SellItemsAction.Apply(town.Owner, caravanParty.Party, rosterElement, num7, town.Owner.Settlement);
			int num8 = boughtItems.FindIndex(((EquipmentElement, int) tuple) => tuple.Item1.IsEqualTo(rosterElement.EquipmentElement));
			if (num8 == -1)
			{
				boughtItems.Add((rosterElement.EquipmentElement, -num7));
			}
			else
			{
				boughtItems[num8] = (rosterElement.EquipmentElement, -num7 + boughtItems[num8].Item2);
			}
			num4 += num7;
			num3 -= (float)(num7 * itemPrice + 1);
			num5 = num7 * itemPrice;
			Town destinationForMobileParty = GetDestinationForMobileParty(caravanParty);
			if (caravanParty.LastVisitedSettlement != null && destinationForMobileParty != null && Campaign.Current.GameStarted)
			{
				if (!_tradeActionLogs.TryGetValue(caravanParty, out var value))
				{
					value = new List<TradeActionLog>();
					_tradeActionLogs.Add(caravanParty, value);
				}
				int itemPrice2 = town.GetItemPrice(rosterElement.EquipmentElement, caravanParty);
				value.Add(_tradeActionLogPool.CreateNewLog(town.Settlement, itemPrice2, rosterElement));
			}
		}
		while (num3 > 0f && num5 > 0 && num4 < Campaign.Current.Models.CaravanModel.MaxNumberOfItemsToBuyFromSingleCategory);
	}

	private int CaravanTotalValue(MobileParty caravanParty)
	{
		float num = 0f;
		for (int i = 0; i < caravanParty.ItemRoster.Count; i++)
		{
			ItemRosterElement itemRosterElement = caravanParty.ItemRoster[i];
			num += GetGlobalItemSellPrice(itemRosterElement.EquipmentElement.Item, caravanParty) * (float)itemRosterElement.Amount;
		}
		return (int)num + caravanParty.PartyTradeGold;
	}

	private float CalculateBuyValue(ItemCategory category, Town town, MobileParty caravanParty, float budgetFactor, float capacityFactor)
	{
		if (!category.IsTradeGood && !category.IsAnimal)
		{
			return 0f;
		}
		if (!GetCategoryPriceData(category, caravanParty, out var priceIndex))
		{
			return 0f;
		}
		if (town.MarketData.GetItemCountOfCategory(category) == 0)
		{
			return 0f;
		}
		float num = 0f;
		if (Campaign.Current.GameStarted && _totalValueOfItemsAtCategory.ContainsKey(category))
		{
			num = TaleWorlds.Library.MathF.Sqrt((float)TaleWorlds.Library.MathF.Min(_totalValueOfItemsAtCategory[category], 5000) / 5000f) * 0.4f;
		}
		float itemCategoryPriceIndex = town.GetItemCategoryPriceIndex(category);
		float averageBuySellPriceIndex = priceIndex.AverageBuySellPriceIndex;
		float num2 = averageBuySellPriceIndex * (1f - num) - itemCategoryPriceIndex;
		if (num2 < 0f)
		{
			return 0f;
		}
		float demand = town.MarketData.GetDemand(category);
		float num3 = 0.1f * TaleWorlds.Library.MathF.Pow(demand, 0.5f);
		float num4 = num2 * _averageValuesCached[category];
		float num5 = num2 * 200f;
		float num6 = averageBuySellPriceIndex / itemCategoryPriceIndex;
		float num7 = ((category.Properties == ItemCategory.Property.BonusToFoodStores) ? 1.1f : 1f);
		return ((category == DefaultItemCategories.PackAnimal && caravanParty.HasLandNavigationCapability) ? 1.5f : 1f) * num7 * num6 * num3 * (num4 * budgetFactor + num5 * capacityFactor);
	}

	private float GetGlobalItemSellPrice(ItemObject item, MobileParty mobileParty)
	{
		if (!GetCategoryPriceData(item.ItemCategory, mobileParty, out var priceIndex))
		{
			return 1f;
		}
		return priceIndex.AverageBuySellPriceIndex * (float)item.Value;
	}

	private List<Kingdom> GetSuitableKingdomsAsTradePartnerForPlayerCaravans()
	{
		List<Kingdom> list = new List<Kingdom>();
		foreach (Kingdom kingdom in Campaign.Current.Kingdoms)
		{
			if (!kingdom.IsEliminated)
			{
				list.Add(kingdom);
			}
		}
		return list;
	}

	private List<Kingdom> GetSuitableKingdomsForHomeSettlement()
	{
		List<Kingdom> list = new List<Kingdom>();
		foreach (Kingdom suitableKingdomsAsTradePartnerForPlayerCaravan in GetSuitableKingdomsAsTradePartnerForPlayerCaravans())
		{
			if (GetSuitableHomeSettlementsForKingdom(suitableKingdomsAsTradePartnerForPlayerCaravan).Count > 0)
			{
				list.Add(suitableKingdomsAsTradePartnerForPlayerCaravan);
			}
		}
		return list;
	}

	private List<Settlement> GetSuitableHomeSettlementsForKingdom(Kingdom kingdom)
	{
		List<Settlement> list = new List<Settlement>();
		MobileParty conversationParty = MobileParty.ConversationParty;
		bool hasNavalNavigationCapability = conversationParty.HasNavalNavigationCapability;
		foreach (Settlement settlement in kingdom.Settlements)
		{
			if (settlement.IsTown && settlement != conversationParty.HomeSettlement && (!hasNavalNavigationCapability || settlement.HasPort))
			{
				list.Add(settlement);
			}
		}
		return list;
	}

	protected void AddDialogs(CampaignGameStarter starter)
	{
		starter.AddPlayerLine("caravan_companion_talk_start", "hero_main_options", "caravan_companion_talk_start", "{=q0RY0dQG}We need to talk business.", companion_is_caravan_leader_on_condition, null);
		starter.AddDialogLine("caravan_companion_talk_start_reply", "caravan_companion_talk_start", "caravan_companion_talk_start_reply", "{=9RiXgPc1}Certainly. What do you need to know?", null, null);
		starter.AddPlayerLine("caravan_companion_change_home_settlement", "caravan_companion_talk_start_reply", "caravan_companion_ask_change_home_settlement", "{=dMQ1u6l2}I would like you to start trading out of a different town.", caravan_companion_change_home_settlement_on_condition, caravan_companion_change_home_settlement_on_consequence, 100, caravan_companion_change_home_settlement_clickable_condition);
		starter.AddPlayerLine("caravan_companion_prohibit_kingdoms", "caravan_companion_talk_start_reply", "caravan_companion_prohibit_kingdoms_selected", "{=5LhfbFpX}Let's discuss our trade partners.", caravan_companion_prohibit_kingdoms_on_condition, caravan_companion_prohibit_kingdoms_on_consequence, 100, caravan_companion_prohibit_kingdoms_clickable_condition);
		starter.AddPlayerLine("caravan_companion_trade_rumors", "caravan_companion_talk_start_reply", "caravan_companion_ask_trade_rumors", "{=oMuxr3X6}What news of the markets? Any good deals to be had?", null, null);
		starter.AddDialogLine("caravan_companion_ask_trade_rumors", "caravan_companion_ask_trade_rumors", "caravan_companion_anything_else", "{=sC4ZLZ8x}{COMMENT}", null, caravan_ask_trade_rumors_on_consequence);
		starter.AddDialogLine("caravan_companion_talk_player_thank", "caravan_companion_anything_else", "caravan_companion_talk_end", "{=DQBaaC0e}Is there anything else?", null, null);
		starter.AddPlayerLine("caravan_companion_talk_not_leave", "caravan_companion_talk_end", "lord_pretalk", "{=i2FwKPmC}Yes, I wanted to talk about something else..", null, null);
		starter.AddPlayerLine("caravan_companion_talk_leave", "caravan_companion_talk_end", "close_window", "{=1IJouNaM}Carry on, then. Farewell.", null, caravan_player_leave_encounter_on_consequence);
		starter.AddPlayerLine("caravan_companion_nevermind", "caravan_companion_talk_start_reply", "lord_pretalk", "{=D33fIGQe}Never mind.", null, null);
		starter.AddDialogLine("caravan_companion_ask_change_home_settlement", "caravan_companion_ask_change_home_settlement", "caravan_companion_ask_change_home_settlement_2", "{=8oJYCDbO}Certainly. We currently trade out of {HOME_SETTLEMENT}. In which realm shall we make our new home?", caravan_companion_ask_change_home_settlement_2_on_condition, null);
		starter.AddRepeatablePlayerLine("caravan_companion_ask_change_home_settlement_2", "caravan_companion_ask_change_home_settlement_2", "caravan_companion_ask_change_home_settlement_3", "{=!}{KINGDOM_NAME}", "{=bKqka5Uj}I am thinking of a different realm.", "caravan_companion_ask_change_home_settlement", caravan_companion_ask_change_home_settlement_3_on_condition, caravan_companion_ask_change_home_settlement_3_on_consequence);
		starter.AddDialogLine("caravan_companion_ask_change_home_settlement_3", "caravan_companion_ask_change_home_settlement_3", "caravan_companion_ask_change_home_settlement_4", "{=SuQSy6g2}And which town there did you have in mind?", null, null);
		starter.AddRepeatablePlayerLine("caravan_companion_ask_change_home_settlement_4", "caravan_companion_ask_change_home_settlement_4", "caravan_companion_change_home_settlement_end", "{=!}{SETTLEMENT.NAME}", "{=aE4JAqn0}I am thinking of a different settlement.", "caravan_companion_ask_change_home_settlement_3", caravan_companion_ask_change_home_settlement_4_on_condition, caravan_companion_ask_change_home_settlement_4_on_consequence);
		starter.AddPlayerLine("caravan_companion_ask_change_home_settlement_cancel", "caravan_companion_ask_change_home_settlement_2", "lord_pretalk", "{=PznWhAdU}Actually, never mind.", null, null);
		starter.AddPlayerLine("caravan_companion_ask_change_home_settlement_cancel_2", "caravan_companion_ask_change_home_settlement_4", "lord_pretalk", "{=PznWhAdU}Actually, never mind.", null, null);
		starter.AddDialogLine("caravan_companion_change_home_settlement_end", "caravan_companion_change_home_settlement_end", "caravan_companion_anything_else", "{=cWwYmaw7}Understood. {NEW_HOME_SETTLEMENT_LINE}", caravan_companion_change_home_settlement_end_on_condition, null);
		starter.AddDialogLine("caravan_companion_prohibit_kingdoms_selected", "caravan_companion_prohibit_kingdoms_selected", "caravan_companion_prohibit_kingdoms_selected_2", "{=cK0yctTy}Certainly. {DESPITE_WAR}", null, null);
		starter.AddRepeatablePlayerLine("caravan_companion_prohibit_kingdoms_selected_2", "caravan_companion_prohibit_kingdoms_selected_2", "caravan_companion_prohibit_kingdoms_selected", "{=!}{CONTINUE_OR_STOP_TRADE}", "{=bKqka5Uj}I am thinking of a different realm.", "caravan_companion_prohibit_kingdoms_selected", caravan_companion_prohibit_kingdoms_selected_2_on_condition, caravan_companion_prohibit_kingdoms_selected_2_on_consequence);
		starter.AddPlayerLine("caravan_companion_prohibit_kingdoms_selected_cancel", "caravan_companion_prohibit_kingdoms_selected_2", "lord_pretalk", "{=FM7YZaOa}Alright, that is all.", null, null);
		starter.AddDialogLine("player_caravan_talk_start", "start", "player_caravan_talk_start", "{=BsVXQEhj}How may I help you?", player_caravan_talk_start_on_condition, null);
		starter.AddPlayerLine("player_caravan_trade_rumors", "player_caravan_talk_start", "player_caravan_ask_trade_rumors", "{=shNl2Npf}What news of the markets?", null, null);
		starter.AddDialogLine("player_caravan_ask_trade_rumors", "player_caravan_ask_trade_rumors", "player_caravan_anything_else", "{=sC4ZLZ8x}{COMMENT}", null, caravan_ask_trade_rumors_on_consequence);
		starter.AddDialogLine("player_caravan_talk_player_thank", "player_caravan_anything_else", "player_caravan_talk_end", "{=DQBaaC0e}Is there anything else?", null, null);
		starter.AddPlayerLine("player_caravan_talk_not_leave", "player_caravan_talk_end", "start", "{=i2FwKPmC}Yes, I wanted to talk about something else..", null, null);
		starter.AddPlayerLine("player_caravan_talk_leave", "player_caravan_talk_end", "close_window", "{=1IJouNaM}Carry on, then. Farewell.", null, caravan_player_leave_encounter_on_consequence);
		starter.AddPlayerLine("player_caravan_nevermind", "player_caravan_talk_start", "close_window", "{=D33fIGQe}Never mind.", null, caravan_player_leave_encounter_on_consequence);
		starter.AddDialogLine("caravan_hero_leader_talk_start", "start", "caravan_talk", "{=!}{CARAVAN_GREETING}", caravan_start_talk_on_condition, null);
		starter.AddDialogLine("caravan_pretalk", "caravan_pretalk", "caravan_talk", "{=3cBfSJOI}Is there anything else?[ib:normal]", null, null);
		starter.AddPlayerLine("caravan_buy_products", "caravan_talk", "caravan_player_trade", "{=t0UGXPV4}I'm interested in trading. What kind of products do you have?", caravan_buy_products_on_condition, null);
		starter.AddPlayerLine("caravan_trade_rumors", "caravan_talk", "caravan_ask_trade_rumors", "{=b5Ucatkb}Tell me about your journeys. What news of the markets?", caravan_ask_trade_rumors_on_condition, null);
		starter.AddDialogLine("caravan_ask_trade_rumors", "caravan_ask_trade_rumors", "caravan_trade_rumors_player_answer", "{=sC4ZLZ8x}{COMMENT}", null, caravan_ask_trade_rumors_on_consequence);
		starter.AddPlayerLine("caravan_trade_rumors_player_answer", "caravan_trade_rumors_player_answer", "caravan_talk_player_thank", "{=ha7EmrU9}Thank you for that information.", null, null);
		starter.AddDialogLine("caravan_talk_player_thank", "caravan_talk_player_thank", "caravan_talk", "{=BQuVWKvq}You're welcome. Is there anything we need to discuss?", null, null);
		starter.AddPlayerLine("caravan_loot", "caravan_talk", "caravan_loot_talk", "{=WOBy5UfY}Hand over your goods, or die!", caravan_loot_on_condition, null, 100, caravan_loot_on_clickable_condition);
		starter.AddPlayerLine("caravan_talk_leave", "caravan_talk", "close_window", "{=1IJouNaM}Carry on, then. Farewell.", null, caravan_talk_leave_on_consequence);
		starter.AddDialogLine("caravan_player_trade_end", "caravan_player_trade", "caravan_pretalk", "{=tlLDHAIu}Very well. A pleasure doing business with you.[rf:convo_relaxed_happy][ib:demure]", conversation_caravan_player_trade_end_on_condition, null);
		starter.AddDialogLine("caravan_player_trade_end_response", "caravan_player_trade_response", "close_window", "{=2g2FhKb5}Farewell.", null, null);
		starter.AddDialogLine("caravan_fight", "caravan_loot_talk", "caravan_do_not_bribe", "{=!}{CARAVAN_DEFIANCE}", conversation_caravan_not_bribe_on_condition, null);
		starter.AddPlayerLine("player_decided_to_fight", "caravan_do_not_bribe", "close_window", "{=EhxS7NQ4}So be it. Attack!", null, conversation_caravan_fight_on_consequence);
		starter.AddPlayerLine("player_decided_to_not_fight_1", "caravan_do_not_bribe", "close_window", "{=bfPsE9M1}You must have misunderstood me. Go in peace.", null, caravan_talk_leave_on_consequence);
		starter.AddDialogLine("caravan_accepted_to_give_some_goods", "caravan_loot_talk", "caravan_give_some_goods", "{=dMc3SjOK}We can pay you. {TAKE_MONEY_AND_PRODUCT_STRING}[rf:idle_angry][ib:nervous]", conversation_caravan_give_goods_on_condition, null);
		starter.AddPlayerLine("player_decided_to_take_some_goods", "caravan_give_some_goods", "caravan_end_talk_bribe", "{=0Pd84h4W}I'll accept that.", null, null, 100, delegate(out TextObject explanation)
		{
			explanation = new TextObject("{=nbgyyif6}This action may start a war.");
			return true;
		});
		starter.AddPlayerLine("player_decided_to_take_everything", "caravan_give_some_goods", "player_wants_everything", "{=QZ6IcCIm}I want everything you've got.", null, null, 100, delegate(out TextObject explanation)
		{
			explanation = new TextObject("{=nbgyyif6}This action may start a war.");
			return true;
		});
		starter.AddPlayerLine("player_decided_to_not_fight_2", "caravan_give_some_goods", "close_window", "{=bfPsE9M1}You must have misunderstood me. Go in peace.", null, caravan_talk_leave_on_consequence);
		starter.AddDialogLine("caravan_fight_no_surrender", "player_wants_everything", "close_window", "{=3JfCwL31}You will have to fight us first![rf:idle_angry][ib:aggressive]", conversation_caravan_not_surrender_on_condition, conversation_caravan_fight_on_consequence);
		starter.AddDialogLine("caravan_accepted_to_give_everything", "player_wants_everything", "player_decision_to_take_prisoners", "{=hbtbSag8}We can't fight you. We surrender. Please don't hurt us. Take what you want.[if:idle_angry][ib:nervous]", conversation_caravan_give_goods_on_condition, null);
		starter.AddPlayerLine("player_do_not_take_prisoners", "player_decision_to_take_prisoners", "caravan_end_talk_surrender", "{=6kaia5qP}Give me all your wares!", null, null, 100, delegate(out TextObject explanation)
		{
			explanation = new TextObject("{=nbgyyif6}This action may start a war.");
			return true;
		});
		starter.AddPlayerLine("player_decided_to_take_prisoner", "player_decision_to_take_prisoners", "caravan_taken_prisoner_warning_check", "{=1gv0AVUN}You are my prisoners now.", null, null, 100, delegate(out TextObject explanation)
		{
			explanation = new TextObject("{=1LlH1Jof}This action will start a war.");
			return true;
		});
		starter.AddPlayerLine("player_decided_to_force_fight", "player_decision_to_take_prisoners", "caravan_force_start_encounter", "{=ha53qb7v}Don't bother pleading for your lives. At them, lads!", null, null, 100, delegate(out TextObject explanation)
		{
			explanation = new TextObject("{=1LlH1Jof}This action will start a war.");
			return true;
		});
		starter.AddDialogLine("caravan_force_fight_encounter", "caravan_force_start_encounter", "close_window", "{=yoWl6w1I}Heaven will avenge us, you butcher!", null, conversation_caravan_fight_forced_on_consequence);
		starter.AddDialogLine("caravan_warn_player_to_take_prisoner", "caravan_taken_prisoner_warning_check", "caravan_taken_prisoner_warning_answer", "{=NuYzgBZB}You are going too far. The {KINGDOM} won't stand for the destruction of its caravans.", conversation_warn_player_on_condition, null);
		starter.AddDialogLine("caravan_do_not_warn_player", "caravan_taken_prisoner_warning_check", "close_window", "{=BvytaDUJ}Heaven protect us from the likes of you.", null, delegate
		{
			Campaign.Current.ConversationManager.ConversationEndOneShot += player_take_prisoner_consequence;
		});
		starter.AddPlayerLine("player_decided_to_take_prisoner_continue", "caravan_taken_prisoner_warning_answer", "close_window", "{=WVkc4UgX}Continue.", null, conversation_caravan_took_prisoner_on_consequence);
		starter.AddPlayerLine("player_decided_to_take_prisoner_leave", "caravan_taken_prisoner_warning_answer", "caravan_loot_talk", "{=D33fIGQe}Never mind.", null, null);
		starter.AddDialogLine("caravan_bribery_leave", "caravan_end_talk_bribe", "close_window", "{=uPwKhAps}Can we leave now?", conversation_caravan_looted_leave_on_condition, conversation_caravan_looted_leave_on_consequence);
		starter.AddDialogLine("caravan_surrender_leave", "caravan_end_talk_surrender", "close_window", "{=uPwKhAps}Can we leave now?", conversation_caravan_looted_leave_on_condition, conversation_caravan_surrender_leave_on_consequence);
	}

	private bool caravan_companion_change_home_settlement_on_condition()
	{
		if (MobileParty.ConversationParty.IsCurrentlyUsedByAQuest)
		{
			return false;
		}
		return true;
	}

	private bool caravan_companion_change_home_settlement_clickable_condition(out TextObject explanation)
	{
		if (GetSuitableKingdomsForHomeSettlement().Count == 0)
		{
			explanation = new TextObject("{=MQM5SxdI}There is no suitable kingdom to select a new home settlement from.");
			return false;
		}
		explanation = null;
		return true;
	}

	private void caravan_companion_change_home_settlement_on_consequence()
	{
		ConversationSentence.SetObjectsToRepeatOver(GetSuitableKingdomsForHomeSettlement());
	}

	private bool caravan_companion_ask_change_home_settlement_2_on_condition()
	{
		MobileParty conversationParty = MobileParty.ConversationParty;
		MBTextManager.SetTextVariable("HOME_SETTLEMENT", conversationParty.HomeSettlement?.Name);
		return true;
	}

	private bool caravan_companion_ask_change_home_settlement_3_on_condition()
	{
		if (ConversationSentence.CurrentProcessedRepeatObject is Kingdom kingdom)
		{
			ConversationSentence.SelectedRepeatLine.SetTextVariable("KINGDOM_NAME", kingdom.Name);
			return true;
		}
		return false;
	}

	private void caravan_companion_ask_change_home_settlement_3_on_consequence()
	{
		Kingdom kingdom = ConversationSentence.SelectedRepeatObject as Kingdom;
		ConversationSentence.SetObjectsToRepeatOver(GetSuitableHomeSettlementsForKingdom(kingdom));
	}

	private bool caravan_companion_ask_change_home_settlement_4_on_condition()
	{
		if (ConversationSentence.CurrentProcessedRepeatObject is Settlement settlement)
		{
			StringHelpers.SetSettlementProperties("SETTLEMENT", settlement, null, isRepeatable: true);
			return true;
		}
		return false;
	}

	private void caravan_companion_ask_change_home_settlement_4_on_consequence()
	{
		Settlement settlement = ConversationSentence.SelectedRepeatObject as Settlement;
		StringHelpers.SetSettlementProperties("SETTLEMENT", settlement);
		MobileParty.ConversationParty.CaravanPartyComponent.ChangeHomeSettlement(settlement);
	}

	private bool caravan_companion_change_home_settlement_end_on_condition()
	{
		MobileParty conversationParty = MobileParty.ConversationParty;
		TextObject empty = TextObject.GetEmpty();
		empty = ((!conversationParty.HomeSettlement.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction)) ? new TextObject("{=JIPKLzsx}Our new home is {SETTLEMENT_NAME}.") : new TextObject("{=Qyqurdka}Although it is inside enemy territory, our new home is {SETTLEMENT_NAME}."));
		empty.SetTextVariable("SETTLEMENT_NAME", conversationParty.HomeSettlement.Name);
		MBTextManager.SetTextVariable("NEW_HOME_SETTLEMENT_LINE", empty);
		return true;
	}

	private bool caravan_companion_prohibit_kingdoms_on_condition()
	{
		if (MobileParty.ConversationParty.IsCurrentlyUsedByAQuest)
		{
			return false;
		}
		return true;
	}

	private void caravan_companion_prohibit_kingdoms_on_consequence()
	{
		ConversationSentence.SetObjectsToRepeatOver(GetSuitableKingdomsAsTradePartnerForPlayerCaravans());
	}

	private bool caravan_companion_prohibit_kingdoms_clickable_condition(out TextObject explanation)
	{
		if (GetSuitableKingdomsAsTradePartnerForPlayerCaravans().Count == 0)
		{
			explanation = new TextObject("{=vUmhym4n}There is no suitable kingdom to discuss as a trade partner.");
			return false;
		}
		explanation = null;
		return true;
	}

	private bool caravan_companion_prohibit_kingdoms_selected_2_on_condition()
	{
		if (ConversationSentence.CurrentProcessedRepeatObject is Kingdom kingdom)
		{
			bool num = _prohibitedKingdomsForPlayerCaravans.Contains(kingdom);
			TextObject empty = TextObject.GetEmpty();
			empty = ((!num) ? new TextObject("{=KsFOH8vo}Let's stop trading with {KINGDOM_NAME}.") : new TextObject("{=1QBbbq4h}Let's continue trading with {KINGDOM_NAME}."));
			empty.SetTextVariable("KINGDOM_NAME", kingdom.Name);
			ConversationSentence.SelectedRepeatLine.SetTextVariable("CONTINUE_OR_STOP_TRADE", empty);
			return true;
		}
		return false;
	}

	private void caravan_companion_prohibit_kingdoms_selected_2_on_consequence()
	{
		Kingdom kingdom = ConversationSentence.SelectedRepeatObject as Kingdom;
		bool num = _prohibitedKingdomsForPlayerCaravans.Contains(kingdom);
		TextObject textObject = TextObject.GetEmpty();
		if (num)
		{
			_prohibitedKingdomsForPlayerCaravans.Remove(kingdom);
		}
		else
		{
			_prohibitedKingdomsForPlayerCaravans.Add(kingdom);
			if (kingdom.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				textObject = new TextObject("{=y9sgoggj}We are currently at war with {KINGDOM_NAME}, and we shall not start trading with them even if we make peace.");
				textObject.SetTextVariable("KINGDOM_NAME", kingdom.Name);
			}
		}
		MBTextManager.SetTextVariable("DESPITE_WAR", textObject);
	}

	private void conversation_caravan_fight_forced_on_consequence()
	{
		SetPlayerInteraction(MobileParty.ConversationParty, PlayerInteraction.Hostile);
		BeHostileAction.ApplyEncounterHostileAction(MobileParty.MainParty.Party, MobileParty.ConversationParty.Party);
	}

	private bool companion_is_caravan_leader_on_condition()
	{
		if (Hero.OneToOneConversationHero != null && MobileParty.ConversationParty != null && MobileParty.ConversationParty.Party.Owner == Hero.MainHero && MobileParty.ConversationParty.IsCaravan)
		{
			if (!Hero.OneToOneConversationHero.IsPlayerCompanion)
			{
				return Hero.OneToOneConversationHero.Clan == Clan.PlayerClan;
			}
			return true;
		}
		return false;
	}

	private bool player_caravan_talk_start_on_condition()
	{
		if (Hero.OneToOneConversationHero == null && MobileParty.ConversationParty != null && MobileParty.ConversationParty.Party.Owner == Hero.MainHero && MobileParty.ConversationParty.IsCaravan)
		{
			return PartyBase.MainParty.Side == BattleSideEnum.Attacker;
		}
		return false;
	}

	private void player_take_prisoner_consequence()
	{
		if (MobileParty.MainParty.MapFaction.IsAtWarWith(PlayerEncounter.EncounteredMobileParty.MapFaction))
		{
			conversation_caravan_took_prisoner_on_consequence();
		}
	}

	private bool conversation_warn_player_on_condition()
	{
		IFaction mapFaction = MobileParty.ConversationParty.MapFaction;
		MBTextManager.SetTextVariable("KINGDOM", mapFaction.IsKingdomFaction ? ((Kingdom)mapFaction).EncyclopediaTitle : mapFaction.Name);
		if (PlayerEncounter.Current != null && !PlayerEncounter.LeaveEncounter)
		{
			return !MobileParty.MainParty.MapFaction.IsAtWarWith(MobileParty.ConversationParty.MapFaction);
		}
		return false;
	}

	private bool caravan_start_talk_on_condition()
	{
		if (MobileParty.ConversationParty == null || !MobileParty.ConversationParty.IsCaravan)
		{
			return false;
		}
		PlayerInteraction playerInteraction = GetPlayerInteraction(MobileParty.ConversationParty);
		SetPlayerInteraction(MobileParty.ConversationParty, PlayerInteraction.Friendly);
		switch (playerInteraction)
		{
		case PlayerInteraction.Hostile:
			MBTextManager.SetTextVariable("CARAVAN_GREETING", "{=L7AN6ybY}What do you want with us now?");
			break;
		default:
			MBTextManager.SetTextVariable("CARAVAN_GREETING", "{=Z5kqbeyu}Greetings, once again. Is there anything else?");
			break;
		case PlayerInteraction.None:
		{
			if (CharacterObject.OneToOneConversationCharacter.IsHero && PartyBase.MainParty.Side == BattleSideEnum.Attacker && MobileParty.ConversationParty.Party.Owner != Hero.MainHero)
			{
				StringHelpers.SetCharacterProperties("LEADER", CharacterObject.OneToOneConversationCharacter);
				MBTextManager.SetTextVariable("CARAVAN_GREETING", "{=afVsbikp}Greetings, traveller. How may we help you?");
				break;
			}
			MBTextManager.SetTextVariable("HOMETOWN", MobileParty.ConversationParty.HomeSettlement.EncyclopediaLinkWithName);
			StringHelpers.SetCharacterProperties("MERCHANT", MobileParty.ConversationParty.Party.Owner.CharacterObject);
			StringHelpers.SetCharacterProperties("PROTECTOR", MobileParty.ConversationParty.HomeSettlement.OwnerClan.Leader.CharacterObject);
			TextObject text = new TextObject("{=FpUybbSk}Greetings. This caravan is owned by {MERCHANT.LINK}. We trade under the protection of {PROTECTOR.LINK}, master of {HOMETOWN}. How may we help you?[if:convo_normal]");
			if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCurrentlyAtSea)
			{
				text = new TextObject("{=yGttYe7g}Greetings. This ship is owned by {MERCHANT.LINK}. We sail under the protection of {PROTECTOR.LINK}, master of {HOMETOWN}. How may we help you?[if:convo_normal]");
			}
			MBTextManager.SetTextVariable("CARAVAN_GREETING", text);
			break;
		}
		}
		return true;
	}

	private bool caravan_loot_on_condition()
	{
		if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCaravan && MobileParty.ConversationParty.Party.MapFaction != Hero.MainHero.MapFaction)
		{
			return MobileParty.ConversationParty.Party.Owner != Hero.MainHero;
		}
		return false;
	}

	private bool caravan_loot_on_clickable_condition(out TextObject explanation)
	{
		if (_lootedCaravans.ContainsKey(MobileParty.ConversationParty))
		{
			explanation = new TextObject("{=il2khBNl}You just looted this party.");
			return false;
		}
		BribeAmount(MobileParty.ConversationParty.Party, out var gold, out var items);
		bool flag = gold > 0;
		bool flag2 = !items.IsEmpty();
		if (flag)
		{
			if (flag2)
			{
				TextObject textObject = ((items.Count == 1) ? GameTexts.FindText("str_LEFT_RIGHT") : GameTexts.FindText("str_LEFT_comma_RIGHT"));
				TextObject textObject2 = GameTexts.FindText("str_looted_party_have_money");
				textObject2.SetTextVariable("MONEY", gold);
				textObject2.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				textObject2.SetTextVariable("ITEM_LIST", textObject);
				for (int i = 0; i < items.Count; i++)
				{
					ItemRosterElement elementCopyAtIndex = items.GetElementCopyAtIndex(i);
					TextObject textObject3 = GameTexts.FindText("str_offered_item_list");
					textObject3.SetTextVariable("COUNT", elementCopyAtIndex.Amount);
					textObject3.SetTextVariable("ITEM", elementCopyAtIndex.EquipmentElement.Item.Name);
					textObject.SetTextVariable("LEFT", textObject3);
					if (items.Count == 1)
					{
						textObject.SetTextVariable("RIGHT", TextObject.GetEmpty());
					}
					else if (items.Count - 2 > i)
					{
						TextObject textObject4 = GameTexts.FindText("str_LEFT_comma_RIGHT");
						textObject.SetTextVariable("RIGHT", textObject4);
						textObject = textObject4;
					}
					else
					{
						TextObject textObject5 = GameTexts.FindText("str_LEFT_ONLY");
						textObject.SetTextVariable("RIGHT", textObject5);
						textObject = textObject5;
					}
				}
				MBTextManager.SetTextVariable("TAKE_MONEY_AND_PRODUCT_STRING", textObject2);
			}
			else
			{
				TextObject textObject6 = GameTexts.FindText("str_looted_party_have_money_but_no_item");
				textObject6.SetTextVariable("MONEY", gold);
				textObject6.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				MBTextManager.SetTextVariable("TAKE_MONEY_AND_PRODUCT_STRING", textObject6);
			}
		}
		else if (flag2)
		{
			TextObject textObject7 = ((items.Count == 1) ? GameTexts.FindText("str_LEFT_RIGHT") : GameTexts.FindText("str_LEFT_comma_RIGHT"));
			TextObject textObject8 = GameTexts.FindText("str_looted_party_have_no_money");
			textObject8.SetTextVariable("ITEM_LIST", textObject7);
			for (int j = 0; j < items.Count; j++)
			{
				ItemRosterElement elementCopyAtIndex2 = items.GetElementCopyAtIndex(j);
				TextObject textObject9 = GameTexts.FindText("str_offered_item_list");
				textObject9.SetTextVariable("COUNT", elementCopyAtIndex2.Amount);
				textObject9.SetTextVariable("ITEM", elementCopyAtIndex2.EquipmentElement.Item.Name);
				textObject7.SetTextVariable("LEFT", textObject9);
				if (items.Count == 1)
				{
					textObject7.SetTextVariable("RIGHT", TextObject.GetEmpty());
				}
				else if (items.Count - 2 > j)
				{
					TextObject textObject10 = GameTexts.FindText("str_LEFT_comma_RIGHT");
					textObject7.SetTextVariable("RIGHT", textObject10);
					textObject7 = textObject10;
				}
				else
				{
					TextObject textObject11 = GameTexts.FindText("str_LEFT_ONLY");
					textObject7.SetTextVariable("RIGHT", textObject11);
					textObject7 = textObject11;
				}
			}
			MBTextManager.SetTextVariable("TAKE_MONEY_AND_PRODUCT_STRING", textObject8);
		}
		if (!flag && !flag2)
		{
			explanation = new TextObject("{=pbRwAjUN}They seem to have no valuable goods.");
			return false;
		}
		explanation = null;
		return true;
	}

	private bool caravan_buy_products_on_condition()
	{
		if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCaravan)
		{
			if (MobileParty.ConversationParty.IsInRaftState)
			{
				return false;
			}
			for (int i = 0; i < MobileParty.ConversationParty.ItemRoster.Count; i++)
			{
				if (MobileParty.ConversationParty.ItemRoster.GetElementNumber(i) > 0)
				{
					return true;
				}
			}
		}
		return false;
	}

	private void caravan_player_leave_encounter_on_consequence()
	{
		PlayerEncounter.LeaveEncounter = true;
	}

	private bool caravan_ask_trade_rumors_on_condition()
	{
		return !MobileParty.ConversationParty.IsInRaftState;
	}

	private void caravan_ask_trade_rumors_on_consequence()
	{
		Town destinationForMobileParty = GetDestinationForMobileParty(MobileParty.ConversationParty);
		if (MobileParty.ConversationParty.LastVisitedSettlement != null && destinationForMobileParty != null && MobileParty.ConversationParty.LastVisitedSettlement != destinationForMobileParty.Settlement)
		{
			List<(TradeActionLog, float)> list = new List<(TradeActionLog, float)>();
			if (_tradeActionLogs.TryGetValue(MobileParty.ConversationParty, out var value))
			{
				foreach (TradeActionLog item in value)
				{
					float profitRate = item.ProfitRate;
					if (profitRate > 1.2f && item.SoldSettlement != null && item.SoldSettlement != item.BoughtSettlement)
					{
						list.Add((item, profitRate));
					}
				}
			}
			if (list.Count > 0)
			{
				TradeActionLog tradeActionLog = MBRandom.ChooseWeighted(list);
				MBTextManager.SetTextVariable("ITEM_NAME", tradeActionLog.ItemRosterElement.EquipmentElement.Item.Name);
				MBTextManager.SetTextVariable("SETTLEMENT", tradeActionLog.BoughtSettlement.EncyclopediaLinkWithName);
				MBTextManager.SetTextVariable("DESTINATION", tradeActionLog.SoldSettlement.EncyclopediaLinkWithName);
				MBTextManager.SetTextVariable("BUY_COST", tradeActionLog.BuyPrice);
				MBTextManager.SetTextVariable("SELL_COST", tradeActionLog.SellPrice);
				MBTextManager.SetTextVariable("COMMENT", GameTexts.FindText("str_caravan_trade_comment"));
				if (_tradeRumorTakenCaravans.ContainsKey(MobileParty.ConversationParty) && (!_tradeRumorTakenCaravans.ContainsKey(MobileParty.ConversationParty) || !(CampaignTime.Now - _tradeRumorTakenCaravans[MobileParty.ConversationParty] >= CampaignTime.Days(1f))))
				{
					return;
				}
				List<TradeRumor> list2 = new List<TradeRumor>();
				list2.Add(new TradeRumor(destinationForMobileParty.Owner.Settlement, tradeActionLog.ItemRosterElement.EquipmentElement.Item, destinationForMobileParty.GetItemPrice(tradeActionLog.ItemRosterElement.EquipmentElement.Item), destinationForMobileParty.GetItemPrice(tradeActionLog.ItemRosterElement.EquipmentElement.Item, null, isSelling: true), 10));
				Town town = MobileParty.ConversationParty.LastVisitedSettlement.Town;
				if (town != null)
				{
					list2.Add(new TradeRumor(town.Owner.Settlement, tradeActionLog.ItemRosterElement.EquipmentElement.Item, town.GetItemPrice(tradeActionLog.ItemRosterElement.EquipmentElement.Item), town.GetItemPrice(tradeActionLog.ItemRosterElement.EquipmentElement.Item, null, isSelling: true), 10));
				}
				if (list2.Count > 0)
				{
					CampaignEventDispatcher.Instance.OnTradeRumorIsTaken(list2);
					if (_tradeRumorTakenCaravans.ContainsKey(MobileParty.ConversationParty) && CampaignTime.Now - _tradeRumorTakenCaravans[MobileParty.ConversationParty] >= CampaignTime.Days(1f))
					{
						_tradeRumorTakenCaravans[MobileParty.ConversationParty] = CampaignTime.Now;
					}
					else
					{
						_tradeRumorTakenCaravans.Add(MobileParty.ConversationParty, CampaignTime.Now);
					}
				}
			}
			else
			{
				MBTextManager.SetTextVariable("COMMENT", GameTexts.FindText("str_caravan_trade_comment_no_profit"));
			}
		}
		else
		{
			MBTextManager.SetTextVariable("COMMENT", new TextObject("{=TEUVTPIa}Well, we've been resting in town for a while, so our information is probably quite out of date."));
		}
	}

	private void caravan_talk_leave_on_consequence()
	{
		if (PlayerEncounter.Current != null)
		{
			PlayerEncounter.LeaveEncounter = true;
		}
	}

	private bool conversation_caravan_player_trade_end_on_condition()
	{
		if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCaravan)
		{
			InventoryScreenHelper.OpenTradeWithCaravanOrAlleyParty(MobileParty.ConversationParty);
		}
		return true;
	}

	private bool conversation_caravan_not_bribe_on_condition()
	{
		if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCaravan)
		{
			if (MobileParty.ConversationParty.IsInRaftState)
			{
				return false;
			}
			if (MobileParty.ConversationParty.IsCurrentlyAtSea)
			{
				MBTextManager.SetTextVariable("CARAVAN_DEFIANCE", "{=jfKTahGa}If you want our wares you'll have to take this ship, you damned pirate![rf: idle_angry][ib: aggressive]");
			}
			else
			{
				MBTextManager.SetTextVariable("CARAVAN_DEFIANCE", "{=QNaKmkt9}We're paid to guard this caravan. If you want to rob it, it's going to be over our dead bodies![rf: idle_angry][ib: aggressive]");
			}
			return !IsBribeFeasible();
		}
		return false;
	}

	private bool conversation_caravan_not_surrender_on_condition()
	{
		if (MobileParty.ConversationParty != null && MobileParty.ConversationParty.IsCaravan)
		{
			if (MobileParty.ConversationParty.IsInRaftState)
			{
				return false;
			}
			return !IsSurrenderFeasible();
		}
		return false;
	}

	private void conversation_caravan_fight_on_consequence()
	{
		SetPlayerInteraction(MobileParty.ConversationParty, PlayerInteraction.Hostile);
		BeHostileAction.ApplyEncounterHostileAction(PartyBase.MainParty, MobileParty.ConversationParty.Party);
	}

	private bool conversation_caravan_give_goods_on_condition()
	{
		if (MobileParty.ConversationParty != null)
		{
			return MobileParty.ConversationParty.IsCaravan;
		}
		return false;
	}

	private bool conversation_caravan_looted_leave_on_condition()
	{
		if (MobileParty.ConversationParty != null)
		{
			return MobileParty.ConversationParty.IsCaravan;
		}
		return false;
	}

	private void conversation_caravan_looted_leave_on_consequence()
	{
		BribeAmount(MobileParty.ConversationParty.Party, out var gold, out var items);
		GiveGoldAction.ApplyForPartyToCharacter(MobileParty.ConversationParty.Party, Hero.MainHero, gold);
		if (!items.IsEmpty())
		{
			for (int num = items.Count - 1; num >= 0; num--)
			{
				GiveItemAction.ApplyForParties(MobileParty.ConversationParty.Party, Hero.MainHero.PartyBelongedTo.Party, items[num]);
			}
		}
		BeHostileAction.ApplyMinorCoercionHostileAction(PartyBase.MainParty, MobileParty.ConversationParty.Party);
		_lootedCaravans.Add(MobileParty.ConversationParty, CampaignTime.Now);
		SetPlayerInteraction(MobileParty.ConversationParty, PlayerInteraction.Hostile);
		SkillLevelingManager.OnLoot(MobileParty.MainParty, MobileParty.ConversationParty, items, attacked: false);
		PlayerEncounter.LeaveEncounter = true;
	}

	private void conversation_caravan_surrender_leave_on_consequence()
	{
		ItemRoster itemRoster = new ItemRoster(MobileParty.ConversationParty.ItemRoster);
		bool flag = false;
		for (int i = 0; i < itemRoster.Count; i++)
		{
			if (itemRoster.GetElementNumber(i) > 0)
			{
				flag = true;
				break;
			}
		}
		if (flag)
		{
			InventoryScreenHelper.OpenScreenAsLoot(new Dictionary<PartyBase, ItemRoster> { 
			{
				PartyBase.MainParty,
				itemRoster
			} });
			MobileParty.ConversationParty.ItemRoster.Clear();
		}
		int num = TaleWorlds.Library.MathF.Max(MobileParty.ConversationParty.PartyTradeGold, 0);
		if (num > 0)
		{
			GiveGoldAction.ApplyForPartyToCharacter(MobileParty.ConversationParty.Party, Hero.MainHero, num);
		}
		BeHostileAction.ApplyMajorCoercionHostileAction(PartyBase.MainParty, MobileParty.ConversationParty.Party);
		_lootedCaravans.Add(MobileParty.ConversationParty, CampaignTime.Now);
		SkillLevelingManager.OnLoot(MobileParty.MainParty, MobileParty.ConversationParty, itemRoster, attacked: false);
		PlayerEncounter.LeaveEncounter = true;
	}

	private void conversation_caravan_took_prisoner_on_consequence()
	{
		MobileParty encounteredMobileParty = PlayerEncounter.EncounteredMobileParty;
		ItemRoster itemRoster = new ItemRoster(encounteredMobileParty.ItemRoster);
		bool flag = false;
		for (int i = 0; i < itemRoster.Count; i++)
		{
			if (itemRoster.GetElementNumber(i) > 0)
			{
				flag = true;
				break;
			}
		}
		if (flag)
		{
			InventoryScreenHelper.OpenScreenAsLoot(new Dictionary<PartyBase, ItemRoster> { 
			{
				PartyBase.MainParty,
				itemRoster
			} });
			encounteredMobileParty.ItemRoster.Clear();
		}
		int num = TaleWorlds.Library.MathF.Max(encounteredMobileParty.PartyTradeGold, 0);
		if (num > 0)
		{
			GiveGoldAction.ApplyForPartyToCharacter(encounteredMobileParty.Party, Hero.MainHero, num);
		}
		BeHostileAction.ApplyEncounterHostileAction(PartyBase.MainParty, encounteredMobileParty.Party);
		TroopRoster troopRoster = TroopRoster.CreateDummyTroopRoster();
		foreach (TroopRosterElement item in encounteredMobileParty.MemberRoster.GetTroopRoster())
		{
			troopRoster.AddToCounts(item.Character, item.Number);
		}
		PartyScreenHelper.OpenScreenAsLoot(TroopRoster.CreateDummyTroopRoster(), troopRoster, encounteredMobileParty.Name, troopRoster.TotalManCount);
		SkillLevelingManager.OnLoot(MobileParty.MainParty, encounteredMobileParty, itemRoster, attacked: false);
		DestroyPartyAction.Apply(MobileParty.MainParty.Party, encounteredMobileParty);
		PlayerEncounter.LeaveEncounter = true;
	}

	private bool IsBribeFeasible()
	{
		float resultNumber = Campaign.Current.Models.EncounterModel.GetBribeChance(MobileParty.ConversationParty, MobileParty.MainParty).ResultNumber;
		if (MobileParty.ConversationParty.Party.RandomFloatWithSeed(5u, 1f) > resultNumber)
		{
			return false;
		}
		return true;
	}

	private bool IsSurrenderFeasible()
	{
		float surrenderChance = Campaign.Current.Models.EncounterModel.GetSurrenderChance(MobileParty.ConversationParty, MobileParty.MainParty);
		if (MobileParty.ConversationParty.Party.RandomFloatWithSeed(7u, 1f) > surrenderChance)
		{
			return false;
		}
		return true;
	}

	private void BribeAmount(PartyBase party, out int gold, out ItemRoster items)
	{
		int num = 0;
		ItemRoster itemRoster = new ItemRoster();
		bool flag = false;
		for (int i = 0; i < MobileParty.ConversationParty.ItemRoster.Count; i++)
		{
			num += MobileParty.ConversationParty.ItemRoster.GetElementUnitCost(i) * MobileParty.ConversationParty.ItemRoster.GetElementNumber(i);
			flag = true;
		}
		num += MobileParty.ConversationParty.PartyTradeGold;
		int num2 = TaleWorlds.Library.MathF.Min((int)((float)num * 0.05f), 2000);
		int num3 = TaleWorlds.Library.MathF.Min(MobileParty.ConversationParty.PartyTradeGold, num2);
		if (num3 < num2 && flag)
		{
			for (int j = 0; j < MobileParty.ConversationParty.ItemRoster.Count; j++)
			{
				ItemRosterElement elementCopyAtIndex = MobileParty.ConversationParty.ItemRoster.GetElementCopyAtIndex(j);
				if (elementCopyAtIndex.EquipmentElement.ItemValue * elementCopyAtIndex.Amount < num2 - num3)
				{
					continue;
				}
				if (elementCopyAtIndex.EquipmentElement.Item.Type == ItemObject.ItemTypeEnum.Goods)
				{
					if (!itemRoster.IsEmpty())
					{
						itemRoster.Clear();
					}
					itemRoster.AddToCounts(elementCopyAtIndex.EquipmentElement.Item, elementCopyAtIndex.Amount);
					break;
				}
				if (itemRoster.IsEmpty())
				{
					itemRoster.AddToCounts(elementCopyAtIndex.EquipmentElement.Item, elementCopyAtIndex.Amount);
				}
			}
			if (itemRoster.IsEmpty())
			{
				int num4 = num2 - num3;
				for (int k = 0; k < MobileParty.ConversationParty.ItemRoster.Count; k++)
				{
					if (num4 <= 0)
					{
						break;
					}
					ItemRosterElement randomElement = MobileParty.ConversationParty.ItemRoster.GetRandomElement();
					num4 -= randomElement.Amount * randomElement.EquipmentElement.ItemValue;
					itemRoster.AddToCounts(randomElement.EquipmentElement.Item, randomElement.Amount);
				}
			}
		}
		gold = num3;
		items = itemRoster;
	}

	private bool CanTradeWith(IFaction caravanFaction, IFaction targetFaction)
	{
		if (caravanFaction.IsAtWarWith(targetFaction))
		{
			return false;
		}
		if (caravanFaction == Hero.MainHero.MapFaction)
		{
			if (targetFaction is Kingdom item)
			{
				return !_prohibitedKingdomsForPlayerCaravans.Contains(item);
			}
			return true;
		}
		return true;
	}
}
