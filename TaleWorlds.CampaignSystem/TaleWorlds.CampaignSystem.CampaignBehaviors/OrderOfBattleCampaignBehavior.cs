using System.Collections.Generic;
using System.Linq;
using TaleWorlds.Core;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.CampaignBehaviors;

public class OrderOfBattleCampaignBehavior : CampaignBehaviorBase
{
	public class OrderOfBattleFormationData
	{
		[SaveableField(1)]
		public readonly Hero Captain;

		[SaveableField(2)]
		public readonly DeploymentFormationClass FormationClass;

		[SaveableField(3)]
		public readonly int PrimaryClassWeight;

		[SaveableField(4)]
		public readonly int SecondaryClassWeight;

		[SaveableField(5)]
		public readonly Dictionary<FormationFilterType, bool> Filters;

		[SaveableField(6)]
		public readonly Hero[] HeroTroops;

		public OrderOfBattleFormationData(Hero captain, List<Hero> heroTroops, DeploymentFormationClass formationClass, int primaryWeight, int secondaryWeight, Dictionary<FormationFilterType, bool> filters)
		{
			Captain = captain;
			HeroTroops = heroTroops.ToArray();
			FormationClass = formationClass;
			PrimaryClassWeight = primaryWeight;
			SecondaryClassWeight = secondaryWeight;
			Filters = new Dictionary<FormationFilterType, bool>();
			foreach (FormationFilterType key in filters.Keys)
			{
				Filters.Add(key, filters[key]);
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsOrderOfBattleFormationData(object o, List<object> collectedObjects)
		{
			((OrderOfBattleFormationData)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(Captain);
			collectedObjects.Add(Filters);
			collectedObjects.Add(HeroTroops);
		}

		internal static object AutoGeneratedGetMemberValueCaptain(object o)
		{
			return ((OrderOfBattleFormationData)o).Captain;
		}

		internal static object AutoGeneratedGetMemberValueFormationClass(object o)
		{
			return ((OrderOfBattleFormationData)o).FormationClass;
		}

		internal static object AutoGeneratedGetMemberValuePrimaryClassWeight(object o)
		{
			return ((OrderOfBattleFormationData)o).PrimaryClassWeight;
		}

		internal static object AutoGeneratedGetMemberValueSecondaryClassWeight(object o)
		{
			return ((OrderOfBattleFormationData)o).SecondaryClassWeight;
		}

		internal static object AutoGeneratedGetMemberValueFilters(object o)
		{
			return ((OrderOfBattleFormationData)o).Filters;
		}

		internal static object AutoGeneratedGetMemberValueHeroTroops(object o)
		{
			return ((OrderOfBattleFormationData)o).HeroTroops;
		}
	}

	private List<OrderOfBattleFormationData> _siegeFormationInfos;

	private List<OrderOfBattleFormationData> _fieldBattleFormationInfos;

	public OrderOfBattleCampaignBehavior()
	{
		_siegeFormationInfos = new List<OrderOfBattleFormationData>();
		_fieldBattleFormationInfos = new List<OrderOfBattleFormationData>();
	}

	public override void RegisterEvents()
	{
		CampaignEvents.OnHeroUnregisteredEvent.AddNonSerializedListener(this, OnHeroUnregistered);
	}

	public override void SyncData(IDataStore dataStore)
	{
		if (dataStore.SyncData("_siegeFormationInfos", ref _siegeFormationInfos) && _siegeFormationInfos == null)
		{
			_siegeFormationInfos = new List<OrderOfBattleFormationData>();
		}
		if (dataStore.SyncData("_formationInfos", ref _fieldBattleFormationInfos) && _fieldBattleFormationInfos == null)
		{
			_fieldBattleFormationInfos = new List<OrderOfBattleFormationData>();
		}
	}

	public OrderOfBattleFormationData GetFormationDataAtIndex(int formationIndex, bool isSiegeBattle)
	{
		if (isSiegeBattle)
		{
			if (_siegeFormationInfos.Count > formationIndex)
			{
				return _siegeFormationInfos[formationIndex];
			}
			return null;
		}
		if (_fieldBattleFormationInfos.Count > formationIndex)
		{
			return _fieldBattleFormationInfos[formationIndex];
		}
		return null;
	}

	public void SetFormationInfos(List<OrderOfBattleFormationData> formationInfos, bool isSiegeBattle)
	{
		if (isSiegeBattle)
		{
			_siegeFormationInfos = new List<OrderOfBattleFormationData>(formationInfos);
		}
		else
		{
			_fieldBattleFormationInfos = new List<OrderOfBattleFormationData>(formationInfos);
		}
	}

	private void OnHeroUnregistered(Hero hero)
	{
		for (int num = _siegeFormationInfos.Count - 1; num >= 0; num--)
		{
			OrderOfBattleFormationData orderOfBattleFormationData = _siegeFormationInfos[num];
			if (orderOfBattleFormationData.Captain != hero)
			{
				Hero[] heroTroops = orderOfBattleFormationData.HeroTroops;
				if (heroTroops == null || !heroTroops.Contains(hero))
				{
					continue;
				}
			}
			List<Hero> list = orderOfBattleFormationData.HeroTroops.ToList();
			list.Remove(hero);
			Hero captain = ((orderOfBattleFormationData.Captain == hero) ? null : orderOfBattleFormationData.Captain);
			_siegeFormationInfos[num] = new OrderOfBattleFormationData(captain, list, orderOfBattleFormationData.FormationClass, orderOfBattleFormationData.PrimaryClassWeight, orderOfBattleFormationData.SecondaryClassWeight, orderOfBattleFormationData.Filters);
		}
		for (int num2 = _fieldBattleFormationInfos.Count - 1; num2 >= 0; num2--)
		{
			OrderOfBattleFormationData orderOfBattleFormationData2 = _fieldBattleFormationInfos[num2];
			if (orderOfBattleFormationData2.Captain != hero)
			{
				Hero[] heroTroops2 = orderOfBattleFormationData2.HeroTroops;
				if (heroTroops2 == null || !heroTroops2.Contains(hero))
				{
					continue;
				}
			}
			List<Hero> list2 = orderOfBattleFormationData2.HeroTroops.ToList();
			list2.Remove(hero);
			Hero captain2 = ((orderOfBattleFormationData2.Captain == hero) ? null : orderOfBattleFormationData2.Captain);
			_fieldBattleFormationInfos[num2] = new OrderOfBattleFormationData(captain2, list2, orderOfBattleFormationData2.FormationClass, orderOfBattleFormationData2.PrimaryClassWeight, orderOfBattleFormationData2.SecondaryClassWeight, orderOfBattleFormationData2.Filters);
		}
	}
}
