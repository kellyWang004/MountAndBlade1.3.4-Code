using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Election;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.MapNotificationTypes;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.LinQuick;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.CampaignBehaviors;

public class AllianceCampaignBehavior : CampaignBehaviorBase, IAllianceCampaignBehavior
{
	public class AllianceCampaignBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public AllianceCampaignBehaviorTypeDefiner()
			: base(312270)
		{
		}

		protected override void DefineStructTypes()
		{
			AddStructDefinition(typeof(Alliance), 1);
			AddStructDefinition(typeof(CallToWarAgreement), 2);
		}

		protected override void DefineContainerDefinitions()
		{
			ConstructContainerDefinition(typeof(List<Alliance>));
			ConstructContainerDefinition(typeof(List<CallToWarAgreement>));
		}
	}

	internal struct Alliance
	{
		[SaveableField(0)]
		public readonly Kingdom Kingdom1;

		[SaveableField(1)]
		public readonly Kingdom Kingdom2;

		[SaveableField(2)]
		public CampaignTime EndTime;

		public Alliance(Kingdom kingdom1, Kingdom kingdom2, CampaignTime endTime)
		{
			Kingdom1 = kingdom1;
			Kingdom2 = kingdom2;
			EndTime = endTime;
		}

		public static void AutoGeneratedStaticCollectObjectsAlliance(object o, List<object> collectedObjects)
		{
			((Alliance)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(Kingdom1);
			collectedObjects.Add(Kingdom2);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(EndTime, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueKingdom1(object o)
		{
			return ((Alliance)o).Kingdom1;
		}

		internal static object AutoGeneratedGetMemberValueKingdom2(object o)
		{
			return ((Alliance)o).Kingdom2;
		}

		internal static object AutoGeneratedGetMemberValueEndTime(object o)
		{
			return ((Alliance)o).EndTime;
		}
	}

	internal struct CallToWarAgreement
	{
		[SaveableField(0)]
		public readonly Kingdom CallingKingdom;

		[SaveableField(1)]
		public readonly Kingdom CalledKingdom;

		[SaveableField(2)]
		public readonly Kingdom KingdomToCallToWarAgainst;

		[SaveableField(3)]
		public CampaignTime EndTime;

		public CallToWarAgreement(Kingdom callingKingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst, CampaignTime endTime)
		{
			CallingKingdom = callingKingdom;
			CalledKingdom = calledKingdom;
			KingdomToCallToWarAgainst = kingdomToCallToWarAgainst;
			EndTime = endTime;
		}

		public static void AutoGeneratedStaticCollectObjectsCallToWarAgreement(object o, List<object> collectedObjects)
		{
			((CallToWarAgreement)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(CallingKingdom);
			collectedObjects.Add(CalledKingdom);
			collectedObjects.Add(KingdomToCallToWarAgainst);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(EndTime, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueCallingKingdom(object o)
		{
			return ((CallToWarAgreement)o).CallingKingdom;
		}

		internal static object AutoGeneratedGetMemberValueCalledKingdom(object o)
		{
			return ((CallToWarAgreement)o).CalledKingdom;
		}

		internal static object AutoGeneratedGetMemberValueKingdomToCallToWarAgainst(object o)
		{
			return ((CallToWarAgreement)o).KingdomToCallToWarAgainst;
		}

		internal static object AutoGeneratedGetMemberValueEndTime(object o)
		{
			return ((CallToWarAgreement)o).EndTime;
		}
	}

	private List<Alliance> _alliances = new List<Alliance>();

	private List<CallToWarAgreement> _callToWarAgreements = new List<CallToWarAgreement>();

	public override void RegisterEvents()
	{
		CampaignEvents.DailyTickClanEvent.AddNonSerializedListener(this, DailyTickClan);
		CampaignEvents.WarDeclared.AddNonSerializedListener(this, OnWarDeclared);
		CampaignEvents.MakePeace.AddNonSerializedListener(this, OnMakePeace);
		CampaignEvents.KingdomDestroyedEvent.AddNonSerializedListener(this, OnKingdomDestroyed);
	}

	public override void SyncData(IDataStore dataStore)
	{
		dataStore.SyncData("_alliances", ref _alliances);
		dataStore.SyncData("_callToWarAgreements", ref _callToWarAgreements);
	}

	void IAllianceCampaignBehavior.OnAllianceOfferedToPlayer(Kingdom offeringKingdom)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			TextObject textObject = new TextObject("{=ho5EndaV}Decision");
			TextObject textObject2 = new TextObject("{=eAhgrwkZ}As {RULER_NAME_AND_TITLE}, you must decide if an alliance will be formed with the {KINGDOM_NAME}.");
			TextObject textObject3 = GameTexts.FindText("str_faction_ruler_name_with_title", Hero.MainHero.MapFaction.Culture.StringId);
			textObject3.SetCharacterProperties("RULER", Hero.MainHero.CharacterObject);
			textObject2.SetTextVariable("RULER_NAME_AND_TITLE", textObject3);
			textObject2.SetTextVariable("KINGDOM_NAME", offeringKingdom.Name);
			TextObject textObject4 = new TextObject("{=Y94H6XnK}Accept");
			InformationManager.ShowInquiry(new InquiryData(negativeText: new TextObject("{=cOgmdp9e}Decline").ToString(), titleText: textObject.ToString(), text: textObject2.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: true, affirmativeText: textObject4.ToString(), affirmativeAction: delegate
			{
				AcceptStartingAlliance(offeringKingdom);
			}, negativeAction: null));
		}
		else
		{
			TextObject textObject5 = new TextObject("{=ho5EndaV}Decision");
			TextObject textObject6 = new TextObject("{=eTylgLCc}A courier has arrived from the {KINGDOM_NAME}. They offer you an alliance. Your kingdom will vote whether to accept the offer.");
			textObject6.SetTextVariable("KINGDOM_NAME", offeringKingdom.Name);
			TextObject textObject7 = new TextObject("{=oHaWR73d}Ok");
			InformationManager.ShowInquiry(new InquiryData(textObject5.ToString(), textObject6.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: false, textObject7.ToString(), textObject7.ToString(), delegate
			{
				ConfirmAllianceOffer(offeringKingdom);
			}, null));
		}
	}

	void IAllianceCampaignBehavior.OnAllianceOfferedToPlayerKingdom(Kingdom offeringKingdom)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			TextObject textObject = new TextObject("{=1V8f9vRM}A courier bearing an alliance offer from the {PROPOSER_KINGDOM} has arrived at the court of your realm.");
			textObject.SetTextVariable("PROPOSER_KINGDOM", offeringKingdom.InformalName);
			Campaign.Current.CampaignInformationManager.NewMapNoticeAdded(new AllianceOfferMapNotification(offeringKingdom, textObject));
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is StartAllianceDecision startAllianceDecision && startAllianceDecision.KingdomToStartAllianceWith == offeringKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		Clan.PlayerClan.Kingdom.AddDecision(new StartAllianceDecision(StartAllianceDecision.GetProposerClanForPlayerKingdom(offeringKingdom), offeringKingdom), ignoreInfluenceCost: true);
	}

	void IAllianceCampaignBehavior.OnCallToWarAgreementProposedToPlayer(Kingdom proposerKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			int callToWarCost = Campaign.Current.Models.AllianceModel.GetCallToWarCost(proposerKingdom, Clan.PlayerClan.Kingdom, kingdomToCallToWarAgainst);
			TextObject textObject = new TextObject("{=ho5EndaV}Decision");
			TextObject textObject2 = new TextObject("{=L81DPSom}As {RULER_NAME_AND_TITLE}, you must decide if your realm will answer the call of the {CALLING_KINGDOM} and declare war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}.");
			TextObject textObject3 = GameTexts.FindText("str_faction_ruler_name_with_title", Hero.MainHero.MapFaction.Culture.StringId);
			textObject3.SetCharacterProperties("RULER", Hero.MainHero.CharacterObject);
			textObject2.SetTextVariable("RULER_NAME_AND_TITLE", textObject3);
			textObject2.SetTextVariable("CALLING_KINGDOM", proposerKingdom.Name);
			textObject2.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
			textObject2.SetTextVariable("CALL_TO_WAR_COST", callToWarCost);
			textObject2.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
			TextObject textObject4 = new TextObject("{=Y94H6XnK}Accept");
			InformationManager.ShowInquiry(new InquiryData(negativeText: new TextObject("{=cOgmdp9e}Decline").ToString(), titleText: textObject.ToString(), text: textObject2.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: true, affirmativeText: textObject4.ToString(), affirmativeAction: delegate
			{
				AcceptCallToWarAgreement(proposerKingdom, kingdomToCallToWarAgainst, callToWarCost);
			}, negativeAction: null));
		}
		else
		{
			TextObject textObject5 = new TextObject("{=ho5EndaV}Decision");
			TextObject textObject6 = new TextObject("{=FuNbouTu}A courier has arrived from the {KINGDOM_NAME}. They call your kingdom to war against {KINGDOM_TO_CALL_TO_WAR_AGAINST}. Your kingdom will vote whether to accept the offer.");
			textObject6.SetTextVariable("KINGDOM_NAME", proposerKingdom.Name);
			textObject6.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
			TextObject textObject7 = new TextObject("{=oHaWR73d}Ok");
			InformationManager.ShowInquiry(new InquiryData(textObject5.ToString(), textObject6.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: false, textObject7.ToString(), textObject7.ToString(), delegate
			{
				ConfirmCallToWarAgreementOffer(proposerKingdom, kingdomToCallToWarAgainst);
			}, null));
		}
	}

	void IAllianceCampaignBehavior.OnCallToWarAgreementProposedToPlayerKingdom(Kingdom proposerKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			TextObject textObject = new TextObject("{=PneX4Ayw}A courier bearing a call to war offer from the {KINGDOM_NAME} against {KINGDOM_TO_CALL_TO_WAR_AGAINST} has arrived at the court of your realm.");
			textObject.SetTextVariable("KINGDOM_NAME", proposerKingdom.Name);
			textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
			Campaign.Current.CampaignInformationManager.NewMapNoticeAdded(new AcceptCallToWarOfferMapNotification(proposerKingdom, kingdomToCallToWarAgainst, textObject));
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is AcceptCallToWarAgreementDecision acceptCallToWarAgreementDecision && acceptCallToWarAgreementDecision.CallingKingdom == proposerKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		AcceptCallToWarAgreementDecision kingdomDecision2 = new AcceptCallToWarAgreementDecision(Clan.PlayerClan, proposerKingdom, kingdomToCallToWarAgainst);
		Clan.PlayerClan.Kingdom.AddDecision(kingdomDecision2, ignoreInfluenceCost: true);
	}

	void IAllianceCampaignBehavior.OnCallToWarAgreementProposedByPlayer(Kingdom proposedKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			int callToWarCost = Campaign.Current.Models.AllianceModel.GetCallToWarCost(Clan.PlayerClan.Kingdom, proposedKingdom, kingdomToCallToWarAgainst);
			if (callToWarCost <= Clan.PlayerClan.Gold)
			{
				TextObject textObject = new TextObject("{=ho5EndaV}Decision");
				TextObject textObject2 = new TextObject("{=AwCnrOan}As {RULER_NAME_AND_TITLE}, you must decide if the {CALLED_KINGDOM} will be called to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}.");
				TextObject textObject3 = GameTexts.FindText("str_faction_ruler_name_with_title", Hero.MainHero.MapFaction.Culture.StringId);
				textObject3.SetCharacterProperties("RULER", Hero.MainHero.CharacterObject);
				textObject2.SetTextVariable("RULER_NAME_AND_TITLE", textObject3);
				textObject2.SetTextVariable("CALLED_KINGDOM", proposedKingdom.Name);
				textObject2.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
				textObject2.SetTextVariable("CALL_TO_WAR_COST", callToWarCost);
				textObject2.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				TextObject textObject4 = new TextObject("{=Y94H6XnK}Accept");
				InformationManager.ShowInquiry(new InquiryData(negativeText: new TextObject("{=cOgmdp9e}Decline").ToString(), titleText: textObject.ToString(), text: textObject2.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: true, affirmativeText: textObject4.ToString(), affirmativeAction: delegate
				{
					AcceptProposalOfCallToWarAgreement(proposedKingdom, kingdomToCallToWarAgainst, callToWarCost);
				}, negativeAction: null));
			}
		}
		else
		{
			TextObject textObject5 = new TextObject("{=ho5EndaV}Decision");
			TextObject textObject6 = new TextObject("{=qgN9o2ip}It is time to call our ally the {KINGDOM_NAME} to war againts {KINGDOM_TO_CALL_TO_WAR_AGAINST}!. Your kingdom will vote whether to propose a call to war agreement to them.");
			textObject6.SetTextVariable("KINGDOM_NAME", proposedKingdom.Name);
			textObject6.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
			TextObject textObject7 = new TextObject("{=oHaWR73d}Ok");
			InformationManager.ShowInquiry(new InquiryData(textObject5.ToString(), textObject6.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: false, textObject7.ToString(), textObject7.ToString(), delegate
			{
				ConfirmCallToWarAgreementProposalOffer(proposedKingdom, kingdomToCallToWarAgainst);
			}, null));
		}
	}

	CampaignTime IAllianceCampaignBehavior.GetAllianceEndDate(Kingdom kingdom1, Kingdom kingdom2)
	{
		if (!TryGetAlliance(kingdom1, kingdom2, out var foundAlliance))
		{
			Debug.FailedAssert("Cant find alliance", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\CampaignBehaviors\\AllianceCampaignBehavior.cs", "GetAllianceEndDate", 271);
			return CampaignTime.Zero;
		}
		return foundAlliance.EndTime;
	}

	public void OnCallToWarAgreementProposedByPlayerKingdom(Kingdom proposedKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		if (Clan.PlayerClan.Kingdom.Clans.Count == 1)
		{
			TextObject textObject = new TextObject("{=dDsJyerw}Call the {CALLED_KINGDOM} to War Against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.");
			textObject.SetTextVariable("CALLED_KINGDOM", proposedKingdom.Name);
			textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", kingdomToCallToWarAgainst.Name);
			Campaign.Current.CampaignInformationManager.NewMapNoticeAdded(new ProposeCallToWarOfferMapNotification(proposedKingdom, kingdomToCallToWarAgainst, textObject));
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is ProposeCallToWarAgreementDecision proposeCallToWarAgreementDecision && proposeCallToWarAgreementDecision.CalledKingdom == proposedKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		ProposeCallToWarAgreementDecision kingdomDecision2 = new ProposeCallToWarAgreementDecision(Clan.PlayerClan, proposedKingdom, kingdomToCallToWarAgainst);
		Clan.PlayerClan.Kingdom.AddDecision(kingdomDecision2, ignoreInfluenceCost: true);
	}

	public bool IsAllyWithKingdom(Kingdom kingdom1, Kingdom kingdom2)
	{
		if (kingdom1 == null || kingdom2 == null || kingdom1 == kingdom2 || kingdom1.IsEliminated || kingdom2.IsEliminated)
		{
			return false;
		}
		Alliance foundAlliance;
		return TryGetAlliance(kingdom1, kingdom2, out foundAlliance);
	}

	public void StartAlliance(Kingdom proposerKingdom, Kingdom receiverKingdom)
	{
		if (IsAllyWithKingdom(proposerKingdom, receiverKingdom))
		{
			return;
		}
		StanceLink stanceWith = proposerKingdom.GetStanceWith(receiverKingdom);
		if (stanceWith.GetDailyTributeToPay(proposerKingdom) != 0)
		{
			stanceWith.SetDailyTributePaid(proposerKingdom, 0, 0);
		}
		if (stanceWith.GetDailyTributeToPay(proposerKingdom) != 0)
		{
			stanceWith.SetDailyTributePaid(proposerKingdom, 0, 0);
		}
		foreach (IFaction item in proposerKingdom.FactionsAtWarWith)
		{
			if (item.IsKingdomFaction && !item.IsAtWarWith(receiverKingdom))
			{
				if (proposerKingdom == Clan.PlayerClan.Kingdom)
				{
					Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().OnCallToWarAgreementProposedByPlayerKingdom(receiverKingdom, (Kingdom)item);
					continue;
				}
				ProposeCallToWarAgreementDecision kingdomDecision = new ProposeCallToWarAgreementDecision(proposerKingdom.RulingClan, receiverKingdom, (Kingdom)item);
				proposerKingdom.AddDecision(kingdomDecision, ignoreInfluenceCost: true);
			}
		}
		foreach (IFaction item2 in receiverKingdom.FactionsAtWarWith)
		{
			if (item2.IsKingdomFaction && !item2.IsAtWarWith(proposerKingdom))
			{
				if (receiverKingdom == Clan.PlayerClan.Kingdom)
				{
					Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().OnCallToWarAgreementProposedByPlayerKingdom(proposerKingdom, (Kingdom)item2);
					continue;
				}
				ProposeCallToWarAgreementDecision kingdomDecision2 = new ProposeCallToWarAgreementDecision(receiverKingdom.RulingClan, proposerKingdom, (Kingdom)item2);
				receiverKingdom.AddDecision(kingdomDecision2, ignoreInfluenceCost: true);
			}
		}
		AddAlliance(proposerKingdom, receiverKingdom);
		CampaignEventDispatcher.Instance.OnAllianceStarted(proposerKingdom, receiverKingdom);
	}

	public void EndAlliance(Kingdom kingdom1, Kingdom kingdom2)
	{
		foreach (CallToWarAgreement callToWarAgreement in GetCallToWarAgreements(kingdom1, kingdom2))
		{
			EndCallToWarAgreement(callToWarAgreement.CallingKingdom, callToWarAgreement.CalledKingdom, callToWarAgreement.KingdomToCallToWarAgainst);
		}
		RemoveAlliance(kingdom1, kingdom2);
		CampaignEventDispatcher.Instance.OnAllianceEnded(kingdom1, kingdom2);
	}

	public bool HasCalledToWar(Kingdom callingKingdom, Kingdom calledKingdom)
	{
		if (callingKingdom == null || calledKingdom == null || callingKingdom == calledKingdom || callingKingdom.IsEliminated || calledKingdom.IsEliminated || !calledKingdom.IsAllyWith(callingKingdom))
		{
			return false;
		}
		return _callToWarAgreements.AnyQ((CallToWarAgreement c) => c.CallingKingdom == callingKingdom && c.CalledKingdom == calledKingdom);
	}

	public bool IsAtWarByCallToWarAgreement(Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		if (kingdomToCallToWarAgainst == null || calledKingdom == null || kingdomToCallToWarAgainst == calledKingdom || kingdomToCallToWarAgainst.IsEliminated || calledKingdom.IsEliminated)
		{
			return false;
		}
		return _callToWarAgreements.AnyQ((CallToWarAgreement c) => c.CalledKingdom == calledKingdom && c.KingdomToCallToWarAgainst == kingdomToCallToWarAgainst);
	}

	public void StartCallToWarAgreement(Kingdom callingKingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst, int callToWarCost, bool isPlayerPaying = false)
	{
		if (IsAllyWithKingdom(callingKingdom, calledKingdom) && !calledKingdom.IsAtWarWith(kingdomToCallToWarAgainst))
		{
			CallToWarAgreement callToWarAgreement = AddCallToWarAgreement(callingKingdom, calledKingdom, kingdomToCallToWarAgainst);
			if (TryGetAlliance(callingKingdom, calledKingdom, out var foundAlliance) && foundAlliance.EndTime < callToWarAgreement.EndTime)
			{
				foundAlliance.EndTime = callToWarAgreement.EndTime;
			}
			if (isPlayerPaying)
			{
				Hero.MainHero.ChangeHeroGold(-callToWarCost);
				calledKingdom.CallToWarWallet += callToWarCost;
			}
			else
			{
				callingKingdom.CallToWarWallet -= callToWarCost;
				calledKingdom.CallToWarWallet += callToWarCost;
			}
			CampaignEventDispatcher.Instance.OnCallToWarAgreementStarted(callingKingdom, calledKingdom, kingdomToCallToWarAgainst);
			DeclareWarAction.ApplyByCallToWarAgreement(calledKingdom, kingdomToCallToWarAgainst);
		}
	}

	public void EndCallToWarAgreement(Kingdom callingKingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		RemoveCallToWarAgreement(callingKingdom, calledKingdom, kingdomToCallToWarAgainst);
		CampaignEventDispatcher.Instance.OnCallToWarAgreementEnded(callingKingdom, calledKingdom, kingdomToCallToWarAgainst);
	}

	public List<Kingdom> GetKingdomsToCallToWarAgainst(Kingdom callingKingdom, Kingdom calledKingdom)
	{
		if (callingKingdom != calledKingdom)
		{
			return _callToWarAgreements.WhereQ((CallToWarAgreement c) => c.CallingKingdom == callingKingdom && c.CalledKingdom == calledKingdom).SelectQ((CallToWarAgreement x) => x.KingdomToCallToWarAgainst).ToListQ();
		}
		return new List<Kingdom>();
	}

	private Alliance AddAlliance(Kingdom kingdom1, Kingdom kingdom2)
	{
		Alliance alliance = new Alliance(kingdom1, kingdom2, CampaignTime.Now + Campaign.Current.Models.AllianceModel.MaxDurationOfAlliance);
		_alliances.Add(alliance);
		kingdom1.UpdateAlliedKingdoms();
		kingdom2.UpdateAlliedKingdoms();
		return alliance;
	}

	private void RemoveAlliance(Kingdom kingdom1, Kingdom kingdom2)
	{
		int num = _alliances.Count - 1;
		while (-1 < num)
		{
			Alliance alliance = _alliances[num];
			if ((alliance.Kingdom1 == kingdom1 && alliance.Kingdom2 == kingdom2) || (alliance.Kingdom2 == kingdom1 && alliance.Kingdom1 == kingdom2))
			{
				_alliances.RemoveAt(num);
				break;
			}
			num--;
		}
		kingdom1.UpdateAlliedKingdoms();
		kingdom2.UpdateAlliedKingdoms();
	}

	private CallToWarAgreement AddCallToWarAgreement(Kingdom callingKingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		CallToWarAgreement callToWarAgreement = new CallToWarAgreement(callingKingdom, calledKingdom, kingdomToCallToWarAgainst, CampaignTime.Now + Campaign.Current.Models.AllianceModel.MaxDurationOfWarParticipation);
		_callToWarAgreements.Add(callToWarAgreement);
		return callToWarAgreement;
	}

	private void RemoveCallToWarAgreement(Kingdom callingKingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		int num = _callToWarAgreements.Count - 1;
		while (-1 < num)
		{
			CallToWarAgreement callToWarAgreement = _callToWarAgreements[num];
			if (callToWarAgreement.CallingKingdom == callingKingdom && callToWarAgreement.CalledKingdom == calledKingdom && callToWarAgreement.KingdomToCallToWarAgainst == kingdomToCallToWarAgainst)
			{
				_callToWarAgreements.RemoveAt(num);
				break;
			}
			num--;
		}
	}

	private List<CallToWarAgreement> GetCallToWarAgreements(Kingdom kingdom1, Kingdom kingdom2)
	{
		if (kingdom1 != kingdom2)
		{
			return _callToWarAgreements.Where((CallToWarAgreement c) => (c.CallingKingdom == kingdom1 && c.CalledKingdom == kingdom2) || (c.CallingKingdom == kingdom2 && c.CalledKingdom == kingdom1)).ToListQ();
		}
		return new List<CallToWarAgreement>();
	}

	private bool TryGetAlliance(Kingdom kingdom1, Kingdom kingdom2, out Alliance foundAlliance)
	{
		bool result = false;
		foundAlliance = default(Alliance);
		foreach (Alliance alliance in _alliances)
		{
			if ((alliance.Kingdom1 == kingdom1 && alliance.Kingdom2 == kingdom2) || (alliance.Kingdom2 == kingdom1 && alliance.Kingdom1 == kingdom2))
			{
				foundAlliance = alliance;
				result = true;
				break;
			}
		}
		return result;
	}

	private void AcceptProposalOfCallToWarAgreement(Kingdom proposedKingdom, Kingdom kingdomToCallToWarAgainst, int callToWarCost)
	{
		Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().StartCallToWarAgreement(Clan.PlayerClan.Kingdom, proposedKingdom, kingdomToCallToWarAgainst, callToWarCost);
	}

	private void AcceptCallToWarAgreement(Kingdom proposerKingdom, Kingdom kingdomToCallToWarAgainst, int callToWarCost)
	{
		Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().StartCallToWarAgreement(proposerKingdom, Clan.PlayerClan.Kingdom, kingdomToCallToWarAgainst, callToWarCost);
	}

	private void AcceptStartingAlliance(Kingdom proposerKingdom)
	{
		Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().StartAlliance(proposerKingdom, Clan.PlayerClan.Kingdom);
	}

	private void ConfirmAllianceOffer(Kingdom proposerKingdom)
	{
		if (Clan.PlayerClan.IsUnderMercenaryService)
		{
			AcceptStartingAlliance(proposerKingdom);
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is StartAllianceDecision startAllianceDecision && startAllianceDecision.KingdomToStartAllianceWith == proposerKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		Clan.PlayerClan.Kingdom.AddDecision(new StartAllianceDecision(StartAllianceDecision.GetProposerClanForPlayerKingdom(proposerKingdom), proposerKingdom), ignoreInfluenceCost: true);
	}

	private void ConfirmCallToWarAgreementProposalOffer(Kingdom proposedKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		ProposeCallToWarAgreementDecision proposeCallToWarAgreementDecision = new ProposeCallToWarAgreementDecision(Clan.PlayerClan, proposedKingdom, kingdomToCallToWarAgainst);
		int callToWarCost = proposeCallToWarAgreementDecision.CallToWarCost;
		if (Clan.PlayerClan.IsUnderMercenaryService)
		{
			AcceptProposalOfCallToWarAgreement(proposedKingdom, kingdomToCallToWarAgainst, callToWarCost);
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is ProposeCallToWarAgreementDecision proposeCallToWarAgreementDecision2 && proposeCallToWarAgreementDecision2.CalledKingdom == proposedKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		Clan.PlayerClan.Kingdom.AddDecision(proposeCallToWarAgreementDecision, ignoreInfluenceCost: true);
	}

	private void ConfirmCallToWarAgreementOffer(Kingdom proposerKingdom, Kingdom kingdomToCallToWarAgainst)
	{
		AcceptCallToWarAgreementDecision acceptCallToWarAgreementDecision = new AcceptCallToWarAgreementDecision(Clan.PlayerClan, proposerKingdom, kingdomToCallToWarAgainst);
		int callToWarCost = acceptCallToWarAgreementDecision.CallToWarCost;
		if (Clan.PlayerClan.IsUnderMercenaryService)
		{
			AcceptCallToWarAgreement(proposerKingdom, kingdomToCallToWarAgainst, callToWarCost);
			return;
		}
		KingdomDecision kingdomDecision = Clan.PlayerClan.Kingdom.UnresolvedDecisions.FirstOrDefault((KingdomDecision s) => s is AcceptCallToWarAgreementDecision acceptCallToWarAgreementDecision2 && acceptCallToWarAgreementDecision2.CallingKingdom == proposerKingdom);
		if (kingdomDecision != null)
		{
			Clan.PlayerClan.Kingdom.RemoveDecision(kingdomDecision);
		}
		Clan.PlayerClan.Kingdom.AddDecision(acceptCallToWarAgreementDecision, ignoreInfluenceCost: true);
	}

	private void DailyTickClan(Clan clan)
	{
		if (clan.IsEliminated)
		{
			return;
		}
		clan.Aggressiveness -= 1f;
		if (clan.Kingdom == null || clan.Kingdom.RulingClan != clan)
		{
			return;
		}
		Kingdom kingdom = clan.Kingdom;
		if (kingdom.AlliedKingdoms.IsEmpty())
		{
			return;
		}
		for (int num = kingdom.AlliedKingdoms.Count - 1; num > -1; num--)
		{
			Kingdom kingdom2 = kingdom.AlliedKingdoms[num];
			if (TryGetAlliance(kingdom2, kingdom, out var foundAlliance))
			{
				List<CallToWarAgreement> callToWarAgreements = GetCallToWarAgreements(kingdom, kingdom2);
				for (int num2 = callToWarAgreements.Count - 1; num2 > -1; num2--)
				{
					CallToWarAgreement callToWarAgreement = callToWarAgreements[num2];
					if (callToWarAgreement.EndTime.IsPast)
					{
						EndCallToWarAgreement(callToWarAgreement.CallingKingdom, callToWarAgreement.CalledKingdom, callToWarAgreement.KingdomToCallToWarAgainst);
					}
				}
				if (foundAlliance.EndTime.IsPast)
				{
					EndAlliance(kingdom, kingdom2);
				}
			}
		}
	}

	private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
	{
		if (!faction1.IsKingdomFaction || !faction2.IsKingdomFaction)
		{
			return;
		}
		Kingdom kingdom = (Kingdom)faction1;
		Kingdom kingdom2 = (Kingdom)faction2;
		if (kingdom.IsAllyWith(kingdom2))
		{
			EndAlliance(kingdom, kingdom2);
		}
		foreach (Kingdom item in kingdom.AlliedKingdoms.ToList())
		{
			if (!item.IsAtWarWith(kingdom2))
			{
				if (kingdom == Clan.PlayerClan.Kingdom)
				{
					Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().OnCallToWarAgreementProposedByPlayerKingdom(item, kingdom2);
					continue;
				}
				ProposeCallToWarAgreementDecision kingdomDecision = new ProposeCallToWarAgreementDecision(kingdom.RulingClan, item, kingdom2);
				kingdom.AddDecision(kingdomDecision, ignoreInfluenceCost: true);
			}
		}
		foreach (Kingdom item2 in kingdom2.AlliedKingdoms.ToList())
		{
			if (!item2.IsAtWarWith(kingdom))
			{
				if (kingdom2 == Clan.PlayerClan.Kingdom)
				{
					Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>().OnCallToWarAgreementProposedByPlayerKingdom(item2, kingdom);
					continue;
				}
				ProposeCallToWarAgreementDecision kingdomDecision2 = new ProposeCallToWarAgreementDecision(kingdom2.RulingClan, item2, kingdom);
				kingdom2.AddDecision(kingdomDecision2, ignoreInfluenceCost: true);
			}
		}
	}

	private void OnMakePeace(IFaction faction1, IFaction faction2, MakePeaceAction.MakePeaceDetail detail)
	{
		if (!faction1.IsKingdomFaction || !faction2.IsKingdomFaction)
		{
			return;
		}
		Kingdom kingdom1 = (Kingdom)faction1;
		Kingdom kingdom2 = (Kingdom)faction2;
		foreach (Kingdom ally in kingdom1.AlliedKingdoms)
		{
			if (_callToWarAgreements.AnyQ((CallToWarAgreement c) => c.CallingKingdom == kingdom1 && c.CalledKingdom == ally && c.KingdomToCallToWarAgainst == kingdom2))
			{
				EndCallToWarAgreement(kingdom1, ally, kingdom2);
			}
		}
		foreach (Kingdom ally2 in kingdom2.AlliedKingdoms)
		{
			if (_callToWarAgreements.AnyQ((CallToWarAgreement c) => c.CallingKingdom == kingdom2 && c.CalledKingdom == ally2 && c.KingdomToCallToWarAgainst == kingdom1))
			{
				EndCallToWarAgreement(kingdom2, ally2, kingdom1);
			}
		}
	}

	private void OnKingdomDestroyed(Kingdom kingdom)
	{
		foreach (Alliance item in _alliances.Where((Alliance a) => a.Kingdom1 == kingdom || a.Kingdom2 == kingdom).ToList())
		{
			EndAlliance(item.Kingdom1, item.Kingdom2);
		}
	}
}
