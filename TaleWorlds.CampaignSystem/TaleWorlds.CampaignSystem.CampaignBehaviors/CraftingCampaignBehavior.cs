using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.CraftingSystem;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.LinQuick;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.CampaignBehaviors;

public class CraftingCampaignBehavior : CampaignBehaviorBase, ICraftingCampaignBehavior, ICampaignBehavior, INonReadyObjectHandler
{
	public class CraftingCampaignBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public CraftingCampaignBehaviorTypeDefiner()
			: base(150000)
		{
		}

		protected override void DefineClassTypes()
		{
			AddClassDefinition(typeof(CraftedItemInitializationData), 10);
			AddClassDefinition(typeof(HeroCraftingRecord), 20);
			AddClassDefinition(typeof(CraftingOrderSlots), 30);
		}

		protected override void DefineContainerDefinitions()
		{
			ConstructContainerDefinition(typeof(Dictionary<ItemObject, CraftedItemInitializationData>));
			ConstructContainerDefinition(typeof(Dictionary<Hero, HeroCraftingRecord>));
			ConstructContainerDefinition(typeof(Dictionary<Town, CraftingOrderSlots>));
			ConstructContainerDefinition(typeof(List<CraftingOrder>));
		}
	}

	internal class CraftedItemInitializationData
	{
		[SaveableField(10)]
		public readonly WeaponDesign CraftedData;

		[SaveableField(20)]
		public readonly TextObject ItemName;

		[SaveableField(30)]
		public readonly CultureObject Culture;

		public CraftedItemInitializationData(WeaponDesign craftedData, TextObject itemName, CultureObject culture)
		{
			CraftedData = craftedData;
			ItemName = itemName;
			Culture = culture;
		}

		internal static void AutoGeneratedStaticCollectObjectsCraftedItemInitializationData(object o, List<object> collectedObjects)
		{
			((CraftedItemInitializationData)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(CraftedData);
			collectedObjects.Add(ItemName);
			collectedObjects.Add(Culture);
		}

		internal static object AutoGeneratedGetMemberValueCraftedData(object o)
		{
			return ((CraftedItemInitializationData)o).CraftedData;
		}

		internal static object AutoGeneratedGetMemberValueItemName(object o)
		{
			return ((CraftedItemInitializationData)o).ItemName;
		}

		internal static object AutoGeneratedGetMemberValueCulture(object o)
		{
			return ((CraftedItemInitializationData)o).Culture;
		}
	}

	internal class HeroCraftingRecord
	{
		[SaveableField(10)]
		public int CraftingStamina;

		public HeroCraftingRecord(int maxStamina)
		{
			CraftingStamina = maxStamina;
		}

		internal static void AutoGeneratedStaticCollectObjectsHeroCraftingRecord(object o, List<object> collectedObjects)
		{
			((HeroCraftingRecord)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
		}

		internal static object AutoGeneratedGetMemberValueCraftingStamina(object o)
		{
			return ((HeroCraftingRecord)o).CraftingStamina;
		}
	}

	public class CraftingOrderSlots
	{
		private const int SlotCount = 6;

		[SaveableField(10)]
		public CraftingOrder[] Slots;

		[SaveableField(30)]
		private MBList<CraftingOrder> _customOrders;

		public MBReadOnlyList<CraftingOrder> CustomOrders => _customOrders;

		public CraftingOrderSlots()
		{
			Slots = new CraftingOrder[6];
			for (int i = 0; i < 6; i++)
			{
				Slots[i] = null;
			}
			_customOrders = new MBList<CraftingOrder>();
		}

		[LoadInitializationCallback]
		private void OnLoad()
		{
			if (_customOrders == null)
			{
				_customOrders = new MBList<CraftingOrder>();
			}
		}

		public bool IsThereAvailableSlot()
		{
			for (int i = 0; i < 6; i++)
			{
				if (Slots[i] == null)
				{
					return true;
				}
			}
			return false;
		}

		public int GetAvailableSlot()
		{
			for (int i = 0; i < 6; i++)
			{
				if (Slots[i] == null)
				{
					return i;
				}
			}
			return -1;
		}

		internal void AddTownOrder(CraftingOrder craftingOrder)
		{
			Slots[craftingOrder.DifficultyLevel] = craftingOrder;
		}

		internal void RemoveTownOrder(CraftingOrder craftingOrder)
		{
			Slots[craftingOrder.DifficultyLevel] = null;
		}

		internal void AddCustomOrder(CraftingOrder order)
		{
			_customOrders.Add(order);
		}

		internal void RemoveCustomOrder(CraftingOrder order)
		{
			_customOrders.Remove(order);
		}

		internal static void AutoGeneratedStaticCollectObjectsCraftingOrderSlots(object o, List<object> collectedObjects)
		{
			((CraftingOrderSlots)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(Slots);
			collectedObjects.Add(_customOrders);
		}

		internal static object AutoGeneratedGetMemberValueSlots(object o)
		{
			return ((CraftingOrderSlots)o).Slots;
		}

		internal static object AutoGeneratedGetMemberValue_customOrders(object o)
		{
			return ((CraftingOrderSlots)o)._customOrders;
		}
	}

	private const float CraftingOrderReplaceChance = 0.05f;

	private const float CreateCraftingOrderChance = 0.05f;

	private const int TownCraftingOrderCount = 6;

	private const int DefaultCraftingOrderPieceTier = 1;

	private const int CraftingOrderTroopBonusAmount = 1;

	private const int MinOrderDifficulty = 40;

	private const int MaxOrderDifficulty = 240;

	private const int MaxCraftingHistoryDesigns = 10;

	private const int BaseHeroCraftingStamina = 100;

	private Hero _activeCraftingHero;

	private ItemModifier _currentItemModifier;

	private Dictionary<CraftingTemplate, List<CraftingPiece>> _openedPartsDictionary = new Dictionary<CraftingTemplate, List<CraftingPiece>>();

	private Dictionary<CraftingTemplate, float> _openNewPartXpDictionary = new Dictionary<CraftingTemplate, float>();

	private Dictionary<ItemObject, CraftedItemInitializationData> _craftedItemDictionary = new Dictionary<ItemObject, CraftedItemInitializationData>();

	private Dictionary<Hero, HeroCraftingRecord> _heroCraftingRecords = new Dictionary<Hero, HeroCraftingRecord>();

	private Dictionary<Town, CraftingOrderSlots> _craftingOrders = new Dictionary<Town, CraftingOrderSlots>();

	private List<ItemObject> _cratingItemsHistory = new List<ItemObject>();

	private int _townOrderCount;

	private int _craftedItemCount;

	public IReadOnlyDictionary<Town, CraftingOrderSlots> CraftingOrders => _craftingOrders;

	public IReadOnlyCollection<WeaponDesign> CraftingHistory
	{
		get
		{
			MBList<WeaponDesign> mBList = new MBList<WeaponDesign>();
			foreach (ItemObject item in _cratingItemsHistory)
			{
				WeaponDesign weaponDesign = item.WeaponDesign;
				mBList.Add(new WeaponDesign(weaponDesign.Template, weaponDesign.WeaponName, weaponDesign.UsedPieces, weaponDesign.HashedCode));
			}
			return mBList;
		}
	}

	private string GetNextCraftedItemId()
	{
		string result = $"crafted_item_{_craftedItemCount}";
		_craftedItemCount++;
		return result;
	}

	private string GetNextTownOrderId()
	{
		string result = $"town_order_{_townOrderCount}";
		_townOrderCount++;
		return result;
	}

	public override void SyncData(IDataStore dataStore)
	{
		dataStore.SyncData("_activeCraftingHero", ref _activeCraftingHero);
		dataStore.SyncData("_craftedItemDictionary", ref _craftedItemDictionary);
		dataStore.SyncData("_heroCraftingRecordsNew", ref _heroCraftingRecords);
		dataStore.SyncData("_craftingOrders", ref _craftingOrders);
		dataStore.SyncData("_cratingItemsHistory", ref _cratingItemsHistory);
		dataStore.SyncData("_openedPartsDictionary", ref _openedPartsDictionary);
		dataStore.SyncData("_openNewPartXpDictionary", ref _openNewPartXpDictionary);
		dataStore.SyncData("_townOrderCount", ref _townOrderCount);
		dataStore.SyncData("_craftedItemCount", ref _craftedItemCount);
		if (!dataStore.IsLoading || !MBSaveLoad.IsUpdatingGameVersion)
		{
			return;
		}
		if (MBSaveLoad.LastLoadedGameVersion < ApplicationVersion.FromString("e1.8.0"))
		{
			List<CraftingPiece> data = new List<CraftingPiece>();
			dataStore.SyncData("_openedParts", ref data);
			if (data != null)
			{
				_openedPartsDictionary = new Dictionary<CraftingTemplate, List<CraftingPiece>>();
				foreach (CraftingTemplate item in CraftingTemplate.All)
				{
					_openedPartsDictionary.Add(item, new List<CraftingPiece>());
					foreach (CraftingPiece item2 in data)
					{
						if (item.Pieces.Contains(item2) && !_openedPartsDictionary[item].Contains(item2))
						{
							_openedPartsDictionary[item].Add(item2);
						}
					}
				}
			}
		}
		if (!(MBSaveLoad.LastLoadedGameVersion < ApplicationVersion.FromString("v1.3.2")))
		{
			return;
		}
		List<ItemObject> list = new List<ItemObject>();
		for (int i = 0; i < _craftedItemDictionary.Count; i++)
		{
			KeyValuePair<ItemObject, CraftedItemInitializationData> keyValuePair = _craftedItemDictionary.ElementAt(i);
			if (keyValuePair.Value.CraftedData.Template.IsReady)
			{
				bool flag = true;
				PieceData[] buildOrders = keyValuePair.Value.CraftedData.Template.BuildOrders;
				for (int j = 0; j < buildOrders.Length; j++)
				{
					PieceData pieceData = buildOrders[j];
					bool flag2 = false;
					WeaponDesignElement[] usedPieces = keyValuePair.Value.CraftedData.UsedPieces;
					foreach (WeaponDesignElement weaponDesignElement in usedPieces)
					{
						if (pieceData.PieceType == weaponDesignElement.CraftingPiece.PieceType && weaponDesignElement.CraftingPiece.IsValid)
						{
							flag2 = true;
						}
					}
					if (!flag2)
					{
						flag = false;
						break;
					}
				}
				if (flag)
				{
					string nextCraftedItemId = GetNextCraftedItemId();
					keyValuePair.Key.StringId = nextCraftedItemId;
					WeaponDesignElement[] array = new WeaponDesignElement[keyValuePair.Value.CraftedData.UsedPieces.Length];
					for (int l = 0; l < keyValuePair.Value.CraftedData.UsedPieces.Length; l++)
					{
						array[l] = keyValuePair.Value.CraftedData.UsedPieces[l].GetCopy();
					}
					WeaponDesign craftedData = new WeaponDesign(keyValuePair.Value.CraftedData.Template, keyValuePair.Value.CraftedData.WeaponName, array, nextCraftedItemId);
					_craftedItemDictionary[keyValuePair.Key] = new CraftedItemInitializationData(craftedData, keyValuePair.Value.ItemName, keyValuePair.Value.Culture);
				}
				else
				{
					list.Add(keyValuePair.Key);
				}
			}
			else
			{
				list.Add(keyValuePair.Key);
			}
		}
		foreach (ItemObject item3 in list)
		{
			_craftedItemDictionary.Remove(item3);
		}
		List<WeaponDesign> data2 = new List<WeaponDesign>();
		dataStore.SyncData("_craftingHistory", ref data2);
		foreach (WeaponDesign item4 in data2)
		{
			ItemObject itemObject = null;
			foreach (KeyValuePair<ItemObject, CraftedItemInitializationData> item5 in _craftedItemDictionary)
			{
				WeaponDesign craftedData2 = item5.Value.CraftedData;
				if (_cratingItemsHistory.Contains(item5.Key) || item4.Template != craftedData2.Template)
				{
					continue;
				}
				bool flag3 = true;
				for (int m = 0; m < item4.UsedPieces.Length && flag3; m++)
				{
					if (item4.UsedPieces[m]?.CraftingPiece?.StringId != craftedData2.UsedPieces[m]?.CraftingPiece?.StringId)
					{
						flag3 = false;
					}
				}
				if (flag3)
				{
					itemObject = item5.Key;
					break;
				}
			}
			if (itemObject != null)
			{
				_cratingItemsHistory.Add(itemObject);
			}
		}
		for (int n = 0; n < _craftingOrders.Count; n++)
		{
			KeyValuePair<Town, CraftingOrderSlots> keyValuePair2 = _craftingOrders.ElementAt(n);
			for (int num = 0; num < keyValuePair2.Value.Slots.Count(); num++)
			{
				string nextTownOrderId = GetNextTownOrderId();
				CraftingOrder craftingOrder = keyValuePair2.Value.Slots[num];
				if (craftingOrder != null)
				{
					WeaponDesign weaponDesignTemplate = craftingOrder.WeaponDesignTemplate;
					WeaponDesign weaponDesignTemplate2 = new WeaponDesign(weaponDesignTemplate.Template, weaponDesignTemplate.WeaponName, weaponDesignTemplate.UsedPieces, nextTownOrderId);
					CraftingTemplate templateFromId = CraftingTemplate.GetTemplateFromId(weaponDesignTemplate.Template.StringId);
					CraftingOrder craftingOrder2 = new CraftingOrder(craftingOrder.OrderOwner, craftingOrder.DifficultyLevel, weaponDesignTemplate2, templateFromId, craftingOrder.DifficultyLevel, nextTownOrderId);
					keyValuePair2.Value.Slots[num] = craftingOrder2;
				}
			}
		}
	}

	void INonReadyObjectHandler.OnBeforeNonReadyObjectsDeleted()
	{
		if (_craftedItemDictionary.Count > 0)
		{
			InitializeCraftedItemData();
		}
		foreach (KeyValuePair<Town, CraftingOrderSlots> craftingOrder2 in CraftingOrders)
		{
			CraftingOrder[] slots = craftingOrder2.Value.Slots;
			foreach (CraftingOrder craftingOrder in slots)
			{
				if (craftingOrder != null && !craftingOrder.IsPreCraftedWeaponDesignValid())
				{
					craftingOrder2.Value.RemoveTownOrder(craftingOrder);
				}
				else
				{
					craftingOrder?.InitializeCraftingOrderOnLoad();
				}
			}
			List<CraftingOrder> list = new List<CraftingOrder>();
			foreach (CraftingOrder customOrder in craftingOrder2.Value.CustomOrders)
			{
				if (!customOrder.IsPreCraftedWeaponDesignValid())
				{
					list.Add(customOrder);
				}
				else
				{
					customOrder.InitializeCraftingOrderOnLoad();
				}
			}
			foreach (CraftingOrder item in list)
			{
				craftingOrder2.Value.RemoveCustomOrder(item);
			}
		}
		for (int num = _cratingItemsHistory.Count - 1; num >= 0; num--)
		{
			ItemObject itemObject = _cratingItemsHistory[num];
			if (itemObject == DefaultItems.Trash || itemObject == null)
			{
				_cratingItemsHistory.RemoveAt(num);
			}
		}
	}

	private void InitializeCraftedItemData()
	{
		for (int i = 0; i < _craftedItemDictionary.Count; i++)
		{
			KeyValuePair<ItemObject, CraftedItemInitializationData> keyValuePair = _craftedItemDictionary.ElementAt(i);
			ItemObject key = keyValuePair.Key;
			WeaponDesignElement[] array = new WeaponDesignElement[keyValuePair.Value.CraftedData.UsedPieces.Length];
			for (int j = 0; j < keyValuePair.Value.CraftedData.UsedPieces.Length; j++)
			{
				array[j] = keyValuePair.Value.CraftedData.UsedPieces[j].GetCopy();
			}
			WeaponDesign craftedData = new WeaponDesign(keyValuePair.Value.CraftedData.Template, keyValuePair.Value.CraftedData.WeaponName, array, key.StringId);
			_craftedItemDictionary[key] = new CraftedItemInitializationData(craftedData, keyValuePair.Value.ItemName, keyValuePair.Value.Culture);
		}
		foreach (KeyValuePair<ItemObject, CraftedItemInitializationData> item in _craftedItemDictionary)
		{
			ItemObject itemObject = Crafting.InitializePreCraftedWeaponOnLoad(item.Key, item.Value.CraftedData, item.Value.ItemName, item.Value.Culture);
			if (itemObject == DefaultItems.Trash || itemObject == null)
			{
				if (MBObjectManager.Instance.GetObject(item.Key.Id) != null)
				{
					MBObjectManager.Instance.UnregisterObject(item.Key);
				}
			}
			else
			{
				ItemObject.InitAsPlayerCraftedItem(ref itemObject);
				itemObject.IsReady = true;
			}
		}
	}

	public override void RegisterEvents()
	{
		CampaignEvents.OnNewGameCreatedPartialFollowUpEndEvent.AddNonSerializedListener(this, OnNewGameCreatedPartialFollowUpEnd);
		CampaignEvents.OnSessionLaunchedEvent.AddNonSerializedListener(this, OnSessionLaunched);
		CampaignEvents.OnNewItemCraftedEvent.AddNonSerializedListener(this, OnNewItemCrafted);
		CampaignEvents.HourlyTickEvent.AddNonSerializedListener(this, HourlyTick);
		CampaignEvents.DailyTickSettlementEvent.AddNonSerializedListener(this, DailyTickSettlement);
		CampaignEvents.DailyTickEvent.AddNonSerializedListener(this, DailyTick);
		CampaignEvents.HeroKilledEvent.AddNonSerializedListener(this, OnHeroKilled);
		CampaignEvents.OnGameLoadedEvent.AddNonSerializedListener(this, OnGameLoaded);
	}

	private void OnNewGameCreatedPartialFollowUpEnd(CampaignGameStarter starter)
	{
		InitializeLists();
		MBList<Hero> mBList = new MBList<Hero>();
		foreach (Town allTown in Town.AllTowns)
		{
			Settlement settlement = allTown.Settlement;
			mBList.AddRange(settlement.HeroesWithoutParty);
			foreach (MobileParty party in settlement.Parties)
			{
				if (party.LeaderHero != null && !party.IsMainParty)
				{
					mBList.Add(party.LeaderHero);
				}
			}
			if (mBList.Count > 0)
			{
				for (int i = 0; i < 6; i++)
				{
					if (CraftingOrders[settlement.Town].GetAvailableSlot() > -1)
					{
						CreateTownOrder(mBList.GetRandomElement(), i);
					}
				}
			}
			mBList.Clear();
		}
	}

	private void DailyTickSettlement(Settlement settlement)
	{
		if (!settlement.IsTown || !CraftingOrders[settlement.Town].IsThereAvailableSlot())
		{
			return;
		}
		List<Hero> list = new List<Hero>(settlement.HeroesWithoutParty);
		foreach (MobileParty party in settlement.Parties)
		{
			if (party.LeaderHero != null && !party.IsMainParty)
			{
				list.Add(party.LeaderHero);
			}
		}
		foreach (Hero item in list)
		{
			if (item != Hero.MainHero && MBRandom.RandomFloat <= 0.05f)
			{
				int availableSlot = CraftingOrders[settlement.Town].GetAvailableSlot();
				if (availableSlot <= -1)
				{
					break;
				}
				CreateTownOrder(item, availableSlot);
			}
		}
	}

	private void DailyTick()
	{
		foreach (KeyValuePair<Town, CraftingOrderSlots> craftingOrder2 in CraftingOrders)
		{
			CraftingOrder[] slots = craftingOrder2.Value.Slots;
			foreach (CraftingOrder craftingOrder in slots)
			{
				if (craftingOrder != null && MBRandom.RandomFloat <= 0.05f)
				{
					ReplaceCraftingOrder(craftingOrder2.Key, craftingOrder);
				}
			}
		}
	}

	private void HourlyTick()
	{
		foreach (KeyValuePair<Hero, HeroCraftingRecord> heroCraftingRecord in _heroCraftingRecords)
		{
			if (heroCraftingRecord.Key.CurrentSettlement != null)
			{
				int maxHeroCraftingStamina = GetMaxHeroCraftingStamina(heroCraftingRecord.Key);
				if (heroCraftingRecord.Value.CraftingStamina < maxHeroCraftingStamina)
				{
					heroCraftingRecord.Value.CraftingStamina = MathF.Min(maxHeroCraftingStamina, heroCraftingRecord.Value.CraftingStamina + GetStaminaHourlyRecoveryRate(heroCraftingRecord.Key));
				}
			}
		}
	}

	private void OnHeroKilled(Hero victim, Hero killer, KillCharacterAction.KillCharacterActionDetail detail, bool showNotification = true)
	{
		RemoveOrdersOfHeroWithoutCompletionIfExists(victim);
	}

	private void OnGameLoaded(CampaignGameStarter campaignGameStarter)
	{
		InitializeLists();
		foreach (KeyValuePair<Town, CraftingOrderSlots> craftingOrder2 in _craftingOrders)
		{
			for (int i = 0; i < 6; i++)
			{
				CraftingOrder craftingOrder = craftingOrder2.Value.Slots[i];
				if (craftingOrder != null && (craftingOrder.PreCraftedWeaponDesignItem == DefaultItems.Trash || craftingOrder.PreCraftedWeaponDesignItem == null || !craftingOrder.PreCraftedWeaponDesignItem.IsReady))
				{
					CancelOrder(craftingOrder2.Key, craftingOrder);
				}
			}
		}
	}

	private static int GetStaminaHourlyRecoveryRate(Hero hero)
	{
		int num = 5 + MathF.Round((float)hero.GetSkillValue(DefaultSkills.Crafting) * 0.025f);
		if (hero.GetPerkValue(DefaultPerks.Athletics.Stamina))
		{
			num += MathF.Round((float)num * DefaultPerks.Athletics.Stamina.PrimaryBonus);
		}
		return num;
	}

	private void OnNewItemCrafted(ItemObject itemObject, ItemModifier overriddenItemModifier, bool isCraftingOrderItem)
	{
		if (!_craftedItemDictionary.ContainsKey(itemObject))
		{
			CultureObject culture = MBObjectManager.Instance.GetObject<CultureObject>(itemObject.Culture.StringId);
			CraftedItemInitializationData value = new CraftedItemInitializationData(itemObject.WeaponDesign, itemObject.Name, culture);
			_craftedItemDictionary.Add(itemObject, value);
		}
	}

	private void AddResearchPoints(CraftingTemplate craftingTemplate, int researchPoints)
	{
		_openNewPartXpDictionary[craftingTemplate] += researchPoints;
		int count = craftingTemplate.Pieces.Count;
		int num = craftingTemplate.Pieces.Count((CraftingPiece x) => IsOpened(x, craftingTemplate));
		float num2 = Campaign.Current.Models.SmithingModel.ResearchPointsNeedForNewPart(count, num);
		do
		{
			if (_openNewPartXpDictionary[craftingTemplate] > num2)
			{
				_openNewPartXpDictionary[craftingTemplate] -= num2;
				if (OpenNewPart(craftingTemplate))
				{
					num++;
				}
			}
			num2 = Campaign.Current.Models.SmithingModel.ResearchPointsNeedForNewPart(count, craftingTemplate.Pieces.Count((CraftingPiece x) => IsOpened(x, craftingTemplate)));
		}
		while (_openNewPartXpDictionary[craftingTemplate] > num2 && num < count);
	}

	private bool OpenNewPart(CraftingTemplate craftingTemplate)
	{
		int num = int.MaxValue;
		MBList<CraftingPiece> mBList = new MBList<CraftingPiece>();
		foreach (CraftingPiece piece in craftingTemplate.Pieces)
		{
			int pieceTier = piece.PieceTier;
			if (num >= pieceTier && !piece.IsHiddenOnDesigner && !IsOpened(piece, craftingTemplate))
			{
				if (num > piece.PieceTier)
				{
					mBList.Clear();
					num = pieceTier;
				}
				mBList.Add(piece);
			}
		}
		if (mBList.Count > 0)
		{
			CraftingPiece randomElement = mBList.GetRandomElement();
			OpenPart(randomElement, craftingTemplate);
			return true;
		}
		return false;
	}

	private void OpenPart(CraftingPiece selectedPiece, CraftingTemplate craftingTemplate, bool showNotification = true)
	{
		_openedPartsDictionary[craftingTemplate].Add(selectedPiece);
		CampaignEventDispatcher.Instance.CraftingPartUnlocked(selectedPiece);
		if (showNotification)
		{
			TextObject textObject = new TextObject("{=p9F90bc0}New Smithing Part Unlocked: {PART_NAME} for {WEAPON_TYPE}.");
			textObject.SetTextVariable("PART_NAME", selectedPiece.Name);
			textObject.SetTextVariable("WEAPON_TYPE", craftingTemplate.TemplateName);
			MBInformationManager.AddQuickInformation(textObject);
		}
	}

	public bool IsOpened(CraftingPiece craftingPiece, CraftingTemplate craftingTemplate)
	{
		if (!craftingPiece.IsGivenByDefault)
		{
			return _openedPartsDictionary[craftingTemplate].Contains(craftingPiece);
		}
		return true;
	}

	public int GetCraftingDifficulty(WeaponDesign weaponDesign)
	{
		return Campaign.Current.Models.SmithingModel.CalculateWeaponDesignDifficulty(weaponDesign);
	}

	private void InitializeLists()
	{
		if (_craftingOrders.IsEmpty())
		{
			foreach (Town allTown in Campaign.Current.AllTowns)
			{
				_craftingOrders.Add(allTown, new CraftingOrderSlots());
			}
		}
		foreach (KeyValuePair<CraftingTemplate, List<CraftingPiece>> item in _openedPartsDictionary.ToList())
		{
			if (!CraftingTemplate.All.Contains(item.Key))
			{
				_openedPartsDictionary.Remove(item.Key);
			}
		}
		foreach (KeyValuePair<CraftingTemplate, float> item2 in _openNewPartXpDictionary.ToList())
		{
			if (!CraftingTemplate.All.Contains(item2.Key))
			{
				_openNewPartXpDictionary.Remove(item2.Key);
			}
		}
		foreach (CraftingTemplate item3 in CraftingTemplate.All)
		{
			if (!_openNewPartXpDictionary.ContainsKey(item3))
			{
				_openNewPartXpDictionary.Add(item3, 0f);
			}
			if (!_openedPartsDictionary.ContainsKey(item3))
			{
				_openedPartsDictionary.Add(item3, new List<CraftingPiece>());
			}
			foreach (CraftingPiece item4 in _openedPartsDictionary[item3].ToList())
			{
				if (!item3.Pieces.Contains(item4))
				{
					_openedPartsDictionary[item3].Remove(item4);
				}
			}
		}
	}

	public void OnSessionLaunched(CampaignGameStarter campaignGameStarter)
	{
		AddDialogs(campaignGameStarter);
	}

	private void AddDialogs(CampaignGameStarter campaignGameStarter)
	{
		campaignGameStarter.AddDialogLine("blacksmith_begin", "start", "blacksmith_player", "{=gYByVHQy}Good day, {?PLAYER.GENDER}madam{?}sir{\\?}. How may I help you?", conversation_blacksmith_begin_on_condition, null);
		campaignGameStarter.AddPlayerLine("blacksmith_craft_items", "blacksmith_player", "player_blacksmith_after_craft", "{=VXKGD0ta}I want to use your forge.", () => Campaign.Current.IsCraftingEnabled, conversation_blacksmith_craft_items_on_consequence);
		campaignGameStarter.AddPlayerLine("blacksmith_leave", "blacksmith_player", "close_window", "{=iW9iKbb8}Nothing.", null, null);
		campaignGameStarter.AddDialogLine("blacksmith_player_after_craft_anything_else", "player_blacksmith_after_craft", "blacksmith_player_1", "{=IvY187PJ}No matter. Anything else?", null, null);
		campaignGameStarter.AddPlayerLine("blacksmith_craft_items_1", "blacksmith_player_1", "player_blacksmith_after_craft", "{=hrn1Cdwo}There is something else I need you to make.", () => Campaign.Current.IsCraftingEnabled, conversation_blacksmith_craft_items_on_consequence);
		campaignGameStarter.AddPlayerLine("blacksmith_leave_1", "blacksmith_player_1", "close_window", "{=iW9iKbb8}Nothing.", null, null);
	}

	private bool conversation_blacksmith_begin_on_condition()
	{
		return CharacterObject.OneToOneConversationCharacter.Occupation == Occupation.Blacksmith;
	}

	private void conversation_blacksmith_craft_items_on_consequence()
	{
		CraftingHelper.OpenCrafting(CraftingTemplate.All[0]);
	}

	public int GetHeroCraftingStamina(Hero hero)
	{
		return GetRecordForCompanion(hero).CraftingStamina;
	}

	private HeroCraftingRecord GetRecordForCompanion(Hero hero)
	{
		if (!_heroCraftingRecords.TryGetValue(hero, out var value))
		{
			value = new HeroCraftingRecord(GetMaxHeroCraftingStamina(hero));
			_heroCraftingRecords[hero] = value;
		}
		return value;
	}

	public void SetHeroCraftingStamina(Hero hero, int value)
	{
		GetRecordForCompanion(hero).CraftingStamina = MathF.Max(0, value);
	}

	public void SetCraftedWeaponName(ItemObject craftedWeaponItem, TextObject name)
	{
		if (_craftedItemDictionary.TryGetValue(craftedWeaponItem, out var value))
		{
			_craftedItemDictionary[craftedWeaponItem] = new CraftedItemInitializationData(value.CraftedData, name, value.Culture);
		}
	}

	public int GetMaxHeroCraftingStamina(Hero hero)
	{
		return 100 + MathF.Round((float)hero.GetSkillValue(DefaultSkills.Crafting) * 0.5f);
	}

	public void DoRefinement(Hero hero, Crafting.RefiningFormula refineFormula)
	{
		ItemRoster itemRoster = MobileParty.MainParty.ItemRoster;
		if (refineFormula.Input1Count > 0)
		{
			ItemObject craftingMaterialItem = Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem(refineFormula.Input1);
			itemRoster.AddToCounts(craftingMaterialItem, -refineFormula.Input1Count);
		}
		if (refineFormula.Input2Count > 0)
		{
			ItemObject craftingMaterialItem2 = Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem(refineFormula.Input2);
			itemRoster.AddToCounts(craftingMaterialItem2, -refineFormula.Input2Count);
		}
		if (refineFormula.OutputCount > 0)
		{
			ItemObject craftingMaterialItem3 = Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem(refineFormula.Output);
			itemRoster.AddToCounts(craftingMaterialItem3, refineFormula.OutputCount);
		}
		if (refineFormula.Output2Count > 0)
		{
			ItemObject craftingMaterialItem4 = Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem(refineFormula.Output2);
			itemRoster.AddToCounts(craftingMaterialItem4, refineFormula.Output2Count);
		}
		hero.AddSkillXp(DefaultSkills.Crafting, Campaign.Current.Models.SmithingModel.GetSkillXpForRefining(ref refineFormula));
		int energyCostForRefining = Campaign.Current.Models.SmithingModel.GetEnergyCostForRefining(ref refineFormula, hero);
		SetHeroCraftingStamina(hero, GetHeroCraftingStamina(hero) - energyCostForRefining);
		CampaignEventDispatcher.Instance.OnItemsRefined(hero, refineFormula);
	}

	public void DoSmelting(Hero currentCraftingHero, EquipmentElement equipmentElement)
	{
		ItemRoster itemRoster = MobileParty.MainParty.ItemRoster;
		ItemObject item = equipmentElement.Item;
		int[] smeltingOutputForItem = Campaign.Current.Models.SmithingModel.GetSmeltingOutputForItem(item);
		for (int num = 8; num >= 0; num--)
		{
			if (smeltingOutputForItem[num] != 0)
			{
				itemRoster.AddToCounts(Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem((CraftingMaterials)num), smeltingOutputForItem[num]);
			}
		}
		itemRoster.AddToCounts(equipmentElement, -1);
		currentCraftingHero.AddSkillXp(DefaultSkills.Crafting, Campaign.Current.Models.SmithingModel.GetSkillXpForSmelting(item));
		int energyCostForSmelting = Campaign.Current.Models.SmithingModel.GetEnergyCostForSmelting(item, currentCraftingHero);
		SetHeroCraftingStamina(currentCraftingHero, GetHeroCraftingStamina(currentCraftingHero) - energyCostForSmelting);
		AddResearchPoints(item.WeaponDesign.Template, Campaign.Current.Models.SmithingModel.GetPartResearchGainForSmeltingItem(item, currentCraftingHero));
		CampaignEventDispatcher.Instance.OnEquipmentSmeltedByHero(currentCraftingHero, equipmentElement);
	}

	public ItemObject CreateCraftedWeaponInFreeBuildMode(Hero hero, WeaponDesign weaponDesign, ItemModifier weaponModifier = null)
	{
		ItemObject itemObject = CreateCraftedWeaponInternal(isFreeMode: true, hero, weaponDesign, weaponModifier);
		int skillXpForSmithingInFreeBuildMode = Campaign.Current.Models.SmithingModel.GetSkillXpForSmithingInFreeBuildMode(itemObject);
		hero.AddSkillXp(DefaultSkills.Crafting, skillXpForSmithingInFreeBuildMode);
		AddItemToHistory(itemObject);
		return itemObject;
	}

	public ItemObject CreateCraftedWeaponInCraftingOrderMode(Hero crafterHero, CraftingOrder craftingOrder, WeaponDesign weaponDesign)
	{
		ItemObject itemObject = CreateCraftedWeaponInternal(isFreeMode: false, crafterHero, weaponDesign);
		float xpAmount = craftingOrder.GetOrderExperience(itemObject, _currentItemModifier) + (float)Campaign.Current.Models.SmithingModel.GetSkillXpForSmithingInCraftingOrderMode(itemObject);
		crafterHero.AddSkillXp(DefaultSkills.Crafting, xpAmount);
		return itemObject;
	}

	private ItemObject CreateCraftedWeaponInternal(bool isFreeMode, Hero crafterHero, WeaponDesign weaponDesign, ItemModifier weaponModifier = null)
	{
		string nextCraftedItemId = GetNextCraftedItemId();
		if (isFreeMode)
		{
			weaponDesign = new WeaponDesign(weaponDesign.Template, weaponDesign.WeaponName, weaponDesign.UsedPieces, nextCraftedItemId);
		}
		SpendMaterials(weaponDesign);
		ItemObject itemObject = (GameStateManager.Current.ActiveState as CraftingState).CraftingLogic.GetCurrentCraftedItemObject(forceReCreate: true, nextCraftedItemId);
		ItemObject.InitAsPlayerCraftedItem(ref itemObject);
		MBObjectManager.Instance.RegisterObject(itemObject);
		if (isFreeMode)
		{
			if (weaponModifier == null)
			{
				PartyBase.MainParty.ItemRoster.AddToCounts(itemObject, 1);
			}
			else
			{
				EquipmentElement rosterElement = new EquipmentElement(itemObject, weaponModifier);
				PartyBase.MainParty.ItemRoster.AddToCounts(rosterElement, 1);
			}
		}
		CampaignEventDispatcher.Instance.OnNewItemCrafted(itemObject, weaponModifier, !isFreeMode);
		int energyCostForSmithing = Campaign.Current.Models.SmithingModel.GetEnergyCostForSmithing(itemObject, crafterHero);
		SetHeroCraftingStamina(crafterHero, GetHeroCraftingStamina(crafterHero) - energyCostForSmithing);
		AddResearchPoints(weaponDesign.Template, Campaign.Current.Models.SmithingModel.GetPartResearchGainForSmithingItem(itemObject, crafterHero, isFreeMode));
		return itemObject;
	}

	private static void SpendMaterials(WeaponDesign weaponDesign)
	{
		ItemRoster itemRoster = MobileParty.MainParty.ItemRoster;
		int[] smithingCostsForWeaponDesign = Campaign.Current.Models.SmithingModel.GetSmithingCostsForWeaponDesign(weaponDesign);
		for (int num = 8; num >= 0; num--)
		{
			if (smithingCostsForWeaponDesign[num] != 0)
			{
				itemRoster.AddToCounts(Campaign.Current.Models.SmithingModel.GetCraftingMaterialItem((CraftingMaterials)num), smithingCostsForWeaponDesign[num]);
			}
		}
	}

	private void AddItemToHistory(ItemObject craftedObject)
	{
		while (_cratingItemsHistory.Count >= 10)
		{
			_cratingItemsHistory.RemoveAt(0);
		}
		_cratingItemsHistory.Add(craftedObject);
	}

	public Hero GetActiveCraftingHero()
	{
		return _activeCraftingHero;
	}

	public void SetActiveCraftingHero(Hero hero)
	{
		_activeCraftingHero = hero;
	}

	public void CreateTownOrder(Hero orderOwner, int orderSlot)
	{
		if (orderOwner.CurrentSettlement == null || !orderOwner.CurrentSettlement.IsTown)
		{
			Debug.Print("Order owner: " + orderOwner.StringId + " Settlement" + ((orderOwner.CurrentSettlement == null) ? "null" : orderOwner.CurrentSettlement.StringId) + " Order owner party: " + ((orderOwner.PartyBelongedTo == null) ? "null" : orderOwner.PartyBelongedTo.StringId));
		}
		float townOrderDifficulty = GetTownOrderDifficulty(orderOwner.CurrentSettlement.Town, orderSlot);
		int pieceTier = (int)townOrderDifficulty / 50;
		CraftingTemplate randomElement = CraftingTemplate.All.GetRandomElement();
		string nextTownOrderId = GetNextTownOrderId();
		WeaponDesign weaponDesignTemplate = new WeaponDesign(randomElement, TextObject.GetEmpty(), GetWeaponPieces(randomElement, pieceTier), nextTownOrderId);
		_craftingOrders[orderOwner.CurrentSettlement.Town].AddTownOrder(new CraftingOrder(orderOwner, townOrderDifficulty, weaponDesignTemplate, randomElement, orderSlot, nextTownOrderId));
	}

	private static float GetTownOrderDifficulty(Town town, int orderSlot)
	{
		int num = 0;
		switch (orderSlot)
		{
		case 0:
			num = MBRandom.RandomInt(40, 80);
			break;
		case 1:
			num = MBRandom.RandomInt(80, 120);
			break;
		case 2:
			num = MBRandom.RandomInt(120, 160);
			break;
		case 3:
			num = MBRandom.RandomInt(160, 200);
			break;
		case 4:
			num = MBRandom.RandomInt(200, 241);
			break;
		case 5:
			num = Hero.MainHero.GetSkillValue(DefaultSkills.Crafting);
			break;
		}
		return (float)num + town.Prosperity / 500f;
	}

	public CraftingOrder CreateCustomOrderForHero(Hero orderOwner, float orderDifficulty = -1f, WeaponDesign weaponDesign = null, CraftingTemplate craftingTemplate = null)
	{
		string nextTownOrderId = GetNextTownOrderId();
		if (orderDifficulty < 0f)
		{
			orderDifficulty = GetRandomOrderDifficulty(orderOwner.CurrentSettlement.Town);
		}
		if (craftingTemplate == null)
		{
			craftingTemplate = CraftingTemplate.All.GetRandomElement();
		}
		if (weaponDesign == null)
		{
			int pieceTier = (int)orderDifficulty / 40;
			weaponDesign = new WeaponDesign(craftingTemplate, TextObject.GetEmpty(), GetWeaponPieces(craftingTemplate, pieceTier), nextTownOrderId);
		}
		CraftingOrder craftingOrder = new CraftingOrder(orderOwner, orderDifficulty, weaponDesign, craftingTemplate, -1, nextTownOrderId);
		_craftingOrders[orderOwner.CurrentSettlement.Town].AddCustomOrder(craftingOrder);
		return craftingOrder;
	}

	private static float GetRandomOrderDifficulty(Town town)
	{
		int num = MBRandom.RandomInt(0, 6);
		int num2 = 0;
		switch (num)
		{
		case 0:
			num2 = MBRandom.RandomInt(40, 80);
			break;
		case 1:
			num2 = MBRandom.RandomInt(80, 120);
			break;
		case 2:
			num2 = MBRandom.RandomInt(120, 160);
			break;
		case 3:
			num2 = MBRandom.RandomInt(160, 200);
			break;
		case 4:
			num2 = MBRandom.RandomInt(200, 241);
			break;
		case 5:
			num2 = Hero.MainHero.GetSkillValue(DefaultSkills.Crafting);
			break;
		}
		return (float)num2 + town.Prosperity / 500f;
	}

	private WeaponDesignElement[] GetWeaponPieces(CraftingTemplate craftingTemplate, int pieceTier)
	{
		WeaponDesignElement[] array = new WeaponDesignElement[4];
		List<WeaponDesignElement>[] array2 = new List<WeaponDesignElement>[4];
		foreach (CraftingPiece piece in craftingTemplate.Pieces)
		{
			bool flag = false;
			PieceData[] buildOrders = craftingTemplate.BuildOrders;
			foreach (PieceData pieceData in buildOrders)
			{
				if (pieceData.PieceType == piece.PieceType)
				{
					flag = true;
					break;
				}
			}
			if (flag)
			{
				int pieceType = (int)piece.PieceType;
				if (array2[pieceType] == null)
				{
					array2[pieceType] = new List<WeaponDesignElement>();
				}
				array2[pieceType].Add(WeaponDesignElement.CreateUsablePiece(piece));
			}
		}
		for (int j = 0; j < array.Length; j++)
		{
			if (array2[j] != null)
			{
				array[j] = (array2[j].FirstOrDefaultQ((WeaponDesignElement p) => !p.CraftingPiece.IsHiddenOnDesigner && p.CraftingPiece.PieceTier == pieceTier) ?? array2[j].FirstOrDefaultQ((WeaponDesignElement p) => !p.CraftingPiece.IsHiddenOnDesigner && p.CraftingPiece.PieceTier == 1)) ?? array2[j].First((WeaponDesignElement p) => !p.CraftingPiece.IsHiddenOnDesigner);
			}
			else
			{
				array[j] = WeaponDesignElement.GetInvalidPieceForType((CraftingPiece.PieceTypes)j);
			}
		}
		return array;
	}

	private void ReplaceCraftingOrder(Town town, CraftingOrder order)
	{
		MBList<Hero> mBList = new MBList<Hero>();
		Settlement settlement = town.Settlement;
		mBList.AddRange(settlement.HeroesWithoutParty);
		foreach (MobileParty party in settlement.Parties)
		{
			if (party.LeaderHero != null && !party.IsMainParty)
			{
				mBList.Add(party.LeaderHero);
			}
		}
		int difficultyLevel = order.DifficultyLevel;
		_craftingOrders[town].RemoveTownOrder(order);
		if (mBList.Count > 0)
		{
			CreateTownOrder(mBList.GetRandomElement(), difficultyLevel);
		}
	}

	public void GetOrderResult(CraftingOrder craftingOrder, ItemObject craftedItem, out bool isSucceed, out TextObject orderRemark, out TextObject orderResult, out int finalReward)
	{
		finalReward = CalculateOrderPriceDifference(craftingOrder, craftedItem);
		craftingOrder.CheckForBonusesAndPenalties(craftedItem, _currentItemModifier, out var craftedStatsSum, out var requiredStatsSum, out var thrustDamageCheck, out var swingDamageCheck);
		isSucceed = craftedStatsSum >= requiredStatsSum && thrustDamageCheck && swingDamageCheck;
		int num = finalReward - craftingOrder.BaseGoldReward;
		orderRemark = TextObject.GetEmpty();
		if (isSucceed)
		{
			orderResult = new TextObject("{=Nn49hU2W}The client is satisfied.");
			if (num == 0)
			{
				orderRemark = new TextObject("{=FWHvvZFq}\"This is exactly what I wanted. Here is your money, you've earned it.\"");
			}
			else if ((float)num > 0f)
			{
				orderRemark = new TextObject("{=raCa7QXj}\"This is even better than what I have imagined. Here is your money, and I'm putting a little extra for your effort.\"");
			}
			return;
		}
		orderResult = new TextObject("{=bC2jevlu}The client is displeased.");
		if (finalReward <= 0)
		{
			orderRemark = new TextObject("{=NZynd8vT}\"This weapon is worthless. I'm not giving you a dime!\"");
		}
		else if (finalReward < craftingOrder.BaseGoldReward)
		{
			TextObject textObject = ((thrustDamageCheck && swingDamageCheck) ? new TextObject("{=wU76OPxM}\"This is worse than what I've asked for. I'm cutting {AMOUNT}{GOLD_ICON} from the price.\"") : new TextObject("{=WyuIksRB}\"This weapon does not have the damage type I wanted. I'm cutting {AMOUNT}{GOLD_ICON} from the price.\""));
			textObject.SetTextVariable("AMOUNT", MathF.Abs(num));
			orderRemark = textObject;
		}
	}

	private int CalculateOrderPriceDifference(CraftingOrder craftingOrder, ItemObject craftedItem)
	{
		craftingOrder.CheckForBonusesAndPenalties(craftedItem, _currentItemModifier, out var craftedStatsSum, out var requiredStatsSum, out var thrustDamageCheck, out var swingDamageCheck);
		float num = craftingOrder.BaseGoldReward;
		if (!craftedStatsSum.ApproximatelyEqualsTo(0f) && !requiredStatsSum.ApproximatelyEqualsTo(0f))
		{
			if (craftedStatsSum < requiredStatsSum || !thrustDamageCheck || !swingDamageCheck)
			{
				float b = (float)Campaign.Current.Models.TradeItemPriceFactorModel.GetTheoreticalMaxItemMarketValue(craftedItem) / (float)Campaign.Current.Models.TradeItemPriceFactorModel.GetTheoreticalMaxItemMarketValue(craftingOrder.PreCraftedWeaponDesignItem);
				num = (float)craftingOrder.BaseGoldReward * 0.5f * MathF.Min(1f, b);
				if (num > (float)craftingOrder.BaseGoldReward)
				{
					num = (float)craftingOrder.BaseGoldReward * 0.5f;
				}
			}
			else if (craftedStatsSum > requiredStatsSum)
			{
				num = (float)craftingOrder.BaseGoldReward * (1f + (craftedStatsSum - requiredStatsSum) / requiredStatsSum * 0.1f);
			}
		}
		return (int)num;
	}

	public void CompleteOrder(Town town, CraftingOrder craftingOrder, ItemObject craftedItem, Hero completerHero)
	{
		int amount = CalculateOrderPriceDifference(craftingOrder, craftedItem);
		GetOrderResult(craftingOrder, craftedItem, out var isSucceed, out var _, out var _, out var _);
		GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, amount);
		if (_craftingOrders[town].CustomOrders.Contains(craftingOrder))
		{
			_craftingOrders[town].RemoveCustomOrder(craftingOrder);
		}
		else
		{
			if (craftingOrder.IsLordOrder)
			{
				ChangeCraftedOrderWithTheNoblesWeaponIfItIsBetter(craftedItem, craftingOrder);
				if (craftingOrder.OrderOwner.PartyBelongedTo != null)
				{
					GiveTroopToNobleAtWeaponTier((int)craftedItem.Tier, craftingOrder.OrderOwner);
				}
				if (isSucceed && completerHero.GetPerkValue(DefaultPerks.Crafting.SteelMaker3))
				{
					ChangeRelationAction.ApplyRelationChangeBetweenHeroes(completerHero, craftingOrder.OrderOwner, (int)DefaultPerks.Crafting.SteelMaker3.SecondaryBonus);
				}
			}
			else
			{
				craftingOrder.OrderOwner.AddPower((float)(craftedItem.Tier + 1));
				if (isSucceed && completerHero.GetPerkValue(DefaultPerks.Crafting.ExperiencedSmith))
				{
					ChangeRelationAction.ApplyRelationChangeBetweenHeroes(completerHero, craftingOrder.OrderOwner, (int)DefaultPerks.Crafting.ExperiencedSmith.SecondaryBonus);
				}
			}
			_craftingOrders[town].RemoveTownOrder(craftingOrder);
		}
		CampaignEventDispatcher.Instance.OnCraftingOrderCompleted(town, craftingOrder, craftedItem, completerHero);
	}

	public ItemModifier GetCurrentItemModifier()
	{
		return _currentItemModifier;
	}

	public void SetCurrentItemModifier(ItemModifier modifier)
	{
		_currentItemModifier = modifier;
	}

	private void RemoveOrdersOfHeroWithoutCompletionIfExists(Hero hero)
	{
		foreach (KeyValuePair<Town, CraftingOrderSlots> craftingOrder in _craftingOrders)
		{
			for (int i = 0; i < 6; i++)
			{
				if (craftingOrder.Value.Slots[i] != null && craftingOrder.Value.Slots[i].OrderOwner == hero)
				{
					craftingOrder.Value.RemoveTownOrder(craftingOrder.Value.Slots[i]);
				}
			}
		}
	}

	public void CancelCustomOrder(Town town, CraftingOrder craftingOrder)
	{
		if (_craftingOrders[town].CustomOrders.Contains(craftingOrder))
		{
			_craftingOrders[town].RemoveCustomOrder(craftingOrder);
		}
		else
		{
			Debug.FailedAssert("Trying to cancel a custom order that doesn't exist.", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\CampaignBehaviors\\CraftingCampaignBehavior.cs", "CancelCustomOrder", 1408);
		}
	}

	private void CancelOrder(Town town, CraftingOrder craftingOrder)
	{
		_craftingOrders[town].RemoveTownOrder(craftingOrder);
	}

	private void ChangeCraftedOrderWithTheNoblesWeaponIfItIsBetter(ItemObject craftedItem, CraftingOrder craftingOrder)
	{
		Equipment battleEquipment = craftingOrder.OrderOwner.BattleEquipment;
		for (int i = 0; i < 12; i++)
		{
			if (!battleEquipment[i].IsEmpty && craftedItem.PrimaryWeapon.WeaponClass == battleEquipment[i].Item.PrimaryWeapon?.WeaponClass)
			{
				ItemObject item = battleEquipment[i].Item;
				int thrustSpeed = item.PrimaryWeapon.ThrustSpeed;
				int thrustSpeed2 = craftedItem.PrimaryWeapon.ThrustSpeed;
				int swingSpeed = item.PrimaryWeapon.SwingSpeed;
				int swingSpeed2 = craftedItem.PrimaryWeapon.SwingSpeed;
				int missileSpeed = item.PrimaryWeapon.MissileSpeed;
				int missileSpeed2 = craftedItem.PrimaryWeapon.MissileSpeed;
				float weaponBalance = item.PrimaryWeapon.WeaponBalance;
				float weaponBalance2 = craftedItem.PrimaryWeapon.WeaponBalance;
				int thrustDamage = item.PrimaryWeapon.ThrustDamage;
				int thrustDamage2 = craftedItem.PrimaryWeapon.ThrustDamage;
				DamageTypes thrustDamageType = item.PrimaryWeapon.ThrustDamageType;
				DamageTypes thrustDamageType2 = craftedItem.PrimaryWeapon.ThrustDamageType;
				int swingDamage = item.PrimaryWeapon.SwingDamage;
				int swingDamage2 = craftedItem.PrimaryWeapon.SwingDamage;
				DamageTypes swingDamageType = item.PrimaryWeapon.SwingDamageType;
				DamageTypes swingDamageType2 = craftedItem.PrimaryWeapon.SwingDamageType;
				int accuracy = item.PrimaryWeapon.Accuracy;
				int accuracy2 = craftedItem.PrimaryWeapon.Accuracy;
				float weight = item.Weight;
				float weight2 = craftedItem.Weight;
				if (thrustSpeed2 > thrustSpeed && swingSpeed2 > swingSpeed && missileSpeed2 > missileSpeed && weaponBalance2 > weaponBalance && thrustDamage2 > thrustDamage && thrustDamageType == thrustDamageType2 && swingDamage2 > swingDamage && swingDamageType2 == swingDamageType && accuracy2 > accuracy && weight2 < weight)
				{
					battleEquipment[i] = new EquipmentElement(craftedItem);
					break;
				}
			}
		}
	}

	private void GiveTroopToNobleAtWeaponTier(int tier, Hero noble)
	{
		CharacterObject characterObject = noble.Culture.BasicTroop;
		for (int i = 0; i < tier; i++)
		{
			if (characterObject.UpgradeTargets.Length != 0)
			{
				characterObject = characterObject.UpgradeTargets.GetRandomElement();
			}
		}
		noble.PartyBelongedTo.AddElementToMemberRoster(characterObject, 1);
	}
}
