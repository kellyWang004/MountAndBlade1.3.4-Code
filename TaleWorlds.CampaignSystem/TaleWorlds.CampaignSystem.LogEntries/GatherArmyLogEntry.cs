using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries;

public class GatherArmyLogEntry : LogEntry, IChatNotification
{
	[SaveableField(220)]
	public readonly Hero ArmyLeader;

	[SaveableField(221)]
	public readonly IFaction ArmyMapFaction;

	[SaveableField(222)]
	public readonly IMapPoint GatheringPoint;

	public override ChatNotificationType NotificationType => MilitaryNotification(ArmyLeader.Clan, null);

	public bool IsVisibleNotification => ArmyMapFaction == Hero.MainHero.MapFaction;

	internal static void AutoGeneratedStaticCollectObjectsGatherArmyLogEntry(object o, List<object> collectedObjects)
	{
		((GatherArmyLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(ArmyLeader);
		collectedObjects.Add(ArmyMapFaction);
		collectedObjects.Add(GatheringPoint);
	}

	internal static object AutoGeneratedGetMemberValueArmyLeader(object o)
	{
		return ((GatherArmyLogEntry)o).ArmyLeader;
	}

	internal static object AutoGeneratedGetMemberValueArmyMapFaction(object o)
	{
		return ((GatherArmyLogEntry)o).ArmyMapFaction;
	}

	internal static object AutoGeneratedGetMemberValueGatheringPoint(object o)
	{
		return ((GatherArmyLogEntry)o).GatheringPoint;
	}

	public GatherArmyLogEntry(Army army, IMapPoint gatheringPoint)
	{
		ArmyLeader = army.LeaderParty.LeaderHero;
		ArmyMapFaction = army.Kingdom;
		GatheringPoint = gatheringPoint;
	}

	public override string ToString()
	{
		return GetNotificationText().ToString();
	}

	public TextObject GetNotificationText()
	{
		TextObject textObject = TextObject.GetEmpty();
		if (GatheringPoint == null)
		{
			textObject = new TextObject("{=tjamxNtT}{LORD.NAME} is gathering an army.");
		}
		else if (GatheringPoint is Settlement settlement)
		{
			textObject = new TextObject("{=Vi5Ylvr1}{LORD.NAME} is gathering an army near {SETTLEMENT}.");
			textObject.SetTextVariable("SETTLEMENT", settlement.Name);
		}
		else
		{
			Debug.FailedAssert("No entry is present.", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\LogEntries\\GatherArmyLogEntry.cs", "GetNotificationText", 51);
		}
		StringHelpers.SetCharacterProperties("LORD", ArmyLeader.CharacterObject, textObject);
		return textObject;
	}
}
