using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries;

public class EndCaptivityLogEntry : LogEntry, IEncyclopediaLog, IChatNotification
{
	[SaveableField(730)]
	public readonly IFaction CapturerMapFaction;

	[SaveableField(731)]
	public readonly Hero Prisoner;

	[SaveableProperty(732)]
	public EndCaptivityDetail Detail { get; private set; }

	public bool IsVisibleNotification => true;

	public override ChatNotificationType NotificationType => MilitaryNotification(Prisoner.Clan, null);

	internal static void AutoGeneratedStaticCollectObjectsEndCaptivityLogEntry(object o, List<object> collectedObjects)
	{
		((EndCaptivityLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(CapturerMapFaction);
		collectedObjects.Add(Prisoner);
	}

	internal static object AutoGeneratedGetMemberValueDetail(object o)
	{
		return ((EndCaptivityLogEntry)o).Detail;
	}

	internal static object AutoGeneratedGetMemberValueCapturerMapFaction(object o)
	{
		return ((EndCaptivityLogEntry)o).CapturerMapFaction;
	}

	internal static object AutoGeneratedGetMemberValuePrisoner(object o)
	{
		return ((EndCaptivityLogEntry)o).Prisoner;
	}

	public EndCaptivityLogEntry(Hero prisoner, IFaction capturerMapFaction, EndCaptivityDetail detail)
	{
		CapturerMapFaction = capturerMapFaction;
		Prisoner = prisoner;
		Detail = detail;
	}

	public override string ToString()
	{
		return GetEncyclopediaText().ToString();
	}

	public TextObject GetEncyclopediaText()
	{
		return GetNotificationText();
	}

	public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
	{
		if ((object)obj != Prisoner)
		{
			return (object)obj == Prisoner.Clan;
		}
		return true;
	}

	public TextObject GetNotificationText()
	{
		Clan clan = Prisoner.Clan;
		TextObject textObject;
		if (clan != null && !clan.IsMinorFaction)
		{
			textObject = GameTexts.FindText("str_released_lord_with_faction_free");
			switch (Detail)
			{
			case EndCaptivityDetail.Death:
				textObject = GameTexts.FindText("str_released_lord_with_faction_death");
				break;
			case EndCaptivityDetail.Ransom:
				textObject = GameTexts.FindText("str_released_lord_with_faction_ransom");
				break;
			case EndCaptivityDetail.ReleasedAfterBattle:
				textObject = GameTexts.FindText("str_released_lord_with_faction_battle");
				break;
			case EndCaptivityDetail.ReleasedAfterEscape:
				textObject = GameTexts.FindText("str_released_lord_with_faction_escape");
				break;
			case EndCaptivityDetail.ReleasedAfterPeace:
				textObject = GameTexts.FindText("str_released_lord_with_faction_peace");
				break;
			case EndCaptivityDetail.ReleasedByCompensation:
				textObject = GameTexts.FindText("str_released_lord_with_faction_escape");
				break;
			}
			textObject.SetTextVariable("PRISONER_FACTION_LINK", Prisoner.MapFaction.EncyclopediaLinkWithName);
		}
		else
		{
			textObject = GameTexts.FindText("str_released_lord_free");
			switch (Detail)
			{
			case EndCaptivityDetail.Death:
				textObject = GameTexts.FindText("str_released_lord_death");
				break;
			case EndCaptivityDetail.Ransom:
				textObject = GameTexts.FindText("str_released_lord_ransom");
				break;
			case EndCaptivityDetail.ReleasedAfterBattle:
				textObject = GameTexts.FindText("str_released_lord_battle");
				break;
			case EndCaptivityDetail.ReleasedAfterEscape:
				textObject = GameTexts.FindText("str_released_lord_escape");
				break;
			case EndCaptivityDetail.ReleasedAfterPeace:
				textObject = GameTexts.FindText("str_released_lord_peace");
				break;
			case EndCaptivityDetail.ReleasedByCompensation:
				textObject = GameTexts.FindText("str_released_lord_escape");
				break;
			}
		}
		StringHelpers.SetCharacterProperties("PRISONER_LORD", Prisoner.CharacterObject, textObject);
		if (CapturerMapFaction != null)
		{
			textObject.SetTextVariable("CAPTURER_FACTION", CapturerMapFaction.InformalName);
		}
		return textObject;
	}

	public override void GetConversationScoreAndComment(Hero talkTroop, bool findString, out string comment, out ImportanceEnum score)
	{
		score = ImportanceEnum.Zero;
		comment = "";
		if (talkTroop == Prisoner && talkTroop.IsPlayerCompanion)
		{
			if (Detail == EndCaptivityDetail.Ransom)
			{
				score = ImportanceEnum.VeryImportant;
				comment = "str_comment_captivity_release_companion_ransom";
			}
			else
			{
				score = ImportanceEnum.VeryImportant;
				comment = "str_comment_captivity_release_companion";
			}
		}
	}

	public override bool IsValid()
	{
		if (Prisoner != null)
		{
			if (Prisoner.IsRebel)
			{
				return Prisoner.IsAlive;
			}
			return true;
		}
		return false;
	}
}
