using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.MapNotificationTypes;
using TaleWorlds.Core.ImageIdentifiers;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election;

public class MakePeaceKingdomDecision : KingdomDecision
{
	public class MakePeaceDecisionOutcome : DecisionOutcome
	{
		[SaveableField(100)]
		public readonly bool ShouldPeaceBeDeclared;

		[SaveableField(110)]
		public readonly Kingdom Kingdom;

		[SaveableField(120)]
		public readonly IFaction FactionToMakePeaceWith;

		internal static void AutoGeneratedStaticCollectObjectsMakePeaceDecisionOutcome(object o, List<object> collectedObjects)
		{
			((MakePeaceDecisionOutcome)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(Kingdom);
			collectedObjects.Add(FactionToMakePeaceWith);
		}

		internal static object AutoGeneratedGetMemberValueShouldPeaceBeDeclared(object o)
		{
			return ((MakePeaceDecisionOutcome)o).ShouldPeaceBeDeclared;
		}

		internal static object AutoGeneratedGetMemberValueKingdom(object o)
		{
			return ((MakePeaceDecisionOutcome)o).Kingdom;
		}

		internal static object AutoGeneratedGetMemberValueFactionToMakePeaceWith(object o)
		{
			return ((MakePeaceDecisionOutcome)o).FactionToMakePeaceWith;
		}

		public MakePeaceDecisionOutcome(bool shouldPeaceBeDeclared, Kingdom kingdom, IFaction factionToMakePeaceWith)
		{
			ShouldPeaceBeDeclared = shouldPeaceBeDeclared;
			Kingdom = kingdom;
			FactionToMakePeaceWith = factionToMakePeaceWith;
		}

		public override TextObject GetDecisionTitle()
		{
			TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}");
			textObject.SetTextVariable("SUPPORT", ShouldPeaceBeDeclared ? 1 : 0);
			return textObject;
		}

		public override TextObject GetDecisionDescription()
		{
			if (base.SponsorClan != null && Kingdom != null && FactionToMakePeaceWith != null && base.SponsorClan != Clan.PlayerClan)
			{
				TextObject reason = TextObject.GetEmpty();
				if (ShouldPeaceBeDeclared)
				{
					Campaign.Current.Models.DiplomacyModel.GetScoreOfDeclaringPeaceForClan(Kingdom, FactionToMakePeaceWith, base.SponsorClan, out reason, includeReason: true);
				}
				if (reason != null && !reason.IsEmpty())
				{
					return reason;
				}
			}
			if (ShouldPeaceBeDeclared)
			{
				return new TextObject("{=THz06NQD}It is time to make peace");
			}
			return new TextObject("{=jQpeuHIE}We oppose making peace at this time");
		}

		public override string GetDecisionLink()
		{
			return null;
		}

		public override ImageIdentifier GetDecisionImageIdentifier()
		{
			return null;
		}
	}

	[SaveableField(101)]
	public readonly IFaction FactionToMakePeaceWith;

	[SaveableField(103)]
	private readonly bool _applyResults;

	[SaveableField(110)]
	public readonly int DailyTributeToBePaid;

	[SaveableField(111)]
	public readonly int DailyTributeDurationInDays;

	[SaveableField(104)]
	private readonly bool _isProposedByOpponent;

	internal static void AutoGeneratedStaticCollectObjectsMakePeaceKingdomDecision(object o, List<object> collectedObjects)
	{
		((MakePeaceKingdomDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(FactionToMakePeaceWith);
	}

	internal static object AutoGeneratedGetMemberValueFactionToMakePeaceWith(object o)
	{
		return ((MakePeaceKingdomDecision)o).FactionToMakePeaceWith;
	}

	internal static object AutoGeneratedGetMemberValueDailyTributeToBePaid(object o)
	{
		return ((MakePeaceKingdomDecision)o).DailyTributeToBePaid;
	}

	internal static object AutoGeneratedGetMemberValueDailyTributeDurationInDays(object o)
	{
		return ((MakePeaceKingdomDecision)o).DailyTributeDurationInDays;
	}

	internal static object AutoGeneratedGetMemberValue_applyResults(object o)
	{
		return ((MakePeaceKingdomDecision)o)._applyResults;
	}

	internal static object AutoGeneratedGetMemberValue_isProposedByOpponent(object o)
	{
		return ((MakePeaceKingdomDecision)o)._isProposedByOpponent;
	}

	public MakePeaceKingdomDecision(Clan proposerClan, IFaction kingdomToMakePeaceWith, int dailyTributeToBePaid = 0, int dailyTributeDurationInDays = 0, bool applyResults = true, bool isProposedByOpponent = false)
		: base(proposerClan)
	{
		FactionToMakePeaceWith = kingdomToMakePeaceWith;
		DailyTributeToBePaid = dailyTributeToBePaid;
		DailyTributeDurationInDays = dailyTributeDurationInDays;
		_applyResults = applyResults;
		_isProposedByOpponent = isProposedByOpponent;
	}

	public override bool IsAllowed()
	{
		TextObject reason;
		return Campaign.Current.Models.KingdomDecisionPermissionModel.IsPeaceDecisionAllowedBetweenKingdoms(base.Kingdom, FactionToMakePeaceWith as Kingdom, out reason);
	}

	public override int GetProposalInfluenceCost()
	{
		return Campaign.Current.Models.DiplomacyModel.GetInfluenceCostOfProposingPeace(base.ProposerClan);
	}

	public override TextObject GetGeneralTitle()
	{
		TextObject textObject = new TextObject("{=v3xdiFfD}Make Peace With {KINGDOM_NAME}");
		textObject.SetTextVariable("KINGDOM_NAME", FactionToMakePeaceWith.Name);
		return textObject;
	}

	public override TextObject GetSupportTitle()
	{
		TextObject textObject = ((DailyTributeToBePaid == 0) ? new TextObject("{=0aXG8dvJ}Make peace with the {KINGDOM_NAME}. No tribute will be paid.") : ((DailyTributeToBePaid <= 0) ? new TextObject("{=NjPMRWbW}Make peace with the {KINGDOM_NAME}. Our kingdom will receive {TRIBUTE_AMOUNT} tribute daily for {TRIBUTE_DURATION} days.") : new TextObject("{=2b1xZGaQ}Make peace with the {KINGDOM_NAME}. Our kingdom will pay {TRIBUTE_AMOUNT} tribute daily for {TRIBUTE_DURATION} days.")));
		textObject.SetTextVariable("TRIBUTE_AMOUNT", MathF.Abs(DailyTributeToBePaid));
		textObject.SetTextVariable("TRIBUTE_DURATION", MathF.Abs(DailyTributeDurationInDays));
		textObject.SetTextVariable("KINGDOM_NAME", FactionToMakePeaceWith.InformalName);
		return textObject;
	}

	public override TextObject GetChooseTitle()
	{
		TextObject textObject = new TextObject("{=4GgfFDWG}Making peace with the {KINGDOM_NAME}");
		textObject.SetTextVariable("KINGDOM_NAME", FactionToMakePeaceWith.InformalName);
		return textObject;
	}

	public override TextObject GetSupportDescription()
	{
		TextObject textObject;
		if (DailyTributeToBePaid != 0)
		{
			textObject = new TextObject("{=BlVjIlZF}{FACTION_LEADER} will decide if the {KINGDOM_CONSIDERING_PEACE_NAME} will make peace with the {KINGDOM_NAME} by paying {TRIBUTE_AMOUNT} as tribute for {TRIBUTE_DURATION} days. You can pick your stance regarding this decision.");
			textObject.SetTextVariable("TRIBUTE_AMOUNT", DailyTributeToBePaid);
			textObject.SetTextVariable("TRIBUTE_DURATION", MathF.Abs(DailyTributeDurationInDays));
		}
		else
		{
			textObject = new TextObject("{=awoeb3br}{FACTION_LEADER} will decide if the {KINGDOM_CONSIDERING_PEACE_NAME} will make peace with the {KINGDOM_NAME}. You can pick your stance regarding this decision.");
		}
		textObject.SetTextVariable("FACTION_LEADER", DetermineChooser().Leader.Name);
		textObject.SetTextVariable("KINGDOM_NAME", FactionToMakePeaceWith.InformalName);
		textObject.SetTextVariable("KINGDOM_CONSIDERING_PEACE_NAME", base.Kingdom.InformalName);
		return textObject;
	}

	public override TextObject GetChooseDescription()
	{
		TextObject textObject;
		if (DailyTributeToBePaid != 0)
		{
			textObject = new TextObject("{=n4I3pWOn}As the ruler, you must decide if peace will be made with the {KINGDOM_NAME} by paying {TRIBUTE_AMOUNT} as tribute for {TRIBUTE_DURATION} days.");
			textObject.SetTextVariable("TRIBUTE_AMOUNT", DailyTributeToBePaid);
			textObject.SetTextVariable("TRIBUTE_DURATION", MathF.Abs(DailyTributeDurationInDays));
		}
		else
		{
			textObject = new TextObject("{=KFHj7ckm}As the ruler, you must decide if peace will be made with the {KINGDOM_NAME}");
		}
		textObject.SetTextVariable("IS_FEMALE", DetermineChooser().Leader.IsFemale ? 1 : 0);
		textObject.SetTextVariable("KINGDOM_NAME", FactionToMakePeaceWith.InformalName);
		return textObject;
	}

	public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
	{
		yield return new MakePeaceDecisionOutcome(shouldPeaceBeDeclared: true, base.Kingdom, FactionToMakePeaceWith);
		yield return new MakePeaceDecisionOutcome(shouldPeaceBeDeclared: false, base.Kingdom, FactionToMakePeaceWith);
	}

	public override Clan DetermineChooser()
	{
		return base.Kingdom.RulingClan;
	}

	protected override bool ShouldBeCancelledInternal()
	{
		if (!FactionToMakePeaceWith.IsEliminated)
		{
			return !base.Kingdom.IsAtWarWith(FactionToMakePeaceWith);
		}
		return true;
	}

	public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		foreach (DecisionOutcome possibleOutcome in possibleOutcomes)
		{
			if (((MakePeaceDecisionOutcome)possibleOutcome).ShouldPeaceBeDeclared)
			{
				possibleOutcome.SetSponsor(base.ProposerClan);
			}
			else
			{
				AssignDefaultSponsor(possibleOutcome);
			}
		}
	}

	public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
	{
		if (_applyResults && ((MakePeaceDecisionOutcome)chosenOutcome).ShouldPeaceBeDeclared)
		{
			MakePeaceAction.ApplyByKingdomDecision(base.Kingdom, FactionToMakePeaceWith, DailyTributeToBePaid, DailyTributeDurationInDays);
		}
	}

	public override bool OnShowDecision()
	{
		if (FactionToMakePeaceWith == Clan.PlayerClan.Kingdom && !Hero.MainHero.Clan.IsUnderMercenaryService)
		{
			TextObject textObject = new TextObject("{=1V8f9vRM}A courier bearing a peace offer from the {PROPOSER_HERO_FACTION} has arrived at the court of your realm.");
			textObject.SetTextVariable("PROPOSER_HERO_FACTION", base.ProposerClan.Leader.MapFaction.InformalName);
			Campaign.Current.CampaignInformationManager.NewMapNoticeAdded(new PeaceOfferMapNotification(base.ProposerClan.MapFaction, DailyTributeToBePaid, DailyTributeDurationInDays, textObject));
			return false;
		}
		return true;
	}

	public override TextObject GetSecondaryEffects()
	{
		return new TextObject("{=!}All supporters gains some relation with each other.");
	}

	public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
	{
		_ = _applyResults;
	}

	public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, SupportStatus supportStatus, bool isShortVersion = false)
	{
		TextObject textObject = (((MakePeaceDecisionOutcome)chosenOutcome).ShouldPeaceBeDeclared ? (IsSingleClanDecision() ? new TextObject("{=CswzBb02}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=17A2DDgD}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM} with the support of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=JDfnPFsW}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM} despite the opposition of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=aEt1kqxm}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM}, with his {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council evenly divided on the matter."), 
		})) : (IsSingleClanDecision() ? new TextObject("{=wsDNxArW}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=mRrYn2qm}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM} with the support of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=Ing5gFbO}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM} over the objections of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=AThZtg7U}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided against making peace with the {KINGDOM}, with his {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council evenly divided on the matter."), 
		})));
		StringHelpers.SetCharacterProperties("PEACEMAKER_RULER", base.Kingdom.Leader.CharacterObject, textObject);
		textObject.SetTextVariable("KINGDOM_CONSIDERING_PEACE", base.Kingdom.InformalName);
		textObject.SetTextVariable("KINGDOM", FactionToMakePeaceWith.InformalName);
		return textObject;
	}

	public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((MakePeaceDecisionOutcome)t).ShouldPeaceBeDeclared);
	}

	public float CalculateSupport(Clan clan)
	{
		return DetermineSupport(clan, new MakePeaceDecisionOutcome(shouldPeaceBeDeclared: true, base.Kingdom, FactionToMakePeaceWith));
	}

	public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
	{
		MakePeaceDecisionOutcome makePeaceDecisionOutcome = (MakePeaceDecisionOutcome)possibleOutcome;
		if (!Campaign.Current.Models.DiplomacyModel.IsPeaceSuitable(base.Kingdom, FactionToMakePeaceWith) && !_isProposedByOpponent)
		{
			if (makePeaceDecisionOutcome.ShouldPeaceBeDeclared)
			{
				return 0f;
			}
			return 200f;
		}
		if (clan == base.Kingdom.RulingClan && Clan.PlayerClan.MapFaction == base.Kingdom && _isProposedByOpponent)
		{
			if (!makePeaceDecisionOutcome.ShouldPeaceBeDeclared)
			{
				return 0f;
			}
			return 200f;
		}
		TextObject reason;
		float scoreOfDeclaringPeaceForClan = Campaign.Current.Models.DiplomacyModel.GetScoreOfDeclaringPeaceForClan(base.Kingdom, FactionToMakePeaceWith, clan, out reason);
		float scoreOfDeclaringPeace = Campaign.Current.Models.DiplomacyModel.GetScoreOfDeclaringPeace(base.Kingdom, FactionToMakePeaceWith);
		float decisionMakingThreshold = Campaign.Current.Models.DiplomacyModel.GetDecisionMakingThreshold(base.Kingdom);
		scoreOfDeclaringPeace *= ((scoreOfDeclaringPeace > 0f) ? 0.95f : 1.05f);
		if (makePeaceDecisionOutcome.ShouldPeaceBeDeclared && (DailyTributeToBePaid < 0 || scoreOfDeclaringPeace > decisionMakingThreshold) && scoreOfDeclaringPeaceForClan > scoreOfDeclaringPeace)
		{
			return 200f;
		}
		if (!makePeaceDecisionOutcome.ShouldPeaceBeDeclared && ((DailyTributeToBePaid >= 0 && scoreOfDeclaringPeace <= decisionMakingThreshold) || scoreOfDeclaringPeaceForClan <= scoreOfDeclaringPeace))
		{
			return 200f;
		}
		return 0f;
	}
}
