using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.CampaignBehaviors;
using TaleWorlds.Core;
using TaleWorlds.Core.ImageIdentifiers;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election;

public class TradeAgreementDecision : KingdomDecision
{
	public class TradeAgreementDecisionOutcome : DecisionOutcome
	{
		[SaveableField(100)]
		public readonly bool ShouldTradeAgreementStart;

		[SaveableField(110)]
		public readonly Kingdom Kingdom1;

		[SaveableField(120)]
		public readonly Kingdom Kingdom2;

		internal static void AutoGeneratedStaticCollectObjectsTradeAgreementDecisionOutcome(object o, List<object> collectedObjects)
		{
			((TradeAgreementDecisionOutcome)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(Kingdom1);
			collectedObjects.Add(Kingdom2);
		}

		internal static object AutoGeneratedGetMemberValueShouldTradeAgreementStart(object o)
		{
			return ((TradeAgreementDecisionOutcome)o).ShouldTradeAgreementStart;
		}

		internal static object AutoGeneratedGetMemberValueKingdom1(object o)
		{
			return ((TradeAgreementDecisionOutcome)o).Kingdom1;
		}

		internal static object AutoGeneratedGetMemberValueKingdom2(object o)
		{
			return ((TradeAgreementDecisionOutcome)o).Kingdom2;
		}

		public TradeAgreementDecisionOutcome(bool shouldStart, Kingdom kingdom1, Kingdom kingdom2)
		{
			Kingdom1 = kingdom1;
			Kingdom2 = kingdom2;
			ShouldTradeAgreementStart = shouldStart;
		}

		public override TextObject GetDecisionDescription()
		{
			TextObject empty = TextObject.GetEmpty();
			empty = ((!ShouldTradeAgreementStart) ? new TextObject("{=bSGB0vWb}We oppose a trade agreement with {KINGDOM}") : new TextObject("{=saHvdWSf}We support a trade agreement with {KINGDOM}"));
			empty.SetTextVariable("KINGDOM", Kingdom2.Name);
			return empty;
		}

		public override ImageIdentifier GetDecisionImageIdentifier()
		{
			return null;
		}

		public override string GetDecisionLink()
		{
			return null;
		}

		public override TextObject GetDecisionTitle()
		{
			TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}");
			textObject.SetTextVariable("SUPPORT", ShouldTradeAgreementStart ? 1 : 0);
			return textObject;
		}
	}

	[SaveableField(0)]
	public readonly Kingdom TargetKingdom;

	private ITradeAgreementsCampaignBehavior _tradeAgreementsCampaignBehavior;

	internal static void AutoGeneratedStaticCollectObjectsTradeAgreementDecision(object o, List<object> collectedObjects)
	{
		((TradeAgreementDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(TargetKingdom);
	}

	internal static object AutoGeneratedGetMemberValueTargetKingdom(object o)
	{
		return ((TradeAgreementDecision)o).TargetKingdom;
	}

	public TradeAgreementDecision(Clan proposerClan, Kingdom targetKingdom)
		: base(proposerClan)
	{
		TargetKingdom = targetKingdom;
		_tradeAgreementsCampaignBehavior = Campaign.Current.GetCampaignBehavior<ITradeAgreementsCampaignBehavior>();
	}

	public override bool OnShowDecision()
	{
		if (TargetKingdom == Clan.PlayerClan.Kingdom && !Hero.MainHero.Clan.IsUnderMercenaryService)
		{
			_tradeAgreementsCampaignBehavior.OnTradeAgreementOfferedToPlayer(base.Kingdom);
			return false;
		}
		return true;
	}

	public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
	{
		if (((TradeAgreementDecisionOutcome)chosenOutcome).ShouldTradeAgreementStart)
		{
			Campaign.Current.GetCampaignBehavior<ITradeAgreementsCampaignBehavior>()?.MakeTradeAgreement(base.Kingdom, TargetKingdom, Campaign.Current.Models.TradeAgreementModel.GetTradeAgreementDurationInYears(base.Kingdom, TargetKingdom));
		}
	}

	public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
	{
	}

	public static Clan GetProposerClanForPlayerKingdom(Kingdom target)
	{
		if (Clan.PlayerClan.Kingdom == null)
		{
			return null;
		}
		TextObject explanation;
		Clan clan = ((Clan.PlayerClan.Kingdom.RulingClan != Clan.PlayerClan && Campaign.Current.Models.TradeAgreementModel.GetScoreOfStartingTradeAgreement(Clan.PlayerClan.Kingdom, target, Clan.PlayerClan.Kingdom.RulingClan, out explanation) > 50f) ? Clan.PlayerClan.Kingdom.RulingClan : null);
		if (clan == null)
		{
			TextObject explanation2;
			List<Clan> list = Clan.PlayerClan.Kingdom.Clans.Where((Clan x) => !x.IsUnderMercenaryService && x != Clan.PlayerClan && Campaign.Current.Models.TradeAgreementModel.GetScoreOfStartingTradeAgreement(Clan.PlayerClan.Kingdom, target, x, out explanation2) > 50f).ToList();
			clan = ((list.Count <= 0) ? Clan.PlayerClan : TaleWorlds.Core.Extensions.MaxBy(list, (Clan x) => Campaign.Current.Models.TradeAgreementModel.GetScoreOfStartingTradeAgreement(Clan.PlayerClan.Kingdom, target, x, out explanation2)));
		}
		return clan;
	}

	public override Clan DetermineChooser()
	{
		return base.Kingdom.RulingClan;
	}

	protected override bool ShouldBeCancelledInternal()
	{
		TextObject reason;
		return !Campaign.Current.Models.TradeAgreementModel.CanMakeTradeAgreement(base.Kingdom, TargetKingdom, checkOtherSideTradeSupport: false, out reason);
	}

	public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
	{
		yield return new TradeAgreementDecisionOutcome(shouldStart: true, base.Kingdom, TargetKingdom);
		yield return new TradeAgreementDecisionOutcome(shouldStart: false, base.Kingdom, TargetKingdom);
	}

	public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		foreach (DecisionOutcome possibleOutcome in possibleOutcomes)
		{
			if (((TradeAgreementDecisionOutcome)possibleOutcome).ShouldTradeAgreementStart)
			{
				possibleOutcome.SetSponsor(base.ProposerClan);
			}
			else
			{
				AssignDefaultSponsor(possibleOutcome);
			}
		}
	}

	public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
	{
		TextObject explanation;
		float scoreOfStartingTradeAgreement = Campaign.Current.Models.TradeAgreementModel.GetScoreOfStartingTradeAgreement(base.Kingdom, TargetKingdom, clan, out explanation);
		if (((TradeAgreementDecisionOutcome)possibleOutcome).ShouldTradeAgreementStart)
		{
			return scoreOfStartingTradeAgreement;
		}
		return 100f - scoreOfStartingTradeAgreement;
	}

	public override TextObject GetChooseDescription()
	{
		TextObject textObject = new TextObject("{=O9XpB5Ah}As the ruler, you must decide if a trade agreement will be made with the {KINGDOM}");
		textObject.SetTextVariable("KINGDOM", TargetKingdom.Name);
		return textObject;
	}

	public override TextObject GetChooseTitle()
	{
		TextObject textObject = new TextObject("{=zXuo0Wbj}Signing a trade agreement with the {KINGDOM}");
		textObject.SetTextVariable("KINGDOM", TargetKingdom.InformalName);
		return textObject;
	}

	public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, SupportStatus supportStatus, bool isShortVersion = false)
	{
		TextObject textObject = (((TradeAgreementDecisionOutcome)chosenOutcome).ShouldTradeAgreementStart ? (IsSingleClanDecision() ? new TextObject("{=Gj5d9y2g}{RULER.NAME} of the {KINGDOM} has decided to sign a trade agreement with the {OTHER_KINGDOM}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=5DdbkWLu}{RULER.NAME} of the {KINGDOM} has decided to sign a trade agreement with the {OTHER_KINGDOM} with the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=1o8vgwTf}{RULER.NAME} of the {KINGDOM} has decided to sign a trade agreement with the {OTHER_KINGDOM} despite the opposition of {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=PP7KD7OC}{RULER.NAME} of the {KINGDOM} has decided to sign a trade agreement with the {OTHER_KINGDOM}, with his {?RULER.GENDER}her{?}his{\\?} council evenly divided on the matter."), 
		})) : (IsSingleClanDecision() ? new TextObject("{=UQq4ekeu}{RULER.NAME} of the {KINGDOM} has chosen not to sign a trade agreement with the {OTHER_KINGDOM}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=dCDBqYsh}{RULER.NAME} of the {KINGDOM} has chosen not to sign a trade agreement with the {OTHER_KINGDOM} with the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=rJIuQ0hc}{RULER.NAME} of the {KINGDOM} has chosen not to sign a trade agreement with the {OTHER_KINGDOM} over the objections of {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=xAuejv91}{RULER.NAME} of the {KINGDOM} has decided against making peace with the {OTHER_KINGDOM}, with his {?RULER.GENDER}her{?}his{\\?} council evenly divided on the matter."), 
		})));
		StringHelpers.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject, textObject);
		textObject.SetTextVariable("KINGDOM", base.Kingdom.Name);
		textObject.SetTextVariable("OTHER_KINGDOM", TargetKingdom.Name);
		return textObject;
	}

	public override TextObject GetGeneralTitle()
	{
		TextObject textObject = new TextObject("{=CWMNTvSb}Trade Agreement with {KINGDOM}");
		textObject.SetTextVariable("KINGDOM", TargetKingdom.Name);
		return textObject;
	}

	public override int GetProposalInfluenceCost()
	{
		return Campaign.Current.Models.TradeAgreementModel.GetInfluenceCostOfProposingTradeAgreement(base.ProposerClan);
	}

	public override bool CanMakeDecision(out TextObject reason)
	{
		return Campaign.Current.Models.TradeAgreementModel.CanMakeTradeAgreement(base.Kingdom, TargetKingdom, checkOtherSideTradeSupport: true, out reason);
	}

	public float CalculateSupport(Clan clan)
	{
		return DetermineSupport(clan, new TradeAgreementDecisionOutcome(shouldStart: true, base.Kingdom, TargetKingdom));
	}

	public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((TradeAgreementDecisionOutcome)t).ShouldTradeAgreementStart);
	}

	public override TextObject GetSecondaryEffects()
	{
		return TextObject.GetEmpty();
	}

	public override TextObject GetSupportDescription()
	{
		TextObject textObject = new TextObject("{=Vg5RmOqL}{FACTION_LEADER} will decide if the {KINGDOM} will sign a trade agreement with the {OTHER_KINGDOM}. You can pick your stance regarding this decision.");
		textObject.SetTextVariable("FACTION_LEADER", DetermineChooser().Leader.Name);
		textObject.SetTextVariable("OTHER_KINGDOM", TargetKingdom.Name);
		textObject.SetTextVariable("KINGDOM", base.Kingdom.Name);
		return textObject;
	}

	public override TextObject GetSupportTitle()
	{
		TextObject textObject = new TextObject("{=LlTtwQpZ}Vote for signing a trade agreement with {KINGDOM}");
		textObject.SetTextVariable("KINGDOM", TargetKingdom.Name);
		return textObject;
	}

	public override bool IsAllowed()
	{
		return !base.Kingdom.IsAtWarWith(TargetKingdom);
	}
}
