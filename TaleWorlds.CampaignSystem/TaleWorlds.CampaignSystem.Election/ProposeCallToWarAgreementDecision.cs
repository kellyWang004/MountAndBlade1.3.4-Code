using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.CampaignBehaviors;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.Core;
using TaleWorlds.Core.ImageIdentifiers;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election;

public class ProposeCallToWarAgreementDecision : KingdomDecision
{
	public class ProposeCallToWarAgreementDecisionOutcome : DecisionOutcome
	{
		[SaveableField(100)]
		public readonly bool ShouldCallToWar;

		[SaveableField(110)]
		public readonly Kingdom Kingdom;

		[SaveableField(120)]
		public readonly Kingdom CalledKingdom;

		[SaveableField(130)]
		public readonly Kingdom KingdomToCallToWarAgainst;

		public ProposeCallToWarAgreementDecisionOutcome(bool shouldCallToWar, Kingdom kingdom, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
		{
			ShouldCallToWar = shouldCallToWar;
			Kingdom = kingdom;
			CalledKingdom = calledKingdom;
			KingdomToCallToWarAgainst = kingdomToCallToWarAgainst;
		}

		public override TextObject GetDecisionTitle()
		{
			TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}");
			textObject.SetTextVariable("SUPPORT", ShouldCallToWar ? 1 : 0);
			return textObject;
		}

		public override TextObject GetDecisionDescription()
		{
			if (base.SponsorClan != null && Kingdom != null && CalledKingdom != null && KingdomToCallToWarAgainst != null && base.SponsorClan != Clan.PlayerClan)
			{
				TextObject reason = TextObject.GetEmpty();
				if (ShouldCallToWar)
				{
					Campaign.Current.Models.AllianceModel.GetScoreOfCallingToWar(Kingdom, CalledKingdom, KingdomToCallToWarAgainst, base.SponsorClan, out reason);
				}
				if (!reason.IsEmpty())
				{
					return reason;
				}
			}
			if (ShouldCallToWar)
			{
				TextObject textObject = new TextObject("{=dEsIQDo3}It is time to call our ally the {CALLED_KINGDOM} to war!");
				textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
				return textObject;
			}
			TextObject textObject2 = new TextObject("{=XbYCVCbR}We oppose calling our ally the {CALLED_KINGDOM} to war.");
			textObject2.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
			return textObject2;
		}

		public override string GetDecisionLink()
		{
			return null;
		}

		public override ImageIdentifier GetDecisionImageIdentifier()
		{
			return null;
		}
	}

	[SaveableField(101)]
	public readonly Kingdom CalledKingdom;

	[SaveableField(102)]
	public readonly Kingdom KingdomToCallToWarAgainst;

	[SaveableField(103)]
	public readonly int CallToWarCost;

	private IAllianceCampaignBehavior _allianceCampaignBehavior;

	public IAllianceCampaignBehavior AllianceCampaignBehavior
	{
		get
		{
			if (_allianceCampaignBehavior == null)
			{
				_allianceCampaignBehavior = Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>();
			}
			return _allianceCampaignBehavior;
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsProposeCallToWarAgreementDecision(object o, List<object> collectedObjects)
	{
		((ProposeCallToWarAgreementDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(CalledKingdom);
		collectedObjects.Add(KingdomToCallToWarAgainst);
	}

	internal static object AutoGeneratedGetMemberValueCalledKingdom(object o)
	{
		return ((ProposeCallToWarAgreementDecision)o).CalledKingdom;
	}

	internal static object AutoGeneratedGetMemberValueKingdomToCallToWarAgainst(object o)
	{
		return ((ProposeCallToWarAgreementDecision)o).KingdomToCallToWarAgainst;
	}

	internal static object AutoGeneratedGetMemberValueCallToWarCost(object o)
	{
		return ((ProposeCallToWarAgreementDecision)o).CallToWarCost;
	}

	public ProposeCallToWarAgreementDecision(Clan proposerClan, Kingdom calledKingdom, Kingdom kingdomToCallToWarAgainst)
		: base(proposerClan)
	{
		CalledKingdom = calledKingdom;
		KingdomToCallToWarAgainst = kingdomToCallToWarAgainst;
		CallToWarCost = Campaign.Current.Models.AllianceModel.GetCallToWarCost(proposerClan.Kingdom, calledKingdom, kingdomToCallToWarAgainst);
	}

	public override bool IsAllowed()
	{
		if (CalledKingdom.IsAllyWith(base.Kingdom) && base.Kingdom.IsAtWarWith(KingdomToCallToWarAgainst))
		{
			return !CalledKingdom.IsAtWarWith(KingdomToCallToWarAgainst);
		}
		return false;
	}

	public override int GetProposalInfluenceCost()
	{
		return Campaign.Current.Models.AllianceModel.GetInfluenceCostOfCallingToWar(base.ProposerClan);
	}

	public override TextObject GetGeneralTitle()
	{
		TextObject textObject = new TextObject("{=0CsbbwtN}Call the {CALLED_KINGDOM} to War Against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}");
		textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		return textObject;
	}

	public override TextObject GetSupportTitle()
	{
		TextObject textObject = new TextObject("{=qN3x2usk}Vote on whether to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}.");
		textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_COST", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetChooseTitle()
	{
		TextObject textObject = new TextObject("{=EqevKYZD}As {RULER_NAME_AND_TITLE}, you must decide if the {CALLED_KINGDOM} will be called to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}");
		textObject.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject);
		textObject.SetTextVariable("RULER_NAME_AND_TITLE", GameTexts.FindText("str_faction_ruler_name_with_title", base.Kingdom.Culture.StringId));
		textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_COST", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetSupportDescription()
	{
		TextObject textObject = new TextObject("{=r0Kq0aeB}{FACTION_LEADER} will decide if the {CALLED_KINGDOM} will be called to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}. You can pick your stance on this decision..");
		textObject.SetTextVariable("FACTION_LEADER", DetermineChooser().Leader.Name);
		textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_COST", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetChooseDescription()
	{
		TextObject textObject = new TextObject("{=AwCnrOan}As {RULER_NAME_AND_TITLE}, you must decide if the {CALLED_KINGDOM} will be called to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_COST}{GOLD_ICON}.");
		textObject.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject);
		textObject.SetTextVariable("RULER_NAME_AND_TITLE", GameTexts.FindText("str_faction_ruler_name_with_title", base.Kingdom.Culture.StringId));
		textObject.SetTextVariable("KINGDOM_NAME", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_COST", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
	{
		yield return new ProposeCallToWarAgreementDecisionOutcome(shouldCallToWar: true, base.Kingdom, CalledKingdom, KingdomToCallToWarAgainst);
		yield return new ProposeCallToWarAgreementDecisionOutcome(shouldCallToWar: false, base.Kingdom, CalledKingdom, KingdomToCallToWarAgainst);
	}

	public override Clan DetermineChooser()
	{
		return base.Kingdom.RulingClan;
	}

	protected override bool ShouldBeCancelledInternal()
	{
		if (!base.Kingdom.IsEliminated && !CalledKingdom.IsEliminated && !KingdomToCallToWarAgainst.IsEliminated && !base.Kingdom.IsAtWarWith(CalledKingdom))
		{
			return CalledKingdom.IsAtWarWith(KingdomToCallToWarAgainst);
		}
		return true;
	}

	public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		foreach (DecisionOutcome possibleOutcome in possibleOutcomes)
		{
			if (((ProposeCallToWarAgreementDecisionOutcome)possibleOutcome).ShouldCallToWar)
			{
				possibleOutcome.SetSponsor(base.ProposerClan);
			}
			else
			{
				AssignDefaultSponsor(possibleOutcome);
			}
		}
	}

	public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
	{
		if (((ProposeCallToWarAgreementDecisionOutcome)chosenOutcome).ShouldCallToWar)
		{
			AllianceCampaignBehavior.StartCallToWarAgreement(base.Kingdom, CalledKingdom, KingdomToCallToWarAgainst, CallToWarCost);
		}
	}

	public override bool OnShowDecision()
	{
		if (CalledKingdom == Clan.PlayerClan.Kingdom && !Hero.MainHero.Clan.IsUnderMercenaryService)
		{
			AllianceCampaignBehavior.OnCallToWarAgreementProposedToPlayerKingdom(base.Kingdom, KingdomToCallToWarAgainst);
			return false;
		}
		return true;
	}

	public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
	{
	}

	public override TextObject GetSecondaryEffects()
	{
		return new TextObject("{=!}All supporters gains some relation with each other.");
	}

	public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, SupportStatus supportStatus, bool isShortVersion = false)
	{
		TextObject textObject = (((ProposeCallToWarAgreementDecisionOutcome)chosenOutcome).ShouldCallToWar ? (IsSingleClanDecision() ? new TextObject("{=xhK4zMec}{RULER.NAME} has decided to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=eEmFbQet}{RULER.NAME} has decided to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=AGdmoIUc}{RULER.NAME} has decided to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision went against the advice of {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=5pOKmHsf}{RULER.NAME} has decided to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of half of {?RULER.GENDER}her{?}his{\\?} council."), 
		})) : (IsSingleClanDecision() ? new TextObject("{=gf2Lje7o}{RULER.NAME} has decided not to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=bMCZ5rWQ}{RULER.NAME} has decided not to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=MYIgSsfk}{RULER.NAME} has decided not to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision went against the advice of {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=AWm7Kb9Y}{RULER.NAME} has decided not to call the {CALLED_KINGDOM} to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of half of {?RULER.GENDER}her{?}his{\\?} council."), 
		})));
		StringHelpers.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject, textObject);
		textObject.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		return textObject;
	}

	public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((ProposeCallToWarAgreementDecisionOutcome)t).ShouldCallToWar);
	}

	public float CalculateSupport(Clan clan)
	{
		return DetermineSupport(clan, new ProposeCallToWarAgreementDecisionOutcome(shouldCallToWar: true, base.Kingdom, CalledKingdom, KingdomToCallToWarAgainst));
	}

	public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
	{
		ProposeCallToWarAgreementDecisionOutcome obj = (ProposeCallToWarAgreementDecisionOutcome)possibleOutcome;
		TextObject reason;
		float scoreOfCallingToWar = Campaign.Current.Models.AllianceModel.GetScoreOfCallingToWar(base.Kingdom, CalledKingdom, KingdomToCallToWarAgainst, clan, out reason);
		if (obj.ShouldCallToWar)
		{
			float num = 0f - (float)clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 2.5f + (float)clan.Leader.GetTraitLevel(DefaultTraits.Calculating) * 2.5f;
			return scoreOfCallingToWar + num;
		}
		float num2 = 0f - scoreOfCallingToWar;
		float num3 = (float)clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 2.5f - (float)clan.Leader.GetTraitLevel(DefaultTraits.Calculating) * 2.5f;
		return num2 + num3;
	}

	public override bool CanMakeDecision(out TextObject reason)
	{
		if (CalledKingdom.IsEliminated || base.Kingdom.IsEliminated || KingdomToCallToWarAgainst.IsEliminated)
		{
			reason = new TextObject("{=a5EAl1aW}That realm has been eliminated.");
			return false;
		}
		if (KingdomToCallToWarAgainst.IsAtWarWith(CalledKingdom))
		{
			reason = new TextObject("{=NFuezpbG}The {CALLED_KINGDOM} are at war with the {KINGDOM_NAME} already.");
			reason.SetTextVariable("CALLED_KINGDOM", CalledKingdom.InformalName);
			reason.SetTextVariable("KINGDOM_NAME", KingdomToCallToWarAgainst.InformalName);
			return false;
		}
		if (!KingdomToCallToWarAgainst.IsAtWarWith(base.Kingdom))
		{
			reason = new TextObject("{=Xm5ebxcP}Your realm is not at war with {KINGDOM_TO_CALL_TO_WAR_AGAINST} anymore.");
			reason.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.Name);
			return false;
		}
		if (!base.Kingdom.IsAllyWith(CalledKingdom))
		{
			reason = new TextObject("{=hz30Xfqh}Your realm is not an ally with {KINGDOM_NAME} anymore.");
			reason.SetTextVariable("KINGDOM_NAME", CalledKingdom.Name);
			return false;
		}
		reason = TextObject.GetEmpty();
		return true;
	}
}
