using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.CampaignBehaviors;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.Core;
using TaleWorlds.Core.ImageIdentifiers;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election;

public class AcceptCallToWarAgreementDecision : KingdomDecision
{
	public class AcceptCallToWarAgreementDecisionOutcome : DecisionOutcome
	{
		[SaveableField(100)]
		public readonly bool ShouldAcceptCallToWar;

		[SaveableField(101)]
		public readonly Kingdom Kingdom;

		[SaveableField(102)]
		public readonly Kingdom CallingKingdom;

		[SaveableField(103)]
		public readonly Kingdom KingdomToCallToWarAgainst;

		public AcceptCallToWarAgreementDecisionOutcome(bool shouldAcceptCallToWar, Kingdom kingdom, Kingdom callingKingdom, Kingdom kingdomToCallToWarAgainst)
		{
			ShouldAcceptCallToWar = shouldAcceptCallToWar;
			Kingdom = kingdom;
			CallingKingdom = callingKingdom;
			KingdomToCallToWarAgainst = kingdomToCallToWarAgainst;
		}

		public override TextObject GetDecisionTitle()
		{
			TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}");
			textObject.SetTextVariable("SUPPORT", ShouldAcceptCallToWar ? 1 : 0);
			return textObject;
		}

		public override TextObject GetDecisionDescription()
		{
			if (base.SponsorClan != null && Kingdom != null && CallingKingdom != null && KingdomToCallToWarAgainst != null && base.SponsorClan != Clan.PlayerClan)
			{
				TextObject reason = TextObject.GetEmpty();
				if (ShouldAcceptCallToWar)
				{
					Campaign.Current.Models.AllianceModel.GetScoreOfJoiningWar(Kingdom, CallingKingdom, KingdomToCallToWarAgainst, base.SponsorClan, out reason);
				}
				if (!reason.IsEmpty())
				{
					return reason;
				}
			}
			if (ShouldAcceptCallToWar)
			{
				TextObject textObject = new TextObject("{=h9bWTLgK}It is time to join our allies, the {KINGDOM_NAME}, in their war.");
				textObject.SetTextVariable("KINGDOM_NAME", CallingKingdom.Name);
				return textObject;
			}
			TextObject textObject2 = new TextObject("{=q9DnHVcZ}It is not in our interests to join the {KINGDOM_NAME} in their war.");
			textObject2.SetTextVariable("KINGDOM_NAME", CallingKingdom.Name);
			return textObject2;
		}

		public override string GetDecisionLink()
		{
			return null;
		}

		public override ImageIdentifier GetDecisionImageIdentifier()
		{
			return null;
		}
	}

	[SaveableField(101)]
	public readonly Kingdom CallingKingdom;

	[SaveableField(102)]
	public readonly Kingdom KingdomToCallToWarAgainst;

	[SaveableField(103)]
	public readonly int CallToWarCost;

	private IAllianceCampaignBehavior _allianceCampaignBehavior;

	public IAllianceCampaignBehavior AllianceCampaignBehavior
	{
		get
		{
			if (_allianceCampaignBehavior == null)
			{
				_allianceCampaignBehavior = Campaign.Current.GetCampaignBehavior<IAllianceCampaignBehavior>();
			}
			return _allianceCampaignBehavior;
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsAcceptCallToWarAgreementDecision(object o, List<object> collectedObjects)
	{
		((AcceptCallToWarAgreementDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(CallingKingdom);
		collectedObjects.Add(KingdomToCallToWarAgainst);
	}

	internal static object AutoGeneratedGetMemberValueCallingKingdom(object o)
	{
		return ((AcceptCallToWarAgreementDecision)o).CallingKingdom;
	}

	internal static object AutoGeneratedGetMemberValueKingdomToCallToWarAgainst(object o)
	{
		return ((AcceptCallToWarAgreementDecision)o).KingdomToCallToWarAgainst;
	}

	internal static object AutoGeneratedGetMemberValueCallToWarCost(object o)
	{
		return ((AcceptCallToWarAgreementDecision)o).CallToWarCost;
	}

	public AcceptCallToWarAgreementDecision(Clan proposerClan, Kingdom callingKingdom, Kingdom kingdomToCallToWarAgainst)
		: base(proposerClan)
	{
		CallingKingdom = callingKingdom;
		KingdomToCallToWarAgainst = kingdomToCallToWarAgainst;
		CallToWarCost = Campaign.Current.Models.AllianceModel.GetCallToWarCost(callingKingdom, proposerClan.Kingdom, kingdomToCallToWarAgainst);
	}

	public override bool IsAllowed()
	{
		if (CallingKingdom.IsAllyWith(base.Kingdom) && !base.Kingdom.IsAtWarWith(KingdomToCallToWarAgainst))
		{
			return CallingKingdom.IsAtWarWith(KingdomToCallToWarAgainst);
		}
		return false;
	}

	public override int GetProposalInfluenceCost()
	{
		return Campaign.Current.Models.AllianceModel.GetInfluenceCostOfCallingToWar(base.ProposerClan);
	}

	public override TextObject GetGeneralTitle()
	{
		TextObject textObject = new TextObject("{=syGyjjKE}Answer the call of the {CALLING_KINGDOM}, and declare war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.");
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		return textObject;
	}

	public override TextObject GetSupportTitle()
	{
		TextObject textObject = new TextObject("{=eiGl6XBr}Vote on whether to answer the {CALLING_KINGDOM} call to war against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_PAYMENT}{GOLD_ICON}.");
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_PAYMENT", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetChooseTitle()
	{
		TextObject textObject = new TextObject("{=Cf0amFBD}Accepting the {CALLING_KINGDOM} Call to War Against the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_PAYMENT}{GOLD_ICON}");
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_PAYMENT", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetSupportDescription()
	{
		TextObject textObject = new TextObject("{=m69pvful}{KINGDOM_LEADER} will decide if your realm will answer the call of the {CALLING_KINGDOM} and declare war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_PAYMENT}{GOLD_ICON}. You can pick your stance regarding this decision.");
		textObject.SetTextVariable("KINGDOM_LEADER", DetermineChooser().Leader.Name);
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.InformalName);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_PAYMENT", CallToWarCost);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override TextObject GetChooseDescription()
	{
		TextObject textObject = new TextObject("{=oAw74q3r}As {RULER_NAME_AND_TITLE}, you must decide if your realm will answer the call of the {CALLING_KINGDOM} and declare war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} for {CALL_TO_WAR_PAYMENT}{GOLD_ICON}.");
		textObject.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject);
		textObject.SetTextVariable("RULER_NAME_AND_TITLE", GameTexts.FindText("str_faction_ruler_name_with_title", base.Kingdom.Culture.StringId));
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.InformalName);
		textObject.SetTextVariable("CALL_TO_WAR_PAYMENT", CallToWarCost);
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.Name);
		textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
		return textObject;
	}

	public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
	{
		yield return new AcceptCallToWarAgreementDecisionOutcome(shouldAcceptCallToWar: true, base.Kingdom, CallingKingdom, KingdomToCallToWarAgainst);
		yield return new AcceptCallToWarAgreementDecisionOutcome(shouldAcceptCallToWar: false, base.Kingdom, CallingKingdom, KingdomToCallToWarAgainst);
	}

	public override Clan DetermineChooser()
	{
		return base.Kingdom.RulingClan;
	}

	protected override bool ShouldBeCancelledInternal()
	{
		TextObject reason;
		return !CanMakeDecision(out reason);
	}

	public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		foreach (DecisionOutcome possibleOutcome in possibleOutcomes)
		{
			if (((AcceptCallToWarAgreementDecisionOutcome)possibleOutcome).ShouldAcceptCallToWar)
			{
				possibleOutcome.SetSponsor(base.ProposerClan);
			}
			else
			{
				AssignDefaultSponsor(possibleOutcome);
			}
		}
	}

	public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
	{
		if (((AcceptCallToWarAgreementDecisionOutcome)chosenOutcome).ShouldAcceptCallToWar)
		{
			AllianceCampaignBehavior.StartCallToWarAgreement(CallingKingdom, base.Kingdom, KingdomToCallToWarAgainst, CallToWarCost);
		}
	}

	public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
	{
	}

	public override TextObject GetSecondaryEffects()
	{
		return new TextObject("{=!}All supporters gains some relation with each other.");
	}

	public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, SupportStatus supportStatus, bool isShortVersion = false)
	{
		TextObject textObject = (((AcceptCallToWarAgreementDecisionOutcome)chosenOutcome).ShouldAcceptCallToWar ? (IsSingleClanDecision() ? new TextObject("{=vf2pb7Ts}{RULER.NAME} has answered the call of the {CALLING_KINGDOM} name and declared war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=ZZ1oLfEq}{RULER.NAME} has answered the call of the {CALLING_KINGDOM} name and declared war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} with the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=Lalj0T1i}{RULER.NAME} has answered the call of the {CALLING_KINGDOM} name and declared war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} despite opposition from {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=uiY3ds0Z}{RULER.NAME} has answered the call of the {CALLING_KINGDOM} name and declared war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST} with the support of half of {?RULER.GENDER}her{?}his{\\?} council."), 
		})) : (IsSingleClanDecision() ? new TextObject("{=Bk3Wqy5j}{RULER.NAME} has decided not to answer the call of the {CALLING_KINGDOM} name and will not war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}.") : (supportStatus switch
		{
			SupportStatus.Majority => new TextObject("{=fcuUcjYV}{RULER.NAME} has decided not to answer the call of the {CALLING_KINGDOM} name and will not war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of {?RULER.GENDER}her{?}his{\\?} council."), 
			SupportStatus.Minority => new TextObject("{=K5w135N9}{RULER.NAME} has decided not to answer the call of the {CALLING_KINGDOM} name and will not war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision was taken against the advice of {?RULER.GENDER}her{?}his{\\?} council."), 
			_ => new TextObject("{=Ouj6eSWC}{RULER.NAME} has decided not to answer the call of the {CALLING_KINGDOM} name and will not war on the {KINGDOM_TO_CALL_TO_WAR_AGAINST}. The decision had the support of half of {?RULER.GENDER}her{?}his{\\?} council."), 
		})));
		StringHelpers.SetCharacterProperties("RULER", base.Kingdom.Leader.CharacterObject, textObject);
		textObject.SetTextVariable("CALLING_KINGDOM", CallingKingdom.Name);
		textObject.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.Name);
		return textObject;
	}

	public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
	{
		return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((AcceptCallToWarAgreementDecisionOutcome)t).ShouldAcceptCallToWar);
	}

	public float CalculateSupport(Clan clan)
	{
		return DetermineSupport(clan, new AcceptCallToWarAgreementDecisionOutcome(shouldAcceptCallToWar: true, base.Kingdom, CallingKingdom, KingdomToCallToWarAgainst));
	}

	public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
	{
		AcceptCallToWarAgreementDecisionOutcome obj = (AcceptCallToWarAgreementDecisionOutcome)possibleOutcome;
		TextObject reason;
		float scoreOfJoiningWar = Campaign.Current.Models.AllianceModel.GetScoreOfJoiningWar(CallingKingdom, base.Kingdom, KingdomToCallToWarAgainst, clan, out reason);
		if (obj.ShouldAcceptCallToWar)
		{
			float num = (float)clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 2.5f + (float)clan.Leader.GetTraitLevel(DefaultTraits.Calculating) * 2.5f;
			return scoreOfJoiningWar + num;
		}
		float num2 = 0f - scoreOfJoiningWar;
		float num3 = 0f - (float)clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 2.5f - (float)clan.Leader.GetTraitLevel(DefaultTraits.Calculating) * 2.5f;
		return num2 + num3;
	}

	public override bool CanMakeDecision(out TextObject reason)
	{
		if (CallingKingdom.IsEliminated || base.Kingdom.IsEliminated || KingdomToCallToWarAgainst.IsEliminated)
		{
			reason = new TextObject("{=a5EAl1aW}That realm has been eliminated.");
			return false;
		}
		if (KingdomToCallToWarAgainst.IsAtWarWith(base.Kingdom))
		{
			reason = new TextObject("{=lseJ70y0}Your realm is at war with the {KINGDOM_NAME}.");
			reason.SetTextVariable("KINGDOM_NAME", KingdomToCallToWarAgainst.Name);
			return false;
		}
		if (!KingdomToCallToWarAgainst.IsAtWarWith(CallingKingdom))
		{
			reason = new TextObject("{=eUWYqwE6}The {CALLING_KINGDOM} is not at war with {KINGDOM_TO_CALL_TO_WAR_AGAINST} anymore.");
			reason.SetTextVariable("CALLING_KINGDOM", CallingKingdom.Name);
			reason.SetTextVariable("KINGDOM_TO_CALL_TO_WAR_AGAINST", KingdomToCallToWarAgainst.Name);
			return false;
		}
		if (!base.Kingdom.IsAllyWith(CallingKingdom))
		{
			reason = new TextObject("{=hz30Xfqh}Your realm is not ally with {KINGDOM_NAME} anymore.");
			reason.SetTextVariable("KINGDOM_NAME", CallingKingdom.Name);
			return false;
		}
		reason = TextObject.GetEmpty();
		return true;
	}
}
