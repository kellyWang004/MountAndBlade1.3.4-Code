using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Naval;

public class AnchorPoint : IInteractablePoint, ITrackableCampaignObject, ITrackableBase
{
	[SaveableField(4)]
	private CampaignVec2 _lastUsedDisembarkPosition;

	public MobileParty Owner { get; private set; }

	[SaveableProperty(1)]
	public CampaignVec2 Position { get; private set; }

	[SaveableProperty(2)]
	public CampaignVec2 TargetPosition { get; private set; }

	public bool IsMovingToPoint
	{
		get
		{
			if (ArrivalTime != CampaignTime.Zero)
			{
				return !ArrivalTime.IsPast;
			}
			return false;
		}
	}

	public bool IsReady => true;

	[SaveableProperty(3)]
	public CampaignTime ArrivalTime { get; private set; } = CampaignTime.Zero;

	[SaveableProperty(5)]
	public bool IsDisabled { get; set; }

	public bool IsValid => Position.IsValid();

	public TextObject Name
	{
		get
		{
			if (Owner.LeaderHero != null)
			{
				TextObject textObject = new TextObject("{=MTuvy9kd}{TROOP.NAME}{.o} Fleet");
				textObject.SetCharacterProperties("TROOP", Owner.LeaderHero.CharacterObject);
				return textObject;
			}
			return new TextObject("{=p6QNVu8p}Fleet");
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsAnchorPoint(object o, List<object> collectedObjects)
	{
		((AnchorPoint)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		CampaignVec2.AutoGeneratedStaticCollectObjectsCampaignVec2(_lastUsedDisembarkPosition, collectedObjects);
		CampaignVec2.AutoGeneratedStaticCollectObjectsCampaignVec2(Position, collectedObjects);
		CampaignVec2.AutoGeneratedStaticCollectObjectsCampaignVec2(TargetPosition, collectedObjects);
		CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(ArrivalTime, collectedObjects);
	}

	internal static object AutoGeneratedGetMemberValuePosition(object o)
	{
		return ((AnchorPoint)o).Position;
	}

	internal static object AutoGeneratedGetMemberValueTargetPosition(object o)
	{
		return ((AnchorPoint)o).TargetPosition;
	}

	internal static object AutoGeneratedGetMemberValueArrivalTime(object o)
	{
		return ((AnchorPoint)o).ArrivalTime;
	}

	internal static object AutoGeneratedGetMemberValueIsDisabled(object o)
	{
		return ((AnchorPoint)o).IsDisabled;
	}

	internal static object AutoGeneratedGetMemberValue_lastUsedDisembarkPosition(object o)
	{
		return ((AnchorPoint)o)._lastUsedDisembarkPosition;
	}

	public void CallFleet(Settlement settlement)
	{
		CampaignTime fleetTravelTimeToPoint = Campaign.Current.Models.PartyTransitionModel.GetFleetTravelTimeToPoint(Owner, settlement.PortPosition);
		if (fleetTravelTimeToPoint == CampaignTime.Zero)
		{
			SetSettlement(settlement);
			return;
		}
		ResetPosition();
		TargetPosition = settlement.PortPosition;
		ArrivalTime = CampaignTime.Now + fleetTravelTimeToPoint;
	}

	public AnchorPoint(MobileParty owner)
	{
		Owner = owner;
		Position = CampaignVec2.Invalid;
	}

	public AnchorPoint(AnchorPoint anchor)
	{
		Owner = anchor.Owner;
		Position = anchor.Position;
		TargetPosition = anchor.TargetPosition;
		_lastUsedDisembarkPosition = anchor._lastUsedDisembarkPosition;
		ArrivalTime = anchor.ArrivalTime;
		IsDisabled = anchor.IsDisabled;
	}

	public void SetPosition(CampaignVec2 position)
	{
		Position = position;
		ResetMoveTarget();
		if (!Owner.IsMainParty)
		{
			return;
		}
		if (IsValid)
		{
			if (!Campaign.Current.VisualTrackerManager.CheckTracked(this))
			{
				Campaign.Current.VisualTrackerManager.RegisterObject(this);
			}
		}
		else if (Campaign.Current.VisualTrackerManager.CheckTracked(this))
		{
			Campaign.Current.VisualTrackerManager.RemoveTrackedObject(this);
		}
	}

	public void SetSettlement(Settlement settlement)
	{
		SetPosition(settlement.PortPosition);
		SetLastUsedDisembarkPosition(settlement.GatePosition);
	}

	public void InitializeOnLoad(MobileParty owner)
	{
		Owner = owner;
	}

	public bool CanPartyInteract(MobileParty mobileParty, float dt)
	{
		if (mobileParty.IsMainParty && IsValid && !IsDisabled)
		{
			return mobileParty.Position.Distance(GetInteractionPosition(mobileParty)) < Campaign.Current.Models.EncounterModel.NeededMaximumDistanceForEncounteringMobileParty;
		}
		return false;
	}

	public void SetLastUsedDisembarkPosition(CampaignVec2 pos)
	{
		_lastUsedDisembarkPosition = pos;
	}

	public CampaignVec2 GetLastUsedDisembarkPosition()
	{
		return _lastUsedDisembarkPosition;
	}

	public CampaignVec2 GetInteractionPosition(MobileParty interactingParty)
	{
		if (IsValid)
		{
			return _lastUsedDisembarkPosition;
		}
		return CampaignVec2.Invalid;
	}

	public void OnPartyInteraction(MobileParty mobileParty)
	{
		mobileParty.Ai.AiBehaviorInteractable = null;
		mobileParty.TargetPosition = Position;
		mobileParty.MoveTargetPoint = Position;
		mobileParty.SetSailAtPosition(Position);
	}

	internal void HourlyTick()
	{
		if (ArrivalTime != CampaignTime.Zero && ArrivalTime.IsPast)
		{
			SetPosition(TargetPosition);
			if (Owner.IsMainParty)
			{
				InformationManager.DisplayMessage(new InformationMessage(new TextObject("{=qFAhDtrw}Your fleet has arrived at its destination.").ToString(), new Color(0f, 1f, 0f))
				{
					SoundEventPath = "event:/ui/panels/panel_call_fleet"
				});
			}
		}
	}

	TextObject ITrackableBase.GetName()
	{
		return Name;
	}

	public Vec3 GetPosition()
	{
		return Position.AsVec3();
	}

	Banner ITrackableCampaignObject.GetBanner()
	{
		return Owner.Banner;
	}

	public bool IsAtSettlement(Settlement settlement)
	{
		if (!IsMovingToPoint && IsValid)
		{
			return settlement.PortPosition.Distance(Position) < Campaign.Current.Models.EncounterModel.NeededMaximumDistanceForEncounteringTown;
		}
		return false;
	}

	public bool IsTargetingSettlement(Settlement settlement)
	{
		if (IsMovingToPoint)
		{
			return settlement.PortPosition.Distance(TargetPosition) < Campaign.Current.Models.EncounterModel.NeededMaximumDistanceForEncounteringTown;
		}
		return false;
	}

	public void CheckPositionsForMapChangeAndUpdateIfNeeded()
	{
		if (Position.IsValid() && !NavigationHelper.IsPositionValidForNavigationType(Position, MobileParty.NavigationType.Naval))
		{
			CampaignVec2 closestNavMeshFaceCenterPositionForPosition = NavigationHelper.GetClosestNavMeshFaceCenterPositionForPosition(Position, Campaign.Current.Models.PartyNavigationModel.GetInvalidTerrainTypesForNavigationType(MobileParty.NavigationType.Naval));
			Position = NavigationHelper.FindReachablePointAroundPosition(closestNavMeshFaceCenterPositionForPosition, MobileParty.NavigationType.Naval, 8f, 1f);
		}
	}

	public void ResetPosition()
	{
		SetPosition(new CampaignVec2(Vec2.Invalid, isOnLand: false));
	}

	public void ResetMoveTarget()
	{
		ArrivalTime = CampaignTime.Zero;
		TargetPosition = CampaignVec2.Invalid;
	}
}
