using System.Collections.Generic;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements.Buildings;

public class Building
{
	[SaveableField(0)]
	private BuildingType _buildingType;

	[SaveableField(1)]
	public float BuildingProgress;

	public const float MaxHitpoints = 100f;

	[SaveableField(2)]
	public bool IsCurrentlyDefault;

	[SaveableField(3)]
	private int _currentLevel;

	[SaveableField(5)]
	private float _hitpoints = 100f;

	public TextObject Name => _buildingType.Name;

	public TextObject Explanation => _buildingType.Explanation;

	public BuildingType BuildingType => _buildingType;

	[SaveableProperty(6)]
	public Town Town { get; private set; }

	public int CurrentLevel
	{
		get
		{
			return _currentLevel;
		}
		set
		{
			_currentLevel = value;
			if (Town.Owner != null)
			{
				Town.Owner.SetLevelMaskIsDirty();
			}
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsBuilding(object o, List<object> collectedObjects)
	{
		((Building)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		collectedObjects.Add(_buildingType);
		collectedObjects.Add(Town);
	}

	internal static object AutoGeneratedGetMemberValueTown(object o)
	{
		return ((Building)o).Town;
	}

	internal static object AutoGeneratedGetMemberValueBuildingProgress(object o)
	{
		return ((Building)o).BuildingProgress;
	}

	internal static object AutoGeneratedGetMemberValueIsCurrentlyDefault(object o)
	{
		return ((Building)o).IsCurrentlyDefault;
	}

	internal static object AutoGeneratedGetMemberValue_buildingType(object o)
	{
		return ((Building)o)._buildingType;
	}

	internal static object AutoGeneratedGetMemberValue_currentLevel(object o)
	{
		return ((Building)o)._currentLevel;
	}

	internal static object AutoGeneratedGetMemberValue_hitpoints(object o)
	{
		return ((Building)o)._hitpoints;
	}

	public Building(BuildingType buildingType, Town town, float buildingProgress = 0f, int currentLevel = 0)
	{
		_buildingType = buildingType;
		BuildingProgress = buildingProgress;
		Town = town;
		_currentLevel = currentLevel;
		IsCurrentlyDefault = false;
		_ = buildingType.IsDailyProject;
	}

	[LateLoadInitializationCallback]
	private void OnLoad()
	{
		UpdateBuildingTypeForOldSaves();
	}

	public override int GetHashCode()
	{
		int num = _buildingType?.GetHashCode() ?? 0;
		return (Town != null) ? ((num * 397) ^ Town.GetHashCode()) : num;
	}

	public int GetConstructionCost()
	{
		float num = 1f;
		if (Town.Settlement.OwnerClan.Kingdom != null && Town.Settlement.OwnerClan.Kingdom.ActivePolicies.Contains(DefaultPolicies.CastleCharters))
		{
			num = 0.8f;
		}
		return (int)((float)_buildingType.GetProductionCost(_currentLevel) * num);
	}

	public void LevelUp()
	{
		if (CurrentLevel < 3)
		{
			int constructionCost = GetConstructionCost();
			CurrentLevel++;
			BuildingProgress -= constructionCost;
			CampaignEventDispatcher.Instance.OnBuildingLevelChanged(Town, this, 1);
		}
	}

	public void LevelDown()
	{
		if (CurrentLevel != _buildingType.StartLevel)
		{
			CurrentLevel--;
			BuildingProgress = 0f;
			_hitpoints = 100f;
			CampaignEventDispatcher.Instance.OnBuildingLevelChanged(Town, this, -1);
		}
	}

	public void HitPointChanged(float change)
	{
		if (CurrentLevel != _buildingType.StartLevel)
		{
			_hitpoints = MathF.Clamp(_hitpoints + change, 0f, 100f);
			if (_hitpoints == 0f)
			{
				LevelDown();
			}
		}
	}

	public void AddEffectOfBuilding(BuildingEffectEnum buildingEffect, ref ExplainedNumber result)
	{
		if (_currentLevel < _buildingType.StartLevel || _currentLevel > 3)
		{
			Debug.FailedAssert(string.Concat("Building: ", Name, " current level is out of bounds!"), "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Settlements\\Buildings\\Building.cs", "AddEffectOfBuilding", 142);
		}
		if (_currentLevel != 0 && (!BuildingType.IsDailyProject || Town.CurrentDefaultBuilding == this) && BuildingType.HasEffect(buildingEffect))
		{
			BuildingEffectIncrementType buildingEffectType = BuildingType.GetBuildingEffectType(buildingEffect);
			float resultNumber = Campaign.Current.Models.BuildingEffectModel.GetBuildingEffect(this, buildingEffect).ResultNumber;
			switch (buildingEffectType)
			{
			case BuildingEffectIncrementType.Add:
				result.Add(resultNumber, Name);
				break;
			case BuildingEffectIncrementType.AddFactor:
				result.AddFactor(resultNumber, Name);
				break;
			default:
				Debug.FailedAssert("Unsupported BuildingEffectIncrementType!", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Settlements\\Buildings\\Building.cs", "AddEffectOfBuilding", 172);
				break;
			}
		}
	}

	public TextObject GetBonusExplanation()
	{
		if (_currentLevel == 0)
		{
			return TextObject.GetEmpty();
		}
		return GetBonusExplanations()[_currentLevel - 1];
	}

	private TextObject[] GetBonusExplanations()
	{
		TextObject[] array = new TextObject[3]
		{
			TextObject.GetEmpty(),
			TextObject.GetEmpty(),
			TextObject.GetEmpty()
		};
		if (_currentLevel == 0 || _currentLevel > 3)
		{
			return array;
		}
		for (int i = 0; i < _currentLevel; i++)
		{
			array[i] = _buildingType.GetExplanationAtLevel(i);
		}
		return array;
	}

	private void UpdateBuildingTypeForOldSaves()
	{
		if (MBSaveLoad.LastLoadedGameVersion.IsOlderThan(ApplicationVersion.FromString("v1.3.0.0")) && new Dictionary<string, string>
		{
			{ "building_fortifications", "building_settlement_fortifications" },
			{ "building_settlement_garrison_barracks", "building_settlement_barracks" },
			{ "building_settlement_militia_barracks", "building_settlement_guard_house" },
			{ "building_siege_workshop", "building_settlement_siege_workshop" },
			{ "building_settlement_marketplace", "building_settlement_tax_office" },
			{ "building_settlement_forum", "building_settlement_marketplace" },
			{ "building_settlement_granary", "building_settlement_warehouse" },
			{ "building_settlement_workshop", "building_settlement_mason" },
			{ "building_settlement_aquaducts", "building_settlement_waterworks" },
			{ "building_settlement_fairgrounds", "building_settlement_courthouse" },
			{ "building_settlement_lime_kilns", "building_settlement_roads_and_paths" },
			{ "building_wall", "building_castle_fortifications" },
			{ "building_castle_gardens", "building_castle_farmlands" },
			{ "building_castle_workshops", "building_castle_mason" },
			{ "building_castle_fairgrounds", "building_castle_roads_and_paths" },
			{ "building_castle_militia_barracks", "building_castle_guard_house" },
			{ "building_castle_lime_kilns", "building_castle_craftmans_quarters" },
			{
				"building_daily_build_house",
				Town.IsCastle ? "building_castle_daily_slacken_garrison" : "building_settlement_daily_housing"
			},
			{
				"building_daily_train_militia",
				Town.IsCastle ? "building_castle_daily_raise_troops" : "building_settlement_daily_train_militia"
			},
			{
				"building_festivals_and_games",
				Town.IsCastle ? "building_castle_daily_drills" : "building_settlement_daily_festival_and_games"
			},
			{
				"building_irrigation",
				Town.IsCastle ? "building_castle_daily_irrigation" : "building_settlement_daily_irrigation"
			}
		}.TryGetValue(_buildingType.StringId, out var value))
		{
			_buildingType = MBObjectManager.Instance.RegisterPresumedObject(new BuildingType(value));
		}
	}
}
