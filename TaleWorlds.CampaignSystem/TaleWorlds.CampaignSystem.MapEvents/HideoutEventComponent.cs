using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.MapEvents;

public class HideoutEventComponent : MapEventComponent
{
	[SaveableField(1)]
	public readonly bool IsSendTroops;

	public override MapEvent.PowerCalculationContext SimulationContext => Campaign.Current.Models.MilitaryPowerModel.GetContextForPosition(base.MapEvent.Position);

	internal static void AutoGeneratedStaticCollectObjectsHideoutEventComponent(object o, List<object> collectedObjects)
	{
		((HideoutEventComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	internal static object AutoGeneratedGetMemberValueIsSendTroops(object o)
	{
		return ((HideoutEventComponent)o).IsSendTroops;
	}

	protected HideoutEventComponent(MapEvent mapEvent, bool isSendTroops)
		: base(mapEvent)
	{
		IsSendTroops = isSendTroops;
	}

	public static HideoutEventComponent CreateHideoutEvent(PartyBase attackerParty, PartyBase defenderParty, bool isSendTroops)
	{
		MapEvent mapEvent = new MapEvent();
		HideoutEventComponent hideoutEventComponent = new HideoutEventComponent(mapEvent, isSendTroops);
		mapEvent.Initialize(attackerParty, defenderParty, hideoutEventComponent, MapEvent.BattleTypes.Hideout);
		Campaign.Current.MapEventManager.OnMapEventCreated(mapEvent);
		return hideoutEventComponent;
	}

	public static HideoutEventComponent CreateComponentForOldSaves(MapEvent mapEvent, bool isSendTroops)
	{
		return new HideoutEventComponent(mapEvent, isSendTroops);
	}

	protected override void OnBeforeFinalize()
	{
		BattleSideEnum winnerSide = ((base.MapEvent.BattleState == BattleState.AttackerVictory) ? BattleSideEnum.Attacker : BattleSideEnum.Defender);
		CampaignEventDispatcher.Instance.OnHideoutBattleCompleted(winnerSide, this);
	}
}
