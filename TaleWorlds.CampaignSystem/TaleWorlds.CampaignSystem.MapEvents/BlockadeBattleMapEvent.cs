using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Siege;
using TaleWorlds.Core;
using TaleWorlds.Library;

namespace TaleWorlds.CampaignSystem.MapEvents;

public class BlockadeBattleMapEvent : MapEventComponent
{
	[CachedData]
	private bool _isInitializationNotFinished;

	public override MapEvent.PowerCalculationContext SimulationContext => MapEvent.PowerCalculationContext.SeaBattle;

	internal static void AutoGeneratedStaticCollectObjectsBlockadeBattleMapEvent(object o, List<object> collectedObjects)
	{
		((BlockadeBattleMapEvent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected BlockadeBattleMapEvent(MapEvent mapEvent)
		: base(mapEvent)
	{
		_isInitializationNotFinished = true;
	}

	public static BlockadeBattleMapEvent CreateBlockadeBattleMapEvent(PartyBase attackerParty, PartyBase besiegerParty, bool isSallyOut)
	{
		MapEvent mapEvent = new MapEvent();
		BlockadeBattleMapEvent blockadeBattleMapEvent = new BlockadeBattleMapEvent(mapEvent);
		mapEvent.Initialize(attackerParty, besiegerParty, blockadeBattleMapEvent, isSallyOut ? MapEvent.BattleTypes.BlockadeSallyOutBattle : MapEvent.BattleTypes.BlockadeBattle);
		Campaign.Current.MapEventManager.OnMapEventCreated(mapEvent);
		return blockadeBattleMapEvent;
	}

	private static float CalculateBesiegerSideNavalPower(BesiegerCamp besiegerCamp)
	{
		float num = 0f;
		foreach (PartyBase item in besiegerCamp.GetInvolvedPartiesForEventType(MapEvent.BattleTypes.BlockadeBattle))
		{
			num += item.GetCustomStrength(BattleSideEnum.Defender, MapEvent.PowerCalculationContext.SeaBattle);
		}
		return num;
	}

	private float CalculateAttackerNavalPower(PartyBase attackerParty)
	{
		float num = 0f;
		num += attackerParty.GetCustomStrength(BattleSideEnum.Attacker, SimulationContext);
		foreach (MobileParty attachedParty in attackerParty.MobileParty.AttachedParties)
		{
			num += attachedParty.Party.GetCustomStrength(BattleSideEnum.Attacker, SimulationContext);
		}
		if (base.MapEvent.EventType == MapEvent.BattleTypes.BlockadeSallyOutBattle)
		{
			foreach (PartyBase item in (attackerParty.MobileParty.CurrentSettlement ?? base.MapEvent.DefenderSide.LeaderParty.MobileParty.BesiegedSettlement).GetInvolvedPartiesForEventType(base.MapEvent.EventType))
			{
				num += item.GetCustomStrength(BattleSideEnum.Attacker, SimulationContext);
			}
		}
		return num;
	}

	protected override void OnInitialize()
	{
		if (base.MapEvent.DefenderSide.LeaderParty.MobileParty.IsMainParty)
		{
			GameMenu.ActivateGameMenu("player_blockade_got_attacked");
		}
		else
		{
			CheckLiftingBlockade();
		}
		_isInitializationNotFinished = false;
	}

	internal override void OnPartyAdded(PartyBase party)
	{
		if (!_isInitializationNotFinished && !base.MapEvent.DefenderSide.LeaderParty.MobileParty.IsMainParty)
		{
			CheckLiftingBlockade();
		}
	}

	private void CheckLiftingBlockade()
	{
		if (base.MapEvent.State == MapEventState.WaitingRemoval)
		{
			return;
		}
		PartyBase leaderParty = base.MapEvent.AttackerSide.LeaderParty;
		PartyBase leaderParty2 = base.MapEvent.DefenderSide.LeaderParty;
		float num = CalculateAttackerNavalPower(leaderParty);
		float num2 = CalculateBesiegerSideNavalPower(leaderParty2.SiegeEvent.BesiegerCamp);
		if (!(num > num2 * 1.2f))
		{
			return;
		}
		leaderParty2.SiegeEvent.DeactivateBlockade();
		List<MapEventParty> list = base.MapEvent.AttackerSide.Parties.ToList();
		base.MapEvent.FinalizeEvent();
		foreach (MapEventParty item in list)
		{
			if (item.Party != PartyBase.MainParty && item.Party.IsMobile && item.Party.MobileParty.CurrentSettlement == null && item.Party.MobileParty.AttachedTo == null)
			{
				item.Party.MobileParty.SetMoveGoToSettlement(leaderParty2.SiegeEvent.BesiegedSettlement, MobileParty.NavigationType.Naval, isTargetingThePort: true);
			}
		}
	}

	protected override void OnFinalize()
	{
		if (base.MapEvent.DefeatedSide == BattleSideEnum.Defender && base.MapEvent.DefenderSide.LeaderParty.SiegeEvent != null)
		{
			base.MapEvent.DefenderSide.LeaderParty.SiegeEvent.FinalizeSiegeEvent();
		}
	}
}
