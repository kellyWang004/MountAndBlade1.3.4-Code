using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;

namespace TaleWorlds.CampaignSystem.MapEvents;

public class ForceSuppliesEventComponent : MapEventComponent
{
	public override MapEvent.PowerCalculationContext SimulationContext => MapEvent.PowerCalculationContext.Village;

	internal static void AutoGeneratedStaticCollectObjectsForceSuppliesEventComponent(object o, List<object> collectedObjects)
	{
		((ForceSuppliesEventComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected ForceSuppliesEventComponent(MapEvent mapEvent)
		: base(mapEvent)
	{
	}

	public static ForceSuppliesEventComponent CreateForceSuppliesEvent(PartyBase attackerParty, PartyBase defenderParty)
	{
		MapEvent mapEvent = new MapEvent();
		ForceSuppliesEventComponent forceSuppliesEventComponent = new ForceSuppliesEventComponent(mapEvent);
		mapEvent.Initialize(attackerParty, defenderParty, forceSuppliesEventComponent, MapEvent.BattleTypes.IsForcingSupplies);
		if (defenderParty.Settlement?.MilitiaPartyComponent != null)
		{
			defenderParty.Settlement.MilitiaPartyComponent.MobileParty.MapEventSide = mapEvent.DefenderSide;
		}
		Campaign.Current.MapEventManager.OnMapEventCreated(mapEvent);
		return forceSuppliesEventComponent;
	}

	public static ForceSuppliesEventComponent CreateComponentForOldSaves(MapEvent mapEvent)
	{
		return new ForceSuppliesEventComponent(mapEvent);
	}

	protected override void OnInitialize()
	{
		ChangeVillageStateAction.ApplyBySettingToBeingForcedForSupplies(base.MapEvent.MapEventSettlement, base.MapEvent.AttackerSide.LeaderParty.MobileParty);
	}

	protected override void OnBeforeFinalize()
	{
		CampaignEventDispatcher.Instance.ForceSuppliesCompleted((base.MapEvent.BattleState == BattleState.AttackerVictory) ? BattleSideEnum.Attacker : BattleSideEnum.Defender, this);
	}

	protected override void OnFinalize()
	{
		ChangeVillageStateAction.ApplyBySettingToNormal(base.MapEvent.MapEventSettlement);
	}
}
