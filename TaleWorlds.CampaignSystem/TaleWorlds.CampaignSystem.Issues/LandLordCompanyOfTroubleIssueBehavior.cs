using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Conversation.Persuasion;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Party.PartyComponents;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues;

public class LandLordCompanyOfTroubleIssueBehavior : CampaignBehaviorBase
{
	public class LandLordCompanyOfTroubleIssue : IssueBase
	{
		private int CompanyTroopCount => 5 + (int)(base.IssueDifficultyMultiplier * 30f);

		public override bool IsThereAlternativeSolution => false;

		public override bool IsThereLordSolution => false;

		public override TextObject IssueBriefByIssueGiver => new TextObject("{=wrpsJM2u}Yes... I hired a band of mercenaries for a campaign some time back. But... normally mercenaries have their own peculiar kind of honor. You pay them, they fight for you, you don't, they go somewhere else. But these ones have made it pretty clear that if I don't keep renewing the contract, they'll turn bandit. I can't afford that right now.[if:convo_thinking][ib:closed]");

		public override TextObject IssueAcceptByPlayer => new TextObject("{=VlbCFDWu}What do you want from me?");

		public override TextObject IssueQuestSolutionExplanationByIssueGiver => new TextObject("{=wxDbPiNH}Well, you have the reputation of being able to manage ruffians. Maybe you can take them off my hands, find some other lord who has more need of them and more denars to pay them. I've paid their contract for a few months. I can give you a small reward and if you can find a buyer, you can transfer the rest of the contract to him and pocket the down payment.[if:convo_innocent_smile]");

		public override TextObject IssueQuestSolutionAcceptByPlayer => new TextObject("{=6bvJSIqh}Yes. I can find a new lord to take them on.");

		public override TextObject Title => new TextObject("{=PV7RHgUl}Company of Trouble");

		public override TextObject Description
		{
			get
			{
				TextObject textObject = new TextObject("{=zw7a9eIt}{ISSUE_GIVER.NAME} wants you to take {?ISSUE_GIVER.GENDER}her{?}his{\\?} mercenaries and transfer them to another lord before they cause any trouble.");
				StringHelpers.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject, textObject);
				return textObject;
			}
		}

		public override TextObject IssueAsRumorInSettlement
		{
			get
			{
				TextObject textObject = new TextObject("{=I022Z9Ub}Heh. {QUEST_GIVER.NAME} got in deeper than {?QUEST_GIVER.GENDER}she{?}he{\\?} could handle with those mercenaries.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject);
				return textObject;
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsLandLordCompanyOfTroubleIssue(object o, List<object> collectedObjects)
		{
			((LandLordCompanyOfTroubleIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		public LandLordCompanyOfTroubleIssue(Hero issueOwner)
			: base(issueOwner, CampaignTime.DaysFromNow(25f))
		{
		}

		protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
		{
			if (issueEffect == DefaultIssueEffects.ClanInfluence)
			{
				return -0.1f;
			}
			return 0f;
		}

		protected override void OnGameLoad()
		{
		}

		protected override void HourlyTick()
		{
		}

		protected override QuestBase GenerateIssueQuest(string questId)
		{
			return new LandLordCompanyOfTroubleIssueQuest(questId, base.IssueOwner, CampaignTime.Never, CompanyTroopCount);
		}

		public override IssueFrequency GetFrequency()
		{
			return IssueFrequency.Rare;
		}

		protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
		{
			skill = null;
			relationHero = null;
			flag = PreconditionFlags.None;
			if (issueGiver.GetRelationWithPlayer() < -10f)
			{
				flag |= PreconditionFlags.Relation;
				relationHero = issueGiver;
			}
			if (Clan.PlayerClan.Tier < 1)
			{
				flag |= PreconditionFlags.ClanTier;
			}
			if (MobileParty.MainParty.MemberRoster.TotalManCount < CompanyTroopCount)
			{
				flag |= PreconditionFlags.NotEnoughTroops;
			}
			if (MobileParty.MainParty.MemberRoster.TotalManCount + CompanyTroopCount > PartyBase.MainParty.PartySizeLimit)
			{
				flag |= PreconditionFlags.PartySizeLimit;
			}
			if (issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				flag |= PreconditionFlags.AtWar;
			}
			return flag == PreconditionFlags.None;
		}

		public override bool IssueStayAliveConditions()
		{
			return base.IssueOwner.Clan != Clan.PlayerClan;
		}

		protected override void CompleteIssueWithTimedOutConsequences()
		{
		}
	}

	public class LandLordCompanyOfTroubleIssueQuest : QuestBase
	{
		private const string TroubleCharacterObjectStringId = "company_of_trouble_character";

		private int _companyTroopCount;

		[SaveableField(20)]
		internal MobileParty _companyOfTroubleParty;

		[SaveableField(30)]
		internal bool _battleWillStart;

		internal bool _checkForBattleResults;

		[SaveableField(40)]
		private int _thieveryCount;

		[SaveableField(80)]
		internal bool _triggerCompanyOfTroubleConversation;

		[SaveableField(50)]
		private int _demandGold;

		internal CharacterObject _troubleCharacterObject;

		private PersuasionTask[] _tasks;

		private PersuasionTask _selectedTask;

		private const PersuasionDifficulty Difficulty = PersuasionDifficulty.Hard;

		[SaveableField(70)]
		private List<Hero> _persuationTriedHeroesList;

		internal bool _companyLeftQuestWillFail;

		public override bool IsRemainingTimeHidden => true;

		public override TextObject Title => new TextObject("{=PV7RHgUl}Company of Trouble");

		private TextObject PlayerStartsQuestLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=8nS3QgD7}{QUEST_GIVER.LINK} is a {?QUEST_GIVER.GENDER}lady{?}lord{\\?} who told you that {?QUEST_GIVER.GENDER}she{?}he{\\?} wants to sell {?QUEST_GIVER.GENDER}her{?}his{\\?} mercenaries to another lord's service. {?QUEST_GIVER.GENDER}She{?}He{\\?} asked you sell them for {?QUEST_GIVER.GENDER}her{?}him{\\?} without causing any trouble.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject QuestSuccessPlayerSoldCompany
		{
			get
			{
				TextObject textObject = new TextObject("{=34MdCd6u}You have sold the mercenaries to another lord as you promised. {QUEST_GIVER.LINK} is grateful and sends {?QUEST_GIVER.GENDER}her{?}his{\\?} regards.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject AllCompanyDiedLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=RrTAX7QE}You got the troublesome mercenaries killed off. You get no extra money for the contract, but you did get rid of them as you promised. {QUEST_GIVER.LINK} is grateful and sends {?QUEST_GIVER.GENDER}her{?}his{\\?} regards.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject PlayerDefeatedAgainstCompany => new TextObject("{=7naLQmq1}You have lost the battle against the mercenaries. You have failed to get rid of them as you promised. Now they've turned bandit and are starting to plunder the countryside");

		private TextObject QuestFailCompanyLeft => new TextObject("{=k9SksaXg}The mercenaries left your party, as you failed to get rid of them as you promised. Now the mercenaries have turned bandit and start to plunder countryside.");

		private TextObject QuestCanceledWarDeclared
		{
			get
			{
				TextObject textObject = new TextObject("{=ItueKmqd}Your clan is now at war with the {QUEST_GIVER_SETTLEMENT_FACTION}. You contract with {QUEST_GIVER.LINK} is canceled.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("QUEST_GIVER_SETTLEMENT_FACTION", base.QuestGiver.MapFaction.InformalName);
				return textObject;
			}
		}

		private TextObject PlayerDeclaredWarQuestLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsLandLordCompanyOfTroubleIssueQuest(object o, List<object> collectedObjects)
		{
			((LandLordCompanyOfTroubleIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_companyOfTroubleParty);
			collectedObjects.Add(_persuationTriedHeroesList);
		}

		internal static object AutoGeneratedGetMemberValue_companyOfTroubleParty(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._companyOfTroubleParty;
		}

		internal static object AutoGeneratedGetMemberValue_battleWillStart(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._battleWillStart;
		}

		internal static object AutoGeneratedGetMemberValue_triggerCompanyOfTroubleConversation(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._triggerCompanyOfTroubleConversation;
		}

		internal static object AutoGeneratedGetMemberValue_thieveryCount(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._thieveryCount;
		}

		internal static object AutoGeneratedGetMemberValue_demandGold(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._demandGold;
		}

		internal static object AutoGeneratedGetMemberValue_persuationTriedHeroesList(object o)
		{
			return ((LandLordCompanyOfTroubleIssueQuest)o)._persuationTriedHeroesList;
		}

		public LandLordCompanyOfTroubleIssueQuest(string questId, Hero questGiver, CampaignTime duration, int companyTroopCount)
			: base(questId, questGiver, duration, 500)
		{
			_troubleCharacterObject = MBObjectManager.Instance.GetObject<CharacterObject>("company_of_trouble_character");
			_persuationTriedHeroesList = new List<Hero>();
			_troubleCharacterObject.SetTransferableInPartyScreen(isTransferable: false);
			_troubleCharacterObject.SetTransferableInHideouts(isTransferable: false);
			_companyTroopCount = companyTroopCount;
			_tasks = new PersuasionTask[3];
			_battleWillStart = false;
			_thieveryCount = 0;
			_demandGold = 0;
			SetDialogs();
			InitializeQuestOnCreation();
		}

		protected override void InitializeQuestOnGameLoad()
		{
			_troubleCharacterObject = MBObjectManager.Instance.GetObject<CharacterObject>("company_of_trouble_character");
			_troubleCharacterObject.SetTransferableInPartyScreen(isTransferable: false);
			_troubleCharacterObject.SetTransferableInHideouts(isTransferable: false);
			_tasks = new PersuasionTask[3];
			UpdateCompanyTroopCount();
			SetDialogs();
		}

		protected override void SetDialogs()
		{
			OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine(new TextObject("{=T6d7wtJX}Very well. I'll tell them to join your party. Good luck.[if:convo_mocking_aristocratic][ib:hip]")).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.Consequence(QuestAcceptedConsequences)
				.CloseDialog();
			DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine(new TextObject("{=bWpLYiEg}Did you ever find a way to handle those mercenaries?[if:convo_astonished]")).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.Consequence(delegate
				{
					Campaign.Current.ConversationManager.ConversationEndOneShot += MapEventHelper.OnConversationEnd;
				})
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=XzK4niIb}I'll find an employer soon."))
				.NpcLine(new TextObject("{=rOBRabQz}Good. I'm waiting for your good news.[if:convo_mocking_aristocratic]"))
				.CloseDialog()
				.PlayerOption(new TextObject("{=Zb3EdxDT}That kind of lord is hard to find."))
				.NpcLine(new TextObject("{=yOfrb9Lu}Don't wait too long. These are dangerous men. Be careful.[if:convo_nonchalant]"))
				.CloseDialog()
				.EndPlayerOptions()
				.CloseDialog();
			Campaign.Current.ConversationManager.AddDialogFlow(GetCompanyDialogFlow(), this);
			Campaign.Current.ConversationManager.AddDialogFlow(GetOtherLordsDialogFlow(), this);
		}

		private DialogFlow GetOtherLordsDialogFlow()
		{
			DialogFlow dialogFlow = DialogFlow.CreateDialogFlow("hero_main_options", 700).BeginPlayerOptions().PlayerOption(new TextObject("{=2E7s4L9R}Do you need mercenaries? I have a contract that I can transfer to you for {DEMAND_GOLD} denars."))
				.Condition(PersuasionDialogForLordGeneralCondition)
				.BeginNpcOptions()
				.NpcOption(new TextObject("{=ZR4RJdYS}Hmm, that sounds interesting...[if:convo_thinking]"), PersuasionDialogSpecialCondition)
				.GotoDialogState("company_of_trouble_persuasion")
				.NpcOption(new TextObject("{=pmrjUNEz}As it happens, I already have a mercenary contract that I wish to sell. So, no thank you.[if:convo_calm_friendly]"), HasSameIssue)
				.GotoDialogState("hero_main_options")
				.NpcOption(new TextObject("{=bw0hEPN6}You already bought their contract from our clan. Why would I want to buy them back?[if:convo_confused_normal]"), IsSameClanMember)
				.GotoDialogState("hero_main_options")
				.NpcOption(new TextObject("{=64bH4bUo}No, thank you. But perhaps one of the other lords of our clan would be interested.[if:convo_undecided_closed]"), () => !HasMobileParty())
				.GotoDialogState("hero_main_options")
				.NpcOption(new TextObject("{=Zs6L1aBL}I'm sorry. I don't need mercenaries right now.[if:convo_normal]"), null)
				.GotoDialogState("hero_main_options")
				.EndNpcOptions()
				.EndPlayerOptions();
			AddPersuasionDialogs(dialogFlow);
			return dialogFlow;
		}

		private bool PersuasionDialogSpecialCondition()
		{
			if (!IsSameClanMember() && !HasSameIssue() && HasMobileParty())
			{
				return !InSameSettlement();
			}
			return false;
		}

		private bool HasMobileParty()
		{
			return Hero.OneToOneConversationHero.PartyBelongedTo != null;
		}

		private bool IsSameClanMember()
		{
			return Hero.OneToOneConversationHero.Clan == base.QuestGiver.Clan;
		}

		private bool InSameSettlement()
		{
			if (Hero.OneToOneConversationHero.CurrentSettlement != null && base.QuestGiver.CurrentSettlement != null)
			{
				return Hero.OneToOneConversationHero.CurrentSettlement == base.QuestGiver.CurrentSettlement;
			}
			return false;
		}

		private bool HasSameIssue()
		{
			return Hero.OneToOneConversationHero.Issue?.GetType() == GetType();
		}

		private bool PersuasionDialogForLordGeneralCondition()
		{
			if (Hero.OneToOneConversationHero != null && Hero.OneToOneConversationHero.IsLord && Hero.OneToOneConversationHero.Age >= (float)Campaign.Current.Models.AgeModel.HeroComesOfAge && Hero.OneToOneConversationHero != base.QuestGiver && !Hero.OneToOneConversationHero.MapFaction.IsAtWarWith(base.QuestGiver.MapFaction) && Hero.OneToOneConversationHero.Clan != Clan.PlayerClan && !_persuationTriedHeroesList.Contains(Hero.OneToOneConversationHero))
			{
				UpdateCompanyTroopCount();
				_demandGold = 1000 + _companyTroopCount * 150;
				MBTextManager.SetTextVariable("DEMAND_GOLD", _demandGold);
				_tasks[0] = GetPersuasionTask1();
				_tasks[1] = GetPersuasionTask2();
				_tasks[2] = GetPersuasionTask3();
				_selectedTask = _tasks.GetRandomElement();
				return true;
			}
			return false;
		}

		private void AddPersuasionDialogs(DialogFlow dialog)
		{
			dialog.AddDialogLine("company_of_trouble_persuasion_check_accepted", "company_of_trouble_persuasion", "company_of_trouble_persuasion_start_reservation", "{=GCH6RgIQ}How tough are they?", persuasion_start_with_company_of_trouble_on_condition, persuasion_start_with_company_of_trouble_on_consequence, this);
			dialog.AddDialogLine("company_of_trouble_persuasion_rejected", "company_of_trouble_persuasion_start_reservation", "hero_main_options", "{=!}{FAILED_PERSUASION_LINE}", persuasion_failed_with_company_of_trouble_on_condition, persuasion_rejected_with_company_of_trouble_on_consequence, this);
			dialog.AddDialogLine("company_of_trouble_persuasion_attempt", "company_of_trouble_persuasion_start_reservation", "company_of_trouble_persuasion_select_option", "{=K0Qtl5RZ}Tell me about the details...", () => !persuasion_failed_with_company_of_trouble_on_condition(), null, this);
			dialog.AddDialogLine("company_of_trouble_persuasion_success", "company_of_trouble_persuasion_start_reservation", "close_window", "{=QlECaaHt}Hmm...They can be useful.", ConversationManager.GetPersuasionProgressSatisfied, persuasion_complete_with_company_of_trouble_on_consequence, this, 200);
			ConversationSentence.OnConditionDelegate conditionDelegate = company_of_trouble_persuasion_select_option_1_on_condition;
			ConversationSentence.OnConsequenceDelegate consequenceDelegate = company_of_trouble_persuasion_select_option_1_on_consequence;
			ConversationSentence.OnPersuasionOptionDelegate persuasionOptionDelegate = company_of_trouble_persuasion_setup_option_1;
			ConversationSentence.OnClickableConditionDelegate clickableConditionDelegate = company_of_trouble_persuasion_clickable_option_1_on_condition;
			dialog.AddPlayerLine("company_of_trouble_persuasion_select_option_1", "company_of_trouble_persuasion_select_option", "company_of_trouble_persuasion_selected_option_response", "{=0AUZvSAq}{COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_1}", conditionDelegate, consequenceDelegate, this, 100, clickableConditionDelegate, persuasionOptionDelegate);
			ConversationSentence.OnConditionDelegate conditionDelegate2 = company_of_trouble_persuasion_select_option_2_on_condition;
			ConversationSentence.OnConsequenceDelegate consequenceDelegate2 = company_of_trouble_persuasion_select_option_2_on_consequence;
			persuasionOptionDelegate = company_of_trouble_persuasion_setup_option_2;
			clickableConditionDelegate = company_of_trouble_persuasion_clickable_option_2_on_condition;
			dialog.AddPlayerLine("company_of_trouble_persuasion_select_option_2", "company_of_trouble_persuasion_select_option", "company_of_trouble_persuasion_selected_option_response", "{=GG1W8qGd}{COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_2}", conditionDelegate2, consequenceDelegate2, this, 100, clickableConditionDelegate, persuasionOptionDelegate);
			ConversationSentence.OnConditionDelegate conditionDelegate3 = company_of_trouble_persuasion_select_option_3_on_condition;
			ConversationSentence.OnConsequenceDelegate consequenceDelegate3 = company_of_trouble_persuasion_select_option_3_on_consequence;
			persuasionOptionDelegate = company_of_trouble_persuasion_setup_option_3;
			clickableConditionDelegate = company_of_trouble_persuasion_clickable_option_3_on_condition;
			dialog.AddPlayerLine("company_of_trouble_persuasion_select_option_3", "company_of_trouble_persuasion_select_option", "company_of_trouble_persuasion_selected_option_response", "{=kFs940kp}{COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_3}", conditionDelegate3, consequenceDelegate3, this, 100, clickableConditionDelegate, persuasionOptionDelegate);
			dialog.AddDialogLine("company_of_trouble_persuasion_select_option_reaction", "company_of_trouble_persuasion_selected_option_response", "company_of_trouble_persuasion_start_reservation", "{=D0xDRqvm}{PERSUASION_REACTION}", company_of_trouble_persuasion_selected_option_response_on_condition, company_of_trouble_persuasion_selected_option_response_on_consequence, this);
		}

		private void persuasion_start_with_company_of_trouble_on_consequence()
		{
			_persuationTriedHeroesList.Add(Hero.OneToOneConversationHero);
			ConversationManager.StartPersuasion(2f, 1f, 0f, 2f, 2f, 0f, PersuasionDifficulty.Hard);
		}

		private bool persuasion_start_with_company_of_trouble_on_condition()
		{
			return !_persuationTriedHeroesList.Contains(Hero.OneToOneConversationHero);
		}

		private PersuasionTask GetPersuasionTask1()
		{
			PersuasionTask persuasionTask = new PersuasionTask(0);
			persuasionTask.FinalFailLine = new TextObject("{=1V9GeKr8}Fah...I don't need more men. Thank you.");
			persuasionTask.TryLaterLine = new TextObject("{=!}TODO");
			persuasionTask.SpokenLine = new TextObject("{=EvAubSxs}What kind of troops do they make?");
			PersuasionOptionArgs option = new PersuasionOptionArgs(DefaultSkills.Trade, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.Easy, givesCriticalSuccess: false, new TextObject("{=sqMUtasn}Cheap, disposable and effective. What you say?"));
			persuasionTask.AddOptionToTask(option);
			PersuasionOptionArgs option2 = new PersuasionOptionArgs(DefaultSkills.Tactics, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.ExtremelyHard, givesCriticalSuccess: true, new TextObject("{=Pcgqs9aX}Here's a quick run down of their training..."), null, canBlockOtherOption: true);
			persuasionTask.AddOptionToTask(option2);
			PersuasionOptionArgs option3 = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.Valor, TraitEffect.Positive, PersuasionArgumentStrength.Normal, givesCriticalSuccess: false, new TextObject("{=WvQDatMJ}I won't kid you, they're mean bastards, but that's good if you can manage them."));
			persuasionTask.AddOptionToTask(option3);
			return persuasionTask;
		}

		private PersuasionTask GetPersuasionTask2()
		{
			PersuasionTask persuasionTask = new PersuasionTask(0);
			persuasionTask.FinalFailLine = new TextObject("{=UP0pMGDR}There are enough bandits around here already. I don't need more on retainer.");
			persuasionTask.TryLaterLine = new TextObject("{=!}TODO");
			persuasionTask.SpokenLine = new TextObject("{=zR356YDY}I have to say, they seem more like bandits than soldiers.");
			PersuasionOptionArgs option = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.Valor, TraitEffect.Positive, PersuasionArgumentStrength.Easy, givesCriticalSuccess: false, new TextObject("{=JI6Q9pQ7}Bandits can kill as well as any other kind of troops, if used correctly."));
			persuasionTask.AddOptionToTask(option);
			PersuasionOptionArgs option2 = new PersuasionOptionArgs(DefaultSkills.Trade, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.ExtremelyHard, givesCriticalSuccess: true, new TextObject("{=SqceZdzH}Of course. That's why they're cheap. You get what you pay for. "), null, canBlockOtherOption: true);
			persuasionTask.AddOptionToTask(option2);
			PersuasionOptionArgs option3 = new PersuasionOptionArgs(DefaultSkills.Scouting, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.Normal, givesCriticalSuccess: false, new TextObject("{=NWLH02KL}Bandits are good in the wilderness, having been both predator and prey."));
			persuasionTask.AddOptionToTask(option3);
			return persuasionTask;
		}

		private PersuasionTask GetPersuasionTask3()
		{
			PersuasionTask persuasionTask = new PersuasionTask(0);
			persuasionTask.FinalFailLine = new TextObject("{=97pacK2l}Fah... I don't need more men. Thank you.");
			persuasionTask.TryLaterLine = new TextObject("{=!}TODO");
			persuasionTask.SpokenLine = new TextObject("{=A2ju7YTZ}I don't know... They look treacherous.");
			PersuasionOptionArgs option = new PersuasionOptionArgs(DefaultSkills.Tactics, DefaultTraits.Mercy, TraitEffect.Negative, PersuasionArgumentStrength.Easy, givesCriticalSuccess: false, new TextObject("{=z1mdQhDB}Of course. Send them in ahead of your other troops. If they die, you don't need to pay them."));
			persuasionTask.AddOptionToTask(option);
			PersuasionOptionArgs option2 = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.ExtremelyHard, givesCriticalSuccess: true, new TextObject("{=jWavM9AD}You've been around in the world. You know that mercenaries aren't saints."), null, canBlockOtherOption: true);
			persuasionTask.AddOptionToTask(option2);
			PersuasionOptionArgs option3 = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.Generosity, TraitEffect.Positive, PersuasionArgumentStrength.Normal, givesCriticalSuccess: false, new TextObject("{=sLjGguGy}Sure, they're bastards. But they'll be loyal bastards if you treat them well."));
			persuasionTask.AddOptionToTask(option3);
			return persuasionTask;
		}

		private bool company_of_trouble_persuasion_selected_option_response_on_condition()
		{
			PersuasionOptionResult item = ConversationManager.GetPersuasionChosenOptions().Last().Item2;
			MBTextManager.SetTextVariable("PERSUASION_REACTION", PersuasionHelper.GetDefaultPersuasionOptionReaction(item));
			if (item == PersuasionOptionResult.CriticalFailure)
			{
				_selectedTask.BlockAllOptions();
			}
			return true;
		}

		private void company_of_trouble_persuasion_selected_option_response_on_consequence()
		{
			Tuple<PersuasionOptionArgs, PersuasionOptionResult> tuple = ConversationManager.GetPersuasionChosenOptions().Last();
			float difficulty = Campaign.Current.Models.PersuasionModel.GetDifficulty(PersuasionDifficulty.Hard);
			Campaign.Current.Models.PersuasionModel.GetEffectChances(tuple.Item1, out var moveToNextStageChance, out var blockRandomOptionChance, difficulty);
			_selectedTask.ApplyEffects(moveToNextStageChance, blockRandomOptionChance);
		}

		private bool company_of_trouble_persuasion_select_option_1_on_condition()
		{
			if (_selectedTask.Options.Count > 0)
			{
				TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}");
				textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(_selectedTask.Options.ElementAt(0), showToPlayer: false));
				textObject.SetTextVariable("PERSUASION_OPTION_LINE", _selectedTask.Options.ElementAt(0).Line);
				MBTextManager.SetTextVariable("COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_1", textObject);
				return true;
			}
			return false;
		}

		private bool company_of_trouble_persuasion_select_option_2_on_condition()
		{
			if (_selectedTask.Options.Count > 1)
			{
				TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}");
				textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(_selectedTask.Options.ElementAt(1), showToPlayer: false));
				textObject.SetTextVariable("PERSUASION_OPTION_LINE", _selectedTask.Options.ElementAt(1).Line);
				MBTextManager.SetTextVariable("COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_2", textObject);
				return true;
			}
			return false;
		}

		private bool company_of_trouble_persuasion_select_option_3_on_condition()
		{
			if (_selectedTask.Options.Count > 2)
			{
				TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}");
				textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(_selectedTask.Options.ElementAt(2), showToPlayer: false));
				textObject.SetTextVariable("PERSUASION_OPTION_LINE", _selectedTask.Options.ElementAt(2).Line);
				MBTextManager.SetTextVariable("COMPANY_OF_TROUBLE_PERSUADE_ATTEMPT_3", textObject);
				return true;
			}
			return false;
		}

		private void company_of_trouble_persuasion_select_option_1_on_consequence()
		{
			if (_selectedTask.Options.Count > 0)
			{
				_selectedTask.Options[0].BlockTheOption(isBlocked: true);
			}
		}

		private void company_of_trouble_persuasion_select_option_2_on_consequence()
		{
			if (_selectedTask.Options.Count > 1)
			{
				_selectedTask.Options[1].BlockTheOption(isBlocked: true);
			}
		}

		private void company_of_trouble_persuasion_select_option_3_on_consequence()
		{
			if (_selectedTask.Options.Count > 2)
			{
				_selectedTask.Options[2].BlockTheOption(isBlocked: true);
			}
		}

		private bool persuasion_failed_with_company_of_trouble_on_condition()
		{
			if (_selectedTask.Options.All((PersuasionOptionArgs x) => x.IsBlocked) && !ConversationManager.GetPersuasionProgressSatisfied())
			{
				MBTextManager.SetTextVariable("FAILED_PERSUASION_LINE", _selectedTask.FinalFailLine);
				return true;
			}
			return false;
		}

		private PersuasionOptionArgs company_of_trouble_persuasion_setup_option_1()
		{
			return _selectedTask.Options.ElementAt(0);
		}

		private PersuasionOptionArgs company_of_trouble_persuasion_setup_option_2()
		{
			return _selectedTask.Options.ElementAt(1);
		}

		private PersuasionOptionArgs company_of_trouble_persuasion_setup_option_3()
		{
			return _selectedTask.Options.ElementAt(2);
		}

		private bool company_of_trouble_persuasion_clickable_option_1_on_condition(out TextObject hintText)
		{
			hintText = new TextObject("{=9ACJsI6S}Blocked");
			if (_selectedTask.Options.Count > 0)
			{
				hintText = (_selectedTask.Options.ElementAt(0).IsBlocked ? hintText : null);
				return !_selectedTask.Options.ElementAt(0).IsBlocked;
			}
			return false;
		}

		private bool company_of_trouble_persuasion_clickable_option_2_on_condition(out TextObject hintText)
		{
			hintText = new TextObject("{=9ACJsI6S}Blocked");
			if (_selectedTask.Options.Count > 1)
			{
				hintText = (_selectedTask.Options.ElementAt(1).IsBlocked ? hintText : null);
				return !_selectedTask.Options.ElementAt(1).IsBlocked;
			}
			return false;
		}

		private bool company_of_trouble_persuasion_clickable_option_3_on_condition(out TextObject hintText)
		{
			hintText = new TextObject("{=9ACJsI6S}Blocked");
			if (_selectedTask.Options.Count > 2)
			{
				hintText = (_selectedTask.Options.ElementAt(2).IsBlocked ? hintText : null);
				return !_selectedTask.Options.ElementAt(2).IsBlocked;
			}
			return false;
		}

		private void persuasion_rejected_with_company_of_trouble_on_consequence()
		{
			if (PlayerEncounter.Current != null)
			{
				PlayerEncounter.LeaveEncounter = true;
			}
			ConversationManager.EndPersuasion();
		}

		private void persuasion_complete_with_company_of_trouble_on_consequence()
		{
			if (PlayerEncounter.Current != null)
			{
				PlayerEncounter.LeaveEncounter = true;
			}
			ConversationManager.EndPersuasion();
			UpdateCompanyTroopCount();
			MobileParty.MainParty.MemberRoster.AddToCounts(_troubleCharacterObject, -_companyTroopCount);
			GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, _demandGold);
			RelationshipChangeWithQuestGiver = 5;
			AddLog(QuestSuccessPlayerSoldCompany);
			CompleteQuestWithSuccess();
		}

		private DialogFlow GetCompanyDialogFlow()
		{
			return DialogFlow.CreateDialogFlow("start", 125).NpcLine(new TextObject("{=8TCev3Qs}So, captain. We expect a bit of looting and plundering as compensation, in addition to the wages. You don't seem like you're going to provide it to us. So, farewell.[if:innocent_smile][ib:hip]")).Condition(CompanyDialogFromCondition)
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=1aaoSpNf}Your contract with the {QUEST_GIVER.NAME} is still in force. I can't let you go without {?QUEST_GIVER.GENDER}her{?}his{\\?} permission."))
				.NpcLine(new TextObject("{=oI5H6Xo8}Don't think we won't fight you if you try and stop us.[if:convo_mocking_aristocratic]"))
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=hIFazIcK}So be it!"))
				.NpcLine(new TextObject("{=KKeRi477}All right, lads. Let's kill the boss.[if:convo_predatory][ib:aggressive]"))
				.Consequence(delegate
				{
					Campaign.Current.ConversationManager.ConversationEndOneShot += CreateCompanyEnemyParty;
				})
				.CloseDialog()
				.PlayerOption(new TextObject("{=bm7UcuQj}No! There is no need to fight. I don't want any bloodshed... Just leave."))
				.NpcLine(new TextObject("{=1vnaskLR}It was a pleasure to work with you, chief. Farewell...[if:convo_nonchalant][ib:normal2]"))
				.Consequence(delegate
				{
					_companyLeftQuestWillFail = true;
				})
				.CloseDialog()
				.EndPlayerOptions()
				.CloseDialog()
				.PlayerOption(new TextObject("{=hj4vfgxk}As you wish! Good luck. "))
				.NpcLine(new TextObject("{=1vnaskLR}It was a pleasure to work with you, chief. Farewell...[if:convo_nonchalant][ib:normal2]"))
				.Consequence(delegate
				{
					_companyLeftQuestWillFail = true;
				})
				.CloseDialog()
				.EndPlayerOptions();
		}

		private bool CompanyDialogFromCondition()
		{
			StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject);
			return _troubleCharacterObject == CharacterObject.OneToOneConversationCharacter;
		}

		private void CreateCompanyEnemyParty()
		{
			MobileParty.MainParty.MemberRoster.AddToCounts(_troubleCharacterObject, -_companyTroopCount);
			Settlement settlement = SettlementHelper.FindRandomSettlement((Settlement x) => x.IsHideout);
			_companyOfTroubleParty = BanditPartyComponent.CreateBanditParty("company_of_trouble_" + base.StringId, settlement.OwnerClan, settlement.Hideout, isBossParty: false, null, MobileParty.MainParty.Position);
			_companyOfTroubleParty.MemberRoster.AddToCounts(_troubleCharacterObject, _companyTroopCount);
			TextObject customName = new TextObject("{=PV7RHgUl}Company of Trouble");
			_companyOfTroubleParty.Party.SetCustomName(customName);
			_companyOfTroubleParty.SetPartyUsedByQuest(isActivelyUsed: true);
			_battleWillStart = true;
		}

		internal void CompanyLeftQuestFail()
		{
			RelationshipChangeWithQuestGiver = -2;
			UpdateCompanyTroopCount();
			MobileParty.MainParty.MemberRoster.AddToCounts(_troubleCharacterObject, -_companyTroopCount);
			AddLog(QuestFailCompanyLeft);
			CompleteQuestWithFail();
			_companyLeftQuestWillFail = false;
			GameMenu.ExitToLast();
		}

		private void QuestAcceptedConsequences()
		{
			StartQuest();
			AddLog(PlayerStartsQuestLogText);
			MobileParty.MainParty.MemberRoster.AddToCounts(_troubleCharacterObject, _companyTroopCount);
			MBInformationManager.AddQuickInformation(new TextObject("{=jGIxKb99}Mercenaries have joined your party."));
		}

		protected override void RegisterEvents()
		{
			CampaignEvents.MapEventEnded.AddNonSerializedListener(this, OnMapEventEnded);
			CampaignEvents.WarDeclared.AddNonSerializedListener(this, OnWarDeclared);
			CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener(this, OnClanChangedKingdom);
			CampaignEvents.MapEventStarted.AddNonSerializedListener(this, OnMapEventStarted);
		}

		private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
		{
			if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
			{
				QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
			}
		}

		private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
		{
			if (base.QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				CompleteQuestWithCancel(QuestCanceledWarDeclared);
			}
		}

		private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
		{
			QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest(this, faction1, faction2, detail, PlayerDeclaredWarQuestLogText, QuestCanceledWarDeclared);
		}

		private void OnMapEventEnded(MapEvent mapEvent)
		{
			if ((mapEvent.IsPlayerMapEvent || mapEvent.IsPlayerSimulation) && !_checkForBattleResults)
			{
				UpdateCompanyTroopCount();
				if (_companyTroopCount == 0)
				{
					AddLog(AllCompanyDiedLogText);
					RelationshipChangeWithQuestGiver = 5;
					GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, RewardGold);
					CompleteQuestWithSuccess();
				}
			}
		}

		protected override void HourlyTick()
		{
			if (base.IsOngoing)
			{
				UpdateCompanyTroopCount();
				if (MobileParty.MainParty.MemberRoster.TotalManCount - _companyTroopCount <= _companyTroopCount && MapEvent.PlayerMapEvent == null && Settlement.CurrentSettlement == null && PlayerEncounter.Current == null && !Hero.MainHero.IsWounded && !MobileParty.MainParty.IsCurrentlyAtSea)
				{
					_triggerCompanyOfTroubleConversation = true;
					GameMenu.ActivateGameMenu("company_of_trouble_menu");
				}
			}
		}

		private void TryToStealItemFromPlayer()
		{
			bool flag = false;
			for (int i = 0; i < MobileParty.MainParty.ItemRoster.Count; i++)
			{
				ItemRosterElement itemRosterElement = MobileParty.MainParty.ItemRoster[i];
				ItemObject item = itemRosterElement.EquipmentElement.Item;
				if (!itemRosterElement.IsEmpty && item.IsFood)
				{
					MobileParty.MainParty.ItemRoster.AddToCounts(item, -1);
					flag = true;
					break;
				}
			}
			if (flag)
			{
				if (_thieveryCount == 0 || _thieveryCount == 1)
				{
					InformationManager.ShowInquiry(new InquiryData(Title.ToString(), (_thieveryCount == 0) ? new TextObject("{=OKpwA8Az}Your men have noticed some of the goods in the baggage train are missing.").ToString() : new TextObject("{=acu1wTeq}Your men are sure of that some of the goods were stolen from the baggage train.").ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: false, GameTexts.FindText("str_ok").ToString(), "", null, null), pauseGameActiveState: true);
				}
				else
				{
					MBInformationManager.AddQuickInformation(new TextObject("{=xlm8oYhM}Your men reported that some of the goods were stolen from the baggage train."));
				}
				_thieveryCount++;
			}
		}

		protected override void DailyTick()
		{
			if (MBRandom.RandomFloat > 0.5f)
			{
				TryToStealItemFromPlayer();
			}
		}

		private void UpdateCompanyTroopCount()
		{
			bool flag = false;
			foreach (TroopRosterElement item in MobileParty.MainParty.MemberRoster.GetTroopRoster())
			{
				if (item.Character == _troubleCharacterObject)
				{
					flag = true;
					_companyTroopCount = item.Number;
					break;
				}
			}
			if (!flag)
			{
				_companyTroopCount = 0;
			}
		}

		internal void QuestSuccessWithPlayerDefeatedCompany()
		{
			AddLog(AllCompanyDiedLogText);
			RelationshipChangeWithQuestGiver = 5;
			GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, RewardGold);
			CompleteQuestWithSuccess();
		}

		internal void QuestFailWithPlayerDefeatedAgainstCompany()
		{
			RelationshipChangeWithQuestGiver = -2;
			AddLog(PlayerDefeatedAgainstCompany);
			CompleteQuestWithFail();
		}

		protected override void OnFinalize()
		{
			UpdateCompanyTroopCount();
			if (_companyTroopCount > 0)
			{
				MobileParty.MainParty.MemberRoster.AddToCounts(_troubleCharacterObject, -_companyTroopCount);
			}
		}
	}

	public class LandLordCompanyOfTroubleIssueTypeDefiner : SaveableTypeDefiner
	{
		public LandLordCompanyOfTroubleIssueTypeDefiner()
			: base(4800000)
		{
		}

		protected override void DefineClassTypes()
		{
			AddClassDefinition(typeof(LandLordCompanyOfTroubleIssue), 1);
			AddClassDefinition(typeof(LandLordCompanyOfTroubleIssueQuest), 2);
		}
	}

	private const IssueBase.IssueFrequency LandLordCompanyOfTroubleIssueFrequency = IssueBase.IssueFrequency.Rare;

	private LandLordCompanyOfTroubleIssueQuest _cachedQuest;

	private const int IssueDuration = 25;

	private static LandLordCompanyOfTroubleIssueQuest Instance
	{
		get
		{
			LandLordCompanyOfTroubleIssueBehavior campaignBehavior = Campaign.Current.GetCampaignBehavior<LandLordCompanyOfTroubleIssueBehavior>();
			if (campaignBehavior._cachedQuest != null && campaignBehavior._cachedQuest.IsOngoing)
			{
				return campaignBehavior._cachedQuest;
			}
			foreach (QuestBase quest in Campaign.Current.QuestManager.Quests)
			{
				if (quest is LandLordCompanyOfTroubleIssueQuest cachedQuest)
				{
					campaignBehavior._cachedQuest = cachedQuest;
					return campaignBehavior._cachedQuest;
				}
			}
			return null;
		}
	}

	public override void RegisterEvents()
	{
		CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, OnCheckForIssue);
		CampaignEvents.OnSessionLaunchedEvent.AddNonSerializedListener(this, OnSessionLaunched);
	}

	private void OnSessionLaunched(CampaignGameStarter gameStarter)
	{
		gameStarter.AddGameMenu("company_of_trouble_menu", "", company_of_trouble_menu_on_init);
	}

	private void company_of_trouble_menu_on_init(MenuCallbackArgs args)
	{
		if (Instance == null)
		{
			return;
		}
		if (Instance._checkForBattleResults)
		{
			bool num = PlayerEncounter.Battle.WinningSide == PlayerEncounter.Battle.PlayerSide;
			PlayerEncounter.Finish();
			if (Instance._companyOfTroubleParty != null && Instance._companyOfTroubleParty.IsActive)
			{
				DestroyPartyAction.Apply(null, Instance._companyOfTroubleParty);
			}
			Instance._checkForBattleResults = false;
			if (num)
			{
				Instance.QuestSuccessWithPlayerDefeatedCompany();
			}
			else
			{
				Instance.QuestFailWithPlayerDefeatedAgainstCompany();
			}
		}
		else if (Instance._triggerCompanyOfTroubleConversation)
		{
			CampaignMapConversation.OpenConversation(new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty), new ConversationCharacterData(Instance._troubleCharacterObject, PartyBase.MainParty));
			Instance._triggerCompanyOfTroubleConversation = false;
		}
		else if (Instance._battleWillStart)
		{
			PlayerEncounter.Start();
			PlayerEncounter.Current.SetupFields(PartyBase.MainParty, Instance._companyOfTroubleParty.Party);
			PlayerEncounter.StartBattle();
			MapPatchData mapPatchAtPosition = Campaign.Current.MapSceneWrapper.GetMapPatchAtPosition(MobileParty.MainParty.Position);
			CampaignMission.OpenBattleMission(Campaign.Current.Models.SceneModel.GetBattleSceneForMapPatch(mapPatchAtPosition, PlayerEncounter.IsNavalEncounter()), usesTownDecalAtlas: false);
			Instance._battleWillStart = false;
			Instance._checkForBattleResults = true;
		}
		else if (Instance._companyLeftQuestWillFail)
		{
			Instance.CompanyLeftQuestFail();
		}
	}

	[GameMenuInitializationHandler("company_of_trouble_menu")]
	public static void company_of_trouble_menu_game_menu_on_init_background(MenuCallbackArgs args)
	{
		args.MenuContext.SetBackgroundMeshName("wait_ambush");
	}

	public void OnCheckForIssue(Hero hero)
	{
		if (hero.IsLord && hero.Clan != Clan.PlayerClan && hero.PartyBelongedTo != null && !hero.IsMinorFactionHero && hero.GetTraitLevel(DefaultTraits.Mercy) <= 0)
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(OnStartIssue, typeof(LandLordCompanyOfTroubleIssue), IssueBase.IssueFrequency.Rare));
		}
		else
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(LandLordCompanyOfTroubleIssue), IssueBase.IssueFrequency.Rare));
		}
	}

	private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
	{
		return new LandLordCompanyOfTroubleIssue(issueOwner);
	}

	public override void SyncData(IDataStore dataStore)
	{
	}
}
