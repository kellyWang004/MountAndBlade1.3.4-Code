using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues;

public class RevenueFarmingIssueBehavior : CampaignBehaviorBase
{
	public class RevenueFarmingIssue : IssueBase
	{
		private const int IssueAndQuestDuration = 20;

		private const int MinimumRequiredMenCount = 40;

		[SaveableField(1)]
		private Settlement _targetSettlement;

		protected override int RewardGold => 0;

		protected int TotalRequestedDenars
		{
			get
			{
				int num = 0;
				foreach (Village boundVillage in _targetSettlement.BoundVillages)
				{
					if (!boundVillage.Settlement.IsRaided && !boundVillage.Settlement.IsUnderRaid)
					{
						num += (int)(boundVillage.Hearth * 4f);
					}
				}
				return num / 3;
			}
		}

		public override TextObject IssueBriefByIssueGiver => new TextObject("{=j5fS9zaa}Yes, there is something. I have been on campaign for much of this year, and I have not been able to go around to my estates collecting the rents that are owed to me and the taxes that are owed to the realm. I need some help collecting these revenues.[ib:confident3][if:convo_nonchalant]");

		public override TextObject IssueAcceptByPlayer => new TextObject("{=AXy26AFb}Maybe I can help. What are the terms of agreement.");

		public override TextObject IssueQuestSolutionExplanationByIssueGiver
		{
			get
			{
				TextObject textObject = new TextObject("{=F540oIed}I can designate you as my official revenue farmer, and give you a list of everyone's holdings and how much they owe. All you need to do is visit all my villages and collect what you can. I don't expect you to be able to get every denar. Some of the people around here are genuinely hard - up, but they'll all try to get out of paying. Let's just keep it simple: I will take {TOTAL_REQUESTED_DENARS}{GOLD_ICON} denars and you can keep whatever else you can squeeze out of them. Are you interested?[if:convo_calm_friendly]");
				textObject.SetTextVariable("TOTAL_REQUESTED_DENARS", TotalRequestedDenars);
				return textObject;
			}
		}

		public override TextObject IssueQuestSolutionAcceptByPlayer => new TextObject("{=dAmK7rKG}All right. I will visit your villages and collect your rent.");

		public override bool IsThereAlternativeSolution => false;

		public override bool IsThereLordSolution => false;

		public override TextObject Title => new TextObject("{=zqrn2beP}Revenue Farming");

		public override TextObject Description
		{
			get
			{
				TextObject result = new TextObject("{=U8izV2lM}A {?ISSUE_GIVER.GENDER}lady{?}lord{\\?} is looking for someone to collect back rents that {?ISSUE_GIVER.GENDER}she{?}he{\\?} says are owed to {?ISSUE_GIVER.GENDER}her{?}him{\\?}.");
				StringHelpers.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject);
				return result;
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsRevenueFarmingIssue(object o, List<object> collectedObjects)
		{
			((RevenueFarmingIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_targetSettlement);
		}

		internal static object AutoGeneratedGetMemberValue_targetSettlement(object o)
		{
			return ((RevenueFarmingIssue)o)._targetSettlement;
		}

		public RevenueFarmingIssue(Hero issueOwner, Settlement targetSettlement)
			: base(issueOwner, CampaignTime.DaysFromNow(20f))
		{
			_targetSettlement = targetSettlement;
		}

		protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
		{
			if (issueEffect == DefaultIssueEffects.ClanInfluence)
			{
				return -0.2f;
			}
			return 0f;
		}

		public override IssueFrequency GetFrequency()
		{
			return IssueFrequency.VeryCommon;
		}

		public override bool IssueStayAliveConditions()
		{
			if (_targetSettlement.OwnerClan == base.IssueOwner.Clan)
			{
				return _targetSettlement.BoundVillages.Any((Village x) => !x.Settlement.IsRaided && !x.Settlement.IsUnderRaid);
			}
			return false;
		}

		protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out PreconditionFlags flags, out Hero relationHero, out SkillObject skill)
		{
			flags = PreconditionFlags.None;
			relationHero = null;
			skill = null;
			if (issueGiver.GetRelationWithPlayer() < -10f)
			{
				flags |= PreconditionFlags.Relation;
				relationHero = issueGiver;
			}
			if (FactionManager.IsAtWarAgainstFaction(issueGiver.MapFaction, Hero.MainHero.MapFaction))
			{
				flags |= PreconditionFlags.AtWar;
			}
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 40)
			{
				flags |= PreconditionFlags.NotEnoughTroops;
			}
			if (issueGiver.MapFaction.Leader == Hero.MainHero)
			{
				flags |= PreconditionFlags.MainHeroIsKingdomLeader;
			}
			return flags == PreconditionFlags.None;
		}

		protected override void OnGameLoad()
		{
		}

		protected override void HourlyTick()
		{
		}

		protected override QuestBase GenerateIssueQuest(string questId)
		{
			List<RevenueVillage> list = new List<RevenueVillage>();
			foreach (Village boundVillage in _targetSettlement.BoundVillages)
			{
				if (!boundVillage.Settlement.IsUnderRaid && !boundVillage.Settlement.IsRaided)
				{
					list.Add(new RevenueVillage(boundVillage, (int)(boundVillage.Hearth * 4f)));
				}
			}
			return new RevenueFarmingIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(20f), list);
		}

		protected override void CompleteIssueWithTimedOutConsequences()
		{
		}
	}

	public class RevenueFarmingIssueQuest : QuestBase
	{
		[SaveableField(10)]
		internal int _totalRequestedDenars;

		[SaveableField(20)]
		private readonly List<RevenueVillage> _revenueVillages;

		[SaveableField(30)]
		public bool CollectingRevenues;

		[SaveableField(40)]
		private readonly Dictionary<string, bool> _currentVillageEvents = new Dictionary<string, bool>();

		[SaveableField(50)]
		internal bool _allRevenuesAreCollected;

		[SaveableField(60)]
		private JournalLog _questProgressLog;

		public override TextObject Title => new TextObject("{=zqrn2beP}Revenue Farming");

		public override bool IsRemainingTimeHidden => false;

		public List<RevenueVillage> RevenueVillages => _revenueVillages;

		public Settlement TargetSettlement { get; private set; }

		private TextObject QuestStartedLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=b0WQfzNb}{QUEST_GIVER.LINK} the {?QUEST_GIVER.GENDER}lady{?}lord{\\?} of {TARGET_SETTLEMENT} told you that {?QUEST_GIVER.GENDER}she{?}he{\\?} wanted to grant revenue collection rights to a commander of good reputation who has enough men to suppress any resistance. {?QUEST_GIVER.GENDER}She{?}He{\\?} asked you to visit all the villages that are bound to {TARGET_SETTLEMENT} and collect taxes and rents. You have agreed to collect the revenues after paying {QUEST_GIVER.LINK}'s share, {REQUESTED_DENARS}{GOLD_ICON} denars.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("TARGET_SETTLEMENT", TargetSettlement.EncyclopediaLinkWithName);
				textObject.SetTextVariable("REQUESTED_DENARS", _totalRequestedDenars);
				return textObject;
			}
		}

		private TextObject QuestCanceledWarDeclaredLog
		{
			get
			{
				TextObject textObject = new TextObject("{=vW6kBki9}Your clan is now at war with {QUEST_GIVER.LINK}'s realm. Your agreement with {QUEST_GIVER.LINK} is canceled.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject PlayerDeclaredWarQuestLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject QuestSuccessLog
		{
			get
			{
				TextObject textObject = new TextObject("{=CEQhyvzj}You have completed the collection of revenues and paid {QUEST_GIVER.LINK} a fix sum in advance, as agreed.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject QuestBetrayedLog
		{
			get
			{
				TextObject textObject = new TextObject("{=5ky3voFY}You have rejected handing over the revenue to the {QUEST_GIVER.LINK}. The {?QUEST_GIVER.GENDER}lady{?}lord{\\?} is deeply disappointed in you.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject QuestFailedWithTimeOutLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=RNdrvZJQ}You have failed to bring the revenues to the {?QUEST_GIVER.GENDER}lady{?}lord{\\?} in time.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				return textObject;
			}
		}

		private TextObject AllRevenuesAreCollectedLogText
		{
			get
			{
				TextObject textObject = new TextObject("{=ywlzjQfN}{QUEST_GIVER.LINK} wants {TOTAL_REQUESTED_DENARS}{GOLD_ICON} that you have collected from {?QUEST_GIVER.GENDER}her{?}his{\\?} fiefs. You can either give the denars to the {?QUEST_GIVER.GENDER}lady{?}lord{\\?} yourself, or hand them over to a steward of the {?QUEST_GIVER.GENDER}lady{?}lord{\\?}, which can be found in the castles and towns that belong to the {?QUEST_GIVER.GENDER}lady{?}lord{\\?}.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("TOTAL_REQUESTED_DENARS", _totalRequestedDenars);
				return textObject;
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsRevenueFarmingIssueQuest(object o, List<object> collectedObjects)
		{
			((RevenueFarmingIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(_revenueVillages);
			collectedObjects.Add(_currentVillageEvents);
			collectedObjects.Add(_questProgressLog);
		}

		internal static object AutoGeneratedGetMemberValue_totalRequestedDenars(object o)
		{
			return ((RevenueFarmingIssueQuest)o)._totalRequestedDenars;
		}

		internal static object AutoGeneratedGetMemberValueCollectingRevenues(object o)
		{
			return ((RevenueFarmingIssueQuest)o).CollectingRevenues;
		}

		internal static object AutoGeneratedGetMemberValue_allRevenuesAreCollected(object o)
		{
			return ((RevenueFarmingIssueQuest)o)._allRevenuesAreCollected;
		}

		internal static object AutoGeneratedGetMemberValue_revenueVillages(object o)
		{
			return ((RevenueFarmingIssueQuest)o)._revenueVillages;
		}

		internal static object AutoGeneratedGetMemberValue_currentVillageEvents(object o)
		{
			return ((RevenueFarmingIssueQuest)o)._currentVillageEvents;
		}

		internal static object AutoGeneratedGetMemberValue_questProgressLog(object o)
		{
			return ((RevenueFarmingIssueQuest)o)._questProgressLog;
		}

		public RevenueFarmingIssueQuest(string questId, Hero giverHero, CampaignTime duration, List<RevenueVillage> revenueVillages)
			: base(questId, giverHero, duration, 0)
		{
			_revenueVillages = revenueVillages;
			TargetSettlement = _revenueVillages[0].Village.Bound;
			foreach (VillageEvent villageEvent in Campaign.Current.GetCampaignBehavior<RevenueFarmingIssueBehavior>()._villageEvents)
			{
				_currentVillageEvents.Add(villageEvent.Id, value: false);
			}
			foreach (RevenueVillage revenueVillage in revenueVillages)
			{
				_totalRequestedDenars += revenueVillage.TargetAmount / 3;
			}
			SetDialogs();
			InitializeQuestOnCreation();
		}

		private void QuestAcceptedConsequences()
		{
			StartQuest();
			_questProgressLog = AddDiscreteLog(QuestStartedLogText, new TextObject("{=bC5aMfG0}Villages"), 0, _revenueVillages.Count, null, hideInformation: true);
			foreach (RevenueVillage revenueVillage in _revenueVillages)
			{
				AddTrackedObject(revenueVillage.Village.Settlement);
			}
		}

		protected override void SetDialogs()
		{
			OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine(new TextObject("{=PXigJyMs}Excellent. You are acting in my name now. Try to be polite but you have every right to use force if they don't cough up what's owed. Good luck.[ib:confident2][if:convo_bored2]")).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.Consequence(QuestAcceptedConsequences)
				.CloseDialog();
			DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine(new TextObject("{=tthBNejU}Have you collected the revenues?[if:convo_undecided_open]")).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
				.BeginPlayerOptions()
				.PlayerOption(new TextObject("{=wErSpkjy}I'm still working on it."))
				.NpcLine(new TextObject("{=BI1UnHaB}Good, good. This takes time, I know, but don't keep me waiting too long.[if:convo_mocking_aristocratic]"))
				.Consequence(MapEventHelper.OnConversationEnd)
				.CloseDialog()
				.PlayerOption(new TextObject("{=ORl6qiOj}Yes, here is your share."))
				.Condition(() => _allRevenuesAreCollected)
				.ClickableCondition(TurnQuestInClickableCondition)
				.NpcLine(new TextObject("{=MKYzHFKB}Thank you for your help.[if:convo_delighted]"))
				.Consequence(delegate
				{
					QuestCompletedWithSuccess();
					MapEventHelper.OnConversationEnd();
				})
				.CloseDialog()
				.PlayerOption(new TextObject("{=kj3WQY1V}Maybe I should keep this to myself."))
				.Condition(() => _allRevenuesAreCollected)
				.NpcLine(new TextObject("{=82aiVoV9}You will regret this in the long run...[ib:closed2][if:convo_angry]"))
				.Consequence(delegate
				{
					QuestCompletedWithBetray();
					MapEventHelper.OnConversationEnd();
				})
				.CloseDialog()
				.PlayerOption(new TextObject("{=G5tyQj6N}Not yet."))
				.NpcLine(new TextObject("{=UXCjNTjF}Hurry up. I don't have that much time.[if:convo_annoyed]"))
				.Consequence(MapEventHelper.OnConversationEnd)
				.CloseDialog()
				.EndPlayerOptions();
		}

		private bool TurnQuestInClickableCondition(out TextObject explanation)
		{
			if (Hero.MainHero.Gold < Instance._totalRequestedDenars)
			{
				explanation = new TextObject("{=QOWyEJrm}You don't have enough denars.");
				return false;
			}
			explanation = null;
			return true;
		}

		protected override void OnBeforeTimedOut(ref bool completeWithSuccess, ref bool doNotResolveTheQuest)
		{
			RelationshipChangeWithQuestGiver = -5;
			TraitLevelingHelper.OnIssueSolvedThroughQuest(base.QuestGiver, new Tuple<TraitObject, int>[1]
			{
				new Tuple<TraitObject, int>(DefaultTraits.Honor, -30)
			});
			if (Hero.MainHero.Gold >= _totalRequestedDenars)
			{
				ShowQuestResolvePopUp();
				doNotResolveTheQuest = true;
			}
		}

		protected override void OnTimedOut()
		{
			AddLog(QuestFailedWithTimeOutLogText);
		}

		protected override void RegisterEvents()
		{
			CampaignEvents.WarDeclared.AddNonSerializedListener(this, OnWarDeclared);
			CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener(this, OnClanChangedKingdom);
			CampaignEvents.VillageBeingRaided.AddNonSerializedListener(this, OnVillageRaid);
			CampaignEvents.MapEventStarted.AddNonSerializedListener(this, OnMapEventStarted);
			CampaignEvents.MapEventEnded.AddNonSerializedListener(this, OnMapEventEnded);
			CampaignEvents.OnSettlementOwnerChangedEvent.AddNonSerializedListener(this, OnSettlementOwnerChanged);
			CampaignEvents.PlayerDesertedBattleEvent.AddNonSerializedListener(this, OnPlayerDeserted);
		}

		private void OnPlayerDeserted(int count)
		{
			Instance.CollectingRevenues = false;
		}

		private void OnMapEventEnded(MapEvent mapEvent)
		{
			if (mapEvent.IsPlayerMapEvent && mapEvent.HasWinner && mapEvent.IsFieldBattle)
			{
				Instance.CollectingRevenues = false;
			}
		}

		private void OnSettlementOwnerChanged(Settlement settlement, bool openToClaim, Hero newOwner, Hero oldOwner, Hero capturerHero, ChangeOwnerOfSettlementAction.ChangeOwnerOfSettlementDetail detail)
		{
			if (settlement == TargetSettlement && oldOwner == base.QuestGiver)
			{
				TextObject textObject = new TextObject("{=1m68Nsze}{QUEST_GIVER.LINK} has lost {SETTLEMENT} and your agreement with {?QUEST_GIVER.GENDER}her{?}him{\\?} has been canceled.");
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				textObject.SetTextVariable("SETTLEMENT", TargetSettlement.EncyclopediaLinkWithName);
				CompleteQuestWithCancel(textObject);
			}
		}

		private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
		{
			if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
			{
				QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
			}
		}

		private void OnVillageRaid(Village village)
		{
			RevenueVillage revenueVillage = _revenueVillages.FirstOrDefault((RevenueVillage x) => x.Village.Id == village.Id);
			if (revenueVillage != null && !revenueVillage.IsRaided)
			{
				TextObject textObject = new TextObject("{=k8U0928J}{VILLAGE} has been raided. {QUEST_GIVER.LINK} asks you to exempt them, but still wants you to collect {AMOUNT}{GOLD_ICON} denars from rest of {?QUEST_GIVER.GENDER}her{?}his{\\?} villages.");
				textObject.SetTextVariable("VILLAGE", village.Settlement.EncyclopediaLinkWithName);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
				_totalRequestedDenars -= revenueVillage.TargetAmount / 3;
				textObject.SetTextVariable("AMOUNT", _totalRequestedDenars);
				revenueVillage.SetDone();
				revenueVillage.IsRaided = true;
				AddLog(textObject);
				_questProgressLog.UpdateCurrentProgress(_questProgressLog.CurrentProgress + 1);
				if (CollectingRevenues)
				{
					CollectingRevenues = false;
				}
				if (_revenueVillages.All((RevenueVillage x) => x.IsRaided))
				{
					TextObject cancelLog = new TextObject("{=44f1ff0q}All the villages of {QUEST_GIVER.LINK} has been raided and your agreement with {?QUEST_GIVER.GENDER}her{?}him{\\?} has been canceled.");
					CompleteQuestWithCancel(cancelLog);
				}
			}
		}

		protected override void HourlyTick()
		{
			if (base.IsOngoing)
			{
				if (!_allRevenuesAreCollected && _revenueVillages.All((RevenueVillage x) => x.GetIsCompleted()))
				{
					OnAllRevenuesAreCollected();
				}
				if (CollectingRevenues)
				{
					ProgressRevenueCollectionForVillage();
				}
			}
		}

		private void OnAllRevenuesAreCollected()
		{
			_allRevenuesAreCollected = true;
			AddLog(AllRevenuesAreCollectedLogText);
		}

		public void RevenuesAreDeliveredToSteward()
		{
			MBInformationManager.AddQuickInformation(new TextObject("{=RCa0DpAo}You have handed over the revenue to the steward"));
			QuestCompletedWithSuccess();
		}

		private void ShowQuestResolvePopUp()
		{
			TextObject textObject = new TextObject("{=I9GYdYZx}{?QUEST_GIVER.GENDER}Lady{?}Lord{\\?} {QUEST_GIVER.NAME} wants {TOTAL_REQUESTED_DENARS}{GOLD_ICON} denars that you have collected from {?QUEST_GIVER.GENDER}her{?}his{\\?} fiefs. {?QUEST_GIVER.GENDER}She{?}He{\\?} has sent {?QUEST_GIVER.GENDER}her{?}his{\\?} steward to you to collect it. If you refuse this will be counted as a crime and {?QUEST_GIVER.GENDER}her{?}his{\\?} faction may declare war on you.");
			StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject);
			textObject.SetTextVariable("TOTAL_REQUESTED_DENARS", _totalRequestedDenars);
			InformationManager.ShowInquiry(new InquiryData(Title.ToString(), textObject.ToString(), isAffirmativeOptionShown: true, isNegativeOptionShown: true, new TextObject("{=plZVwdlL}Send the revenue").ToString(), new TextObject("{=asa9HaIQ}Keep the revenue").ToString(), QuestCompletedWithSuccess, QuestCompletedWithBetray));
			Campaign.Current.TimeControlMode = CampaignTimeControlMode.Stop;
			if (CollectingRevenues)
			{
				CollectingRevenues = false;
			}
		}

		private void QuestCompletedWithSuccess()
		{
			GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, _totalRequestedDenars);
			TraitLevelingHelper.OnIssueSolvedThroughQuest(base.QuestGiver, new Tuple<TraitObject, int>[1]
			{
				new Tuple<TraitObject, int>(DefaultTraits.Honor, 30)
			});
			RelationshipChangeWithQuestGiver = 5;
			AddLog(QuestSuccessLog);
			CompleteQuestWithSuccess();
		}

		private void QuestCompletedWithBetray()
		{
			TraitLevelingHelper.OnIssueSolvedThroughQuest(base.QuestGiver, new Tuple<TraitObject, int>[1]
			{
				new Tuple<TraitObject, int>(DefaultTraits.Honor, -100)
			});
			RelationshipChangeWithQuestGiver = -15;
			AddLog(QuestBetrayedLog);
			CompleteQuestWithBetrayal();
			ChangeCrimeRatingAction.Apply(base.QuestGiver.MapFaction, 45f);
		}

		private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
		{
			if (base.QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
			{
				CompleteQuestWithCancel(QuestCanceledWarDeclaredLog);
			}
		}

		private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
		{
			QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest(this, faction1, faction2, detail, PlayerDeclaredWarQuestLogText, QuestCanceledWarDeclaredLog);
		}

		protected override void OnFinalize()
		{
			if (Campaign.Current.CurrentMenuContext != null && (_currentVillageEvents.Any((KeyValuePair<string, bool> x) => x.Key == Campaign.Current.CurrentMenuContext.GameMenu.StringId) || Campaign.Current.CurrentMenuContext.GameMenu.StringId == "village_collect_revenue"))
			{
				if (Game.Current.GameStateManager.ActiveState is MapState)
				{
					PlayerEncounter.Finish();
				}
				else
				{
					GameMenu.SwitchToMenu("village_outside");
				}
			}
		}

		protected override void InitializeQuestOnGameLoad()
		{
			TargetSettlement = _revenueVillages[0].Village.Bound;
			SetDialogs();
		}

		public RevenueVillage FindCurrentRevenueVillage()
		{
			foreach (RevenueVillage revenueVillage in _revenueVillages)
			{
				if (revenueVillage.Village.Id == Settlement.CurrentSettlement.Village.Id)
				{
					return revenueVillage;
				}
			}
			return null;
		}

		private void ProgressRevenueCollectionForVillage()
		{
			RevenueVillage revenueVillage = FindCurrentRevenueVillage();
			if (!revenueVillage.EventOccurred && revenueVillage.CollectProgress >= 0.3f)
			{
				RevenueFarmingIssueBehavior behavior = Campaign.Current.GetCampaignBehavior<RevenueFarmingIssueBehavior>();
				KeyValuePair<string, bool> randomElementInefficiently = _currentVillageEvents.Where((KeyValuePair<string, bool> x) => !x.Value && behavior._villageEvents.Any((VillageEvent y) => y.Id == x.Key)).GetRandomElementInefficiently();
				_currentVillageEvents[randomElementInefficiently.Key] = true;
				behavior.OnVillageEventWithIdSpawned(randomElementInefficiently.Key);
				revenueVillage.EventOccurred = true;
				GameMenu.SwitchToMenu(randomElementInefficiently.Key);
				Campaign.Current.TimeControlMode = CampaignTimeControlMode.Stop;
			}
			else
			{
				revenueVillage.CollectedAmount += revenueVillage.HourlyGain;
				GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, revenueVillage.HourlyGain);
				if (revenueVillage.GetIsCompleted())
				{
					SetVillageAsCompleted(revenueVillage);
				}
			}
		}

		public void SetVillageAsCompleted(RevenueVillage village, bool addLog = true)
		{
			CollectingRevenues = false;
			village.SetDone();
			RemoveTrackedObject(village.Village.Settlement);
			GameMenu.SwitchToMenu("village");
			_questProgressLog.UpdateCurrentProgress(_questProgressLog.CurrentProgress + 1);
			if (addLog)
			{
				TextObject textObject = new TextObject("{=mQqN8Fg0}Your men have collected {TOTAL_COLLECTED_FROM_VILLAGE}{GOLD_ICON} denars and completed the revenue collection from {VILLAGE}.");
				textObject.SetTextVariable("TOTAL_COLLECTED_FROM_VILLAGE", village.CollectedAmount);
				textObject.SetTextVariable("VILLAGE", village.Village.Settlement.EncyclopediaLinkWithName);
				AddLog(textObject);
			}
			if (!_allRevenuesAreCollected && _revenueVillages.All((RevenueVillage x) => x.GetIsCompleted()))
			{
				OnAllRevenuesAreCollected();
			}
		}
	}

	public class VillageEvent
	{
		public readonly string Id;

		public readonly string MainEventText;

		public TextObject MainLog;

		public List<VillageEventOptionData> OptionConditionsAndConsequences;

		internal static void AutoGeneratedStaticCollectObjectsVillageEvent(object o, List<object> collectedObjects)
		{
			((VillageEvent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
		}

		public VillageEvent(string id, string mainEventText, TextObject mainLog, List<VillageEventOptionData> optionConditionsAndConsequences)
		{
			Id = id;
			MainEventText = mainEventText;
			MainLog = mainLog;
			OptionConditionsAndConsequences = optionConditionsAndConsequences;
		}
	}

	public class RevenueVillage
	{
		[SaveableField(1)]
		public readonly Village Village;

		[SaveableField(2)]
		public readonly int TargetAmount;

		[SaveableField(3)]
		public int CollectedAmount;

		[SaveableField(4)]
		public int HourlyGain;

		[SaveableField(5)]
		private bool _isDone;

		[SaveableField(6)]
		public bool EventOccurred;

		[SaveableField(7)]
		public bool IsRaided;

		[SaveableField(8)]
		private float _customProgress;

		public float CollectProgress => ((CollectedAmount == 0) ? 0f : ((float)CollectedAmount / (float)TargetAmount)) + _customProgress;

		internal static void AutoGeneratedStaticCollectObjectsRevenueVillage(object o, List<object> collectedObjects)
		{
			((RevenueVillage)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(Village);
		}

		internal static object AutoGeneratedGetMemberValueVillage(object o)
		{
			return ((RevenueVillage)o).Village;
		}

		internal static object AutoGeneratedGetMemberValueTargetAmount(object o)
		{
			return ((RevenueVillage)o).TargetAmount;
		}

		internal static object AutoGeneratedGetMemberValueCollectedAmount(object o)
		{
			return ((RevenueVillage)o).CollectedAmount;
		}

		internal static object AutoGeneratedGetMemberValueHourlyGain(object o)
		{
			return ((RevenueVillage)o).HourlyGain;
		}

		internal static object AutoGeneratedGetMemberValueEventOccurred(object o)
		{
			return ((RevenueVillage)o).EventOccurred;
		}

		internal static object AutoGeneratedGetMemberValueIsRaided(object o)
		{
			return ((RevenueVillage)o).IsRaided;
		}

		internal static object AutoGeneratedGetMemberValue_isDone(object o)
		{
			return ((RevenueVillage)o)._isDone;
		}

		internal static object AutoGeneratedGetMemberValue_customProgress(object o)
		{
			return ((RevenueVillage)o)._customProgress;
		}

		public void SetDone()
		{
			_isDone = true;
		}

		public RevenueVillage(Village village, int targetAmount)
		{
			Village = village;
			TargetAmount = targetAmount;
			CollectedAmount = 0;
			HourlyGain = targetAmount / 10;
			_isDone = false;
			EventOccurred = false;
			IsRaided = false;
			_customProgress = 0f;
		}

		public void SetAdditionalProgress(float progress)
		{
			_customProgress = progress;
		}

		public bool GetIsCompleted()
		{
			if (!_isDone && !(CollectProgress >= 1f))
			{
				return CollectedAmount >= TargetAmount;
			}
			return true;
		}
	}

	public class RevenueFarmingIssueBehaviorTypeDefiner : SaveableTypeDefiner
	{
		public RevenueFarmingIssueBehaviorTypeDefiner()
			: base(850000)
		{
		}

		protected override void DefineClassTypes()
		{
			AddClassDefinition(typeof(RevenueFarmingIssue), 1);
			AddClassDefinition(typeof(RevenueFarmingIssueQuest), 2);
			AddClassDefinition(typeof(VillageEvent), 3);
			AddClassDefinition(typeof(RevenueVillage), 4);
		}

		protected override void DefineContainerDefinitions()
		{
			ConstructContainerDefinition(typeof(List<RevenueVillage>));
			ConstructContainerDefinition(typeof(List<VillageEvent>));
			ConstructContainerDefinition(typeof(Dictionary<string, bool>));
		}
	}

	public struct VillageEventOptionData
	{
		public readonly string Text;

		public readonly GameMenuOption.OnConditionDelegate OnCondition;

		public readonly GameMenuOption.OnConsequenceDelegate OnConsequence;

		public readonly bool IsLeave;

		public VillageEventOptionData(string text, GameMenuOption.OnConditionDelegate onCondition, GameMenuOption.OnConsequenceDelegate onConsequence, bool isLeave = false)
		{
			Text = text;
			OnCondition = onCondition;
			OnConsequence = onConsequence;
			IsLeave = isLeave;
		}
	}

	private const int CollectAllVillageTaxesAfterHours = 10;

	private const IssueBase.IssueFrequency RevenueFarmingIssueFrequency = IssueBase.IssueFrequency.VeryCommon;

	private List<VillageEvent> _villageEvents;

	private RevenueFarmingIssueQuest _cachedQuest;

	private float IncidentChance => (100f - Instance.TargetSettlement.Town.Loyalty * 0.8f) * 0.01f;

	private static RevenueFarmingIssueQuest Instance
	{
		get
		{
			RevenueFarmingIssueBehavior campaignBehavior = Campaign.Current.GetCampaignBehavior<RevenueFarmingIssueBehavior>();
			if (campaignBehavior._cachedQuest != null && campaignBehavior._cachedQuest.IsOngoing)
			{
				return campaignBehavior._cachedQuest;
			}
			foreach (QuestBase quest in Campaign.Current.QuestManager.Quests)
			{
				if (quest is RevenueFarmingIssueQuest cachedQuest)
				{
					campaignBehavior._cachedQuest = cachedQuest;
					return campaignBehavior._cachedQuest;
				}
			}
			return null;
		}
	}

	public override void RegisterEvents()
	{
		CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, OnCheckForIssue);
		CampaignEvents.OnSessionLaunchedEvent.AddNonSerializedListener(this, OnSessionLaunched);
		CampaignEvents.OnAfterSessionLaunchedEvent.AddNonSerializedListener(this, OnAfterSessionLaunchedEvent);
	}

	private void OnAfterSessionLaunchedEvent(CampaignGameStarter gameStarter)
	{
		gameStarter.AddGameMenuOption("town_guard", "talk_to_steward_for_revenue_town", "{=voXpzZdH}Hand over the revenue", talk_to_steward_on_condition, talk_to_steward_on_consequence, isLeave: false, 2);
		gameStarter.AddGameMenuOption("town", "talk_to_steward_for_revenue_town", "{=voXpzZdH}Hand over the revenue", talk_to_steward_on_condition, talk_to_steward_on_consequence, isLeave: false, 9);
		gameStarter.AddGameMenuOption("castle_guard", "talk_to_steward_for_revenue_castle", "{=voXpzZdH}Hand over the revenue", talk_to_steward_on_condition, talk_to_steward_on_consequence, isLeave: false, 2);
	}

	private void OnSessionLaunched(CampaignGameStarter gameStarter)
	{
		gameStarter.AddGameMenuOption("village", "revenue_farming_quest_collect_tax_menu_button", "{=mcrjFxDQ}Collect revenue", collect_revenue_menu_condition, collect_revenue_menu_consequence, isLeave: false, 5);
		gameStarter.AddWaitGameMenu("village_collect_revenue", "{=p6swAFWn}Your men started collecting the revenues...", collecting_menu_on_init, null, null, collection_menu_on_tick, GameMenu.MenuAndOptionType.WaitMenuShowOnlyProgressOption, GameMenu.MenuOverlayType.None, 10f);
		gameStarter.AddGameMenuOption("village_collect_revenue", "village_collect_revenue_back", "{=3sRdGQou}Leave", leave_on_condition, leave_consequence, isLeave: true);
		AddVillageEvents(gameStarter);
	}

	private bool talk_to_steward_on_condition(MenuCallbackArgs args)
	{
		args.optionLeaveType = GameMenuOption.LeaveType.Manage;
		args.OptionQuestData = GameMenuOption.IssueQuestFlags.ActiveIssue;
		if (Instance != null)
		{
			if (Hero.MainHero.Gold < Instance._totalRequestedDenars)
			{
				args.IsEnabled = false;
				args.Tooltip = new TextObject("{=QOWyEJrm}You don't have enough denars.");
			}
			if (!Instance._allRevenuesAreCollected)
			{
				args.IsEnabled = false;
				args.Tooltip = new TextObject("{=QrAowQ5f}You have to collect the revenues first.");
			}
			return Settlement.CurrentSettlement.OwnerClan == Instance.QuestGiver.Clan;
		}
		return false;
	}

	private void talk_to_steward_on_consequence(MenuCallbackArgs args)
	{
		Instance.RevenuesAreDeliveredToSteward();
		if (Settlement.CurrentSettlement.IsCastle)
		{
			GameMenu.SwitchToMenu("castle");
		}
		else
		{
			GameMenu.SwitchToMenu("town");
		}
	}

	private void AddVillageEvents(CampaignGameStarter gameStarter)
	{
		_villageEvents = new List<VillageEvent>();
		string mainEventText = "{=RabC7Wzm}The headman tells you that most of the villagers can't afford the rest of the tax. They offer crops and other goods as payment in kind.";
		TextObject mainLog = new TextObject("{=5hgc03yZ}While your men were collecting revenues, a headman came and told you that most of the villagers couldn't afford to pay what they owe. They offered to pay the rest with their products.");
		List<VillageEventOptionData> list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=XVzQ7MXQ}Refuse the offer, break into their homes and collect all rents and taxes by force.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.HostileAction;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 10)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			TraitLevelingHelper.OnIssueSolvedThroughQuest(Instance.QuestGiver, new Tuple<TraitObject, int>[1]
			{
				new Tuple<TraitObject, int>(DefaultTraits.Mercy, -50)
			});
			int variable = MBRandom.RandomInt(2, 4);
			TextObject textObject = new TextObject("{=3vFxRKja}You refused his offer and decided to collect the rest of the revenues by force. Your action upset the village notables and made villagers angry. Some villagers tried to resist. In the brawl, {WOUNDED_COUNT} of your men got wounded.");
			textObject.SetTextVariable("WOUNDED_COUNT", variable);
			Instance.AddLog(textObject);
			ChangeRelationWithNotables(-5);
			int num = MBRandom.RandomInt(2, 4);
			MobileParty.MainParty.MemberRoster.WoundNumberOfNonHeroTroopsRandomly(num);
			TextObject textObject2 = new TextObject("{=o27lTMD4}Some villagers tried to resist. In the brawl, {WOUNDED_NUMBER} of your men got wounded.");
			textObject2.SetTextVariable("WOUNDED_NUMBER", num);
			MBInformationManager.AddQuickInformation(textObject2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=buKXELE3}Accept the offer.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Trade;
			RevenueVillage revenueVillage = Instance.FindCurrentRevenueVillage();
			int variable = (int)((float)revenueVillage.TargetAmount * 0.5f / (float)revenueVillage.Village.VillageType.PrimaryProduction.Value);
			TextObject textObject = new TextObject("{=wZfbYfoH}They will give you {PRODUCT_COUNT} {.%}{?(PRODUCT_COUNT > 1)}{PLURAL(PRODUCT)}{?}{PRODUCT}{\\?}{.%}.");
			textObject.SetTextVariable("PRODUCT", revenueVillage.Village.VillageType.PrimaryProduction.Name);
			textObject.SetTextVariable("PRODUCT_COUNT", variable);
			args.Tooltip = textObject;
			return true;
		}, delegate
		{
			GiveVillageGoods(out var amount);
			TextObject textObject = new TextObject("{=b5InObbq}You accepted the headman's offer. The village's notables and villagers were happy with your decision and they gave you {PRODUCT_COUNT} {.%}{?(PRODUCT_COUNT > 1)}{PLURAL(PRODUCT)}{?}{PRODUCT}{\\?}{.%}.");
			textObject.SetTextVariable("PRODUCT", Instance.FindCurrentRevenueVillage().Village.VillageType.PrimaryProduction.Name);
			textObject.SetTextVariable("PRODUCT_COUNT", amount);
			Instance.AddLog(textObject);
			ChangeRelationWithNotables(1);
			CompleteCurrentRevenueCollection();
		}));
		list.Add(new VillageEventOptionData("{=jULnw6F1}Leave the village, telling the villagers that they are exempted from payment this year.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=a3WpsFTM}You decided to exempt the rest of the villagers from payment and left the village. The village's notables and farmers were grateful to you."));
			ChangeRelationWithNotables(3);
			CompleteCurrentRevenueCollection();
		}));
		_villageEvents.Add(new VillageEvent("offer_goods_and_troops", mainEventText, mainLog, list));
		mainEventText = "{=tVYLzFwu}Suddenly a brawl starts between your troops and some of the village youth.";
		mainLog = new TextObject("{=vKaeKPJ5}Revenue collection was interrupted by a sudden brawl between your troops and young men of the village.");
		list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=eJegI0iX}Order the rest of your troops to put the village youth to flight.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Mission;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 10)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			Instance.AddLog(new TextObject("{=Zx1ZEl6Q}You ordered your troops to fight back. In the heat of the brawl, one of the young men was struck on the head and killed. His death greatly upset the villagers."));
			MBInformationManager.AddQuickInformation(new TextObject("{=xfEVlh7v}Your men beat some of youngsters to the death."));
			ChangeRelationWithNotables(-5);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=Z6IoX4MH}Order your troops to try not to hurt the youth and try to separate the two sides.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 10)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			int num = MBRandom.RandomInt(6, 10);
			TextObject textObject = new TextObject("{=YRocrk78}You ordered your troops to disengage. When the dust settled, {WOUNDED} of them had been injured. But the village notables understood that you wanted a peaceful solution.");
			textObject.SetTextVariable("WOUNDED", num);
			Instance.AddLog(textObject);
			TextObject textObject2 = new TextObject("{=00Qvwelb}{WOUNDED_NUMBER} of your men got wounded while they were trying to separate the two sides.");
			textObject2.SetTextVariable("WOUNDED_NUMBER", num);
			MBInformationManager.AddQuickInformation(textObject2);
			MobileParty.MainParty.MemberRoster.WoundNumberOfNonHeroTroopsRandomly(num);
			ChangeRelationWithNotables(2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=Xl5JTBJE}Leave the village, telling them you've collected enough.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Leave;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=T0feOigD}You decided to stop collecting revenues and leave the village. You told the villagers that they had paid enough, and they were grateful to you."));
			ChangeRelationWithNotables(4);
			CompleteCurrentRevenueCollection();
		}, isLeave: true));
		_villageEvents.Add(new VillageEvent("brawl_breaks_out", mainEventText, mainLog, list));
		mainEventText = "{=cOlZvnal}A landlord says that his retainers, who help keep order in the village, have gone unpaid and are starting to get mutinous. He says that if you can't help him out with a small sum of money to pay them while you collect the revenues from the rest of the village, he can't guarantee that things will go peacefully.";
		mainLog = new TextObject("{=HK4pwetq}A few hours after the revenue collection started, a landlord came and told you that his retainers were getting mutinuous. He asked you for some money to pay them their back wages.");
		list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=0p0jXXIa}Reject the landlord's request for money and collect revenues as before.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 5)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			ChangeRelationWithNotables(-5);
			if (MBRandom.RandomFloat < IncidentChance)
			{
				Instance.AddLog(new TextObject("{=bS7IAgJS}You told the notable that this was not your affair. A few hours later, the mutineers ambushed and killed some of your men on the outskirts of the village, and the revenues stolen. Your men completed collecting revenues from the village, but lost it all to an ambush."));
				GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, Instance.FindCurrentRevenueVillage().CollectedAmount, disableNotification: true);
				TextObject textObject = GameTexts.FindText("str_quest_collect_debt_quest_gold_removed");
				textObject.SetTextVariable("GOLD_AMOUNT", Instance.FindCurrentRevenueVillage().CollectedAmount);
				InformationManager.DisplayMessage(new InformationMessage(textObject.ToString(), "event:/ui/notification/coins_negative"));
				CompleteCurrentRevenueCollection(addLog: false);
				int num = MBRandom.RandomInt(2, 5);
				TextObject textObject2 = new TextObject("{=mosHZG3b}The mutineers ambushed and killed {KILLED_NUMBER} of your men.");
				textObject2.SetTextVariable("KILLED_NUMBER", num);
				MBInformationManager.AddQuickInformation(textObject2);
				MobileParty.MainParty.MemberRoster.RemoveNumberOfNonHeroTroopsRandomly(num);
			}
			else
			{
				Instance.AddLog(new TextObject("{=KQ8AU8Bz}You told the notable that this was not your affair. He did not like to hear this."));
				collect_revenue_menu_consequence(args);
			}
		}));
		list.Add(new VillageEventOptionData("{=EmJDw5xP}Give the landlord a small bribe for his men, and continue to collect revenues with their help.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Trade;
			int num = Instance.FindCurrentRevenueVillage().TargetAmount / 3;
			if (Hero.MainHero.Gold < num)
			{
				args.Tooltip = new TextObject("{=m6uSOtE4}You don't have enough money.");
				args.IsEnabled = false;
			}
			else
			{
				TextObject textObject = new TextObject("{=hCavIm4G}You will pay {AMOUNT}{GOLD_ICON} denars.");
				textObject.SetTextVariable("AMOUNT", num);
				args.Tooltip = textObject;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			Instance.AddLog(new TextObject("{=kp19y5Hh}You paid off the landlords' retainers to forestall a mutiny. The village notables were grateful to you."));
			GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, Instance.FindCurrentRevenueVillage().TargetAmount / 3);
			ChangeRelationWithNotables(2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=DhrjR8bs}Announce that the villagers have paid enough, and leave the village.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Leave;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=1yCeyK4I}You declared that the village had paid enough, and departed."));
			ChangeRelationWithNotables(4);
			CompleteCurrentRevenueCollection();
		}, isLeave: true));
		_villageEvents.Add(new VillageEvent("landlord_asks_for_money", mainEventText, mainLog, list));
		mainEventText = "{=pBII35Fa}As your man were collecting the tax, the headman shouted out to you across the fields that there has been an outbreak of the flux in the village. He warns you, for your own good, to stay away.";
		mainLog = new TextObject("{=fn59IIUf}As your man were collecting the tax, the headman shouted out to you that the village had seen an outbreak of the flux, and that you should stay away.");
		list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=CbapENnw}Tell your men that the headman is probably lying, and to go ahead and collect the revenues.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 5)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			if (MBRandom.RandomFloat < IncidentChance)
			{
				Instance.AddLog(new TextObject("{=9AyDNhQj}You told your men to ignore the warning. Several hours after you left, some of your men started experiencing chills, then diarrhea. This does not appear to be a particularly virulent strain, as no one died, but about half your men are incapacitated."));
				int num = MobileParty.MainParty.MemberRoster.TotalHealthyCount / 2;
				TextObject textObject = new TextObject("{=rmmZayCT}{WOUNDED_COUNT} of your men got wounded because of illness.");
				textObject.SetTextVariable("WOUNDED_COUNT", num);
				MBInformationManager.AddQuickInformation(textObject);
				MobileParty.MainParty.MemberRoster.WoundNumberOfNonHeroTroopsRandomly(num);
			}
			else
			{
				Instance.AddLog(new TextObject("{=obhcbsQT}You told your men to ignore the warning."));
			}
			ChangeRelationWithNotables(-4);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=iE5vWYj2}Tell your men to be careful, and to touch nothing in a house where anyone has been sick.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			RevenueVillage revenueVillage = Instance.FindCurrentRevenueVillage();
			Instance.AddLog(new TextObject("{=b3GrvocA}You told your men to go carefully, but still collect the revenues. The village notables seemed upset with your decision."));
			revenueVillage.SetAdditionalProgress(0.35f);
			ChangeRelationWithNotables(-2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=YZZ4zjxU}Tell the villagers that, in light of their hardship, they are forgiven what they owe.", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Leave;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=JSI0FVZ1}You decided to forgive the villagers' back payments. The headman thanked you, as the villagers were already suffering."));
			ChangeRelationWithNotables(4);
			CompleteCurrentRevenueCollection();
		}, isLeave: true));
		_villageEvents.Add(new VillageEvent("village_is_under_quarantine", mainEventText, mainLog, list));
		mainEventText = "{=yPkHn74X}When you enter the village commons, you find a crowd of villagers has gathered to resist you. They call the rents and taxes owed 'unlawful' and refuse to pay them at all. They pelt your men with rotten vegetables.";
		mainLog = new TextObject("{=yPkHn74X}When you enter the village commons, you find a crowd of villagers has gathered to resist you. They call the rents and taxes owed 'unlawful' and refuse to pay them at all. They pelt your men with rotten vegetables.");
		list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=aZ9bME9C}Order your men to break up the crowd by force", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount <= 9)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			if (MBRandom.RandomFloat < IncidentChance)
			{
				Instance.AddLog(new TextObject("{=ztY2Nf0N}You ordered your men to break up the crowd. There was some scuffling, and some of your men were wounded."));
				int num = MBRandom.RandomInt(6, 8);
				TextObject textObject = new TextObject("{=xJwo7eBh}{WOUNDED_NUMBER} of your men got wounded while they were breaking up the crowd.");
				textObject.SetTextVariable("WOUNDED_NUMBER", num);
				MBInformationManager.AddQuickInformation(textObject);
				MobileParty.MainParty.MemberRoster.WoundNumberOfNonHeroTroopsRandomly(num);
			}
			else
			{
				Instance.AddLog(new TextObject("{=ObYvBt0e}You ordered your men to break up the crowd. The attempt was successful and your men continued collecting taxes as usual."));
			}
			ChangeRelationWithNotables(-5);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=4MPhLYcT}Bargain with the group, agreeing to forgive the debts of the poorest villagers", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.DefendAction;
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			Instance.FindCurrentRevenueVillage().SetAdditionalProgress(0.5f);
			Instance.AddLog(new TextObject("{=54RyKzPJ}After your attempts to bargain, a deal has been made to forgive the debts of the poorest villagers."));
			ChangeRelationWithNotables(2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=tZw45isr}Tell the villagers that they made their point and that you're leaving", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Leave;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=6TYsIQav}After observing the villagers' hardships, you called back your men so as not put any more burden on them."));
			ChangeRelationWithNotables(4);
			CompleteCurrentRevenueCollection();
		}, isLeave: true));
		_villageEvents.Add(new VillageEvent("refuse_to_pay_what_they_owe", mainEventText, mainLog, list));
		mainEventText = "{=Tl4yagLi}The headman tells you that some households have suffered particularly hard this year from crop failures and bandit depredations. He asks you to forgive their back payments entirely. He hints that they are so desperate that they might resist by force.";
		mainLog = new TextObject("{=Tl4yagLi}The headman tells you that some households have suffered particularly hard this year from crop failures and bandit depredations. He asks you to forgive their back payments entirely. He hints that they are so desperate that they might resist by force.");
		list = new List<VillageEventOptionData>();
		list.Add(new VillageEventOptionData("{=agMtRiru}Refuse to exempt anyone", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Continue;
			if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 5)
			{
				args.Tooltip = new TextObject("{=MTbOGRCF}You don't have enough men!");
				args.IsEnabled = false;
			}
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			if (MBRandom.RandomFloat < IncidentChance)
			{
				Instance.AddLog(new TextObject("{=VsriS0iI}You refused to exempt anyone, but the residents attacked and killed some of your troops who were separated from the rest, and then ran away."));
				int num = MBRandom.RandomInt(2, 4);
				TextObject textObject = new TextObject("{=MGD8Ka2o}The residents attacked and killed {KILLED_NUMBER} of your troops who were separated from the rest.");
				textObject.SetTextVariable("KILLED_NUMBER", num);
				MBInformationManager.AddQuickInformation(textObject);
				MobileParty.MainParty.MemberRoster.RemoveNumberOfNonHeroTroopsRandomly(num);
			}
			else
			{
				Instance.AddLog(new TextObject("{=Rz1kkvbK}You refused to exempt anyone. Fortunately the villagers were sufficiently cowed by your men, and did not raise a hand."));
			}
			ChangeRelationWithNotables(-5);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=WDp5EAl3}Agree to exempt the poor households", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Conversation;
			return true;
		}, delegate(MenuCallbackArgs args)
		{
			Instance.FindCurrentRevenueVillage().SetAdditionalProgress(0.35f);
			Instance.AddLog(new TextObject("{=o70h6xqb}You showed mercy and exempted the poor households from the tax collection"));
			ChangeRelationWithNotables(2);
			collect_revenue_menu_consequence(args);
		}));
		list.Add(new VillageEventOptionData("{=aMleZjlG}Tell the villagers that they have all paid enough, and depart", delegate(MenuCallbackArgs args)
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Leave;
			return true;
		}, delegate
		{
			Instance.AddLog(new TextObject("{=rsQhD7sC}You thought that the villagers have paid enough, so departed from the settlement"));
			ChangeRelationWithNotables(4);
			CompleteCurrentRevenueCollection();
		}, isLeave: true));
		_villageEvents.Add(new VillageEvent("relief_for_the_poorest", mainEventText, mainLog, list));
		foreach (VillageEvent villageEvent in _villageEvents)
		{
			AddVillageEventMenus(villageEvent, gameStarter);
		}
	}

	private void AddVillageEventMenus(VillageEvent villageEvent, CampaignGameStarter gameStarter)
	{
		gameStarter.AddGameMenu(villageEvent.Id, villageEvent.MainEventText, null);
		for (int i = 0; i < villageEvent.OptionConditionsAndConsequences.Count; i++)
		{
			VillageEventOptionData villageEventOptionData = villageEvent.OptionConditionsAndConsequences[i];
			gameStarter.AddGameMenuOption(villageEvent.Id, "Id_option" + i, villageEventOptionData.Text, villageEventOptionData.OnCondition, villageEventOptionData.OnConsequence, villageEventOptionData.IsLeave);
		}
	}

	private bool collect_revenue_menu_condition(MenuCallbackArgs args)
	{
		if (Instance != null && Instance.IsOngoing && (MobileParty.MainParty.Army == null || MobileParty.MainParty.Army.LeaderParty == MobileParty.MainParty))
		{
			args.optionLeaveType = GameMenuOption.LeaveType.Manage;
			args.OptionQuestData = GameMenuOption.IssueQuestFlags.ActiveIssue;
			RevenueVillage revenueVillage = Instance.RevenueVillages.FirstOrDefault((RevenueVillage x) => x.Village == Settlement.CurrentSettlement.Village);
			if (revenueVillage != null && !revenueVillage.GetIsCompleted())
			{
				bool flag = MobileParty.MainParty.MemberRoster.TotalHealthyCount >= 20;
				TextObject disabledText = new TextObject("{=CfCsGTfb}Villagers are not taking you seriously, as you do not have enough soldiers to carry out the process. At least 20 men are needed to continue.");
				return MenuHelper.SetOptionProperties(args, flag, !flag, disabledText);
			}
			return false;
		}
		return false;
	}

	private bool leave_on_condition(MenuCallbackArgs args)
	{
		args.optionLeaveType = GameMenuOption.LeaveType.Leave;
		return true;
	}

	private void leave_consequence(MenuCallbackArgs args)
	{
		Instance.CollectingRevenues = false;
		GameMenu.SwitchToMenu("village");
	}

	private void collecting_menu_on_init(MenuCallbackArgs args)
	{
		if (Instance.FindCurrentRevenueVillage().CollectedAmount == 0)
		{
			TextObject textObject = new TextObject("{=VktwHCN6}Your men have started to collect the tax of {VILLAGE}");
			textObject.SetTextVariable("VILLAGE", Settlement.CurrentSettlement.Name);
			MBInformationManager.AddQuickInformation(textObject);
		}
		Instance.CollectingRevenues = true;
		args.MenuContext.GameMenu.StartWait();
		UpdateCollectionMenuProgress(args);
	}

	private void collection_menu_on_tick(MenuCallbackArgs args, CampaignTime dt)
	{
		UpdateCollectionMenuProgress(args);
	}

	private static void UpdateCollectionMenuProgress(MenuCallbackArgs args)
	{
		RevenueVillage revenueVillage = Instance.FindCurrentRevenueVillage();
		args.MenuContext.GameMenu.SetProgressOfWaitingInMenu(revenueVillage.CollectProgress);
	}

	private void collect_revenue_menu_consequence(MenuCallbackArgs args)
	{
		GameMenu.SwitchToMenu("village_collect_revenue");
		Campaign.Current.TimeControlMode = CampaignTimeControlMode.UnstoppablePlay;
	}

	[GameMenuInitializationHandler("village_collect_revenue")]
	private static void village_collect_revenue_game_menu_on_init(MenuCallbackArgs args)
	{
		args.MenuContext.SetBackgroundMeshName(Settlement.CurrentSettlement.SettlementComponent.WaitMeshName);
		Campaign.Current.TimeControlMode = CampaignTimeControlMode.UnstoppablePlay;
	}

	[GameMenuInitializationHandler("offer_goods_and_troops")]
	[GameMenuInitializationHandler("brawl_breaks_out")]
	[GameMenuInitializationHandler("landlord_asks_for_money")]
	[GameMenuInitializationHandler("village_is_under_quarantine")]
	[GameMenuInitializationHandler("refuse_to_pay_what_they_owe")]
	[GameMenuInitializationHandler("relief_for_the_poorest")]
	private static void village_event_common_menu_on_init(MenuCallbackArgs args)
	{
		args.MenuContext.SetBackgroundMeshName(Settlement.CurrentSettlement.SettlementComponent.WaitMeshName);
	}

	private void ChangeRelationWithNotables(int relation)
	{
		foreach (Hero notable in Settlement.CurrentSettlement.Notables)
		{
			notable.SetHasMet();
			ChangeRelationAction.ApplyPlayerRelation(notable, relation, affectRelatives: false, showQuickNotification: false);
		}
		TextObject textObject = ((relation <= 0) ? new TextObject("{=r5Netxy0}Your relation is decreased by {MAGNITUDE} with village notables.") : new TextObject("{=IwS1qeq9}Your relation is increased by {MAGNITUDE} with village notables."));
		textObject.SetTextVariable("MAGNITUDE", relation);
		MBInformationManager.AddQuickInformation(textObject);
	}

	private void CompleteCurrentRevenueCollection(bool addLog = true)
	{
		RevenueVillage revenueVillage = Instance.FindCurrentRevenueVillage();
		Instance.SetVillageAsCompleted(revenueVillage, addLog);
		if (Instance.IsTracked(revenueVillage.Village.Settlement))
		{
			Instance.RemoveTrackedObject(revenueVillage.Village.Settlement);
		}
		Instance.CollectingRevenues = false;
		PlayerEncounter.Finish();
	}

	private void GiveVillageGoods(out int amount)
	{
		RevenueVillage revenueVillage = Instance.FindCurrentRevenueVillage();
		amount = (int)((float)revenueVillage.TargetAmount * 0.5f / (float)revenueVillage.Village.VillageType.PrimaryProduction.Value);
		MobileParty.MainParty.ItemRoster.AddToCounts(revenueVillage.Village.VillageType.PrimaryProduction, amount);
	}

	public void OnVillageEventWithIdSpawned(string Id)
	{
		VillageEvent villageEvent = _villageEvents.FirstOrDefault((VillageEvent x) => x.Id == Id);
		Instance.AddLog(villageEvent.MainLog);
	}

	public override void SyncData(IDataStore dataStore)
	{
	}

	private bool ConditionsHold(Hero issueGiver, out Settlement targetSettlement)
	{
		targetSettlement = null;
		if (issueGiver.IsLord && issueGiver.Clan.Leader == issueGiver && issueGiver.GetTraitLevel(DefaultTraits.Mercy) <= 0 && issueGiver.Clan.Settlements.Count > 0)
		{
			targetSettlement = issueGiver.Clan.Settlements.Where((Settlement x) => x.IsTown).GetRandomElementInefficiently();
		}
		return targetSettlement != null;
	}

	public void OnCheckForIssue(Hero hero)
	{
		if (ConditionsHold(hero, out var targetSettlement))
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(OnSelected, typeof(RevenueFarmingIssue), IssueBase.IssueFrequency.VeryCommon, targetSettlement));
		}
		else
		{
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(RevenueFarmingIssue), IssueBase.IssueFrequency.VeryCommon));
		}
	}

	private IssueBase OnSelected(in PotentialIssueData pid, Hero issueOwner)
	{
		return new RevenueFarmingIssue(issueOwner, pid.RelatedObject as Settlement);
	}
}
