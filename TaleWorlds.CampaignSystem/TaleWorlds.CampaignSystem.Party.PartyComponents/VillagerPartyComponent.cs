using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class VillagerPartyComponent : PartyComponent
{
	protected class InitializationArgs
	{
		private const float VillagerSpawnRadius = 1f;

		public void InitializeVillagerPartyProperties(MobileParty mobileParty, Village village)
		{
			mobileParty.InitializeMobilePartyAroundPosition(village.Settlement.Culture.VillagerPartyTemplate, village.Owner.Settlement.GatePosition, 1f);
			float num = 10000f;
			ItemObject itemObject = null;
			foreach (ItemObject item in Items.All)
			{
				if (item.ItemCategory == DefaultItemCategories.PackAnimal && (float)item.Value < num && item.Value > 40)
				{
					itemObject = item;
					num = item.Value;
				}
			}
			if (itemObject != null)
			{
				int amount = (int)(0.5f * (float)mobileParty.MemberRoster.TotalManCount);
				mobileParty.ItemRoster.Add(new ItemRosterElement(itemObject, amount));
			}
		}
	}

	private InitializationArgs _initializationArgs;

	[CachedData]
	protected TextObject _cachedName;

	[SaveableProperty(1)]
	public Village Village { get; private set; }

	public override Hero PartyOwner => Village.Settlement.OwnerClan.Leader;

	public override Settlement HomeSettlement => Village.Settlement;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null)
			{
				_cachedName = GameTexts.FindText("str_villagers_of_VILLAGE_NAME");
				_cachedName.SetTextVariable("VILLAGE_NAME", Village.Name);
			}
			return _cachedName;
		}
	}

	internal static void AutoGeneratedStaticCollectObjectsVillagerPartyComponent(object o, List<object> collectedObjects)
	{
		((VillagerPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(Village);
	}

	internal static object AutoGeneratedGetMemberValueVillage(object o)
	{
		return ((VillagerPartyComponent)o).Village;
	}

	public static MobileParty CreateVillagerParty(string stringId, Village village)
	{
		return MobileParty.CreateParty(stringId, new VillagerPartyComponent(village, new InitializationArgs()));
	}

	public static void ConvertPartyToVillagerParty(MobileParty mobileParty, Village village)
	{
		mobileParty.SetPartyComponent(new VillagerPartyComponent(village, null));
	}

	public override Banner GetDefaultComponentBanner()
	{
		return HomeSettlement.Banner;
	}

	protected VillagerPartyComponent(Village village, InitializationArgs args)
	{
		Village = village;
		_initializationArgs = args;
	}

	protected override void OnMobilePartySetOnCreation()
	{
		base.MobileParty.Aggressiveness = 0f;
		base.MobileParty.InitializePartyTrade(0);
		base.MobileParty.Party.SetVisualAsDirty();
		if (_initializationArgs != null)
		{
			_initializationArgs.InitializeVillagerPartyProperties(base.MobileParty, Village);
			_initializationArgs = null;
		}
	}

	protected override void OnInitialize()
	{
		Village.VillagerPartyComponent = this;
	}

	protected override void OnFinalize()
	{
		Village.VillagerPartyComponent = null;
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}
}
