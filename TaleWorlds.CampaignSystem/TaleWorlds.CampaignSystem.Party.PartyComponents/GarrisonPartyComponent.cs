using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class GarrisonPartyComponent : PartyComponent
{
	protected class InitializationArgs
	{
		public void InitializeGarrisonPartyProperties(MobileParty mobileParty, Settlement settlement)
		{
			mobileParty.CurrentSettlement = settlement;
			mobileParty.InitializeMobilePartyAtPosition(settlement.GatePosition);
		}
	}

	private InitializationArgs _initializationArgs;

	[CachedData]
	private TextObject _cachedName;

	public override Hero PartyOwner => Settlement.OwnerClan.Leader;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null)
			{
				_cachedName = GameTexts.FindText("str_garrison_party_name");
				_cachedName.SetTextVariable("MAJOR_PARTY_LEADER", Settlement.Name);
			}
			return _cachedName;
		}
	}

	public override Settlement HomeSettlement => Settlement;

	public override int WagePaymentLimit => Settlement.GarrisonWagePaymentLimit;

	public override bool CanHaveNavalNavigationCapability => false;

	[SaveableProperty(1)]
	public Settlement Settlement { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsGarrisonPartyComponent(object o, List<object> collectedObjects)
	{
		((GarrisonPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(Settlement);
	}

	internal static object AutoGeneratedGetMemberValueSettlement(object o)
	{
		return ((GarrisonPartyComponent)o).Settlement;
	}

	public static MobileParty CreateGarrisonParty(string stringId, Settlement settlement)
	{
		InitializationArgs args = new InitializationArgs();
		return MobileParty.CreateParty(stringId, new GarrisonPartyComponent(settlement, args));
	}

	public static void ConvertPartyToGarrisonParty(MobileParty mobileParty, Settlement settlement)
	{
		mobileParty.SetPartyComponent(new GarrisonPartyComponent(settlement, null));
	}

	public override Banner GetDefaultComponentBanner()
	{
		return Settlement.Banner;
	}

	public override void SetWagePaymentLimit(int newLimit)
	{
		Settlement.SetGarrisonWagePaymentLimit(newLimit);
	}

	protected GarrisonPartyComponent(Settlement settlement, InitializationArgs args)
	{
		Settlement = settlement;
		_initializationArgs = args;
	}

	protected override void OnMobilePartySetOnCreation()
	{
		base.MobileParty.Party.SetVisualAsDirty();
		base.MobileParty.InitializePartyTrade(Campaign.Current.Models.ClanFinanceModel.PartyGoldLowerThreshold);
		base.MobileParty.Ai.DisableAi();
		base.MobileParty.Aggressiveness = 0f;
		base.MobileParty.DesiredAiNavigationType = MobileParty.NavigationType.None;
		if (_initializationArgs != null)
		{
			_initializationArgs.InitializeGarrisonPartyProperties(base.MobileParty, Settlement);
			_initializationArgs = null;
		}
	}

	protected override void OnInitialize()
	{
		Settlement.Town.GarrisonPartyComponent = this;
	}

	protected override void OnFinalize()
	{
		Settlement.Town.GarrisonPartyComponent = null;
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}
}
