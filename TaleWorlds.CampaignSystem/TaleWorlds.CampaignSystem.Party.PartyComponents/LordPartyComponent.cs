using System.Collections.Generic;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class LordPartyComponent : WarPartyComponent
{
	public class InitializationArgs
	{
		public readonly CampaignVec2 Position;

		public readonly float SpawnRadius;

		public readonly Settlement SpawnSettlement;

		public InitializationArgs(CampaignVec2 position, float spawnRadius, Settlement spawnSettlement)
		{
			Position = position;
			SpawnRadius = spawnRadius;
			SpawnSettlement = spawnSettlement;
		}

		public void InitializeLordPartyProperties(MobileParty mobileParty, Hero owner)
		{
			mobileParty.AddElementToMemberRoster(owner.CharacterObject, 1, insertAtFront: true);
			if (mobileParty == MobileParty.MainParty || owner.Clan == Clan.PlayerClan)
			{
				mobileParty.InitializeMobilePartyAtPosition(Position);
			}
			else
			{
				PartyTemplateObject pt = (owner.Clan.IsRebelClan ? owner.Clan.Culture.RebelsPartyTemplate : owner.Clan.DefaultPartyTemplate);
				mobileParty.InitializeMobilePartyAroundPosition(pt, Position, SpawnRadius);
			}
			mobileParty.ItemRoster.Add(new ItemRosterElement(DefaultItems.Grain, MBRandom.RandomInt(15, 30)));
			if (SpawnSettlement != null)
			{
				MobileParty.NavigationType navigationType = ((!mobileParty.IsCurrentlyAtSea) ? MobileParty.NavigationType.Default : MobileParty.NavigationType.Naval);
				mobileParty.SetMoveGoToSettlement(SpawnSettlement, navigationType, mobileParty.IsCurrentlyAtSea);
			}
		}
	}

	private InitializationArgs _initializationArgs;

	[CachedData]
	private TextObject _cachedName;

	[SaveableField(30)]
	private Hero _leader;

	[SaveableField(40)]
	private int _wagePaymentLimit = Campaign.Current.Models.PartyWageModel.MaxWagePaymentLimit;

	public override Hero PartyOwner => Owner;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null && Owner != null)
			{
				_cachedName = GetPartyName();
			}
			return _cachedName ?? new TextObject("{=!}unnamedMobileParty");
		}
	}

	public override bool CanHaveNavalNavigationCapability => true;

	public override Settlement HomeSettlement => Owner.HomeSettlement;

	[SaveableProperty(20)]
	public Hero Owner { get; private set; }

	public override Hero Leader => _leader;

	public override int WagePaymentLimit => _wagePaymentLimit;

	internal static void AutoGeneratedStaticCollectObjectsLordPartyComponent(object o, List<object> collectedObjects)
	{
		((LordPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(_leader);
		collectedObjects.Add(Owner);
	}

	internal static object AutoGeneratedGetMemberValueOwner(object o)
	{
		return ((LordPartyComponent)o).Owner;
	}

	internal static object AutoGeneratedGetMemberValue_leader(object o)
	{
		return ((LordPartyComponent)o)._leader;
	}

	internal static object AutoGeneratedGetMemberValue_wagePaymentLimit(object o)
	{
		return ((LordPartyComponent)o)._wagePaymentLimit;
	}

	public override void SetWagePaymentLimit(int newLimit)
	{
		_wagePaymentLimit = newLimit;
	}

	protected override void OnMobilePartySetOnCreation()
	{
		base.MobileParty.ActualClan = Owner.Clan;
		base.MobileParty.Party.SetVisualAsDirty();
		if (base.MobileParty != MobileParty.MainParty && base.MobileParty.Owner.Clan != Clan.PlayerClan)
		{
			base.MobileParty.Aggressiveness = 0.9f + 0.1f * (float)Owner.GetTraitLevel(DefaultTraits.Valor) - 0.05f * (float)Owner.GetTraitLevel(DefaultTraits.Mercy);
			Owner.PassedTimeAtHomeSettlement = (int)(MBRandom.RandomFloat * 100f);
		}
		if (_initializationArgs != null)
		{
			_initializationArgs.InitializeLordPartyProperties(base.MobileParty, Owner);
			_initializationArgs = null;
		}
	}

	public static MobileParty CreateLordParty(string stringId, Hero hero, CampaignVec2 position, float spawnRadius, Settlement spawnSettlement, Hero partyLeader)
	{
		InitializationArgs args = new InitializationArgs(position, spawnRadius, spawnSettlement);
		return MobileParty.CreateParty(stringId + "_party_1", new LordPartyComponent(hero, partyLeader, args));
	}

	public static void ConvertPartyToLordParty(MobileParty mobileParty, Hero owner, Hero partyLeader)
	{
		mobileParty.SetPartyComponent(new LordPartyComponent(owner, partyLeader, null));
	}

	protected LordPartyComponent(Hero owner, Hero leader, InitializationArgs args)
	{
		Owner = owner;
		_leader = leader;
		_initializationArgs = args;
	}

	internal void ChangePartyOwner(Hero owner)
	{
		ClearCachedName();
		Owner = owner;
	}

	protected override void OnChangePartyLeader(Hero newLeader)
	{
		_leader = newLeader;
		ClearCachedName();
		if (_leader != null)
		{
			ChangePartyOwner(newLeader);
		}
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}

	private TextObject GetPartyName()
	{
		TextObject textObject = GameTexts.FindText("str_lord_party_name");
		textObject.SetCharacterProperties("TROOP", Owner.CharacterObject);
		textObject.SetTextVariable("IS_LORDPARTY", 1);
		return textObject;
	}
}
