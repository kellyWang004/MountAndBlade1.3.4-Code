using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class MilitiaPartyComponent : PartyComponent
{
	protected class InitializationArgs
	{
		public void InitializeMilitiaPartyProperties(MobileParty mobileParty, Settlement settlement)
		{
			PartyTemplateObject militiaPartyTemplate = settlement.Culture.MilitiaPartyTemplate;
			mobileParty.InitializeMobilePartyAtPosition(militiaPartyTemplate, settlement.GatePosition);
		}
	}

	private InitializationArgs _initializationArgs;

	[CachedData]
	private TextObject _cachedName;

	[SaveableProperty(1)]
	public Settlement Settlement { get; private set; }

	public override Hero PartyOwner => Settlement.OwnerClan.Leader;

	public override bool CanHaveNavalNavigationCapability => false;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null)
			{
				_cachedName = GameTexts.FindText("str_militia_name");
				_cachedName.SetTextVariable("SETTLEMENT_NAME", Settlement.Name);
			}
			return _cachedName;
		}
	}

	public override Settlement HomeSettlement => Settlement;

	internal static void AutoGeneratedStaticCollectObjectsMilitiaPartyComponent(object o, List<object> collectedObjects)
	{
		((MilitiaPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(Settlement);
	}

	internal static object AutoGeneratedGetMemberValueSettlement(object o)
	{
		return ((MilitiaPartyComponent)o).Settlement;
	}

	public override Banner GetDefaultComponentBanner()
	{
		return Settlement.Banner;
	}

	public static MobileParty CreateMilitiaParty(string stringId, Settlement settlement)
	{
		InitializationArgs args = new InitializationArgs();
		MobileParty mobileParty = MobileParty.CreateParty("militias_of_" + stringId + "_aaa1", new MilitiaPartyComponent(settlement, args));
		mobileParty.DesiredAiNavigationType = MobileParty.NavigationType.None;
		EnterSettlementAction.ApplyForParty(mobileParty, settlement);
		return mobileParty;
	}

	public static void ConvertPartyToMilitiaParty(MobileParty mobileParty, Settlement settlement)
	{
		mobileParty.SetPartyComponent(new MilitiaPartyComponent(settlement, null));
	}

	protected override void OnMobilePartySetOnCreation()
	{
		base.MobileParty.Party.SetVisualAsDirty();
		base.MobileParty.Ai.DisableAi();
		base.MobileParty.Aggressiveness = 0f;
		if (_initializationArgs != null)
		{
			_initializationArgs.InitializeMilitiaPartyProperties(base.MobileParty, Settlement);
			_initializationArgs = null;
		}
	}

	protected MilitiaPartyComponent(Settlement settlement, InitializationArgs args)
	{
		Settlement = settlement;
		_initializationArgs = args;
	}

	protected override void OnInitialize()
	{
		Settlement.MilitiaPartyComponent = this;
	}

	protected override void OnFinalize()
	{
		Settlement.MilitiaPartyComponent = null;
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}
}
