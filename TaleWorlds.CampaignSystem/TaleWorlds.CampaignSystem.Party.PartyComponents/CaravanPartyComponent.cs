using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class CaravanPartyComponent : PartyComponent
{
	protected class InitializationArgs
	{
		public readonly Hero CaravanLeader;

		public readonly ItemRoster CaravanItems;

		public readonly PartyTemplateObject PartyTemplateObject;

		public InitializationArgs(PartyTemplateObject partyTemplateObject, Hero caravanLeader = null, ItemRoster caravanItems = null)
		{
			CaravanLeader = caravanLeader;
			CaravanItems = caravanItems;
			PartyTemplateObject = partyTemplateObject;
		}

		public void InitializeCaravanOnCreation(MobileParty mobileParty, Settlement settlement)
		{
			int num;
			CampaignVec2 campaignVec;
			if (PartyTemplateObject.ShipHulls != null)
			{
				num = ((PartyTemplateObject.ShipHulls.Count > 0) ? 1 : 0);
				if (num != 0)
				{
					campaignVec = settlement.PortPosition;
					goto IL_0034;
				}
			}
			else
			{
				num = 0;
			}
			campaignVec = settlement.GatePosition;
			goto IL_0034;
			IL_0034:
			CampaignVec2 position = campaignVec;
			if (num != 0)
			{
				mobileParty.SetLandNavigationAccess(access: false);
			}
			mobileParty.InitializeMobilePartyAtPosition(PartyTemplateObject, position);
			if (CaravanLeader != null)
			{
				CaravanLeader?.PartyBelongedTo?.MemberRoster?.AddToCounts(CaravanLeader.CharacterObject, -1);
				mobileParty.MemberRoster.AddToCounts(CaravanLeader.CharacterObject, 1, insertAtFront: true);
			}
			else
			{
				mobileParty.MemberRoster.AddToCounts(mobileParty.Party.Owner.Culture.CaravanMaster, 1, insertAtFront: true);
			}
			if (CaravanItems != null)
			{
				mobileParty.ItemRoster.Add(CaravanItems);
				return;
			}
			float num2 = 10000f;
			ItemObject itemObject = null;
			foreach (ItemObject item in Items.All)
			{
				if (item.ItemCategory == DefaultItemCategories.PackAnimal && !item.NotMerchandise && (float)item.Value < num2)
				{
					itemObject = item;
					num2 = item.Value;
				}
			}
			if (itemObject != null)
			{
				mobileParty.ItemRoster.Add(new ItemRosterElement(itemObject, (int)((float)mobileParty.MemberRoster.TotalManCount * 0.5f)));
			}
		}
	}

	private InitializationArgs _initializationArgs;

	[CachedData]
	private TextObject _cachedName;

	[SaveableField(4)]
	private bool _isElite;

	[SaveableField(3)]
	private Hero _leader;

	[SaveableProperty(1)]
	public Settlement Settlement { get; private set; }

	[SaveableProperty(2)]
	public Hero Owner { get; private set; }

	public override Hero PartyOwner => Owner;

	public bool IsElite => _isElite;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null)
			{
				if (base.MobileParty == null)
				{
					return GameTexts.FindText("str_caravan_party_name");
				}
				CacheName();
			}
			return _cachedName;
		}
	}

	public override bool CanHaveNavalNavigationCapability => !base.MobileParty.HasLandNavigationCapability;

	public override bool CanHaveLandNavigationCapability => base.MobileParty.HasLandNavigationCapability;

	public override Settlement HomeSettlement => Settlement;

	public override Hero Leader => _leader;

	internal static void AutoGeneratedStaticCollectObjectsCaravanPartyComponent(object o, List<object> collectedObjects)
	{
		((CaravanPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(_leader);
		collectedObjects.Add(Settlement);
		collectedObjects.Add(Owner);
	}

	internal static object AutoGeneratedGetMemberValueSettlement(object o)
	{
		return ((CaravanPartyComponent)o).Settlement;
	}

	internal static object AutoGeneratedGetMemberValueOwner(object o)
	{
		return ((CaravanPartyComponent)o).Owner;
	}

	internal static object AutoGeneratedGetMemberValue_isElite(object o)
	{
		return ((CaravanPartyComponent)o)._isElite;
	}

	internal static object AutoGeneratedGetMemberValue_leader(object o)
	{
		return ((CaravanPartyComponent)o)._leader;
	}

	public override Banner GetDefaultComponentBanner()
	{
		if (Leader != null)
		{
			return Leader.ClanBanner;
		}
		if (Owner == Hero.MainHero)
		{
			return Owner.MapFaction.Banner;
		}
		return Owner.HomeSettlement.OwnerClan.MapFaction.Banner;
	}

	protected CaravanPartyComponent(Settlement settlement, Hero owner, Hero partyLeader, bool isElite, InitializationArgs args)
	{
		Settlement = settlement;
		Owner = owner;
		_leader = partyLeader;
		_isElite = isElite;
		_initializationArgs = args;
	}

	protected override void OnMobilePartySetOnCreation()
	{
		base.MobileParty.Aggressiveness = 0f;
		base.MobileParty.ActualClan = Owner.Clan;
		base.MobileParty.Party.SetVisualAsDirty();
		if (_initializationArgs != null)
		{
			_initializationArgs.InitializeCaravanOnCreation(base.MobileParty, Settlement);
			_initializationArgs = null;
		}
	}

	protected override void OnInitialize()
	{
		Owner.OwnedCaravans.Add(this);
	}

	protected override void OnFinalize()
	{
		Owner.OwnedCaravans.Remove(this);
	}

	public static void ConvertPartyToCaravanParty(MobileParty mobileParty, Hero caravanOwner, Settlement spawnSettlement, bool isInitialSpawn = false, Hero caravanLeader = null, ItemRoster caravanItems = null, bool isElite = false)
	{
		mobileParty.SetPartyComponent(new CaravanPartyComponent(spawnSettlement, caravanOwner, caravanLeader, isElite, null));
		if (mobileParty.LeaderHero != null)
		{
			CampaignEventDispatcher.Instance.OnHeroGetsBusy(mobileParty.LeaderHero, HeroGetsBusyReasons.BecomeCaravanLeader);
		}
	}

	protected override void OnChangePartyLeader(Hero newLeader)
	{
		_leader = newLeader;
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}

	private void CacheName()
	{
		if (base.MobileParty.HasNavalNavigationCapability)
		{
			_cachedName = GameTexts.FindText(IsElite ? "str_armed_convoy_party_name" : "str_convoy_party_name");
		}
		else
		{
			_cachedName = GameTexts.FindText(IsElite ? "str_armed_caravan_party_name" : "str_caravan_party_name");
		}
		_cachedName.SetCharacterProperties("OWNER", base.MobileParty.LeaderHero?.CharacterObject ?? Owner.CharacterObject);
	}

	public static MobileParty CreateCaravanParty(Hero caravanOwner, Settlement spawnSettlement, PartyTemplateObject templateObject, bool isInitialSpawn = false, Hero caravanLeader = null, ItemRoster caravanItems = null, bool isElite = false)
	{
		bool flag = templateObject.ShipHulls.Any();
		InitializationArgs args = new InitializationArgs(templateObject, caravanLeader, caravanItems);
		MobileParty mobileParty = MobileParty.CreateParty("caravan_template_" + spawnSettlement.Culture.StringId.ToLower() + "_1", new CaravanPartyComponent(spawnSettlement, caravanOwner, caravanLeader, isElite, args));
		mobileParty.InitializePartyTrade(Campaign.Current.Models.CaravanModel.GetInitialTradeGold(caravanOwner, flag, isElite));
		if (spawnSettlement.Party.MapEvent == null && spawnSettlement.SiegeEvent == null)
		{
			mobileParty.SetMoveGoToSettlement(spawnSettlement, (!flag) ? MobileParty.NavigationType.Default : MobileParty.NavigationType.Naval, flag);
			mobileParty.RecalculateShortTermBehavior();
			EnterSettlementAction.ApplyForParty(mobileParty, spawnSettlement);
		}
		else
		{
			mobileParty.SetMoveModeHold();
		}
		if (mobileParty.LeaderHero != null)
		{
			CampaignEventDispatcher.Instance.OnHeroGetsBusy(mobileParty.LeaderHero, HeroGetsBusyReasons.BecomeCaravanLeader);
		}
		return mobileParty;
	}

	public override void GetMountAndHarnessVisualIdsForPartyIcon(PartyBase party, out string mountStringId, out string harnessStringId)
	{
		string text = party.MapFaction?.Culture?.StringId ?? string.Empty;
		if (text == "aserai" || text == "khuzait")
		{
			mountStringId = "camel";
			if (party.Index % 2 == 0)
			{
				harnessStringId = "camel_saddle_a";
			}
			else
			{
				harnessStringId = "camel_saddle_b";
			}
			return;
		}
		mountStringId = "mule";
		switch (party.Index % 3)
		{
		case 0:
			harnessStringId = "mule_load_a";
			break;
		case 1:
			harnessStringId = "mule_load_b";
			break;
		default:
			harnessStringId = "mule_load_c";
			break;
		}
	}

	public static void TransferCaravanOwnership(MobileParty caravan, Hero newOwner, Settlement homeSettlement)
	{
		int partyTradeGold = caravan.PartyTradeGold;
		ConvertPartyToCaravanParty(caravan, newOwner, homeSettlement, isInitialSpawn: false, caravan.LeaderHero, null, caravan.CaravanPartyComponent.IsElite);
		caravan.PartyTradeGold = partyTradeGold;
	}

	public void ChangeHomeSettlement(Settlement newHomeSettlement)
	{
		Settlement = newHomeSettlement;
	}
}
