using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class PatrolPartyComponent : PartyComponent
{
	[CachedData]
	private TextObject _name;

	[SaveableField(0)]
	private Settlement _homeSettlement;

	public override Hero PartyOwner => HomeSettlement.Owner;

	public override TextObject Name => _name;

	public override Settlement HomeSettlement => _homeSettlement;

	public Clan Clan => HomeSettlement.OwnerClan;

	[SaveableProperty(1)]
	public bool IsNaval { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsPatrolPartyComponent(object o, List<object> collectedObjects)
	{
		((PatrolPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(_homeSettlement);
	}

	internal static object AutoGeneratedGetMemberValueIsNaval(object o)
	{
		return ((PatrolPartyComponent)o).IsNaval;
	}

	internal static object AutoGeneratedGetMemberValue_homeSettlement(object o)
	{
		return ((PatrolPartyComponent)o)._homeSettlement;
	}

	public override Banner GetDefaultComponentBanner()
	{
		return HomeSettlement.Banner;
	}

	public static MobileParty CreatePatrolParty(string stringId, CampaignVec2 position, float spawnRadius, Settlement homeSettlement, PartyTemplateObject template)
	{
		bool flag = template.ShipHulls != null && template.ShipHulls.Count > 0;
		MobileParty mobileParty = MobileParty.CreateParty(stringId + "_party_1", new PatrolPartyComponent(homeSettlement, flag));
		mobileParty.InitializeMobilePartyAroundPosition(template, position, spawnRadius);
		mobileParty.ItemRoster.Add(new ItemRosterElement(DefaultItems.Grain, MBRandom.RandomInt(15, 30)));
		mobileParty.PatrolPartyComponent.SortRoster();
		if (flag)
		{
			mobileParty.SetLandNavigationAccess(access: false);
		}
		mobileParty.PatrolPartyComponent.InitializePartyComponentProperties();
		return mobileParty;
	}

	protected PatrolPartyComponent(Settlement homeSettlement, bool isNaval)
	{
		_homeSettlement = homeSettlement;
		IsNaval = isNaval;
	}

	protected override void OnMobilePartySetOnCreation()
	{
	}

	protected override void OnInitialize()
	{
		InitializePartyComponentProperties();
	}

	private void InitializePartyComponentProperties()
	{
		_name = GetPartyName();
		if (!IsNaval)
		{
			HomeSettlement.SetPatrolParty(this);
		}
	}

	protected override void OnFinalize()
	{
		if (!IsNaval)
		{
			HomeSettlement.SetPatrolParty(null);
		}
	}

	private TextObject GetPartyName()
	{
		TextObject textObject = null;
		textObject = ((!IsNaval) ? GameTexts.FindText("str_patrol_party_name") : GameTexts.FindText("str_coastal_patrol_party_name"));
		textObject.SetTextVariable("SETTLEMENT", HomeSettlement.Name);
		return textObject;
	}

	public void SortRoster()
	{
		PartyBaseHelper.SortRoster(base.MobileParty);
	}
}
