using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class CustomPartyComponent : PartyComponent
{
	protected class InitializationArgs
	{
		public readonly CampaignVec2 Position;

		public readonly float SpawnRadius;

		public readonly Clan Clan;

		public readonly TroopRoster TroopRoster;

		public readonly TroopRoster PrisonerRoster;

		public readonly PartyTemplateObject PartyTemplate;

		public bool IsCreatedWithPartyTemplate => PartyTemplate != null;

		private InitializationArgs(CampaignVec2 position, float spawnRadius, Clan clan)
		{
			Position = position;
			SpawnRadius = spawnRadius;
			Clan = clan;
		}

		public InitializationArgs(CampaignVec2 position, float spawnRadius, Clan clan, PartyTemplateObject partyTemplate)
			: this(position, spawnRadius, clan)
		{
			PartyTemplate = partyTemplate;
		}

		public InitializationArgs(CampaignVec2 position, float spawnRadius, Clan clan, TroopRoster troopRoster, TroopRoster prisonerRoster)
			: this(position, spawnRadius, clan)
		{
			TroopRoster = troopRoster;
			PrisonerRoster = prisonerRoster;
		}

		public void InitializeCustomPartyPropertiesWithPartyTemplate(MobileParty mobileParty)
		{
			mobileParty.ActualClan = Clan;
			mobileParty.InitializeMobilePartyAroundPosition(PartyTemplate, Position, SpawnRadius);
			mobileParty.Party.SetVisualAsDirty();
		}

		public void InitializeCustomPartyPropertiesWithTroopRoster(MobileParty mobileParty)
		{
			mobileParty.ActualClan = Clan;
			mobileParty.InitializeMobilePartyAroundPosition(TroopRoster, PrisonerRoster, Position, SpawnRadius, 0f, !Position.IsOnLand);
			mobileParty.Party.SetVisualAsDirty();
		}
	}

	private InitializationArgs _initializationArgs;

	private const string StringId = "quest_party_template_1";

	[SaveableField(10)]
	private TextObject _name;

	[SaveableField(20)]
	private Settlement _homeSettlement;

	[SaveableField(30)]
	private Hero _owner;

	[SaveableField(40)]
	private float _customPartyBaseSpeed;

	[SaveableField(50)]
	private string _partyMountStringId;

	[SaveableField(60)]
	private string _partyHarnessStringId;

	[SaveableField(70)]
	private bool _avoidHostileActions;

	[SaveableField(80)]
	private Hero _leader;

	public float CustomPartyBaseSpeed
	{
		get
		{
			return _customPartyBaseSpeed;
		}
		set
		{
			_customPartyBaseSpeed = value;
		}
	}

	public override bool AvoidHostileActions => _avoidHostileActions;

	public override Hero Leader => _leader;

	public float BaseSpeed => _customPartyBaseSpeed;

	public override Hero PartyOwner => _owner;

	public override TextObject Name => _name;

	public override Settlement HomeSettlement => _homeSettlement;

	internal static void AutoGeneratedStaticCollectObjectsCustomPartyComponent(object o, List<object> collectedObjects)
	{
		((CustomPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(_name);
		collectedObjects.Add(_homeSettlement);
		collectedObjects.Add(_owner);
		collectedObjects.Add(_leader);
	}

	internal static object AutoGeneratedGetMemberValue_name(object o)
	{
		return ((CustomPartyComponent)o)._name;
	}

	internal static object AutoGeneratedGetMemberValue_homeSettlement(object o)
	{
		return ((CustomPartyComponent)o)._homeSettlement;
	}

	internal static object AutoGeneratedGetMemberValue_owner(object o)
	{
		return ((CustomPartyComponent)o)._owner;
	}

	internal static object AutoGeneratedGetMemberValue_customPartyBaseSpeed(object o)
	{
		return ((CustomPartyComponent)o)._customPartyBaseSpeed;
	}

	internal static object AutoGeneratedGetMemberValue_partyMountStringId(object o)
	{
		return ((CustomPartyComponent)o)._partyMountStringId;
	}

	internal static object AutoGeneratedGetMemberValue_partyHarnessStringId(object o)
	{
		return ((CustomPartyComponent)o)._partyHarnessStringId;
	}

	internal static object AutoGeneratedGetMemberValue_avoidHostileActions(object o)
	{
		return ((CustomPartyComponent)o)._avoidHostileActions;
	}

	internal static object AutoGeneratedGetMemberValue_leader(object o)
	{
		return ((CustomPartyComponent)o)._leader;
	}

	protected CustomPartyComponent(Settlement homeSettlement, TextObject name, Hero owner, string partyMountStringId, string partyHarnessStringId, float customPartyBaseSpeed, bool avoidHostileActions, InitializationArgs args, Hero leader = null)
	{
		_name = name;
		_homeSettlement = homeSettlement;
		_owner = owner;
		_leader = leader;
		_partyMountStringId = partyMountStringId;
		_partyHarnessStringId = partyHarnessStringId;
		SetBaseSpeed(customPartyBaseSpeed);
		_avoidHostileActions = avoidHostileActions;
		_initializationArgs = args;
	}

	public override Banner GetDefaultComponentBanner()
	{
		return null;
	}

	public static MobileParty CreateCustomPartyWithPartyTemplate(CampaignVec2 position, float spawnRadius, Settlement homeSettlement, TextObject name, Clan clan, PartyTemplateObject partyTemplate, Hero owner, string partyMountStringId = "", string partyHarnessStringId = "", float customPartyBaseSpeed = 0f, bool avoidHostileActions = false)
	{
		InitializationArgs args = new InitializationArgs(position, spawnRadius, clan, partyTemplate);
		return MobileParty.CreateParty("quest_party_template_1", new CustomPartyComponent(homeSettlement, name, owner, partyMountStringId, partyHarnessStringId, customPartyBaseSpeed, avoidHostileActions, args));
	}

	public static MobileParty CreateCustomPartyWithPartyTemplate(CampaignVec2 position, float spawnRadius, Settlement homeSettlement, TextObject name, Clan clan, PartyTemplateObject partyTemplate, Hero owner, Hero leader, string partyMountStringId = "", string partyHarnessStringId = "", float customPartyBaseSpeed = 0f, bool avoidHostileActions = false)
	{
		InitializationArgs args = new InitializationArgs(position, spawnRadius, clan, partyTemplate);
		MobileParty mobileParty = MobileParty.CreateParty("quest_party_template_1", new CustomPartyComponent(homeSettlement, name, owner, partyMountStringId, partyHarnessStringId, customPartyBaseSpeed, avoidHostileActions, args, leader));
		AddHeroToPartyAction.Apply(leader, mobileParty, showNotification: false);
		return mobileParty;
	}

	public static MobileParty CreateCustomPartyWithTroopRoster(CampaignVec2 position, float spawnRadius, Settlement homeSettlement, TextObject name, Clan clan, TroopRoster troopRoster, TroopRoster prisonerRoster, Hero owner, string partyMountStringId = "", string partyHarnessStringId = "", float customPartyBaseSpeed = 0f, bool avoidHostileActions = false)
	{
		InitializationArgs args = new InitializationArgs(position, spawnRadius, clan, troopRoster, prisonerRoster);
		return MobileParty.CreateParty("quest_party_template_1", new CustomPartyComponent(homeSettlement, name, owner, partyMountStringId, partyHarnessStringId, customPartyBaseSpeed, avoidHostileActions, args));
	}

	public static void ConvertPartyToCustomParty(MobileParty mobileParty, Settlement homeSettlement, TextObject name, Hero owner, string partyMountStringId = "", string partyHarnessStringId = "", float customPartyBaseSpeed = 0f, bool avoidHostileActions = false)
	{
		mobileParty.SetPartyComponent(new CustomPartyComponent(homeSettlement, name, owner, partyMountStringId, partyHarnessStringId, customPartyBaseSpeed, avoidHostileActions, null));
	}

	public void SetBaseSpeed(float speed)
	{
		_customPartyBaseSpeed = speed;
		base.MobileParty?.UpdateVersionNo();
	}

	public override void GetMountAndHarnessVisualIdsForPartyIcon(PartyBase party, out string mountStringId, out string harnessStringId)
	{
		mountStringId = _partyMountStringId;
		harnessStringId = _partyHarnessStringId;
	}

	protected override void OnMobilePartySetOnCreation()
	{
		if (_initializationArgs != null)
		{
			if (_initializationArgs.IsCreatedWithPartyTemplate)
			{
				_initializationArgs.InitializeCustomPartyPropertiesWithPartyTemplate(base.MobileParty);
			}
			else
			{
				_initializationArgs.InitializeCustomPartyPropertiesWithTroopRoster(base.MobileParty);
			}
			_initializationArgs = null;
		}
	}

	protected override void OnChangePartyLeader(Hero newLeader)
	{
		_leader = newLeader;
		ClearCachedName();
		if (_leader != null)
		{
			ChangePartyOwner(newLeader);
		}
	}

	internal void ChangePartyOwner(Hero owner)
	{
		ClearCachedName();
		_owner = owner;
	}
}
